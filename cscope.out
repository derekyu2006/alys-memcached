cscope 15 /Users/hoddis/workdir/opsrcprojs/memcached -q 0000002215 0000383129
	@assoc.c

14 
	~"memÿched.h
"

15 
	~<sys/¡©.h
>

16 
	~<sys/sock‘.h
>

17 
	~<sys/»sourû.h
>

18 
	~<sigÇl.h
>

19 
	~<fú.h
>

20 
	~<Ãtš‘/š.h
>

21 
	~<”ºo.h
>

22 
	~<¡dlib.h
>

23 
	~<¡dio.h
>

24 
	~<¡ršg.h
>

25 
	~<as£¹.h
>

26 
	~<±h»ad.h
>

28 
±h»ad_cÚd_t
 
	gmaš‹Çnû_cÚd
 = 
PTHREAD_COND_INITIALIZER
;

29 
±h»ad_mu‹x_t
 
	gmaš‹Çnû_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

30 
±h»ad_mu‹x_t
 
	ghash_™ems_couÁ”_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

32 
	tub4
;

33 
	tub1
;

36 
	ghashpow”
 = 
HASHPOWER_DEFAULT
;

38 
	#hashsize
(
n
è((
ub4
)1<<Ò))

	)

39 
	#hashmask
(
n
è(
	`hashsize
Ò)-1)

	)

42 
™em
** 
	g´im¬y_hashbË
 = 0;

48 
™em
** 
	gŞd_hashbË
 = 0;

51 
	ghash_™ems
 = 0;

54 
boŞ
 
	gex·ndšg
 = 
çl£
;

55 
boŞ
 
	g¡¬‹d_ex·ndšg
 = 
çl£
;

61 
	gex·nd_buck‘
 = 0;

63 
	$assoc_š™
(cÚ¡ 
hashbË_š™
) {

64 ià(
hashbË_š™
) {

65 
hashpow”
 = 
hashbË_š™
;

67 
´im¬y_hashbË
 = 
	`ÿÎoc
(
	`hashsize
(
hashpow”
), (*));

68 ià(! 
´im¬y_hashbË
) {

69 
	`årštf
(
¡d”r
, "Failedo init hashtable.\n");

70 
	`ex™
(
EXIT_FAILURE
);

72 
	`STATS_LOCK
();

73 
¡©s_¡©e
.
hash_pow”_Ëv–
 = 
hashpow”
;

74 
¡©s_¡©e
.
hash_by‹s
 = 
	`hashsize
(
hashpow”
) * (*);

75 
	`STATS_UNLOCK
();

76 
	}
}

78 
™em
 *
	$assoc_fšd
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
ušt32_t
 
hv
) {

79 
™em
 *
™
;

80 
Şdbuck‘
;

82 ià(
ex·ndšg
 &&

83 (
Şdbuck‘
 = (
hv
 & 
	`hashmask
(
hashpow”
 - 1))è>ğ
ex·nd_buck‘
)

85 
™
 = 
Şd_hashbË
[
Şdbuck‘
];

87 
™
 = 
´im¬y_hashbË
[
hv
 & 
	`hashmask
(
hashpow”
)];

90 
™em
 *
»t
 = 
NULL
;

91 
d•th
 = 0;

92 
™
) {

93 ià((
nkey
 =ğ
™
->nkeyè&& (
	`memcmp
(
key
, 
	`ITEM_key
(it),‚key) == 0)) {

94 
»t
 = 
™
;

97 
™
 = it->
h_Ãxt
;

98 ++
d•th
;

100 
	`MEMCACHED_ASSOC_FIND
(
key
, 
nkey
, 
d•th
);

101  
»t
;

102 
	}
}

107 
™em
** 
	$_hash™em_befÜe
 (cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
ušt32_t
 
hv
) {

108 
™em
 **
pos
;

109 
Şdbuck‘
;

111 ià(
ex·ndšg
 &&

112 (
Şdbuck‘
 = (
hv
 & 
	`hashmask
(
hashpow”
 - 1))è>ğ
ex·nd_buck‘
)

114 
pos
 = &
Şd_hashbË
[
Şdbuck‘
];

116 
pos
 = &
´im¬y_hashbË
[
hv
 & 
	`hashmask
(
hashpow”
)];

119 *
pos
 && ((
nkey
 !ğ(*pos)->nkeyè|| 
	`memcmp
(
key
, 
	`ITEM_key
(*pos),‚key))) {

120 
pos
 = &(*pos)->
h_Ãxt
;

122  
pos
;

123 
	}
}

126 
	$assoc_ex·nd
() {

127 
Şd_hashbË
 = 
´im¬y_hashbË
;

129 
´im¬y_hashbË
 = 
	`ÿÎoc
(
	`hashsize
(
hashpow”
 + 1), (*));

130 ià(
´im¬y_hashbË
) {

131 ià(
£‰šgs
.
v”bo£
 > 1)

132 
	`årštf
(
¡d”r
, "Hashableƒxpansion starting\n");

133 
hashpow”
++;

134 
ex·ndšg
 = 
Œue
;

135 
ex·nd_buck‘
 = 0;

136 
	`STATS_LOCK
();

137 
¡©s_¡©e
.
hash_pow”_Ëv–
 = 
hashpow”
;

138 
¡©s_¡©e
.
hash_by‹s
 +ğ
	`hashsize
(
hashpow”
) * (*);

139 
¡©s_¡©e
.
hash_is_ex·ndšg
 = 
Œue
;

140 
	`STATS_UNLOCK
();

142 
´im¬y_hashbË
 = 
Şd_hashbË
;

145 
	}
}

147 
	$assoc_¡¬t_ex·nd
() {

148 ià(
¡¬‹d_ex·ndšg
)

151 
¡¬‹d_ex·ndšg
 = 
Œue
;

152 
	`±h»ad_cÚd_sigÇl
(&
maš‹Çnû_cÚd
);

153 
	}
}

156 
	$assoc_š£¹
(
™em
 *
™
, cÚ¡ 
ušt32_t
 
hv
) {

157 
Şdbuck‘
;

161 ià(
ex·ndšg
 &&

162 (
Şdbuck‘
 = (
hv
 & 
	`hashmask
(
hashpow”
 - 1))è>ğ
ex·nd_buck‘
)

164 
™
->
h_Ãxt
 = 
Şd_hashbË
[
Şdbuck‘
];

165 
Şd_hashbË
[
Şdbuck‘
] = 
™
;

167 
™
->
h_Ãxt
 = 
´im¬y_hashbË
[
hv
 & 
	`hashmask
(
hashpow”
)];

168 
´im¬y_hashbË
[
hv
 & 
	`hashmask
(
hashpow”
)] = 
™
;

171 
	`±h»ad_mu‹x_lock
(&
hash_™ems_couÁ”_lock
);

172 
hash_™ems
++;

173 ià(! 
ex·ndšg
 && 
hash_™ems
 > (
	`hashsize
(
hashpow”
) * 3) / 2) {

174 
	`assoc_¡¬t_ex·nd
();

176 
	`±h»ad_mu‹x_uÆock
(&
hash_™ems_couÁ”_lock
);

178 
	`MEMCACHED_ASSOC_INSERT
(
	`ITEM_key
(
™
), it->
nkey
, 
hash_™ems
);

180 
	}
}

182 
	$assoc_d–‘e
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
ušt32_t
 
hv
) {

183 
™em
 **
befÜe
 = 
	`_hash™em_befÜe
(
key
, 
nkey
, 
hv
);

185 ià(*
befÜe
) {

186 
™em
 *
nxt
;

187 
	`±h»ad_mu‹x_lock
(&
hash_™ems_couÁ”_lock
);

188 
hash_™ems
--;

189 
	`±h»ad_mu‹x_uÆock
(&
hash_™ems_couÁ”_lock
);

193 
	`MEMCACHED_ASSOC_DELETE
(
key
, 
nkey
, 
hash_™ems
);

194 
nxt
 = (*
befÜe
)->
h_Ãxt
;

195 (*
befÜe
)->
h_Ãxt
 = 0;

196 *
befÜe
 = 
nxt
;

201 
	`as£¹
(*
befÜe
 != 0);

202 
	}
}

205 vŞ©
	gdo_run_maš‹Çnû_th»ad
 = 1;

207 
	#DEFAULT_HASH_BULK_MOVE
 1

	)

208 
	ghash_bulk_move
 = 
DEFAULT_HASH_BULK_MOVE
;

210 *
	$assoc_maš‹Çnû_th»ad
(*
¬g
) {

212 
	`mu‹x_lock
(&
maš‹Çnû_lock
);

213 
do_run_maš‹Çnû_th»ad
) {

214 
ii
 = 0;

217 
ii
 = 0; i˜< 
hash_bulk_move
 && 
ex·ndšg
; ++ii) {

218 
™em
 *
™
, *
Ãxt
;

219 
buck‘
;

220 *
™em_lock
 = 
NULL
;

226 ià((
™em_lock
 = 
	`™em_Œylock
(
ex·nd_buck‘
))) {

227 
™
 = 
Şd_hashbË
[
ex·nd_buck‘
]; 
NULL
 !ğ™; iˆğ
Ãxt
) {

228 
Ãxt
 = 
™
->
h_Ãxt
;

229 
buck‘
 = 
	`hash
(
	`ITEM_key
(
™
), it->
nkey
è& 
	`hashmask
(
hashpow”
);

230 
™
->
h_Ãxt
 = 
´im¬y_hashbË
[
buck‘
];

231 
´im¬y_hashbË
[
buck‘
] = 
™
;

234 
Şd_hashbË
[
ex·nd_buck‘
] = 
NULL
;

236 
ex·nd_buck‘
++;

237 ià(
ex·nd_buck‘
 =ğ
	`hashsize
(
hashpow”
 - 1)) {

238 
ex·ndšg
 = 
çl£
;

239 
	`ä“
(
Şd_hashbË
);

240 
	`STATS_LOCK
();

241 
¡©s_¡©e
.
hash_by‹s
 -ğ
	`hashsize
(
hashpow”
 - 1) * (*);

242 
¡©s_¡©e
.
hash_is_ex·ndšg
 = 
çl£
;

243 
	`STATS_UNLOCK
();

244 ià(
£‰šgs
.
v”bo£
 > 1)

245 
	`årštf
(
¡d”r
, "Hashableƒxpansion done\n");

249 
	`u¦“p
(10*1000);

252 ià(
™em_lock
) {

253 
	`™em_Œylock_uÆock
(
™em_lock
);

254 
™em_lock
 = 
NULL
;

258 ià(!
ex·ndšg
) {

260 
¡¬‹d_ex·ndšg
 = 
çl£
;

261 
	`±h»ad_cÚd_wa™
(&
maš‹Çnû_cÚd
, &
maš‹Çnû_lock
);

269 
	`·u£_th»ads
(
PAUSE_ALL_THREADS
);

270 
	`assoc_ex·nd
();

271 
	`·u£_th»ads
(
RESUME_ALL_THREADS
);

274  
NULL
;

275 
	}
}

277 
±h»ad_t
 
	gmaš‹Çnû_tid
;

279 
	$¡¬t_assoc_maš‹Çnû_th»ad
() {

280 
»t
;

281 *
’v
 = 
	`g‘’v
("MEMCACHED_HASH_BULK_MOVE");

282 ià(
’v
 !ğ
NULL
) {

283 
hash_bulk_move
 = 
	`©oi
(
’v
);

284 ià(
hash_bulk_move
 == 0) {

285 
hash_bulk_move
 = 
DEFAULT_HASH_BULK_MOVE
;

288 
	`±h»ad_mu‹x_š™
(&
maš‹Çnû_lock
, 
NULL
);

289 ià((
»t
 = 
	`±h»ad_ü—‹
(&
maš‹Çnû_tid
, 
NULL
,

290 
assoc_maš‹Çnû_th»ad
, 
NULL
)) != 0) {

291 
	`årštf
(
¡d”r
, "Cª'ˆü—‹h»ad: %s\n", 
	`¡»¼Ü
(
»t
));

295 
	}
}

297 
	$¡İ_assoc_maš‹Çnû_th»ad
() {

298 
	`mu‹x_lock
(&
maš‹Çnû_lock
);

299 
do_run_maš‹Çnû_th»ad
 = 0;

300 
	`±h»ad_cÚd_sigÇl
(&
maš‹Çnû_cÚd
);

301 
	`mu‹x_uÆock
(&
maš‹Çnû_lock
);

304 
	`±h»ad_još
(
maš‹Çnû_tid
, 
NULL
);

305 
	}
}

	@assoc.h

2 
assoc_š™
(cÚ¡ 
hashpow”_š™
);

3 
™em
 *
assoc_fšd
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
ušt32_t
 
hv
);

4 
assoc_š£¹
(
™em
 *™em, cÚ¡ 
ušt32_t
 
hv
);

5 
assoc_d–‘e
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
ušt32_t
 
hv
);

6 
do_assoc_move_Ãxt_buck‘
();

7 
¡¬t_assoc_maš‹Çnû_th»ad
();

8 
¡İ_assoc_maš‹Çnû_th»ad
();

9 
hashpow”
;

10 
™em_lock_hashpow”
;

	@bipbuffer.c

10 
	~"¡dio.h
"

11 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

16 
	~"bbufãr.h
"

18 
size_t
 
	$bbuf_sizeof
(cÚ¡ 
size
)

20  (
bbuf_t
è+ 
size
;

21 
	}
}

23 
	$bbuf_unu£d
(cÚ¡ 
bbuf_t
* 
me
)

25 ià(1 =ğ
me
->
b_šu£
)

27  
me
->
a_¡¬t
 - me->
b_’d
;

29  
me
->
size
 - me->
a_’d
;

30 
	}
}

32 
	$bbuf_size
(cÚ¡ 
bbuf_t
* 
me
)

34  
me
->
size
;

35 
	}
}

37 
	$bbuf_u£d
(cÚ¡ 
bbuf_t
* 
me
)

39  (
me
->
a_’d
 - me->
a_¡¬t
è+ me->
b_’d
;

40 
	}
}

42 
	$bbuf_š™
(
bbuf_t
* 
me
, cÚ¡ 
size
)

44 
me
->
a_¡¬t
 = me->
a_’d
 = me->
b_’d
 = 0;

45 
me
->
size
 = size;

46 
me
->
b_šu£
 = 0;

47 
	}
}

49 
bbuf_t
 *
	$bbuf_Ãw
(cÚ¡ 
size
)

51 
bbuf_t
 *
me
 = 
	`m®loc
(
	`bbuf_sizeof
(
size
));

52 ià(!
me
)

53  
NULL
;

54 
	`bbuf_š™
(
me
, 
size
);

55  
me
;

56 
	}
}

58 
	$bbuf_ä“
(
bbuf_t
* 
me
)

60 
	`ä“
(
me
);

61 
	}
}

63 
	$bbuf_is_em±y
(cÚ¡ 
bbuf_t
* 
me
)

65  
me
->
a_¡¬t
 =ğme->
a_’d
;

66 
	}
}

70 
	$__check_fÜ_sw™ch_to_b
(
bbuf_t
* 
me
)

72 ià(
me
->
size
 - me->
a_’d
 < me->
a_¡¬t
 - me->
b_’d
)

73 
me
->
b_šu£
 = 1;

74 
	}
}

77 *
	$bbuf_»que¡
(
bbuf_t
* 
me
, cÚ¡ 
size
)

79 ià(
	`bbuf_unu£d
(
me
è< 
size
)

81 ià(1 =ğ
me
->
b_šu£
)

83  (*)
me
->
d©a
 + me->
b_’d
;

87  (*)
me
->
d©a
 + me->
a_’d
;

89 
	}
}

91 
	$bbuf_push
(
bbuf_t
* 
me
, cÚ¡ 
size
)

93 ià(
	`bbuf_unu£d
(
me
è< 
size
)

96 ià(1 =ğ
me
->
b_šu£
)

98 
me
->
b_’d
 +ğ
size
;

102 
me
->
a_’d
 +ğ
size
;

105 
	`__check_fÜ_sw™ch_to_b
(
me
);

106  
size
;

107 
	}
}

109 
	$bbuf_ofãr
(
bbuf_t
* 
me
, cÚ¡ *
d©a
, cÚ¡ 
size
)

112 ià(
	`bbuf_unu£d
(
me
è< 
size
)

115 ià(1 =ğ
me
->
b_šu£
)

117 
	`memıy
(
me
->
d©a
 + me->
b_’d
, d©a, 
size
);

118 
me
->
b_’d
 +ğ
size
;

122 
	`memıy
(
me
->
d©a
 + me->
a_’d
, d©a, 
size
);

123 
me
->
a_’d
 +ğ
size
;

126 
	`__check_fÜ_sw™ch_to_b
(
me
);

127  
size
;

128 
	}
}

130 *
	$bbuf_³ek
(cÚ¡ 
bbuf_t
* 
me
, cÚ¡ 
size
)

133 ià(
me
->
size
 < me->
a_¡¬t
 + size)

134  
NULL
;

136 ià(
	`bbuf_is_em±y
(
me
))

137  
NULL
;

139  (*)
me
->
d©a
 + me->
a_¡¬t
;

140 
	}
}

142 *
	$bbuf_³ek_®l
(cÚ¡ 
bbuf_t
* 
me
, *
size
)

144 ià(
	`bbuf_is_em±y
(
me
))

145  
NULL
;

147 *
size
 = 
me
->
a_’d
 - me->
a_¡¬t
;

148  (*)
me
->
d©a
 + me->
a_¡¬t
;

149 
	}
}

151 *
	$bbuf_pŞl
(
bbuf_t
* 
me
, cÚ¡ 
size
)

153 ià(
	`bbuf_is_em±y
(
me
))

154  
NULL
;

157 ià(
me
->
size
 < me->
a_¡¬t
 + size)

158  
NULL
;

160 *
’d
 = 
me
->
d©a
 + me->
a_¡¬t
;

161 
me
->
a_¡¬t
 +ğ
size
;

164 ià(
me
->
a_¡¬t
 =ğme->
a_’d
)

167 ià(1 =ğ
me
->
b_šu£
)

169 
me
->
a_¡¬t
 = 0;

170 
me
->
a_’d
 = me->
b_’d
;

171 
me
->
b_’d
 = me->
b_šu£
 = 0;

175 
me
->
a_¡¬t
 = me->
a_’d
 = 0;

178 
	`__check_fÜ_sw™ch_to_b
(
me
);

179  
’d
;

180 
	}
}

	@bipbuffer.h

1 #iâdeà
BIPBUFFER_H


2 
	#BIPBUFFER_H


	)

6 
	msize
;

9 
	ma_¡¬t
, 
	ma_’d
;

12 
	mb_’d
;

15 
	mb_šu£
;

17 
	md©a
[];

18 } 
	tbbuf_t
;

26 
bbuf_t
 *
bbuf_Ãw
(cÚ¡ 
size
);

34 
bbuf_š™
(
bbuf_t
* 
me
, cÚ¡ 
size
);

38 
bbuf_ä“
(
bbuf_t
 *
me
);

41 *
bbuf_»que¡
(
bbuf_t
* 
me
, cÚ¡ 
size
);

42 
bbuf_push
(
bbuf_t
* 
me
, cÚ¡ 
size
);

48 
bbuf_ofãr
(
bbuf_t
 *
me
, cÚ¡ *
d©a
, cÚ¡ 
size
);

55 *
bbuf_³ek
(cÚ¡ 
bbuf_t
* 
me
, cÚ¡ 
Ën
);

62 *
bbuf_³ek_®l
(cÚ¡ 
bbuf_t
* 
me
, *
Ën
);

69 *
bbuf_pŞl
(
bbuf_t
* 
me
, cÚ¡ 
size
);

73 
bbuf_size
(cÚ¡ 
bbuf_t
* 
me
);

77 
bbuf_is_em±y
(cÚ¡ 
bbuf_t
* 
me
);

81 
bbuf_u£d
(cÚ¡ 
bbuf_t
* 
cb
);

85 
bbuf_unu£d
(cÚ¡ 
bbuf_t
* 
me
);

	@cache.c

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<š‰y³s.h
>

6 #iâdeà
NDEBUG


7 
	~<sigÇl.h
>

10 
	~"ÿche.h
"

12 #iâdeà
NDEBUG


13 cÚ¡ 
ušt64_t
 
	g»dzÚe_·‰”n
 = 0xdeadbeefcafebabe;

14 
	gÿche_”rÜ
 = 0;

17 cÚ¡ 
	gš™Ÿl_poŞ_size
 = 64;

19 
ÿche_t
* 
	$ÿche_ü—‹
(cÚ¡ *
Çme
, 
size_t
 
bufsize
, size_ˆ
®ign
,

20 
ÿche_cÚ¡ruùÜ_t
* 
cÚ¡ruùÜ
,

21 
ÿche_de¡ruùÜ_t
* 
de¡ruùÜ
) {

22 
ÿche_t
* 
»t
 = 
	`ÿÎoc
(1, (cache_t));

23 * 
nm
 = 
	`¡rdup
(
Çme
);

24 ** 
±r
 = 
	`ÿÎoc
(
š™Ÿl_poŞ_size
, (*));

25 ià(
»t
 =ğ
NULL
 || 
nm
 =ğNULL || 
±r
 == NULL ||

26 
	`±h»ad_mu‹x_š™
(&
»t
->
mu‹x
, 
NULL
) == -1) {

27 
	`ä“
(
»t
);

28 
	`ä“
(
nm
);

29 
	`ä“
(
±r
);

30  
NULL
;

33 
»t
->
Çme
 = 
nm
;

34 
»t
->
±r
 =…tr;

35 
»t
->
ä“tÙ®
 = 
š™Ÿl_poŞ_size
;

36 
»t
->
cÚ¡ruùÜ
 = constructor;

37 
»t
->
de¡ruùÜ
 = destructor;

39 #iâdeà
NDEBUG


40 
»t
->
bufsize
 = bufsiz+ 2 * (
»dzÚe_·‰”n
);

42 
»t
->
bufsize
 = bufsize;

45  
»t
;

46 
	}
}

48 
šlše
 * 
	$g‘_objeù
(*
±r
) {

49 #iâdeà
NDEBUG


50 
ušt64_t
 *
´e
 = 
±r
;

51  
´e
 + 1;

53  
±r
;

55 
	}
}

57 
	$ÿche_de¡roy
(
ÿche_t
 *
ÿche
) {

58 
ÿche
->
ä“cu¼
 > 0) {

59 *
±r
 = 
ÿche
->±r[--ÿche->
ä“cu¼
];

60 ià(
ÿche
->
de¡ruùÜ
) {

61 
ÿche
->
	`de¡ruùÜ
(
	`g‘_objeù
(
±r
), 
NULL
);

63 
	`ä“
(
±r
);

65 
	`ä“
(
ÿche
->
Çme
);

66 
	`ä“
(
ÿche
->
±r
);

67 
	`±h»ad_mu‹x_de¡roy
(&
ÿche
->
mu‹x
);

68 
	`ä“
(
ÿche
);

69 
	}
}

71 * 
	$ÿche_®loc
(
ÿche_t
 *
ÿche
) {

72 *
»t
;

73 *
objeù
;

74 
	`±h»ad_mu‹x_lock
(&
ÿche
->
mu‹x
);

75 ià(
ÿche
->
ä“cu¼
 > 0) {

76 
»t
 = 
ÿche
->
±r
[--ÿche->
ä“cu¼
];

77 
objeù
 = 
	`g‘_objeù
(
»t
);

79 
objeù
 = 
»t
 = 
	`m®loc
(
ÿche
->
bufsize
);

80 ià(
»t
 !ğ
NULL
) {

81 
objeù
 = 
	`g‘_objeù
(
»t
);

83 ià(
ÿche
->
cÚ¡ruùÜ
 !ğ
NULL
 &&

84 
ÿche
->
	`cÚ¡ruùÜ
(
objeù
, 
NULL
, 0) != 0) {

85 
	`ä“
(
»t
);

86 
objeù
 = 
NULL
;

90 
	`±h»ad_mu‹x_uÆock
(&
ÿche
->
mu‹x
);

92 #iâdeà
NDEBUG


93 ià(
objeù
 !ğ
NULL
) {

95 
ušt64_t
 *
´e
 = 
»t
;

96 *
´e
 = 
»dzÚe_·‰”n
;

97 
»t
 = 
´e
+1;

98 
	`memıy
(((*)
»t
è+ 
ÿche
->
bufsize
 - (2 * (
»dzÚe_·‰”n
)),

99 &
»dzÚe_·‰”n
, (redzone_pattern));

103  
objeù
;

104 
	}
}

106 
	$ÿche_ä“
(
ÿche_t
 *
ÿche
, *
±r
) {

107 
	`±h»ad_mu‹x_lock
(&
ÿche
->
mu‹x
);

109 #iâdeà
NDEBUG


111 ià(
	`memcmp
(((*)
±r
è+ 
ÿche
->
bufsize
 - (2 * (
»dzÚe_·‰”n
)),

112 &
»dzÚe_·‰”n
, (redzone_pattern)) != 0) {

113 
	`¿i£
(
SIGABRT
);

114 
ÿche_”rÜ
 = 1;

115 
	`±h»ad_mu‹x_uÆock
(&
ÿche
->
mu‹x
);

118 
ušt64_t
 *
´e
 = 
±r
;

119 --
´e
;

120 ià(*
´e
 !ğ
»dzÚe_·‰”n
) {

121 
	`¿i£
(
SIGABRT
);

122 
ÿche_”rÜ
 = -1;

123 
	`±h»ad_mu‹x_uÆock
(&
ÿche
->
mu‹x
);

126 
±r
 = 
´e
;

128 ià(
ÿche
->
ä“cu¼
 < cache->
ä“tÙ®
) {

129 
ÿche
->
±r
[ÿche->
ä“cu¼
++] =…tr;

132 
size_t
 
ÃwtÙ®
 = 
ÿche
->
ä“tÙ®
 * 2;

133 **
Ãw_ä“
 = 
	`»®loc
(
ÿche
->
±r
, (*è* 
ÃwtÙ®
);

134 ià(
Ãw_ä“
) {

135 
ÿche
->
ä“tÙ®
 = 
ÃwtÙ®
;

136 
ÿche
->
±r
 = 
Ãw_ä“
;

137 
ÿche
->
±r
[ÿche->
ä“cu¼
++] =…tr;

139 ià(
ÿche
->
de¡ruùÜ
) {

140 
ÿche
->
	`de¡ruùÜ
(
±r
, 
NULL
);

142 
	`ä“
(
±r
);

146 
	`±h»ad_mu‹x_uÆock
(&
ÿche
->
mu‹x
);

147 
	}
}

	@cache.h

2 #iâdeà
CACHE_H


3 
	#CACHE_H


	)

4 
	~<±h»ad.h
>

6 #ifdeà
HAVE_UMEM_H


7 
	~<umem.h
>

8 
	#ÿche_t
 
umem_ÿche_t


	)

9 
	#ÿche_®loc
(
a
è
	`umem_ÿche_®loc
×, 
UMEM_DEFAULT
)

	)

10 
	#ÿche_ä“
(
a
, 
b
è
	`umem_ÿche_ä“
×, b)

	)

11 
	#ÿche_ü—‹
(
a
,
b
,
c
,
d
,
e
è
	`umem_ÿche_ü—‹
((*ï, b, c, d,ƒ, 
NULL
, NULL, NULL, 0)

	)

12 
	#ÿche_de¡roy
(
a
è
	`umem_ÿche_de¡roy
×);

	)

16 #iâdeà
NDEBUG


18 
ÿche_”rÜ
;

29 
	tÿche_cÚ¡ruùÜ_t
(* 
	tobj
, * 
	tnÙu£d1
, 
	tnÙu£d2
);

39 
	tÿche_de¡ruùÜ_t
(* 
	tobj
, * 
	tnÙu£d
);

48 
±h»ad_mu‹x_t
 
	mmu‹x
;

50 *
	mÇme
;

52 **
	m±r
;

54 
size_t
 
	mbufsize
;

56 
	mä“tÙ®
;

58 
	mä“cu¼
;

60 
ÿche_cÚ¡ruùÜ_t
* 
	mcÚ¡ruùÜ
;

62 
ÿche_de¡ruùÜ_t
* 
	mde¡ruùÜ
;

63 } 
	tÿche_t
;

83 
ÿche_t
* 
ÿche_ü—‹
(cÚ¡ * 
Çme
, 
size_t
 
bufsize
, size_ˆ
®ign
,

84 
ÿche_cÚ¡ruùÜ_t
* 
cÚ¡ruùÜ
,

85 
ÿche_de¡ruùÜ_t
* 
de¡ruùÜ
);

95 
ÿche_de¡roy
(
ÿche_t
* 
hªdË
);

103 * 
ÿche_®loc
(
ÿche_t
* 
hªdË
);

113 
ÿche_ä“
(
ÿche_t
* 
hªdË
, * 
±r
);

	@crawler.c

8 
	~"memÿched.h
"

9 
	~<sys/¡©.h
>

10 
	~<sys/sock‘.h
>

11 
	~<sys/»sourû.h
>

12 
	~<fú.h
>

13 
	~<Ãtš‘/š.h
>

14 
	~<”ºo.h
>

15 
	~<¡dlib.h
>

16 
	~<¡dio.h
>

17 
	~<sigÇl.h
>

18 
	~<¡ršg.h
>

19 
	~<time.h
>

20 
	~<as£¹.h
>

21 
	~<uni¡d.h
>

22 
	~<pŞl.h
>

24 
	#LARGEST_ID
 
POWER_LARGEST


	)

27 *
	mc
;

28 
	msfd
;

29 
bbuf_t
 *
	mbuf
;

30 *
	mcbuf
;

31 } 
	tüawËr_ş›Á_t
;

33 
_üawËr_moduË_t
 
	tüawËr_moduË_t
;

35 (*
	tüawËr_ev®_func
)(
	tüawËr_moduË_t
 *
	tcm
, 
	t™em
 *
	t™
, 
	tušt32_t
 
	thv
, 
	t¦ab_şs
);

36 (*
	tüawËr_š™_func
)(
	tüawËr_moduË_t
 *
	tcm
, *
	td©a
);

37 (*
	tüawËr_deš™_func
)(
	tüawËr_moduË_t
 *
	tcm
);

38 (*
	tüawËr_dÚeşass_func
)(
	tüawËr_moduË_t
 *
	tcm
, 
	t¦ab_şs
);

39 (*
	tüawËr_fš®ize_func
)(
	tüawËr_moduË_t
 *
	tcm
);

42 
üawËr_š™_func
 
š™
;

43 
üawËr_ev®_func
 
ev®
;

44 
üawËr_dÚeşass_func
 
dÚeşass
;

45 
üawËr_fš®ize_func
 
fš®ize
;

46 
boŞ
 
Ãeds_lock
;

47 
boŞ
 
Ãeds_ş›Á
;

48 } 
	tüawËr_moduË_»g_t
;

50 
	s_üawËr_moduË_t
 {

51 *
d©a
;

52 
üawËr_ş›Á_t
 
c
;

53 
üawËr_moduË_»g_t
 *
mod
;

56 
	`üawËr_expœed_š™
(
üawËr_moduË_t
 *
cm
, *
d©a
);

57 
	`üawËr_expœed_dÚeşass
(
üawËr_moduË_t
 *
cm
, 
¦ab_şs
);

58 
	`üawËr_expœed_fš®ize
(
üawËr_moduË_t
 *
cm
);

59 
	`üawËr_expœed_ev®
(
üawËr_moduË_t
 *
cm
, 
™em
 *
£¬ch
, 
ušt32_t
 
hv
, 
i
);

61 
üawËr_moduË_»g_t
 
üawËr_expœed_mod
 = {

62 .
š™
 = 
üawËr_expœed_š™
,

63 .
ev®
 = 
üawËr_expœed_ev®
,

64 .
dÚeşass
 = 
üawËr_expœed_dÚeşass
,

65 .
fš®ize
 = 
üawËr_expœed_fš®ize
,

66 .
Ãeds_lock
 = 
Œue
,

67 .
Ãeds_ş›Á
 = 
çl£


68 
	}
};

70 
üawËr_m‘adump_ev®
(
üawËr_moduË_t
 *
cm
, 
™em
 *
£¬ch
, 
ušt32_t
 
hv
, 
i
);

72 
üawËr_moduË_»g_t
 
	güawËr_m‘adump_mod
 = {

73 .
š™
 = 
NULL
,

74 .
	gev®
 = 
üawËr_m‘adump_ev®
,

75 .
	gdÚeşass
 = 
NULL
,

76 .
	gfš®ize
 = 
NULL
,

77 .
	gÃeds_lock
 = 
çl£
,

78 .
	gÃeds_ş›Á
 = 
Œue


81 
üawËr_moduË_»g_t
 *
	güawËr_mod_»gs
[2] = {

82 &
üawËr_expœed_mod
,

83 &
üawËr_m‘adump_mod


86 
üawËr_moduË_t
 
	gaùive_üawËr_mod
;

88 
üawËr
 
	güawËrs
[
LARGEST_ID
];

90 
	güawËr_couÁ
 = 0;

91 vŞ©
	gdo_run_Ìu_üawËr_th»ad
 = 0;

92 
	gÌu_üawËr_š™Ÿlized
 = 0;

93 
±h»ad_mu‹x_t
 
	gÌu_üawËr_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

94 
±h»ad_cÚd_t
 
	gÌu_üawËr_cÚd
 = 
PTHREAD_COND_INITIALIZER
;

97 
	#MAX_MAINTCRAWL_WAIT
 60 * 60

	)

101 
	#LRU_CRAWLER_WRITEBUF
 8192

	)

103 
	$Ìu_üawËr_şo£_ş›Á
(
üawËr_ş›Á_t
 *
c
) {

105 
	`sid‘h»ad_cÚn_şo£
(
c
->c);

106 
c
->øğ
NULL
;

107 
c
->
cbuf
 = 
NULL
;

108 
	`bbuf_ä“
(
c
->
buf
);

109 
c
->
buf
 = 
NULL
;

110 
	}
}

112 
	$Ìu_üawËr_»Ëa£_ş›Á
(
üawËr_ş›Á_t
 *
c
) {

114 
	`»di¥©ch_cÚn
(
c
->c);

115 
c
->øğ
NULL
;

116 
c
->
cbuf
 = 
NULL
;

117 
	`bbuf_ä“
(
c
->
buf
);

118 
c
->
buf
 = 
NULL
;

119 
	}
}

121 
	$üawËr_expœed_š™
(
üawËr_moduË_t
 *
cm
, *
d©a
) {

122 
üawËr_expœed_d©a
 *
d
;

123 ià(
d©a
 !ğ
NULL
) {

124 
d
 = 
d©a
;

125 
d
->
is_ex‹º®
 = 
Œue
;

126 
cm
->
d©a
 = data;

129 
d
 = 
	`ÿÎoc
(1, (
üawËr_expœed_d©a
));

130 ià(
d
 =ğ
NULL
) {

134 
	`±h»ad_mu‹x_š™
(&
d
->
lock
, 
NULL
);

135 
d
->
is_ex‹º®
 = 
çl£
;

136 
d
->
¡¬t_time
 = 
cu¼’t_time
;

138 
cm
->
d©a
 = 
d
;

140 
	`±h»ad_mu‹x_lock
(&
d
->
lock
);

141 
	`mem£t
(&
d
->
üawËr¡©s
, 0, (
üawËr¡©s_t
è* 
MAX_NUMBER_OF_SLAB_CLASSES
);

142 
x
 = 0; x < 
MAX_NUMBER_OF_SLAB_CLASSES
; x++) {

143 
d
->
üawËr¡©s
[
x
].
¡¬t_time
 = 
cu¼’t_time
;

144 
d
->
üawËr¡©s
[
x
].
run_com¶‘e
 = 
çl£
;

146 
	`±h»ad_mu‹x_uÆock
(&
d
->
lock
);

148 
	}
}

150 
	$üawËr_expœed_dÚeşass
(
üawËr_moduË_t
 *
cm
, 
¦ab_şs
) {

151 
üawËr_expœed_d©a
 *
d
 = (üawËr_expœed_d©¨*è
cm
->
d©a
;

152 
	`±h»ad_mu‹x_lock
(&
d
->
lock
);

153 
d
->
üawËr¡©s
[
	`CLEAR_LRU
(
¦ab_şs
)].
’d_time
 = 
cu¼’t_time
;

154 
d
->
üawËr¡©s
[
	`CLEAR_LRU
(
¦ab_şs
)].
run_com¶‘e
 = 
Œue
;

155 
	`±h»ad_mu‹x_uÆock
(&
d
->
lock
);

156 
	}
}

158 
	$üawËr_expœed_fš®ize
(
üawËr_moduË_t
 *
cm
) {

159 
üawËr_expœed_d©a
 *
d
 = (üawËr_expœed_d©¨*è
cm
->
d©a
;

160 
	`±h»ad_mu‹x_lock
(&
d
->
lock
);

161 
d
->
’d_time
 = 
cu¼’t_time
;

162 
d
->
üawl_com¶‘e
 = 
Œue
;

163 
	`±h»ad_mu‹x_uÆock
(&
d
->
lock
);

165 ià(!
d
->
is_ex‹º®
) {

166 
	`ä“
(
d
);

168 
	}
}

173 
	$üawËr_expœed_ev®
(
üawËr_moduË_t
 *
cm
, 
™em
 *
£¬ch
, 
ušt32_t
 
hv
, 
i
) {

174 
¦ab_id
 = 
	`CLEAR_LRU
(
i
);

175 
üawËr_expœed_d©a
 *
d
 = (üawËr_expœed_d©¨*è
cm
->
d©a
;

176 
	`±h»ad_mu‹x_lock
(&
d
->
lock
);

177 
üawËr¡©s_t
 *
s
 = &
d
->
üawËr¡©s
[
¦ab_id
];

178 
is_æushed
 = 
	`™em_is_æushed
(
£¬ch
);

179 ià((
£¬ch
->
ex±ime
 !ğ0 && s—rch->ex±im< 
cu¼’t_time
)

180 || 
is_æushed
) {

181 
üawËrs
[
i
].
»şaimed
++;

182 
s
->
»şaimed
++;

184 ià(
£‰šgs
.
v”bo£
 > 1) {

185 
ii
;

186 *
key
 = 
	`ITEM_key
(
£¬ch
);

187 
	`årštf
(
¡d”r
, "LRU crawler found‡nƒxpired item (flags: %d, slab: %d): ",

188 
£¬ch
->
™_æags
, s—rch->
¦abs_şsid
);

189 
ii
 = 0; i˜< 
£¬ch
->
nkey
; ++ii) {

190 
	`årštf
(
¡d”r
, "%c", 
key
[
ii
]);

192 
	`årštf
(
¡d”r
, "\n");

194 ià((
£¬ch
->
™_æags
 & 
ITEM_FETCHED
è=ğ0 && !
is_æushed
) {

195 
üawËrs
[
i
].
unãtched
++;

197 
	`do_™em_uÆšk_nŞock
(
£¬ch
, 
hv
);

198 
	`do_™em_»move
(
£¬ch
);

199 
	`as£¹
(
£¬ch
->
¦abs_şsid
 == 0);

201 
s
->
£’
++;

202 
	`»fcouÁ_deü
(&
£¬ch
->
»fcouÁ
);

203 ià(
£¬ch
->
ex±ime
 == 0) {

204 
s
->
nÛxp
++;

205 } ià(
£¬ch
->
ex±ime
 - 
cu¼’t_time
 > 3599) {

206 
s
->
‰l_hou½lus
++;

208 
»l_time_t
 
‰l_»maš
 = 
£¬ch
->
ex±ime
 - 
cu¼’t_time
;

209 
buck‘
 = 
‰l_»maš
 / 60;

210 
s
->
hi¡o
[
buck‘
]++;

213 
	`±h»ad_mu‹x_uÆock
(&
d
->
lock
);

214 
	}
}

216 
	$üawËr_m‘adump_ev®
(
üawËr_moduË_t
 *
cm
, 
™em
 *
™
, 
ušt32_t
 
hv
, 
i
) {

218 
keybuf
[
KEY_MAX_LENGTH
 * 3 + 1];

219 
is_æushed
 = 
	`™em_is_æushed
(
™
);

221 ià((
™
->
ex±ime
 !ğ0 && it->ex±im< 
cu¼’t_time
)

222 || 
is_æushed
) {

223 
	`»fcouÁ_deü
(&
™
->
»fcouÁ
);

227 
	`ur›ncode
(
	`ITEM_key
(
™
), 
keybuf
, it->
nkey
, 
KEY_MAX_LENGTH
 * 3 + 1);

228 
tÙ®
 = 
	`¢´štf
(
cm
->
c
.
cbuf
, 4096,

230 
keybuf
,

231 (
™
->
ex±ime
 =ğ0è? -1 : ()™->ex±im+ 
´oûss_¡¬‹d
,

232 ()
™
->
time
 + 
´oûss_¡¬‹d
,

233 ()
	`ITEM_g‘_ÿs
(
™
),

234 (
™
->
™_æags
 & 
ITEM_FETCHED
) ? "yes" : "no");

235 
	`»fcouÁ_deü
(&
™
->
»fcouÁ
);

237 ià(
tÙ®
 >ğ
LRU_CRAWLER_WRITEBUF
 - 1 ||otal <= 0) {

241 
	`bbuf_push
(
cm
->
c
.
buf
, 
tÙ®
);

242 
	}
}

244 
	$Ìu_üawËr_pŞl
(
üawËr_ş›Á_t
 *
c
) {

245 *
d©a
;

246 
d©a_size
 = 0;

247 
pŞlfd
 
to_pŞl
[1];

248 
to_pŞl
[0].
fd
 = 
c
->
sfd
;

249 
to_pŞl
[0].
ev’ts
 = 
POLLOUT
;

251 
»t
 = 
	`pŞl
(
to_pŞl
, 1, 1000);

253 ià(
»t
 < 0) {

258 ià(
»t
 == 0)  0;

260 ià(
to_pŞl
[0].
»v’ts
 & 
POLLIN
) {

261 
buf
[1];

262 
»s
 = 
	`»ad
(
c
->
sfd
, 
buf
, 1);

263 ià(
»s
 =ğ0 || (» =ğ-1 && (
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EWOULDBLOCK
))) {

264 
	`Ìu_üawËr_şo£_ş›Á
(
c
);

268 ià((
d©a
 = 
	`bbuf_³ek_®l
(
c
->
buf
, &
d©a_size
)è!ğ
NULL
) {

269 ià(
to_pŞl
[0].
»v’ts
 & (
POLLHUP
|
POLLERR
)) {

270 
	`Ìu_üawËr_şo£_ş›Á
(
c
);

272 } ià(
to_pŞl
[0].
»v’ts
 & 
POLLOUT
) {

273 
tÙ®
 = 
	`wr™e
(
c
->
sfd
, 
d©a
, 
d©a_size
);

274 ià(
tÙ®
 == -1) {

275 ià(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EWOULDBLOCK
) {

276 
	`Ìu_üawËr_şo£_ş›Á
(
c
);

279 } ià(
tÙ®
 == 0) {

280 
	`Ìu_üawËr_şo£_ş›Á
(
c
);

283 
	`bbuf_pŞl
(
c
->
buf
, 
tÙ®
);

288 
	}
}

294 
	$Ìu_üawËr_ş›Á_g‘buf
(
üawËr_ş›Á_t
 *
c
) {

295 *
buf
 = 
NULL
;

296 ià(
c
->ø=ğ
NULL
)  -1;

298 (
buf
 = 
	`bbuf_»que¡
(
c
->buf, 
LRU_CRAWLER_WRITEBUF
)è=ğ
NULL
) {

300 
»t
 = 
	`Ìu_üawËr_pŞl
(
c
);

301 ià(
»t
 < 0) „et;

304 
c
->
cbuf
 = 
buf
;

306 
	}
}

308 
	$Ìu_üawËr_şass_dÚe
(
i
) {

309 
üawËrs
[
i
].
™_æags
 = 0;

310 
üawËr_couÁ
--;

311 
	`do_™em_uÆšk_q
((
™em
 *)&
üawËrs
[
i
]);

312 
	`do_™em_¡©s_add_üawl
(
i
, 
üawËrs
[i].
»şaimed
,

313 
üawËrs
[
i
].
unãtched
, c¿wËrs[i].
checked
);

314 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
i
]);

315 ià(
aùive_üawËr_mod
.
mod
->
dÚeşass
 !ğ
NULL
)

316 
aùive_üawËr_mod
.
mod
->
	`dÚeşass
(&aùive_üawËr_mod, 
i
);

317 
	}
}

319 *
	$™em_üawËr_th»ad
(*
¬g
) {

320 
i
;

321 
üawls_³r¦“p
 = 
£‰šgs
.crawls_persleep;

323 
	`±h»ad_mu‹x_lock
(&
Ìu_üawËr_lock
);

324 
	`±h»ad_cÚd_sigÇl
(&
Ìu_üawËr_cÚd
);

325 
£‰šgs
.
Ìu_üawËr
 = 
Œue
;

326 ià(
£‰šgs
.
v”bo£
 > 2)

327 
	`årštf
(
¡d”r
, "Starting LRU crawler backgroundhread\n");

328 
do_run_Ìu_üawËr_th»ad
) {

329 
	`±h»ad_cÚd_wa™
(&
Ìu_üawËr_cÚd
, &
Ìu_üawËr_lock
);

331 
üawËr_couÁ
) {

332 
™em
 *
£¬ch
 = 
NULL
;

333 *
hŞd_lock
 = 
NULL
;

335 
i
 = 
POWER_SMALLEST
; i < 
LARGEST_ID
; i++) {

336 ià(
üawËrs
[
i
].
™_æags
 != 1) {

341 ià(
aùive_üawËr_mod
.
c
.ø!ğ
NULL
) {

342 
»t
 = 
	`Ìu_üawËr_ş›Á_g‘buf
(&
aùive_üawËr_mod
.
c
);

343 ià(
»t
 != 0) {

344 
	`Ìu_üawËr_şass_dÚe
(
i
);

347 } ià(
aùive_üawËr_mod
.
mod
->
Ãeds_ş›Á
) {

348 
	`Ìu_üawËr_şass_dÚe
(
i
);

351 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
i
]);

352 
£¬ch
 = 
	`do_™em_üawl_q
((
™em
 *)&
üawËrs
[
i
]);

353 ià(
£¬ch
 =ğ
NULL
 ||

354 (
üawËrs
[
i
].
»maššg
 && --crawlers[i].remaining < 1)) {

355 ià(
£‰šgs
.
v”bo£
 > 2)

356 
	`årštf
(
¡d”r
, "NÙhšg†eáØüawÈfÜ %d\n", 
i
);

357 
	`Ìu_üawËr_şass_dÚe
(
i
);

360 
ušt32_t
 
hv
 = 
	`hash
(
	`ITEM_key
(
£¬ch
), s—rch->
nkey
);

364 ià((
hŞd_lock
 = 
	`™em_Œylock
(
hv
)è=ğ
NULL
) {

365 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
i
]);

369 ià(
	`»fcouÁ_šü
(&
£¬ch
->
»fcouÁ
) != 2) {

370 
	`»fcouÁ_deü
(&
£¬ch
->
»fcouÁ
);

371 ià(
hŞd_lock
)

372 
	`™em_Œylock_uÆock
(
hŞd_lock
);

373 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
i
]);

377 
üawËrs
[
i
].
checked
++;

381 ià(!
aùive_üawËr_mod
.
mod
->
Ãeds_lock
) {

382 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
i
]);

385 
aùive_üawËr_mod
.
mod
->
	`ev®
(&aùive_üawËr_mod, 
£¬ch
, 
hv
, 
i
);

387 ià(
hŞd_lock
)

388 
	`™em_Œylock_uÆock
(
hŞd_lock
);

389 ià(
aùive_üawËr_mod
.
mod
->
Ãeds_lock
) {

390 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
i
]);

393 ià(
üawls_³r¦“p
-- <ğ0 && 
£‰šgs
.
Ìu_üawËr_¦“p
) {

394 
	`u¦“p
(
£‰šgs
.
Ìu_üawËr_¦“p
);

395 
üawls_³r¦“p
 = 
£‰šgs
.crawls_persleep;

400 ià(
aùive_üawËr_mod
.
mod
 !ğ
NULL
) {

401 ià(
aùive_üawËr_mod
.
mod
->
fš®ize
 !ğ
NULL
)

402 
aùive_üawËr_mod
.
mod
->
	`fš®ize
(&active_crawler_mod);

403 
aùive_üawËr_mod
.
c
.ø!ğ
NULL
 && 
	`bbuf_u£d
×ùive_üawËr_mod.c.
buf
)) {

404 
	`Ìu_üawËr_pŞl
(&
aùive_üawËr_mod
.
c
);

407 ià(
aùive_üawËr_mod
.
c
.ø!ğ
NULL
) {

408 
	`Ìu_üawËr_»Ëa£_ş›Á
(&
aùive_üawËr_mod
.
c
);

410 
aùive_üawËr_mod
.
mod
 = 
NULL
;

413 ià(
£‰šgs
.
v”bo£
 > 2)

414 
	`årštf
(
¡d”r
, "LRU crawlerhread sleeping\n");

415 
	`STATS_LOCK
();

416 
¡©s_¡©e
.
Ìu_üawËr_ruÂšg
 = 
çl£
;

417 
	`STATS_UNLOCK
();

419 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

420 ià(
£‰šgs
.
v”bo£
 > 2)

421 
	`årštf
(
¡d”r
, "LRU crawlerhread stopping\n");

423  
NULL
;

424 
	}
}

426 
±h»ad_t
 
	g™em_üawËr_tid
;

428 
	$¡İ_™em_üawËr_th»ad
() {

429 
»t
;

430 
	`±h»ad_mu‹x_lock
(&
Ìu_üawËr_lock
);

431 
do_run_Ìu_üawËr_th»ad
 = 0;

432 
	`±h»ad_cÚd_sigÇl
(&
Ìu_üawËr_cÚd
);

433 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

434 ià((
»t
 = 
	`±h»ad_još
(
™em_üawËr_tid
, 
NULL
)) != 0) {

435 
	`årštf
(
¡d”r
, "FaedØ¡İ LRU c¿wË¸th»ad: %s\n", 
	`¡»¼Ü
(
»t
));

438 
£‰šgs
.
Ìu_üawËr
 = 
çl£
;

440 
	}
}

453 
	$¡¬t_™em_üawËr_th»ad
() {

454 
»t
;

456 ià(
£‰šgs
.
Ìu_üawËr
)

458 
	`±h»ad_mu‹x_lock
(&
Ìu_üawËr_lock
);

459 
do_run_Ìu_üawËr_th»ad
 = 1;

460 ià((
»t
 = 
	`±h»ad_ü—‹
(&
™em_üawËr_tid
, 
NULL
,

461 
™em_üawËr_th»ad
, 
NULL
)) != 0) {

462 
	`årštf
(
¡d”r
, "Can't create LRU crawlerhread: %s\n",

463 
	`¡»¼Ü
(
»t
));

464 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

468 
	`±h»ad_cÚd_wa™
(&
Ìu_üawËr_cÚd
, &
Ìu_üawËr_lock
);

469 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

472 
	}
}

477 
	$do_Ìu_üawËr_¡¬t
(
ušt32_t
 
id
, ušt32_ˆ
»maššg
) {

478 
i
;

479 
ušt32_t
 
sid
;

480 
ušt32_t
 
toüawl
[3];

481 
¡¬ts
 = 0;

482 
toüawl
[0] = 
id
 | 
HOT_LRU
;

483 
toüawl
[1] = 
id
 | 
WARM_LRU
;

484 
toüawl
[2] = 
id
 | 
COLD_LRU
;

486 
i
 = 0; i < 3; i++) {

487 
sid
 = 
toüawl
[
i
];

488 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
sid
]);

491 ià(
£‰šgs
.
v”bo£
 > 2)

492 
	`årštf
(
¡d”r
, "Kickšg LRU c¿wË¸ofàfÜ LRU %u\n", 
sid
);

493 
üawËrs
[
sid
].
nby‹s
 = 0;

494 
üawËrs
[
sid
].
nkey
 = 0;

495 
üawËrs
[
sid
].
™_æags
 = 1;

496 
üawËrs
[
sid
].
Ãxt
 = 0;

497 
üawËrs
[
sid
].
´ev
 = 0;

498 
üawËrs
[
sid
].
time
 = 0;

499 
üawËrs
[
sid
].
»maššg
 =„emaining;

500 
üawËrs
[
sid
].
¦abs_şsid
 = sid;

501 
üawËrs
[
sid
].
»şaimed
 = 0;

502 
üawËrs
[
sid
].
unãtched
 = 0;

503 
üawËrs
[
sid
].
checked
 = 0;

504 
	`do_™em_lšk_q
((
™em
 *)&
üawËrs
[
sid
]);

505 
üawËr_couÁ
++;

506 
¡¬ts
++;

508 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
sid
]);

510 ià(
¡¬ts
) {

511 
	`STATS_LOCK
();

512 
¡©s_¡©e
.
Ìu_üawËr_ruÂšg
 = 
Œue
;

513 
¡©s
.
Ìu_üawËr_¡¬ts
++;

514 
	`STATS_UNLOCK
();

516  
¡¬ts
;

517 
	}
}

519 
	$Ìu_üawËr_£t_ş›Á
(
üawËr_moduË_t
 *
cm
, *
c
, cÚ¡ 
sfd
) {

520 
üawËr_ş›Á_t
 *
üawlc
 = &
cm
->
c
;

521 ià(
üawlc
->
c
 !ğ
NULL
) {

524 
üawlc
->
c
 = c;

525 
üawlc
->
sfd
 = sfd;

527 
üawlc
->
buf
 = 
	`bbuf_Ãw
(1024 * 128);

528 ià(
üawlc
->
buf
 =ğ
NULL
) {

532 
	}
}

534 
	$Ìu_üawËr_¡¬t
(
ušt8_t
 *
ids
, 
ušt32_t
 
»maššg
,

535 cÚ¡ 
üawËr_run_ty³
 
ty³
, *
d©a
,

536 *
c
, cÚ¡ 
sfd
) {

537 
¡¬ts
 = 0;

538 ià(
	`±h»ad_mu‹x_Œylock
(&
Ìu_üawËr_lock
) != 0) {

543 
	`as£¹
(
üawËr_mod_»gs
[
ty³
] !ğ
NULL
);

544 
aùive_üawËr_mod
.
mod
 = 
üawËr_mod_»gs
[
ty³
];

545 ià(
aùive_üawËr_mod
.
mod
->
š™
 !ğ
NULL
) {

546 
aùive_üawËr_mod
.
mod
->
	`š™
(&aùive_üawËr_mod, 
d©a
);

548 ià(
aùive_üawËr_mod
.
mod
->
Ãeds_ş›Á
) {

549 ià(
c
 =ğ
NULL
 || 
sfd
 == 0) {

550 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

553 ià(
	`Ìu_üawËr_£t_ş›Á
(&
aùive_üawËr_mod
, 
c
, 
sfd
) != 0) {

554 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

559 
sid
 = 
POWER_SMALLEST
; sid < 
MAX_NUMBER_OF_SLAB_CLASSES
; sid++) {

560 ià(
ids
[
sid
]) {

561 
¡¬ts
 +ğ
	`do_Ìu_üawËr_¡¬t
(
sid
, 
»maššg
);

564 ià(
¡¬ts
) {

565 
	`±h»ad_cÚd_sigÇl
(&
Ìu_üawËr_cÚd
);

567 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

568  
¡¬ts
;

569 
	}
}

574 
üawËr_»suÉ_ty³
 
	$Ìu_üawËr_üawl
(*
¦abs
, cÚ¡ 
üawËr_run_ty³
 
ty³
,

575 *
c
, cÚ¡ 
sfd
) {

576 *
b
 = 
NULL
;

577 
ušt32_t
 
sid
 = 0;

578 
¡¬ts
 = 0;

579 
ušt8_t
 
toüawl
[
MAX_NUMBER_OF_SLAB_CLASSES
];

582 
	`mem£t
(
toüawl
, 0, (
ušt8_t
è* 
MAX_NUMBER_OF_SLAB_CLASSES
);

583 ià(
	`¡rcmp
(
¦abs
, "all") == 0) {

584 
sid
 = 0; sid < 
MAX_NUMBER_OF_SLAB_CLASSES
; sid++) {

585 
toüawl
[
sid
] = 1;

588 *
p
 = 
	`¡¹ok_r
(
¦abs
, ",", &
b
);

589 
p
 !ğ
NULL
;

590 
p
 = 
	`¡¹ok_r
(
NULL
, ",", &
b
)) {

592 ià(!
	`§ã_¡¹oul
(
p
, &
sid
è|| sid < 
POWER_SMALLEST


593 || 
sid
 >ğ
MAX_NUMBER_OF_SLAB_CLASSES
) {

594 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

595  
CRAWLER_BADCLASS
;

597 
toüawl
[
sid
] = 1;

601 
¡¬ts
 = 
	`Ìu_üawËr_¡¬t
(
toüawl
, 
£‰šgs
.
Ìu_üawËr_toüawl
,

602 
ty³
, 
NULL
, 
c
, 
sfd
);

603 ià(
¡¬ts
 == -1) {

604  
CRAWLER_RUNNING
;

605 } ià(
¡¬ts
 == -2) {

606  
CRAWLER_ERROR
;

607 } ià(
¡¬ts
) {

608  
CRAWLER_OK
;

610  
CRAWLER_NOTSTARTED
;

612 
	}
}

615 
	$Ìu_üawËr_·u£
() {

616 
	`±h»ad_mu‹x_lock
(&
Ìu_üawËr_lock
);

617 
	}
}

619 
	$Ìu_üawËr_»sume
() {

620 
	`±h»ad_mu‹x_uÆock
(&
Ìu_üawËr_lock
);

621 
	}
}

623 
	$š™_Ìu_üawËr
() {

624 ià(
Ìu_üawËr_š™Ÿlized
 == 0) {

625 ià(
	`±h»ad_cÚd_š™
(&
Ìu_üawËr_cÚd
, 
NULL
) != 0) {

626 
	`årštf
(
¡d”r
, "Can't initialize†ru crawler condition\n");

629 
	`±h»ad_mu‹x_š™
(&
Ìu_üawËr_lock
, 
NULL
);

630 
aùive_üawËr_mod
.
c
.øğ
NULL
;

631 
aùive_üawËr_mod
.
mod
 = 
NULL
;

632 
aùive_üawËr_mod
.
d©a
 = 
NULL
;

633 
Ìu_üawËr_š™Ÿlized
 = 1;

636 
	}
}

	@crawler.h

1 #iâdeà
CRAWLER_H


2 
	#CRAWLER_H


	)

5 
ušt64_t
 
	mhi¡o
[61];

6 
ušt64_t
 
	m‰l_hou½lus
;

7 
ušt64_t
 
	mnÛxp
;

8 
ušt64_t
 
	m»şaimed
;

9 
ušt64_t
 
	m£’
;

10 
»l_time_t
 
	m¡¬t_time
;

11 
»l_time_t
 
	m’d_time
;

12 
boŞ
 
	mrun_com¶‘e
;

13 } 
	tüawËr¡©s_t
;

15 
	süawËr_expœed_d©a
 {

16 
±h»ad_mu‹x_t
 
	mlock
;

17 
üawËr¡©s_t
 
	müawËr¡©s
[
MAX_NUMBER_OF_SLAB_CLASSES
];

19 
»l_time_t
 
	m¡¬t_time
;

20 
»l_time_t
 
	m’d_time
;

21 
boŞ
 
	müawl_com¶‘e
;

22 
boŞ
 
	mis_ex‹º®
;

25 
	eüawËr_»suÉ_ty³
 {

26 
	mCRAWLER_OK
=0, 
	mCRAWLER_RUNNING
, 
	mCRAWLER_BADCLASS
, 
	mCRAWLER_NOTSTARTED
, 
	mCRAWLER_ERROR


29 
¡¬t_™em_üawËr_th»ad
();

30 
¡İ_™em_üawËr_th»ad
();

31 
š™_Ìu_üawËr
();

32 
üawËr_»suÉ_ty³
 
Ìu_üawËr_üawl
(*
¦abs
, 
üawËr_run_ty³
, *
c
, cÚ¡ 
sfd
);

33 
Ìu_üawËr_¡¬t
(
ušt8_t
 *
ids
, 
ušt32_t
 
»maššg
,

34 cÚ¡ 
üawËr_run_ty³
 
ty³
, *
d©a
,

35 *
c
, cÚ¡ 
sfd
);

36 
Ìu_üawËr_·u£
();

37 
Ìu_üawËr_»sume
();

	@daemon.c

32 #ià
defšed
 
__SUNPRO_C
 || defšed 
__DECC
 || defšed 
__HP_cc


33 #´agm¨
id’t
 "@(#)$Header: /cvsroot/wikipedia/willow/src/bin/willow/daemon.c,v 1.1 2005/05/02 19:15:21 kateturner Exp $"

34 #´agm¨
id’t
 "$NetBSD: daemon.c,v 1.9 2003/08/07 16:42:46‡gc Exp $"

37 
	~<fú.h
>

38 
	~<¡dio.h
>

39 
	~<¡dlib.h
>

40 
	~<uni¡d.h
>

42 
	~"memÿched.h
"

44 
	$d«mÚize
(
nochdœ
, 
noşo£
)

46 
fd
;

48 
	`fÜk
()) {

54 
	`_ex™
(
EXIT_SUCCESS
);

57 ià(
	`£tsid
() == -1)

60 ià(
nochdœ
 == 0) {

61 if(
	`chdœ
("/") != 0) {

62 
	`³¼Ü
("chdir");

67 ià(
noşo£
 =ğ0 && (
fd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
, 0)) != -1) {

68 if(
	`dup2
(
fd
, 
STDIN_FILENO
) < 0) {

69 
	`³¼Ü
("dup2 stdin");

72 if(
	`dup2
(
fd
, 
STDOUT_FILENO
) < 0) {

73 
	`³¼Ü
("dup2 stdout");

76 if(
	`dup2
(
fd
, 
STDERR_FILENO
) < 0) {

77 
	`³¼Ü
("dup2 stderr");

81 ià(
fd
 > 
STDERR_FILENO
) {

82 if(
	`şo£
(
fd
) < 0) {

83 
	`³¼Ü
("close");

89 
	}
}

	@hash.c

3 
	~"memÿched.h
"

4 
	~"j’kšs_hash.h
"

5 
	~"murmur3_hash.h
"

7 
	$hash_š™
(
hashfunc_ty³
 
ty³
) {

8 
ty³
) {

9 
JENKINS_HASH
:

10 
hash
 = 
j’kšs_hash
;

11 
£‰šgs
.
hash_®gÜ™hm
 = "jenkins";

13 
MURMUR3_HASH
:

14 
hash
 = 
MurmurHash3_x86_32
;

15 
£‰šgs
.
hash_®gÜ™hm
 = "murmur3";

21 
	}
}

	@hash.h

1 #iâdeà
HASH_H


2 
	#HASH_H


	)

4 
	$ušt32_t
 (*
	thash_func
)(cÚ¡ *
	tkey
, 
	tsize_t
 
	tËngth
);

5 
hash_func
 
hash
;

7 
	ehashfunc_ty³
 {

8 
JENKINS_HASH
=0, 
MURMUR3_HASH


11 
	`hash_š™
(
hashfunc_ty³
 
ty³
);

	@items.c

2 
	~"memÿched.h
"

3 
	~<sys/¡©.h
>

4 
	~<sys/sock‘.h
>

5 
	~<sys/»sourû.h
>

6 
	~<fú.h
>

7 
	~<Ãtš‘/š.h
>

8 
	~<”ºo.h
>

9 
	~<¡dlib.h
>

10 
	~<¡dio.h
>

11 
	~<sigÇl.h
>

12 
	~<¡ršg.h
>

13 
	~<time.h
>

14 
	~<as£¹.h
>

15 
	~<uni¡d.h
>

16 
	~<pŞl.h
>

19 
™em_lšk_q
(
™em
 *
™
);

20 
™em_uÆšk_q
(
™em
 *
™
);

22 
	gÌu_ty³_m­
[4] = {
HOT_LRU
, 
WARM_LRU
, 
COLD_LRU
, 
NOEXP_LRU
};

24 
	#LARGEST_ID
 
POWER_LARGEST


	)

26 
ušt64_t
 
	meviùed
;

27 
ušt64_t
 
	meviùed_nÚz”o
;

28 
ušt64_t
 
	m»şaimed
;

29 
ušt64_t
 
	moutofmemÜy
;

30 
ušt64_t
 
	m»·œs
;

31 
ušt64_t
 
	mexpœed_unãtched
;

32 
ušt64_t
 
	meviùed_unãtched
;

33 
ušt64_t
 
	meviùed_aùive
;

34 
ušt64_t
 
	müawËr_»şaimed
;

35 
ušt64_t
 
	müawËr_™ems_checked
;

36 
ušt64_t
 
	mÌu_»æocked
;

37 
ušt64_t
 
	mmoves_to_cŞd
;

38 
ušt64_t
 
	mmoves_to_w¬m
;

39 
ušt64_t
 
	mmoves_w™hš_Ìu
;

40 
ušt64_t
 
	mdœeù_»şaims
;

41 
»l_time_t
 
	meviùed_time
;

42 } 
	t™em¡©s_t
;

44 
™em
 *
	gh—ds
[
LARGEST_ID
];

45 
™em
 *
	gs
[
LARGEST_ID
];

46 
™em¡©s_t
 
	g™em¡©s
[
LARGEST_ID
];

47 
	gsizes
[
LARGEST_ID
];

48 
ušt64_t
 
	gsizes_by‹s
[
LARGEST_ID
];

49 *
	g¡©s_sizes_hi¡
 = 
NULL
;

50 
ušt64_t
 
	g¡©s_sizes_ÿs_mš
 = 0;

51 
	g¡©s_sizes_buck‘s
 = 0;

53 vŞ©
	gdo_run_Ìu_mašš”_th»ad
 = 0;

54 
	gÌu_mašš”_š™Ÿlized
 = 0;

55 
	gÌu_mašš”_check_şsid
 = 0;

56 
±h»ad_mu‹x_t
 
	gÌu_mašš”_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

57 
±h»ad_mu‹x_t
 
	gÿs_id_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

58 
±h»ad_mu‹x_t
 
	g¡©s_sizes_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

60 
	$™em_¡©s_»£t
() {

61 
i
;

62 
i
 = 0; i < 
LARGEST_ID
; i++) {

63 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
i
]);

64 
	`mem£t
(&
™em¡©s
[
i
], 0, (
™em¡©s_t
));

65 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
i
]);

67 
	}
}

70 
	$do_™em_¡©s_add_üawl
(cÚ¡ 
i
, cÚ¡ 
ušt64_t
 
»şaimed
,

71 cÚ¡ 
ušt64_t
 
unãtched
, cÚ¡ ušt64_ˆ
checked
) {

72 
™em¡©s
[
i
].
üawËr_»şaimed
 +ğ
»şaimed
;

73 
™em¡©s
[
i
].
expœed_unãtched
 +ğ
unãtched
;

74 
™em¡©s
[
i
].
üawËr_™ems_checked
 +ğ
checked
;

75 
	}
}

77 
	#LRU_PULL_EVICT
 1

	)

78 
	#LRU_PULL_CRAWL_BLOCKS
 2

	)

80 
Ìu_puÎ_
(cÚ¡ 
Üig_id
, cÚ¡ 
cur_Ìu
,

81 cÚ¡ 
ušt64_t
 
tÙ®_by‹s
, 
ušt8_t
 
æags
);

85 
ušt64_t
 
	$g‘_ÿs_id
() {

86 
ušt64_t
 
ÿs_id
 = 0;

87 
	`±h»ad_mu‹x_lock
(&
ÿs_id_lock
);

88 
ušt64_t
 
Ãxt_id
 = ++
ÿs_id
;

89 
	`±h»ad_mu‹x_uÆock
(&
ÿs_id_lock
);

90  
Ãxt_id
;

91 
	}
}

93 
	$™em_is_æushed
(
™em
 *
™
) {

94 
»l_time_t
 
Şde¡_live
 = 
£‰šgs
.oldest_live;

95 
ušt64_t
 
ÿs
 = 
	`ITEM_g‘_ÿs
(
™
);

96 
ušt64_t
 
Şde¡_ÿs
 = 
£‰šgs
.oldest_cas;

97 ià(
Şde¡_live
 =ğ0 || olde¡_liv> 
cu¼’t_time
)

99 ià((
™
->
time
 <ğ
Şde¡_live
)

100 || (
Şde¡_ÿs
 !ğ0 && 
ÿs
 != 0 && cas < oldest_cas)) {

104 
	}
}

106 
	$nÛxp_Ìu_size
(
¦abs_şsid
) {

107 
id
 = 
	`CLEAR_LRU
(
¦abs_şsid
);

108 
id
 |ğ
NOEXP_LRU
;

109 
»t
;

110 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
id
]);

111 
»t
 = 
sizes_by‹s
[
id
];

112 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
id
]);

113  
»t
;

114 
	}
}

118 
	#DEBUG_REFCNT
(
™
,
İ
) \

119 
	`årštf
(
¡d”r
, "item %x„efcnt(%c) %d %c%c%c\n", \

120 
™
, 
İ
, it->
»fcouÁ
, \

121 (
™
->
™_æags
 & 
ITEM_LINKED
) ? 'L' : ' ', \

122 (
™
->
™_æags
 & 
ITEM_SLABBED
è? 'S' : ' ')

	)

124 
	#DEBUG_REFCNT
(
™
,
İ
è0)

	)

139 
size_t
 
	$™em_make_h—d”
(cÚ¡ 
ušt8_t
 
nkey
, cÚ¡ 
æags
, cÚ¡ 
nby‹s
,

140 *
suffix
, 
ušt8_t
 *
nsuffix
) {

142 *
nsuffix
 = (
ušt8_t
è
	`¢´štf
(
suffix
, 40, " %u %d\r\n", 
æags
, 
nby‹s
 - 2);

143  (
™em
è+ 
nkey
 + *
nsuffix
 + 
nby‹s
;

144 
	}
}

146 
™em
 *
	$do_™em_®loc
(*
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
æags
,

147 cÚ¡ 
»l_time_t
 
ex±ime
, cÚ¡ 
nby‹s
) {

148 
i
;

149 
ušt8_t
 
nsuffix
;

150 
™em
 *
™
 = 
NULL
;

151 
suffix
[40];

153 ià(
nby‹s
 < 2)

156 
size_t
 
ÁÙ®
 = 
	`™em_make_h—d”
(
nkey
 + 1, 
æags
, 
nby‹s
, 
suffix
, &
nsuffix
);

157 ià(
£‰šgs
.
u£_ÿs
) {

158 
ÁÙ®
 +ğ(
ušt64_t
);

161 
id
 = 
	`¦abs_şsid
(
ÁÙ®
);

162 ià(
id
 == 0)

179 
i
 = 0; i < 10; i++) {

180 
ušt64_t
 
tÙ®_by‹s
;

182 ià(!
£‰šgs
.
Ìu_mašš”_th»ad
) {

183 
	`Ìu_puÎ_
(
id
, 
COLD_LRU
, 0, 0);

185 
™
 = 
	`¦abs_®loc
(
ÁÙ®
, 
id
, &
tÙ®_by‹s
, 0);

187 ià(
£‰šgs
.
expœez”o_dÛs_nÙ_eviù
)

188 
tÙ®_by‹s
 -ğ
	`nÛxp_Ìu_size
(
id
);

190 ià(
™
 =ğ
NULL
) {

191 ià(
£‰šgs
.
Ìu_mašš”_th»ad
) {

192 
	`Ìu_puÎ_
(
id
, 
HOT_LRU
, 
tÙ®_by‹s
, 0);

193 
	`Ìu_puÎ_
(
id
, 
WARM_LRU
, 
tÙ®_by‹s
, 0);

194 ià(
	`Ìu_puÎ_
(
id
, 
COLD_LRU
, 
tÙ®_by‹s
, 
LRU_PULL_EVICT
) <= 0)

197 ià(
	`Ìu_puÎ_
(
id
, 
COLD_LRU
, 0, 
LRU_PULL_EVICT
) <= 0)

205 ià(
i
 > 0) {

206 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
id
]);

207 
™em¡©s
[
id
].
dœeù_»şaims
 +ğ
i
;

208 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
id
]);

211 ià(
™
 =ğ
NULL
) {

212 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
id
]);

213 
™em¡©s
[
id
].
outofmemÜy
++;

214 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
id
]);

215  
NULL
;

218 
	`as£¹
(
™
->
¦abs_şsid
 == 0);

222 
™
->
Ãxt
 = it->
´ev
 = 0;

227 ià(
£‰šgs
.
Ìu_mašš”_th»ad
) {

228 ià(
ex±ime
 =ğ0 && 
£‰šgs
.
expœez”o_dÛs_nÙ_eviù
) {

229 
id
 |ğ
NOEXP_LRU
;

231 
id
 |ğ
HOT_LRU
;

235 
id
 |ğ
COLD_LRU
;

237 
™
->
¦abs_şsid
 = 
id
;

239 
	`DEBUG_REFCNT
(
™
, '*');

240 
™
->
™_æags
 |ğ
£‰šgs
.
u£_ÿs
 ? 
ITEM_CAS
 : 0;

241 
™
->
nkey
 =‚key;

242 
™
->
nby‹s
 =‚bytes;

243 
	`memıy
(
	`ITEM_key
(
™
), 
key
, 
nkey
);

244 
™
->
ex±ime
 =ƒxptime;

245 
	`memıy
(
	`ITEM_suffix
(
™
), 
suffix
, (
size_t
)
nsuffix
);

246 
™
->
nsuffix
 =‚suffix;

249 ià(
™
->
™_æags
 & 
ITEM_CHUNKED
) {

250 
™em_chunk
 *
chunk
 = (™em_chunk *è
	`ITEM_d©a
(
™
);

252 
chunk
->
Ãxt
 = (
™em_chunk
 *è
™
->
h_Ãxt
;

253 
chunk
->
´ev
 = 0;

254 
chunk
->
h—d
 = 
™
;

256 
chunk
->
Ãxt
->
´ev
 = chunk;

257 
chunk
->
size
 = chunk->
Ãxt
->siz- ((*)chunk - (*)
™
);

258 
chunk
->
u£d
 = 0;

259 
	`as£¹
(
chunk
->
size
 > 0);

261 
™
->
h_Ãxt
 = 0;

263  
™
;

264 
	}
}

266 
	$™em_ä“
(
™em
 *
™
) {

267 
size_t
 
ÁÙ®
 = 
	`ITEM_ÁÙ®
(
™
);

268 
şsid
;

269 
	`as£¹
((
™
->
™_æags
 & 
ITEM_LINKED
) == 0);

270 
	`as£¹
(
™
 !ğ
h—ds
[™->
¦abs_şsid
]);

271 
	`as£¹
(
™
 !ğ
s
[™->
¦abs_şsid
]);

272 
	`as£¹
(
™
->
»fcouÁ
 == 0);

275 
şsid
 = 
	`ITEM_şsid
(
™
);

276 
	`DEBUG_REFCNT
(
™
, 'F');

277 
	`¦abs_ä“
(
™
, 
ÁÙ®
, 
şsid
);

278 
	}
}

284 
boŞ
 
	$™em_size_ok
(cÚ¡ 
size_t
 
nkey
, cÚ¡ 
æags
, cÚ¡ 
nby‹s
) {

285 
´efix
[40];

286 
ušt8_t
 
nsuffix
;

288 
size_t
 
ÁÙ®
 = 
	`™em_make_h—d”
(
nkey
 + 1, 
æags
, 
nby‹s
,

289 
´efix
, &
nsuffix
);

290 ià(
£‰šgs
.
u£_ÿs
) {

291 
ÁÙ®
 +ğ(
ušt64_t
);

294  
	`¦abs_şsid
(
ÁÙ®
) != 0;

295 
	}
}

297 
	$do_™em_lšk_q
(
™em
 *
™
) {

298 
™em
 **
h—d
, **

;

299 
	`as£¹
((
™
->
™_æags
 & 
ITEM_SLABBED
) == 0);

301 
h—d
 = &
h—ds
[
™
->
¦abs_şsid
];

302 

 = &
s
[
™
->
¦abs_şsid
];

303 
	`as£¹
(
™
 !ğ*
h—d
);

304 
	`as£¹
((*
h—d
 && *

) || (*head == 0 && *tail == 0));

305 
™
->
´ev
 = 0;

306 
™
->
Ãxt
 = *
h—d
;

307 ià(
™
->
Ãxt
è™->Ãxt->
´ev
 = it;

308 *
h—d
 = 
™
;

309 ià(*

 =ğ0è* = 
™
;

310 
sizes
[
™
->
¦abs_şsid
]++;

311 
sizes_by‹s
[
™
->
¦abs_şsid
] +ğ
	`ITEM_ÁÙ®
(it);

313 
	}
}

315 
	$™em_lšk_q
(
™em
 *
™
) {

316 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
™
->
¦abs_şsid
]);

317 
	`do_™em_lšk_q
(
™
);

318 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
™
->
¦abs_şsid
]);

319 
	}
}

321 
	$do_™em_uÆšk_q
(
™em
 *
™
) {

322 
™em
 **
h—d
, **

;

323 
h—d
 = &
h—ds
[
™
->
¦abs_şsid
];

324 

 = &
s
[
™
->
¦abs_şsid
];

326 ià(*
h—d
 =ğ
™
) {

327 
	`as£¹
(
™
->
´ev
 == 0);

328 *
h—d
 = 
™
->
Ãxt
;

330 ià(*

 =ğ
™
) {

331 
	`as£¹
(
™
->
Ãxt
 == 0);

332 *

 = 
™
->
´ev
;

334 
	`as£¹
(
™
->
Ãxt
 != it);

335 
	`as£¹
(
™
->
´ev
 != it);

337 ià(
™
->
Ãxt
è™->Ãxt->
´ev
 = it->prev;

338 ià(
™
->
´ev
è™->´ev->
Ãxt
 = it->next;

339 
sizes
[
™
->
¦abs_şsid
]--;

340 
sizes_by‹s
[
™
->
¦abs_şsid
] -ğ
	`ITEM_ÁÙ®
(it);

342 
	}
}

344 
	$™em_uÆšk_q
(
™em
 *
™
) {

345 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
™
->
¦abs_şsid
]);

346 
	`do_™em_uÆšk_q
(
™
);

347 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
™
->
¦abs_şsid
]);

348 
	}
}

350 
	$do_™em_lšk
(
™em
 *
™
, cÚ¡ 
ušt32_t
 
hv
) {

351 
	`MEMCACHED_ITEM_LINK
(
	`ITEM_key
(
™
), it->
nkey
, it->
nby‹s
);

352 
	`as£¹
((
™
->
™_æags
 & (
ITEM_LINKED
|
ITEM_SLABBED
)) == 0);

353 
™
->
™_æags
 |ğ
ITEM_LINKED
;

354 
™
->
time
 = 
cu¼’t_time
;

356 
	`STATS_LOCK
();

357 
¡©s_¡©e
.
cu¼_by‹s
 +ğ
	`ITEM_ÁÙ®
(
™
);

358 
¡©s_¡©e
.
cu¼_™ems
 += 1;

359 
¡©s
.
tÙ®_™ems
 += 1;

360 
	`STATS_UNLOCK
();

363 
	`ITEM_£t_ÿs
(
™
, (
£‰šgs
.
u£_ÿs
è? 
	`g‘_ÿs_id
() : 0);

364 
	`assoc_š£¹
(
™
, 
hv
);

365 
	`™em_lšk_q
(
™
);

366 
	`»fcouÁ_šü
(&
™
->
»fcouÁ
);

367 
	`™em_¡©s_sizes_add
(
™
);

370 
	}
}

372 
	$do_™em_uÆšk
(
™em
 *
™
, cÚ¡ 
ušt32_t
 
hv
) {

373 
	`MEMCACHED_ITEM_UNLINK
(
	`ITEM_key
(
™
), it->
nkey
, it->
nby‹s
);

374 ià((
™
->
™_æags
 & 
ITEM_LINKED
) != 0) {

375 
™
->
™_æags
 &ğ~
ITEM_LINKED
;

376 
	`STATS_LOCK
();

377 
¡©s_¡©e
.
cu¼_by‹s
 -ğ
	`ITEM_ÁÙ®
(
™
);

378 
¡©s_¡©e
.
cu¼_™ems
 -= 1;

379 
	`STATS_UNLOCK
();

380 
	`™em_¡©s_sizes_»move
(
™
);

381 
	`assoc_d–‘e
(
	`ITEM_key
(
™
), it->
nkey
, 
hv
);

382 
	`™em_uÆšk_q
(
™
);

383 
	`do_™em_»move
(
™
);

385 
	}
}

388 
	$do_™em_uÆšk_nŞock
(
™em
 *
™
, cÚ¡ 
ušt32_t
 
hv
) {

389 
	`MEMCACHED_ITEM_UNLINK
(
	`ITEM_key
(
™
), it->
nkey
, it->
nby‹s
);

390 ià((
™
->
™_æags
 & 
ITEM_LINKED
) != 0) {

391 
™
->
™_æags
 &ğ~
ITEM_LINKED
;

392 
	`STATS_LOCK
();

393 
¡©s_¡©e
.
cu¼_by‹s
 -ğ
	`ITEM_ÁÙ®
(
™
);

394 
¡©s_¡©e
.
cu¼_™ems
 -= 1;

395 
	`STATS_UNLOCK
();

396 
	`™em_¡©s_sizes_»move
(
™
);

397 
	`assoc_d–‘e
(
	`ITEM_key
(
™
), it->
nkey
, 
hv
);

398 
	`do_™em_uÆšk_q
(
™
);

399 
	`do_™em_»move
(
™
);

401 
	}
}

403 
	$do_™em_»move
(
™em
 *
™
) {

404 
	`MEMCACHED_ITEM_REMOVE
(
	`ITEM_key
(
™
), it->
nkey
, it->
nby‹s
);

405 
	`as£¹
((
™
->
™_æags
 & 
ITEM_SLABBED
) == 0);

406 
	`as£¹
(
™
->
»fcouÁ
 > 0);

408 ià(
	`»fcouÁ_deü
(&
™
->
»fcouÁ
) == 0) {

409 
	`™em_ä“
(
™
);

411 
	}
}

415 
	$do_™em_upd©e_nŞock
(
™em
 *
™
) {

416 
	`MEMCACHED_ITEM_UPDATE
(
	`ITEM_key
(
™
), it->
nkey
, it->
nby‹s
);

417 ià(
™
->
time
 < 
cu¼’t_time
 - 
ITEM_UPDATE_INTERVAL
) {

418 
	`as£¹
((
™
->
™_æags
 & 
ITEM_SLABBED
) == 0);

420 ià((
™
->
™_æags
 & 
ITEM_LINKED
) != 0) {

421 
	`do_™em_uÆšk_q
(
™
);

422 
™
->
time
 = 
cu¼’t_time
;

423 
	`do_™em_lšk_q
(
™
);

426 
	}
}

429 
	$do_™em_upd©e
(
™em
 *
™
) {

430 
	`MEMCACHED_ITEM_UPDATE
(
	`ITEM_key
(
™
), it->
nkey
, it->
nby‹s
);

431 ià(
™
->
time
 < 
cu¼’t_time
 - 
ITEM_UPDATE_INTERVAL
) {

432 
	`as£¹
((
™
->
™_æags
 & 
ITEM_SLABBED
) == 0);

434 ià((
™
->
™_æags
 & 
ITEM_LINKED
) != 0) {

435 
™
->
time
 = 
cu¼’t_time
;

436 ià(!
£‰šgs
.
Ìu_mašš”_th»ad
) {

437 
	`™em_uÆšk_q
(
™
);

438 
	`™em_lšk_q
(
™
);

442 
	}
}

444 
	$do_™em_»¶aû
(
™em
 *
™
, i‹m *
Ãw_™
, cÚ¡ 
ušt32_t
 
hv
) {

445 
	`MEMCACHED_ITEM_REPLACE
(
	`ITEM_key
(
™
), it->
nkey
, it->
nby‹s
,

446 
	`ITEM_key
(
Ãw_™
),‚ew_™->
nkey
,‚ew_™->
nby‹s
);

447 
	`as£¹
((
™
->
™_æags
 & 
ITEM_SLABBED
) == 0);

449 
	`do_™em_uÆšk
(
™
, 
hv
);

450  
	`do_™em_lšk
(
Ãw_™
, 
hv
);

451 
	}
}

461 *
	$™em_ÿchedump
(cÚ¡ 
¦abs_şsid
, cÚ¡ 
lim™
, *
by‹s
) {

462 
memlim™
 = 2 * 1024 * 1024;

463 *
bufãr
;

464 
bufcu¼
;

465 
™em
 *
™
;

466 
Ën
;

467 
shown
 = 0;

468 
key_‹mp
[
KEY_MAX_LENGTH
 + 1];

469 
‹mp
[512];

470 
id
 = 
¦abs_şsid
;

471 ià(!
£‰šgs
.
Ìu_mašš”_th»ad
)

472 
id
 |ğ
COLD_LRU
;

474 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
id
]);

475 
™
 = 
h—ds
[
id
];

477 
bufãr
 = 
	`m®loc
((
size_t
)
memlim™
);

478 ià(
bufãr
 == 0) {

479  
NULL
;

481 
bufcu¼
 = 0;

483 
™
 !ğ
NULL
 && (
lim™
 =ğ0 || 
shown
 <†imit)) {

484 
	`as£¹
(
™
->
nkey
 <ğ
KEY_MAX_LENGTH
);

485 ià(
™
->
nby‹s
 =ğ0 && it->
nkey
 == 0) {

486 
™
 = it->
Ãxt
;

490 
	`¡ºıy
(
key_‹mp
, 
	`ITEM_key
(
™
), it->
nkey
);

491 
key_‹mp
[
™
->
nkey
] = 0x00;

492 
Ën
 = 
	`¢´štf
(
‹mp
, (temp), "ITEM %s [%d b; %llu s]\r\n",

493 
key_‹mp
, 
™
->
nby‹s
 - 2,

494 
™
->
ex±ime
 == 0 ? 0 :

495 ()
™
->
ex±ime
 + 
´oûss_¡¬‹d
);

496 ià(
bufcu¼
 + 
Ën
 + 6 > 
memlim™
)

498 
	`memıy
(
bufãr
 + 
bufcu¼
, 
‹mp
, 
Ën
);

499 
bufcu¼
 +ğ
Ën
;

500 
shown
++;

501 
™
 = it->
Ãxt
;

504 
	`memıy
(
bufãr
 + 
bufcu¼
, "END\r\n", 6);

505 
bufcu¼
 += 5;

507 *
by‹s
 = 
bufcu¼
;

508 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
id
]);

509  
bufãr
;

510 
	}
}

512 
	$™em_¡©s_tÙ®s
(
ADD_STAT
 
add_¡©s
, *
c
) {

513 
™em¡©s_t
 
tÙ®s
;

514 
	`mem£t
(&
tÙ®s
, 0, (
™em¡©s_t
));

515 
n
;

516 
n
 = 0;‚ < 
MAX_NUMBER_OF_SLAB_CLASSES
;‚++) {

517 
x
;

518 
i
;

519 
x
 = 0; x < 4; x++) {

520 
i
 = 
n
 | 
Ìu_ty³_m­
[
x
];

521 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
i
]);

522 
tÙ®s
.
expœed_unãtched
 +ğ
™em¡©s
[
i
].expired_unfetched;

523 
tÙ®s
.
eviùed_unãtched
 +ğ
™em¡©s
[
i
].evicted_unfetched;

524 
tÙ®s
.
eviùed_aùive
 +ğ
™em¡©s
[
i
].evicted_active;

525 
tÙ®s
.
eviùed
 +ğ
™em¡©s
[
i
].evicted;

526 
tÙ®s
.
»şaimed
 +ğ
™em¡©s
[
i
].reclaimed;

527 
tÙ®s
.
üawËr_»şaimed
 +ğ
™em¡©s
[
i
].crawler_reclaimed;

528 
tÙ®s
.
üawËr_™ems_checked
 +ğ
™em¡©s
[
i
].crawler_items_checked;

529 
tÙ®s
.
Ìu_»æocked
 +ğ
™em¡©s
[
i
].lrutail_reflocked;

530 
tÙ®s
.
moves_to_cŞd
 +ğ
™em¡©s
[
i
].moves_to_cold;

531 
tÙ®s
.
moves_to_w¬m
 +ğ
™em¡©s
[
i
].moves_to_warm;

532 
tÙ®s
.
moves_w™hš_Ìu
 +ğ
™em¡©s
[
i
].moves_within_lru;

533 
tÙ®s
.
dœeù_»şaims
 +ğ
™em¡©s
[
i
].direct_reclaims;

534 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
i
]);

537 
	`APPEND_STAT
("expired_unfetched", "%llu",

538 ()
tÙ®s
.
expœed_unãtched
);

539 
	`APPEND_STAT
("evicted_unfetched", "%llu",

540 ()
tÙ®s
.
eviùed_unãtched
);

541 ià(
£‰šgs
.
Ìu_mašš”_th»ad
) {

542 
	`APPEND_STAT
("evicted_active", "%llu",

543 ()
tÙ®s
.
eviùed_aùive
);

545 
	`APPEND_STAT
("evictions", "%llu",

546 ()
tÙ®s
.
eviùed
);

547 
	`APPEND_STAT
("reclaimed", "%llu",

548 ()
tÙ®s
.
»şaimed
);

549 
	`APPEND_STAT
("crawler_reclaimed", "%llu",

550 ()
tÙ®s
.
üawËr_»şaimed
);

551 
	`APPEND_STAT
("crawler_items_checked", "%llu",

552 ()
tÙ®s
.
üawËr_™ems_checked
);

553 
	`APPEND_STAT
("lrutail_reflocked", "%llu",

554 ()
tÙ®s
.
Ìu_»æocked
);

555 ià(
£‰šgs
.
Ìu_mašš”_th»ad
) {

556 
	`APPEND_STAT
("moves_to_cold", "%llu",

557 ()
tÙ®s
.
moves_to_cŞd
);

558 
	`APPEND_STAT
("moves_to_warm", "%llu",

559 ()
tÙ®s
.
moves_to_w¬m
);

560 
	`APPEND_STAT
("moves_within_lru", "%llu",

561 ()
tÙ®s
.
moves_w™hš_Ìu
);

562 
	`APPEND_STAT
("direct_reclaims", "%llu",

563 ()
tÙ®s
.
dœeù_»şaims
);

565 
	}
}

567 
	$™em_¡©s
(
ADD_STAT
 
add_¡©s
, *
c
) {

568 
™em¡©s_t
 
tÙ®s
;

569 
n
;

570 
n
 = 0;‚ < 
MAX_NUMBER_OF_SLAB_CLASSES
;‚++) {

571 
	`mem£t
(&
tÙ®s
, 0, (
™em¡©s_t
));

572 
x
;

573 
i
;

574 
size
 = 0;

575 
age
 = 0;

576 
Ìu_size_m­
[4];

577 cÚ¡ *
fmt
 = "items:%d:%s";

578 
key_¡r
[
STAT_KEY_LEN
];

579 
v®_¡r
[
STAT_VAL_LEN
];

580 
kËn
 = 0, 
vËn
 = 0;

581 
x
 = 0; x < 4; x++) {

582 
i
 = 
n
 | 
Ìu_ty³_m­
[
x
];

583 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
i
]);

584 
tÙ®s
.
eviùed
 +ğ
™em¡©s
[
i
].evicted;

585 
tÙ®s
.
eviùed_nÚz”o
 +ğ
™em¡©s
[
i
].evicted_nonzero;

586 
tÙ®s
.
outofmemÜy
 +ğ
™em¡©s
[
i
].outofmemory;

587 
tÙ®s
.
»·œs
 +ğ
™em¡©s
[
i
].tailrepairs;

588 
tÙ®s
.
»şaimed
 +ğ
™em¡©s
[
i
].reclaimed;

589 
tÙ®s
.
expœed_unãtched
 +ğ
™em¡©s
[
i
].expired_unfetched;

590 
tÙ®s
.
eviùed_unãtched
 +ğ
™em¡©s
[
i
].evicted_unfetched;

591 
tÙ®s
.
eviùed_aùive
 +ğ
™em¡©s
[
i
].evicted_active;

592 
tÙ®s
.
üawËr_»şaimed
 +ğ
™em¡©s
[
i
].crawler_reclaimed;

593 
tÙ®s
.
üawËr_™ems_checked
 +ğ
™em¡©s
[
i
].crawler_items_checked;

594 
tÙ®s
.
Ìu_»æocked
 +ğ
™em¡©s
[
i
].lrutail_reflocked;

595 
tÙ®s
.
moves_to_cŞd
 +ğ
™em¡©s
[
i
].moves_to_cold;

596 
tÙ®s
.
moves_to_w¬m
 +ğ
™em¡©s
[
i
].moves_to_warm;

597 
tÙ®s
.
moves_w™hš_Ìu
 +ğ
™em¡©s
[
i
].moves_within_lru;

598 
tÙ®s
.
dœeù_»şaims
 +ğ
™em¡©s
[
i
].direct_reclaims;

599 
size
 +ğ
sizes
[
i
];

600 
Ìu_size_m­
[
x
] = 
sizes
[
i
];

601 ià(
Ìu_ty³_m­
[
x
] =ğ
COLD_LRU
 && 
s
[
i
] !ğ
NULL
)

602 
age
 = 
cu¼’t_time
 - 
s
[
i
]->
time
;

603 ià(
Ìu_ty³_m­
[
x
] =ğ
COLD_LRU
)

604 
tÙ®s
.
eviùed_time
 = 
™em¡©s
[
i
].evicted_time;

605 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
i
]);

607 ià(
size
 == 0)

609 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "numb”", "%u", 
size
);

610 ià(
£‰šgs
.
Ìu_mašš”_th»ad
) {

611 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "numb”_hÙ", "%u", 
Ìu_size_m­
[0]);

612 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "numb”_w¬m", "%u", 
Ìu_size_m­
[1]);

613 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "numb”_cŞd", "%u", 
Ìu_size_m­
[2]);

614 ià(
£‰šgs
.
expœez”o_dÛs_nÙ_eviù
) {

615 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "numb”_nÛxp", "%u", 
Ìu_size_m­
[3]);

618 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "age", "%u", 
age
);

619 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "evicted",

620 "%Îu", ()
tÙ®s
.
eviùed
);

621 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "evicted_nonzero",

622 "%Îu", ()
tÙ®s
.
eviùed_nÚz”o
);

623 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "evicted_time",

624 "%u", 
tÙ®s
.
eviùed_time
);

625 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "outofmemory",

626 "%Îu", ()
tÙ®s
.
outofmemÜy
);

627 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "tailrepairs",

628 "%Îu", ()
tÙ®s
.
»·œs
);

629 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "reclaimed",

630 "%Îu", ()
tÙ®s
.
»şaimed
);

631 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "expired_unfetched",

632 "%Îu", ()
tÙ®s
.
expœed_unãtched
);

633 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "evicted_unfetched",

634 "%Îu", ()
tÙ®s
.
eviùed_unãtched
);

635 ià(
£‰šgs
.
Ìu_mašš”_th»ad
) {

636 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "evicted_active",

637 "%Îu", ()
tÙ®s
.
eviùed_aùive
);

639 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "crawler_reclaimed",

640 "%Îu", ()
tÙ®s
.
üawËr_»şaimed
);

641 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "crawler_items_checked",

642 "%Îu", ()
tÙ®s
.
üawËr_™ems_checked
);

643 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "lrutail_reflocked",

644 "%Îu", ()
tÙ®s
.
Ìu_»æocked
);

645 ià(
£‰šgs
.
Ìu_mašš”_th»ad
) {

646 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "moves_to_cold",

647 "%Îu", ()
tÙ®s
.
moves_to_cŞd
);

648 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "moves_to_warm",

649 "%Îu", ()
tÙ®s
.
moves_to_w¬m
);

650 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "moves_within_lru",

651 "%Îu", ()
tÙ®s
.
moves_w™hš_Ìu
);

652 
	`APPEND_NUM_FMT_STAT
(
fmt
, 
n
, "direct_reclaims",

653 "%Îu", ()
tÙ®s
.
dœeù_»şaims
);

658 
	`add_¡©s
(
NULL
, 0, NULL, 0, 
c
);

659 
	}
}

661 
boŞ
 
	$™em_¡©s_sizes_¡©us
() {

662 
boŞ
 
»t
 = 
çl£
;

663 
	`mu‹x_lock
(&
¡©s_sizes_lock
);

664 ià(
¡©s_sizes_hi¡
 !ğ
NULL
)

665 
»t
 = 
Œue
;

666 
	`mu‹x_uÆock
(&
¡©s_sizes_lock
);

667  
»t
;

668 
	}
}

670 
	$™em_¡©s_sizes_š™
() {

671 ià(
¡©s_sizes_hi¡
 !ğ
NULL
)

673 
¡©s_sizes_buck‘s
 = 
£‰šgs
.
™em_size_max
 / 32 + 1;

674 
¡©s_sizes_hi¡
 = 
	`ÿÎoc
(
¡©s_sizes_buck‘s
, ());

675 
¡©s_sizes_ÿs_mš
 = (
£‰šgs
.
u£_ÿs
è? 
	`g‘_ÿs_id
() : 0;

676 
	}
}

678 
	$™em_¡©s_sizes_’abË
(
ADD_STAT
 
add_¡©s
, *
c
) {

679 
	`mu‹x_lock
(&
¡©s_sizes_lock
);

680 ià(!
£‰šgs
.
u£_ÿs
) {

681 
	`APPEND_STAT
("sizes_status", "error", "");

682 
	`APPEND_STAT
("sizes_error", "cas_support_disabled", "");

683 } ià(
¡©s_sizes_hi¡
 =ğ
NULL
) {

684 
	`™em_¡©s_sizes_š™
();

685 ià(
¡©s_sizes_hi¡
 !ğ
NULL
) {

686 
	`APPEND_STAT
("sizes_status", "enabled", "");

688 
	`APPEND_STAT
("sizes_status", "error", "");

689 
	`APPEND_STAT
("sizes_error", "no_memory", "");

692 
	`APPEND_STAT
("sizes_status", "enabled", "");

694 
	`mu‹x_uÆock
(&
¡©s_sizes_lock
);

695 
	}
}

697 
	$™em_¡©s_sizes_di§bË
(
ADD_STAT
 
add_¡©s
, *
c
) {

698 
	`mu‹x_lock
(&
¡©s_sizes_lock
);

699 ià(
¡©s_sizes_hi¡
 !ğ
NULL
) {

700 
	`ä“
(
¡©s_sizes_hi¡
);

701 
¡©s_sizes_hi¡
 = 
NULL
;

703 
	`APPEND_STAT
("sizes_status", "disabled", "");

704 
	`mu‹x_uÆock
(&
¡©s_sizes_lock
);

705 
	}
}

707 
	$™em_¡©s_sizes_add
(
™em
 *
™
) {

708 ià(
¡©s_sizes_hi¡
 =ğ
NULL
 || 
¡©s_sizes_ÿs_mš
 > 
	`ITEM_g‘_ÿs
(
™
))

710 
ÁÙ®
 = 
	`ITEM_ÁÙ®
(
™
);

711 
buck‘
 = 
ÁÙ®
 / 32;

712 ià((
ÁÙ®
 % 32è!ğ0è
buck‘
++;

713 ià(
buck‘
 < 
¡©s_sizes_buck‘s
è
¡©s_sizes_hi¡
[bucket]++;

714 
	}
}

719 
	$™em_¡©s_sizes_»move
(
™em
 *
™
) {

720 ià(
¡©s_sizes_hi¡
 =ğ
NULL
 || 
¡©s_sizes_ÿs_mš
 > 
	`ITEM_g‘_ÿs
(
™
))

722 
ÁÙ®
 = 
	`ITEM_ÁÙ®
(
™
);

723 
buck‘
 = 
ÁÙ®
 / 32;

724 ià((
ÁÙ®
 % 32è!ğ0è
buck‘
++;

725 ià(
buck‘
 < 
¡©s_sizes_buck‘s
è
¡©s_sizes_hi¡
[bucket]--;

726 
	}
}

734 
	$™em_¡©s_sizes
(
ADD_STAT
 
add_¡©s
, *
c
) {

735 
	`mu‹x_lock
(&
¡©s_sizes_lock
);

737 ià(
¡©s_sizes_hi¡
 !ğ
NULL
) {

738 
i
;

739 
i
 = 0; i < 
¡©s_sizes_buck‘s
; i++) {

740 ià(
¡©s_sizes_hi¡
[
i
] != 0) {

741 
key
[8];

742 
	`¢´štf
(
key
, (key), "%d", 
i
 * 32);

743 
	`APPEND_STAT
(
key
, "%u", 
¡©s_sizes_hi¡
[
i
]);

747 
	`APPEND_STAT
("sizes_status", "disabled", "");

750 
	`add_¡©s
(
NULL
, 0, NULL, 0, 
c
);

751 
	`mu‹x_uÆock
(&
¡©s_sizes_lock
);

752 
	}
}

755 
™em
 *
	$do_™em_g‘
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
ušt32_t
 
hv
, 
cÚn
 *
c
) {

756 
™em
 *
™
 = 
	`assoc_fšd
(
key
, 
nkey
, 
hv
);

757 ià(
™
 !ğ
NULL
) {

758 
	`»fcouÁ_šü
(&
™
->
»fcouÁ
);

780 
was_found
 = 0;

782 ià(
£‰šgs
.
v”bo£
 > 2) {

783 
ii
;

784 ià(
™
 =ğ
NULL
) {

785 
	`årštf
(
¡d”r
, "> NOT FOUND ");

787 
	`årštf
(
¡d”r
, "> FOUND KEY ");

789 
ii
 = 0; i˜< 
nkey
; ++ii) {

790 
	`årštf
(
¡d”r
, "%c", 
key
[
ii
]);

794 ià(
™
 !ğ
NULL
) {

795 
was_found
 = 1;

796 ià(
	`™em_is_æushed
(
™
)) {

797 
	`do_™em_uÆšk
(
™
, 
hv
);

798 
	`do_™em_»move
(
™
);

799 
™
 = 
NULL
;

800 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

801 
c
->
th»ad
->
¡©s
.
g‘_æushed
++;

802 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

803 ià(
£‰šgs
.
v”bo£
 > 2) {

804 
	`årštf
(
¡d”r
, " -nuked by flush");

806 
was_found
 = 2;

807 } ià(
™
->
ex±ime
 !ğ0 && it->ex±im<ğ
cu¼’t_time
) {

808 
	`do_™em_uÆšk
(
™
, 
hv
);

809 
	`do_™em_»move
(
™
);

810 
™
 = 
NULL
;

811 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

812 
c
->
th»ad
->
¡©s
.
g‘_expœed
++;

813 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

814 ià(
£‰šgs
.
v”bo£
 > 2) {

815 
	`årštf
(
¡d”r
, " -nuked byƒxpire");

817 
was_found
 = 3;

819 
™
->
™_æags
 |ğ
ITEM_FETCHED
|
ITEM_ACTIVE
;

820 
	`DEBUG_REFCNT
(
™
, '+');

824 ià(
£‰šgs
.
v”bo£
 > 2)

825 
	`årštf
(
¡d”r
, "\n");

827 
	`LOGGER_LOG
(
c
->
th»ad
->
l
, 
LOG_FETCHERS
, 
LOGGER_ITEM_GET
, 
NULL
, 
was_found
, 
key
, 
nkey
,

828 (
™
è? 
	`ITEM_şsid
(it) : 0);

830  
™
;

831 
	}
}

833 
™em
 *
	$do_™em_touch
(cÚ¡ *
key
, 
size_t
 
nkey
, 
ušt32_t
 
ex±ime
,

834 cÚ¡ 
ušt32_t
 
hv
, 
cÚn
 *
c
) {

835 
™em
 *
™
 = 
	`do_™em_g‘
(
key
, 
nkey
, 
hv
, 
c
);

836 ià(
™
 !ğ
NULL
) {

837 
™
->
ex±ime
 =ƒxptime;

839  
™
;

840 
	}
}

846 
	$Ìu_puÎ_
(cÚ¡ 
Üig_id
, cÚ¡ 
cur_Ìu
,

847 cÚ¡ 
ušt64_t
 
tÙ®_by‹s
, 
ušt8_t
 
æags
) {

848 
™em
 *
™
 = 
NULL
;

849 
id
 = 
Üig_id
;

850 
»moved
 = 0;

851 ià(
id
 == 0)

854 
Œ›s
 = 5;

855 
™em
 *
£¬ch
;

856 
™em
 *
Ãxt_™
;

857 *
hŞd_lock
 = 
NULL
;

858 
move_to_Ìu
 = 0;

859 
ušt64_t
 
lim™
 = 0;

861 
id
 |ğ
cur_Ìu
;

862 
	`±h»ad_mu‹x_lock
(&
Ìu_locks
[
id
]);

863 
£¬ch
 = 
s
[
id
];

865 ; 
Œ›s
 > 0 && 
£¬ch
 !ğ
NULL
;r›s--, s—rch=
Ãxt_™
) {

867 
Ãxt_™
 = 
£¬ch
->
´ev
;

868 ià(
£¬ch
->
nby‹s
 =ğ0 && s—rch->
nkey
 =ğ0 && s—rch->
™_æags
 == 1) {

870 ià(
æags
 & 
LRU_PULL_CRAWL_BLOCKS
) {

871 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
id
]);

874 
Œ›s
++;

877 
ušt32_t
 
hv
 = 
	`hash
(
	`ITEM_key
(
£¬ch
), s—rch->
nkey
);

880 ià((
hŞd_lock
 = 
	`™em_Œylock
(
hv
)è=ğ
NULL
)

883 ià(
	`»fcouÁ_šü
(&
£¬ch
->
»fcouÁ
) != 2) {

886 
™em¡©s
[
id
].
Ìu_»æocked
++;

889 ià(
£‰šgs
.
_»·œ_time
 &&

890 
£¬ch
->
time
 + 
£‰šgs
.
_»·œ_time
 < 
cu¼’t_time
) {

891 
™em¡©s
[
id
].
»·œs
++;

892 
£¬ch
->
»fcouÁ
 = 1;

894 
	`do_™em_uÆšk_nŞock
(
£¬ch
, 
hv
);

895 
	`™em_Œylock_uÆock
(
hŞd_lock
);

901 ià((
£¬ch
->
ex±ime
 !ğ0 && s—rch->ex±im< 
cu¼’t_time
)

902 || 
	`™em_is_æushed
(
£¬ch
)) {

903 
™em¡©s
[
id
].
»şaimed
++;

904 ià((
£¬ch
->
™_æags
 & 
ITEM_FETCHED
) == 0) {

905 
™em¡©s
[
id
].
expœed_unãtched
++;

908 
	`do_™em_uÆšk_nŞock
(
£¬ch
, 
hv
);

910 
	`do_™em_»move
(
£¬ch
);

911 
	`™em_Œylock_uÆock
(
hŞd_lock
);

912 
»moved
++;

921 
cur_Ìu
) {

922 
HOT_LRU
:

923 
lim™
 = 
tÙ®_by‹s
 * 
£‰šgs
.
hÙ_Ìu_pù
 / 100;

924 
WARM_LRU
:

925 ià(
lim™
 == 0)

926 
lim™
 = 
tÙ®_by‹s
 * 
£‰šgs
.
w¬m_Ìu_pù
 / 100;

927 ià(
sizes_by‹s
[
id
] > 
lim™
) {

928 
™em¡©s
[
id
].
moves_to_cŞd
++;

929 
move_to_Ìu
 = 
COLD_LRU
;

930 
	`do_™em_uÆšk_q
(
£¬ch
);

931 
™
 = 
£¬ch
;

932 
»moved
++;

934 } ià((
£¬ch
->
™_æags
 & 
ITEM_ACTIVE
) != 0) {

936 
™em¡©s
[
id
].
moves_w™hš_Ìu
++;

937 
£¬ch
->
™_æags
 &ğ~
ITEM_ACTIVE
;

938 
	`do_™em_upd©e_nŞock
(
£¬ch
);

939 
	`do_™em_»move
(
£¬ch
);

940 
	`™em_Œylock_uÆock
(
hŞd_lock
);

943 
™
 = 
£¬ch
;

946 
COLD_LRU
:

947 
™
 = 
£¬ch
;

948 ià(
æags
 & 
LRU_PULL_EVICT
) {

949 ià(
£‰šgs
.
eviù_to_ä“
 == 0) {

953 
™em¡©s
[
id
].
eviùed
++;

954 
™em¡©s
[
id
].
eviùed_time
 = 
cu¼’t_time
 - 
£¬ch
->
time
;

955 ià(
£¬ch
->
ex±ime
 != 0)

956 
™em¡©s
[
id
].
eviùed_nÚz”o
++;

957 ià((
£¬ch
->
™_æags
 & 
ITEM_FETCHED
) == 0) {

958 
™em¡©s
[
id
].
eviùed_unãtched
++;

960 ià((
£¬ch
->
™_æags
 & 
ITEM_ACTIVE
)) {

961 
™em¡©s
[
id
].
eviùed_aùive
++;

963 
	`LOGGER_LOG
(
NULL
, 
LOG_EVICTIONS
, 
LOGGER_EVICTION
, 
£¬ch
);

964 
	`do_™em_uÆšk_nŞock
(
£¬ch
, 
hv
);

965 
»moved
++;

966 ià(
£‰šgs
.
¦ab_automove
 == 2) {

967 
	`¦abs_»assign
(-1, 
Üig_id
);

969 } ià((
£¬ch
->
™_æags
 & 
ITEM_ACTIVE
) != 0

970 && 
£‰šgs
.
Ìu_mašš”_th»ad
) {

971 
™em¡©s
[
id
].
moves_to_w¬m
++;

972 
£¬ch
->
™_æags
 &ğ~
ITEM_ACTIVE
;

973 
move_to_Ìu
 = 
WARM_LRU
;

974 
	`do_™em_uÆšk_q
(
£¬ch
);

975 
»moved
++;

979 ià(
™
 !ğ
NULL
)

983 
	`±h»ad_mu‹x_uÆock
(&
Ìu_locks
[
id
]);

985 ià(
™
 !ğ
NULL
) {

986 ià(
move_to_Ìu
) {

987 
™
->
¦abs_şsid
 = 
	`ITEM_şsid
(it);

988 
™
->
¦abs_şsid
 |ğ
move_to_Ìu
;

989 
	`™em_lšk_q
(
™
);

991 
	`do_™em_»move
(
™
);

992 
	`™em_Œylock_uÆock
(
hŞd_lock
);

995  
»moved
;

996 
	}
}

1006 
	$Ìu_mašš”_juggË
(cÚ¡ 
¦abs_şsid
) {

1007 
i
;

1008 
did_moves
 = 0;

1009 
boŞ
 
mem_lim™_»ached
 = 
çl£
;

1010 
ušt64_t
 
tÙ®_by‹s
 = 0;

1011 
chunks_³r¦ab
 = 0;

1012 
chunks_ä“
 = 0;

1014 
chunks_ä“
 = 
	`¦abs_avaabË_chunks
(
¦abs_şsid
, &
mem_lim™_»ached
,

1015 &
tÙ®_by‹s
, &
chunks_³r¦ab
);

1016 ià(
£‰šgs
.
expœez”o_dÛs_nÙ_eviù
)

1017 
tÙ®_by‹s
 -ğ
	`nÛxp_Ìu_size
(
¦abs_şsid
);

1023 ià(
£‰šgs
.
¦ab_automove
 > 0 && 
chunks_ä“
 > (
chunks_³r¦ab
 * 2.5)) {

1024 
	`¦abs_»assign
(
¦abs_şsid
, 
SLAB_GLOBAL_PAGE_POOL
);

1028 
i
 = 0; i < 1000; i++) {

1029 
do_mÜe
 = 0;

1030 ià(
	`Ìu_puÎ_
(
¦abs_şsid
, 
HOT_LRU
, 
tÙ®_by‹s
, 
LRU_PULL_CRAWL_BLOCKS
) ||

1031 
	`Ìu_puÎ_
(
¦abs_şsid
, 
WARM_LRU
, 
tÙ®_by‹s
, 
LRU_PULL_CRAWL_BLOCKS
)) {

1032 
do_mÜe
++;

1034 
do_mÜe
 +ğ
	`Ìu_puÎ_
(
¦abs_şsid
, 
COLD_LRU
, 
tÙ®_by‹s
, 
LRU_PULL_CRAWL_BLOCKS
);

1035 ià(
do_mÜe
 == 0)

1037 
did_moves
++;

1039  
did_moves
;

1040 
	}
}

1043 
	#MAX_MAINTCRAWL_WAIT
 60 * 60

	)

1056 
	$Ìu_mašš”_üawËr_check
(
üawËr_expœed_d©a
 *
cd©a
, 
logg”
 *
l
) {

1057 
i
;

1058 
»l_time_t
 
Ãxt_üawls
[
MAX_NUMBER_OF_SLAB_CLASSES
];

1059 
»l_time_t
 
Ãxt_üawl_wa™
[
MAX_NUMBER_OF_SLAB_CLASSES
];

1060 
ušt8_t
 
todo
[
MAX_NUMBER_OF_SLAB_CLASSES
];

1061 
	`mem£t
(
todo
, 0, (
ušt8_t
è* 
MAX_NUMBER_OF_SLAB_CLASSES
);

1062 
boŞ
 
do_run
 = 
çl£
;

1063 ià(!
cd©a
->
üawl_com¶‘e
) {

1067 
i
 = 
POWER_SMALLEST
; i < 
MAX_NUMBER_OF_SLAB_CLASSES
; i++) {

1068 
üawËr¡©s_t
 *
s
 = &
cd©a
->
üawËr¡©s
[
i
];

1070 ià(
s
->
run_com¶‘e
) {

1071 
	`±h»ad_mu‹x_lock
(&
cd©a
->
lock
);

1072 
x
;

1074 
ušt64_t
 
possibË_»şaims
 = 
s
->
£’
 - s->
nÛxp
;

1075 
ušt64_t
 
avaabË_»şaims
 = 0;

1079 
ušt64_t
 
low_w©”m¬k
 = (
possibË_»şaims
 / 100) + 1;

1080 
»l_time_t
 
sšû_run
 = 
cu¼’t_time
 - 
s
->
’d_time
;

1082 
x
 = 0; x < 60; x++) {

1083 
avaabË_»şaims
 +ğ
s
->
hi¡o
[
x
];

1084 ià(
avaabË_»şaims
 > 
low_w©”m¬k
) {

1085 ià(
Ãxt_üawl_wa™
[
i
] < (
x
 * 60)) {

1086 
Ãxt_üawl_wa™
[
i
] += 60;

1087 } ià(
Ãxt_üawl_wa™
[
i
] >= 60) {

1088 
Ãxt_üawl_wa™
[
i
] -= 60;

1094 ià(
avaabË_»şaims
 == 0) {

1095 
Ãxt_üawl_wa™
[
i
] += 60;

1098 ià(
Ãxt_üawl_wa™
[
i
] > 
MAX_MAINTCRAWL_WAIT
) {

1099 
Ãxt_üawl_wa™
[
i
] = 
MAX_MAINTCRAWL_WAIT
;

1102 
Ãxt_üawls
[
i
] = 
cu¼’t_time
 + 
Ãxt_üawl_wa™
[i] + 5;

1103 
	`LOGGER_LOG
(
l
, 
LOG_SYSEVENTS
, 
LOGGER_CRAWLER_STATUS
, 
NULL
, 
i
, ()
low_w©”m¬k
,

1104 ()
avaabË_»şaims
,

1105 ()
sšû_run
,

1106 
Ãxt_üawls
[
i
] - 
cu¼’t_time
,

1107 
s
->
’d_time
 - s->
¡¬t_time
,

1108 
s
->
£’
,

1109 
s
->
»şaimed
);

1111 
s
->
run_com¶‘e
 = 
çl£
;

1112 
	`±h»ad_mu‹x_uÆock
(&
cd©a
->
lock
);

1114 ià(
cu¼’t_time
 > 
Ãxt_üawls
[
i
]) {

1115 
todo
[
i
] = 1;

1116 
do_run
 = 
Œue
;

1117 
Ãxt_üawls
[
i
] = 
cu¼’t_time
 + 5;

1120 ià(
do_run
) {

1121 
	`Ìu_üawËr_¡¬t
(
todo
, 0, 
CRAWLER_EXPIRED
, 
cd©a
, 
NULL
, 0);

1123 
	}
}

1125 
±h»ad_t
 
	gÌu_mašš”_tid
;

1127 
	#MAX_LRU_MAINTAINER_SLEEP
 1000000

	)

1128 
	#MIN_LRU_MAINTAINER_SLEEP
 1000

	)

1130 *
	$Ìu_mašš”_th»ad
(*
¬g
) {

1131 
i
;

1132 
u£cÚds_t
 
to_¦“p
 = 
MIN_LRU_MAINTAINER_SLEEP
;

1133 
»l_time_t
 
Ï¡_üawËr_check
 = 0;

1134 
üawËr_expœed_d©a
 
cd©a
;

1135 
	`mem£t
(&
cd©a
, 0, (
üawËr_expœed_d©a
));

1136 
	`±h»ad_mu‹x_š™
(&
cd©a
.
lock
, 
NULL
);

1137 
cd©a
.
üawl_com¶‘e
 = 
Œue
;

1138 
logg”
 *
l
 = 
	`logg”_ü—‹
();

1139 ià(
l
 =ğ
NULL
) {

1140 
	`årštf
(
¡d”r
, "Failedo‡llocate†ogger for LRU maintainerhread\n");

1141 
	`abÜt
();

1144 
	`±h»ad_mu‹x_lock
(&
Ìu_mašš”_lock
);

1145 ià(
£‰šgs
.
v”bo£
 > 2)

1146 
	`årštf
(
¡d”r
, "Starting LRU maintainer backgroundhread\n");

1147 
do_run_Ìu_mašš”_th»ad
) {

1148 
did_moves
 = 0;

1149 
	`±h»ad_mu‹x_uÆock
(&
Ìu_mašš”_lock
);

1150 
	`u¦“p
(
to_¦“p
);

1151 
	`±h»ad_mu‹x_lock
(&
Ìu_mašš”_lock
);

1153 
	`STATS_LOCK
();

1154 
¡©s
.
Ìu_mašš”_juggËs
++;

1155 
	`STATS_UNLOCK
();

1158 ià(
Ìu_mašš”_check_şsid
 != 0) {

1159 
did_moves
 = 
	`Ìu_mašš”_juggË
(
Ìu_mašš”_check_şsid
);

1160 
Ìu_mašš”_check_şsid
 = 0;

1162 
i
 = 
POWER_SMALLEST
; i < 
MAX_NUMBER_OF_SLAB_CLASSES
; i++) {

1163 
did_moves
 +ğ
	`Ìu_mašš”_juggË
(
i
);

1166 ià(
did_moves
 == 0) {

1167 ià(
to_¦“p
 < 
MAX_LRU_MAINTAINER_SLEEP
)

1168 
to_¦“p
 += 1000;

1170 
to_¦“p
 /= 2;

1171 ià(
to_¦“p
 < 
MIN_LRU_MAINTAINER_SLEEP
)

1172 
to_¦“p
 = 
MIN_LRU_MAINTAINER_SLEEP
;

1175 ià(
£‰šgs
.
Ìu_üawËr
 && 
Ï¡_üawËr_check
 !ğ
cu¼’t_time
) {

1176 
	`Ìu_mašš”_üawËr_check
(&
cd©a
, 
l
);

1177 
Ï¡_üawËr_check
 = 
cu¼’t_time
;

1180 
	`±h»ad_mu‹x_uÆock
(&
Ìu_mašš”_lock
);

1181 ià(
£‰šgs
.
v”bo£
 > 2)

1182 
	`årštf
(
¡d”r
, "LRU maintainerhread stopping\n");

1184  
NULL
;

1185 
	}
}

1187 
	$¡İ_Ìu_mašš”_th»ad
() {

1188 
»t
;

1189 
	`±h»ad_mu‹x_lock
(&
Ìu_mašš”_lock
);

1191 
do_run_Ìu_mašš”_th»ad
 = 0;

1192 
	`±h»ad_mu‹x_uÆock
(&
Ìu_mašš”_lock
);

1193 ià((
»t
 = 
	`±h»ad_još
(
Ìu_mašš”_tid
, 
NULL
)) != 0) {

1194 
	`årštf
(
¡d”r
, "FaedØ¡İ LRU mašš”h»ad: %s\n", 
	`¡»¼Ü
(
»t
));

1197 
£‰šgs
.
Ìu_mašš”_th»ad
 = 
çl£
;

1199 
	}
}

1201 
	$¡¬t_Ìu_mašš”_th»ad
() {

1202 
»t
;

1204 
	`±h»ad_mu‹x_lock
(&
Ìu_mašš”_lock
);

1205 
do_run_Ìu_mašš”_th»ad
 = 1;

1206 
£‰šgs
.
Ìu_mašš”_th»ad
 = 
Œue
;

1207 ià((
»t
 = 
	`±h»ad_ü—‹
(&
Ìu_mašš”_tid
, 
NULL
,

1208 
Ìu_mašš”_th»ad
, 
NULL
)) != 0) {

1209 
	`årštf
(
¡d”r
, "Can't create LRU maintainerhread: %s\n",

1210 
	`¡»¼Ü
(
»t
));

1211 
	`±h»ad_mu‹x_uÆock
(&
Ìu_mašš”_lock
);

1214 
	`±h»ad_mu‹x_uÆock
(&
Ìu_mašš”_lock
);

1217 
	}
}

1220 
	$Ìu_mašš”_·u£
() {

1221 
	`±h»ad_mu‹x_lock
(&
Ìu_mašš”_lock
);

1222 
	}
}

1224 
	$Ìu_mašš”_»sume
() {

1225 
	`±h»ad_mu‹x_uÆock
(&
Ìu_mašš”_lock
);

1226 
	}
}

1228 
	$š™_Ìu_mašš”
() {

1229 ià(
Ìu_mašš”_š™Ÿlized
 == 0) {

1230 
	`±h»ad_mu‹x_š™
(&
Ìu_mašš”_lock
, 
NULL
);

1231 
Ìu_mašš”_š™Ÿlized
 = 1;

1234 
	}
}

1237 
	$do_™em_lšk_q
(
™em
 *
™
) {

1238 
™em
 **
h—d
, **

;

1239 
	`as£¹
(
™
->
™_æags
 == 1);

1240 
	`as£¹
(
™
->
nby‹s
 == 0);

1242 
h—d
 = &
h—ds
[
™
->
¦abs_şsid
];

1243 

 = &
s
[
™
->
¦abs_şsid
];

1245 
	`as£¹
(
™
 !ğ*

);

1246 
	`as£¹
((*
h—d
 && *

) || (*head == 0 && *tail == 0));

1247 
™
->
´ev
 = *

;

1248 
™
->
Ãxt
 = 0;

1249 ià(
™
->
´ev
) {

1250 
	`as£¹
(
™
->
´ev
->
Ãxt
 == 0);

1251 
™
->
´ev
->
Ãxt
 = it;

1253 *

 = 
™
;

1254 ià(*
h—d
 =ğ0è*h—d = 
™
;

1256 
	}
}

1258 
	$do_™em_uÆšk_q
(
™em
 *
™
) {

1259 
™em
 **
h—d
, **

;

1260 
h—d
 = &
h—ds
[
™
->
¦abs_şsid
];

1261 

 = &
s
[
™
->
¦abs_şsid
];

1263 ià(*
h—d
 =ğ
™
) {

1264 
	`as£¹
(
™
->
´ev
 == 0);

1265 *
h—d
 = 
™
->
Ãxt
;

1267 ià(*

 =ğ
™
) {

1268 
	`as£¹
(
™
->
Ãxt
 == 0);

1269 *

 = 
™
->
´ev
;

1271 
	`as£¹
(
™
->
Ãxt
 != it);

1272 
	`as£¹
(
™
->
´ev
 != it);

1274 ià(
™
->
Ãxt
è™->Ãxt->
´ev
 = it->prev;

1275 ià(
™
->
´ev
è™->´ev->
Ãxt
 = it->next;

1277 
	}
}

1281 
™em
 *
	$do_™em_üawl_q
(
™em
 *
™
) {

1282 
™em
 **
h—d
, **

;

1283 
	`as£¹
(
™
->
™_æags
 == 1);

1284 
	`as£¹
(
™
->
nby‹s
 == 0);

1285 
h—d
 = &
h—ds
[
™
->
¦abs_şsid
];

1286 

 = &
s
[
™
->
¦abs_şsid
];

1289 ià(
™
->
´ev
 == 0) {

1290 
	`as£¹
(*
h—d
 =ğ
™
);

1291 ià(
™
->
Ãxt
) {

1292 *
h—d
 = 
™
->
Ãxt
;

1293 
	`as£¹
(
™
->
Ãxt
->
´ev
 == it);

1294 
™
->
Ãxt
->
´ev
 = 0;

1296  
NULL
;

1301 
	`as£¹
(
™
->
´ev
 != it);

1302 ià(
™
->
´ev
) {

1303 ià(*
h—d
 =ğ
™
->
´ev
) {

1305 *
h—d
 = 
™
;

1307 ià(*

 =ğ
™
) {

1309 *

 = 
™
->
´ev
;

1311 
	`as£¹
(
™
->
Ãxt
 != it);

1312 ià(
™
->
Ãxt
) {

1313 
	`as£¹
(
™
->
´ev
->
Ãxt
 == it);

1314 
™
->
´ev
->
Ãxt
 = it->next;

1315 
™
->
Ãxt
->
´ev
 = it->prev;

1318 
™
->
´ev
->
Ãxt
 = 0;

1321 
™
->
Ãxt
 = it->
´ev
;

1322 
™
->
´ev
 = it->
Ãxt
->prev;

1323 
™
->
Ãxt
->
´ev
 = it;

1325 ià(
™
->
´ev
) {

1326 
™
->
´ev
->
Ãxt
 = it;

1329 
	`as£¹
(
™
->
Ãxt
 != it);

1330 
	`as£¹
(
™
->
´ev
 != it);

1332  
™
->
Ãxt
;

1333 
	}
}

	@items.h

1 
	#HOT_LRU
 0

	)

2 
	#WARM_LRU
 64

	)

3 
	#COLD_LRU
 128

	)

4 
	#NOEXP_LRU
 192

	)

6 
	#CLEAR_LRU
(
id
è(id & ~(3<<6))

	)

9 
ušt64_t
 
g‘_ÿs_id
();

12 
™em
 *
do_™em_®loc
(*
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
æags
, cÚ¡ 
»l_time_t
 
ex±ime
, cÚ¡ 
nby‹s
);

13 
™em_ä“
(
™em
 *
™
);

14 
boŞ
 
™em_size_ok
(cÚ¡ 
size_t
 
nkey
, cÚ¡ 
æags
, cÚ¡ 
nby‹s
);

16 
do_™em_lšk
(
™em
 *
™
, cÚ¡ 
ušt32_t
 
hv
);

17 
do_™em_uÆšk
(
™em
 *
™
, cÚ¡ 
ušt32_t
 
hv
);

18 
do_™em_uÆšk_nŞock
(
™em
 *
™
, cÚ¡ 
ušt32_t
 
hv
);

19 
do_™em_»move
(
™em
 *
™
);

20 
do_™em_upd©e
(
™em
 *
™
);

21 
do_™em_upd©e_nŞock
(
™em
 *
™
);

22 
do_™em_»¶aû
(
™em
 *
™
, i‹m *
Ãw_™
, cÚ¡ 
ušt32_t
 
hv
);

24 
™em_is_æushed
(
™em
 *
™
);

26 
do_™em_lšk_q
(
™em
 *
™
);

27 
do_™em_uÆšk_q
(
™em
 *
™
);

28 
™em
 *
do_™em_üawl_q
(™em *
™
);

31 *
™em_ÿchedump
(cÚ¡ 
¦abs_şsid
, cÚ¡ 
lim™
, *
by‹s
);

32 
™em_¡©s
(
ADD_STAT
 
add_¡©s
, *
c
);

33 
do_™em_¡©s_add_üawl
(cÚ¡ 
i
, cÚ¡ 
ušt64_t
 
»şaimed
,

34 cÚ¡ 
ušt64_t
 
unãtched
, cÚ¡ ušt64_ˆ
checked
);

35 
™em_¡©s_tÙ®s
(
ADD_STAT
 
add_¡©s
, *
c
);

37 
™em_¡©s_sizes
(
ADD_STAT
 
add_¡©s
, *
c
);

38 
™em_¡©s_sizes_š™
();

39 
™em_¡©s_sizes_’abË
(
ADD_STAT
 
add_¡©s
, *
c
);

40 
™em_¡©s_sizes_di§bË
(
ADD_STAT
 
add_¡©s
, *
c
);

41 
™em_¡©s_sizes_add
(
™em
 *
™
);

42 
™em_¡©s_sizes_»move
(
™em
 *
™
);

43 
boŞ
 
™em_¡©s_sizes_¡©us
();

45 
™em
 *
do_™em_g‘
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
ušt32_t
 
hv
, 
cÚn
 *
c
);

46 
™em
 *
do_™em_touch
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, 
ušt32_t
 
ex±ime
, cÚ¡ ušt32_ˆ
hv
, 
cÚn
 *
c
);

47 
™em_¡©s_»£t
();

48 
±h»ad_mu‹x_t
 
Ìu_locks
[
POWER_LARGEST
];

50 
¡¬t_Ìu_mašš”_th»ad
();

51 
¡İ_Ìu_mašš”_th»ad
();

52 
š™_Ìu_mašš”
();

53 
Ìu_mašš”_·u£
();

54 
Ìu_mašš”_»sume
();

	@jenkins_hash.c

12 
	~"memÿched.h
"

13 
	~"j’kšs_hash.h
"

20 #ià
ENDIAN_BIG
 == 1

21 
	#HASH_LITTLE_ENDIAN
 0

	)

22 
	#HASH_BIG_ENDIAN
 1

	)

24 #ià
ENDIAN_LITTLE
 == 1

25 
	#HASH_LITTLE_ENDIAN
 1

	)

26 
	#HASH_BIG_ENDIAN
 0

	)

28 
	#HASH_LITTLE_ENDIAN
 0

	)

29 
	#HASH_BIG_ENDIAN
 0

	)

33 
	#rÙ
(
x
,
k
è(((x)<<(k)è^ ((x)>>(32-(k))))

	)

79 
	#mix
(
a
,
b
,
c
) \

81 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c, 4); c +ğ
b
; \

82 
b
 -ğ
a
; b ^ğ
	`rÙ
×, 6);‡ +ğ
c
; \

83 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 8); b +ğ
a
; \

84 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c,16); c +ğ
b
; \

85 
b
 -ğ
a
; b ^ğ
	`rÙ
×,19);‡ +ğ
c
; \

86 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 4); b +ğ
a
; \

87 }

	)

114 
	#fš®
(
a
,
b
,
c
) \

116 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,14); \

117 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,11); \

118 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,25); \

119 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,16); \

120 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,4); \

121 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,14); \

122 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,24); \

123 }

	)

125 #ià
HASH_LITTLE_ENDIAN
 == 1

126 
ušt32_t
 
	$j’kšs_hash
(

127 cÚ¡ *
key
,

128 
size_t
 
Ëngth
)

130 
ušt32_t
 
a
,
b
,
c
;

131 uniÚ { cÚ¡ *
±r
; 
size_t
 
i
; } 
u
;

134 
a
 = 
b
 = 
c
 = 0xd—db“à+ ((
ušt32_t
)
Ëngth
) + 0;

136 
u
.
±r
 = 
key
;

137 ià(
HASH_LITTLE_ENDIAN
 && ((
u
.
i
 & 0x3) == 0)) {

138 cÚ¡ 
ušt32_t
 *
k
 = 
key
;

139 #ifdeà
VALGRIND


140 cÚ¡ 
ušt8_t
 *
k8
;

144 
Ëngth
 > 12)

146 
a
 +ğ
k
[0];

147 
b
 +ğ
k
[1];

148 
c
 +ğ
k
[2];

149 
	`mix
(
a
,
b
,
c
);

150 
Ëngth
 -= 12;

151 
k
 += 3;

164 #iâdeà
VALGRIND


166 
Ëngth
)

168 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

169 11: 
c
+=
k
[2]&0xffffff; 
b
+=k[1]; 
a
+=k[0]; ;

170 10: 
c
+=
k
[2]&0xffff; 
b
+=k[1]; 
a
+=k[0]; ;

171 9 : 
c
+=
k
[2]&0xff; 
b
+=k[1]; 
a
+=k[0]; ;

172 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

173 7 : 
b
+=
k
[1]&0xffffff; 
a
+=k[0]; ;

174 6 : 
b
+=
k
[1]&0xffff; 
a
+=k[0]; ;

175 5 : 
b
+=
k
[1]&0xff; 
a
+=k[0]; ;

176 4 : 
a
+=
k
[0]; ;

177 3 : 
a
+=
k
[0]&0xffffff; ;

178 2 : 
a
+=
k
[0]&0xffff; ;

179 1 : 
a
+=
k
[0]&0xff; ;

180 0 :  
c
;

185 
k8
 = (cÚ¡ 
ušt8_t
 *)
k
;

186 
Ëngth
)

188 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

189 11: 
c
+=((
ušt32_t
)
k8
[10])<<16;

190 10: 
c
+=((
ušt32_t
)
k8
[9])<<8;

191 9 : 
c
+=
k8
[8];

192 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

193 7 : 
b
+=((
ušt32_t
)
k8
[6])<<16;

194 6 : 
b
+=((
ušt32_t
)
k8
[5])<<8;

195 5 : 
b
+=
k8
[4];

196 4 : 
a
+=
k
[0]; ;

197 3 : 
a
+=((
ušt32_t
)
k8
[2])<<16;

198 2 : 
a
+=((
ušt32_t
)
k8
[1])<<8;

199 1 : 
a
+=
k8
[0]; ;

200 0 :  
c
;

205 } ià(
HASH_LITTLE_ENDIAN
 && ((
u
.
i
 & 0x1) == 0)) {

206 cÚ¡ 
ušt16_t
 *
k
 = 
key
;

207 cÚ¡ 
ušt8_t
 *
k8
;

210 
Ëngth
 > 12)

212 
a
 +ğ
k
[0] + (((
ušt32_t
)k[1])<<16);

213 
b
 +ğ
k
[2] + (((
ušt32_t
)k[3])<<16);

214 
c
 +ğ
k
[4] + (((
ušt32_t
)k[5])<<16);

215 
	`mix
(
a
,
b
,
c
);

216 
Ëngth
 -= 12;

217 
k
 += 6;

221 
k8
 = (cÚ¡ 
ušt8_t
 *)
k
;

222 
Ëngth
)

224 12: 
c
+=
k
[4]+(((
ušt32_t
)k[5])<<16);

225 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

226 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

228 11: 
c
+=((
ušt32_t
)
k8
[10])<<16;

229 10: 
c
+=
k
[4];

230 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

231 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

233 9 : 
c
+=
k8
[8];

234 8 : 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

235 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

237 7 : 
b
+=((
ušt32_t
)
k8
[6])<<16;

238 6 : 
b
+=
k
[2];

239 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

241 5 : 
b
+=
k8
[4];

242 4 : 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

244 3 : 
a
+=((
ušt32_t
)
k8
[2])<<16;

245 2 : 
a
+=
k
[0];

247 1 : 
a
+=
k8
[0];

249 0 :  
c
;

253 cÚ¡ 
ušt8_t
 *
k
 = 
key
;

256 
Ëngth
 > 12)

258 
a
 +ğ
k
[0];

259 
a
 +ğ((
ušt32_t
)
k
[1])<<8;

260 
a
 +ğ((
ušt32_t
)
k
[2])<<16;

261 
a
 +ğ((
ušt32_t
)
k
[3])<<24;

262 
b
 +ğ
k
[4];

263 
b
 +ğ((
ušt32_t
)
k
[5])<<8;

264 
b
 +ğ((
ušt32_t
)
k
[6])<<16;

265 
b
 +ğ((
ušt32_t
)
k
[7])<<24;

266 
c
 +ğ
k
[8];

267 
c
 +ğ((
ušt32_t
)
k
[9])<<8;

268 
c
 +ğ((
ušt32_t
)
k
[10])<<16;

269 
c
 +ğ((
ušt32_t
)
k
[11])<<24;

270 
	`mix
(
a
,
b
,
c
);

271 
Ëngth
 -= 12;

272 
k
 += 12;

276 
Ëngth
)

278 12: 
c
+=((
ušt32_t
)
k
[11])<<24;

279 11: 
c
+=((
ušt32_t
)
k
[10])<<16;

280 10: 
c
+=((
ušt32_t
)
k
[9])<<8;

281 9 : 
c
+=
k
[8];

282 8 : 
b
+=((
ušt32_t
)
k
[7])<<24;

283 7 : 
b
+=((
ušt32_t
)
k
[6])<<16;

284 6 : 
b
+=((
ušt32_t
)
k
[5])<<8;

285 5 : 
b
+=
k
[4];

286 4 : 
a
+=((
ušt32_t
)
k
[3])<<24;

287 3 : 
a
+=((
ušt32_t
)
k
[2])<<16;

288 2 : 
a
+=((
ušt32_t
)
k
[1])<<8;

289 1 : 
a
+=
k
[0];

291 0 :  
c
;

295 
	`fš®
(
a
,
b
,
c
);

296  
c
;

297 
	}
}

299 #–ià
HASH_BIG_ENDIAN
 == 1

306 
ušt32_t
 
	$j’kšs_hash
ĞcÚ¡ *
key
, 
size_t
 
Ëngth
)

308 
ušt32_t
 
a
,
b
,
c
;

309 uniÚ { cÚ¡ *
±r
; 
size_t
 
i
; } 
u
;

312 
a
 = 
b
 = 
c
 = 0xd—db“à+ ((
ušt32_t
)
Ëngth
) + 0;

314 
u
.
±r
 = 
key
;

315 ià(
HASH_BIG_ENDIAN
 && ((
u
.
i
 & 0x3) == 0)) {

316 cÚ¡ 
ušt32_t
 *
k
 = 
key
;

317 #ifdeà
VALGRIND


318 cÚ¡ 
ušt8_t
 *
k8
;

322 
Ëngth
 > 12)

324 
a
 +ğ
k
[0];

325 
b
 +ğ
k
[1];

326 
c
 +ğ
k
[2];

327 
	`mix
(
a
,
b
,
c
);

328 
Ëngth
 -= 12;

329 
k
 += 3;

342 #iâdeà
VALGRIND


344 
Ëngth
)

346 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

347 11: 
c
+=
k
[2]&0xffffff00; 
b
+=k[1]; 
a
+=k[0]; ;

348 10: 
c
+=
k
[2]&0xffff0000; 
b
+=k[1]; 
a
+=k[0]; ;

349 9 : 
c
+=
k
[2]&0xff000000; 
b
+=k[1]; 
a
+=k[0]; ;

350 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

351 7 : 
b
+=
k
[1]&0xffffff00; 
a
+=k[0]; ;

352 6 : 
b
+=
k
[1]&0xffff0000; 
a
+=k[0]; ;

353 5 : 
b
+=
k
[1]&0xff000000; 
a
+=k[0]; ;

354 4 : 
a
+=
k
[0]; ;

355 3 : 
a
+=
k
[0]&0xffffff00; ;

356 2 : 
a
+=
k
[0]&0xffff0000; ;

357 1 : 
a
+=
k
[0]&0xff000000; ;

358 0 :  
c
;

363 
k8
 = (cÚ¡ 
ušt8_t
 *)
k
;

364 
Ëngth
)

366 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

367 11: 
c
+=((
ušt32_t
)
k8
[10])<<8;

368 10: 
c
+=((
ušt32_t
)
k8
[9])<<16;

369 9 : 
c
+=((
ušt32_t
)
k8
[8])<<24;

370 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

371 7 : 
b
+=((
ušt32_t
)
k8
[6])<<8;

372 6 : 
b
+=((
ušt32_t
)
k8
[5])<<16;

373 5 : 
b
+=((
ušt32_t
)
k8
[4])<<24;

374 4 : 
a
+=
k
[0]; ;

375 3 : 
a
+=((
ušt32_t
)
k8
[2])<<8;

376 2 : 
a
+=((
ušt32_t
)
k8
[1])<<16;

377 1 : 
a
+=((
ušt32_t
)
k8
[0])<<24; ;

378 0 :  
c
;

384 cÚ¡ 
ušt8_t
 *
k
 = 
key
;

387 
Ëngth
 > 12)

389 
a
 +ğ((
ušt32_t
)
k
[0])<<24;

390 
a
 +ğ((
ušt32_t
)
k
[1])<<16;

391 
a
 +ğ((
ušt32_t
)
k
[2])<<8;

392 
a
 +ğ((
ušt32_t
)
k
[3]);

393 
b
 +ğ((
ušt32_t
)
k
[4])<<24;

394 
b
 +ğ((
ušt32_t
)
k
[5])<<16;

395 
b
 +ğ((
ušt32_t
)
k
[6])<<8;

396 
b
 +ğ((
ušt32_t
)
k
[7]);

397 
c
 +ğ((
ušt32_t
)
k
[8])<<24;

398 
c
 +ğ((
ušt32_t
)
k
[9])<<16;

399 
c
 +ğ((
ušt32_t
)
k
[10])<<8;

400 
c
 +ğ((
ušt32_t
)
k
[11]);

401 
	`mix
(
a
,
b
,
c
);

402 
Ëngth
 -= 12;

403 
k
 += 12;

407 
Ëngth
)

409 12: 
c
+=
k
[11];

410 11: 
c
+=((
ušt32_t
)
k
[10])<<8;

411 10: 
c
+=((
ušt32_t
)
k
[9])<<16;

412 9 : 
c
+=((
ušt32_t
)
k
[8])<<24;

413 8 : 
b
+=
k
[7];

414 7 : 
b
+=((
ušt32_t
)
k
[6])<<8;

415 6 : 
b
+=((
ušt32_t
)
k
[5])<<16;

416 5 : 
b
+=((
ušt32_t
)
k
[4])<<24;

417 4 : 
a
+=
k
[3];

418 3 : 
a
+=((
ušt32_t
)
k
[2])<<8;

419 2 : 
a
+=((
ušt32_t
)
k
[1])<<16;

420 1 : 
a
+=((
ušt32_t
)
k
[0])<<24;

422 0 :  
c
;

426 
	`fš®
(
a
,
b
,
c
);

427  
c
;

428 
	}
}

430 #”rÜ 
Mu¡
 
defše
 
HASH_BIG_ENDIAN
 
Ü
 
HASH_LITTLE_ENDIAN


	@jenkins_hash.h

1 #iâdeà
JENKINS_HASH_H


2 
	#JENKINS_HASH_H


	)

4 #ifdeà 
__ılu¥lus


8 
ušt32_t
 
j’kšs_hash
(cÚ¡ *
key
, 
size_t
 
Ëngth
);

10 #ifdeà 
__ılu¥lus


	@logger.c

3 
	~<¡dlib.h
>

4 
	~<¡dio.h
>

5 
	~<¡ršg.h
>

6 
	~<”ºo.h
>

7 
	~<pŞl.h
>

8 
	~<ùy³.h
>

10 #ià
defšed
(
__sun
)

11 
	~<©omic.h
>

14 
	~"memÿched.h
"

15 
	~"bbufãr.h
"

17 #ifdeà
LOGGER_DEBUG


18 
	#L_DEBUG
(...) \

20 
	`årštf
(
¡d”r
, 
__VA_ARGS__
); \

21 } 0)

	)

23 
	#L_DEBUG
(...)

	)

28 
logg”
 *
	glogg”_¡ack_h—d
 = 
NULL
;

29 
logg”
 *
	glogg”_¡ack_
 = 
NULL
;

30 
	glogg”_couÁ
 = 0;

31 vŞ©
	gdo_run_logg”_th»ad
 = 1;

32 
±h»ad_t
 
	glogg”_tid
;

33 
±h»ad_mu‹x_t
 
	glogg”_¡ack_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

35 
±h»ad_key_t
 
	glogg”_key
;

37 #ià!
defšed
(
HAVE_GCC_64ATOMICS
è&& !defšed(
__sun
)

38 
±h»ad_mu‹x_t
 
	glogg”_©omics_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

41 
	#WATCHER_LIMIT
 20

	)

42 
logg”_w©ch”
 *
	gw©ch”s
[20];

43 
pŞlfd
 
	gw©ch”s_pŞlfds
[20];

44 
	gw©ch”_couÁ
 = 0;

47 cÚ¡ 
’Œy_d‘as
 
	gdeçuÉ_’Œ›s
[] = {

48 [
LOGGER_ASCII_CMD
] = {
LOGGER_TEXT_ENTRY
, 512, 
LOG_RAWCMDS
, "<%d %s"},

49 [
LOGGER_EVICTION
] = {
LOGGER_EVICTION_ENTRY
, 512, 
LOG_EVICTIONS
, 
NULL
},

50 [
LOGGER_ITEM_GET
] = {
LOGGER_ITEM_GET_ENTRY
, 512, 
LOG_FETCHERS
, 
NULL
},

51 [
LOGGER_ITEM_STORE
] = {
LOGGER_ITEM_STORE_ENTRY
, 512, 
LOG_MUTATIONS
, 
NULL
},

52 [
LOGGER_CRAWLER_STATUS
] = {
LOGGER_TEXT_ENTRY
, 512, 
LOG_SYSEVENTS
,

57 
	#WATCHER_ALL
 -1

	)

58 
logg”_th»ad_pŞl_w©ch”s
(
fÜû_pŞl
, 
w©ch”
);

66 
ušt64_t
 
	$logg”_g‘_gid
() {

67 
ušt64_t
 
logg”_gid
 = 0;

68 #ifdeà
HAVE_GCC_64ATOMICS


69  
	`__sync_add_ªd_ãtch
(&
logg”_gid
, 1);

70 #–ià
	`defšed
(
__sun
)

71  
	`©omic_šc_64_nv
(&
logg”_gid
);

73 
	`mu‹x_lock
(&
logg”_©omics_mu‹x
);

74 
ušt64_t
 
»s
 = ++
logg”_gid
;

75 
	`mu‹x_uÆock
(&
logg”_©omics_mu‹x
);

76  
»s
;

78 
	}
}

84 
	$logg”_lšk_q
(
logg”
 *
l
) {

85 
	`±h»ad_mu‹x_lock
(&
logg”_¡ack_lock
);

86 
	`as£¹
(
l
 !ğ
logg”_¡ack_h—d
);

88 
l
->
´ev
 = 0;

89 
l
->
Ãxt
 = 
logg”_¡ack_h—d
;

90 ià(
l
->
Ãxt
èl->Ãxt->
´ev
 =†;

91 
logg”_¡ack_h—d
 = 
l
;

92 ià(
logg”_¡ack_
 =ğ0èlogg”_¡ack_ = 
l
;

93 
logg”_couÁ
++;

94 
	`±h»ad_mu‹x_uÆock
(&
logg”_¡ack_lock
);

96 
	}
}

122 
	$logg”_£t_æags
() {

123 
logg”
 *
l
 = 
NULL
;

124 
x
 = 0;

125 
ušt16_t
 
f
 = 0;

127 
x
 = 0; x < 
WATCHER_LIMIT
; x++) {

128 
logg”_w©ch”
 *
w
 = 
w©ch”s
[
x
];

129 ià(
w
 =ğ
NULL
)

132 
f
 |ğ
w
->
eæags
;

134 
l
 = 
logg”_¡ack_h—d
;† !ğ
NULL
;†ö->
Ãxt
) {

135 
	`±h»ad_mu‹x_lock
(&
l
->
mu‹x
);

136 
l
->
eæags
 = 
f
;

137 
	`±h»ad_mu‹x_uÆock
(&
l
->
mu‹x
);

140 
	}
}

147 
	#LOGGER_PARSE_SCRATCH
 4096

	)

149 
	$_logg”_th»ad_·r£_i£
(
log’Œy
 *
e
, *
sü©ch
) {

150 
tÙ®
;

151 cÚ¡ *
cmd
 = "na";

152 
keybuf
[
KEY_MAX_LENGTH
 * 3 + 1];

153 
log’Œy_™em_¡Üe
 *
Ë
 = (log’Œy_™em_¡Ü*è
e
->
d©a
;

154 cÚ¡ * cÚ¡ 
¡©us_m­
[] = {

156 cÚ¡ * cÚ¡ 
cmd_m­
[] = {

159 ià(
Ë
->
cmd
 <= 5)

160 
cmd
 = 
cmd_m­
[
Ë
->cmd];

162 
	`ur›ncode
(
Ë
->
key
, 
keybuf
,†e->
nkey
, 
LOGGER_PARSE_SCRATCH
);

163 
tÙ®
 = 
	`¢´štf
(
sü©ch
, 
LOGGER_PARSE_SCRATCH
,

165 ()
e
->
tv
.
tv_£c
, (ë->tv.
tv_u£c
, (èe->
gid
,

166 
keybuf
, 
¡©us_m­
[
Ë
->
¡©us
], 
cmd
,†e->
‰l
,†e->
şsid
);

167  
tÙ®
;

168 
	}
}

170 
	$_logg”_th»ad_·r£_ige
(
log’Œy
 *
e
, *
sü©ch
) {

171 
tÙ®
;

172 
log’Œy_™em_g‘
 *
Ë
 = (log’Œy_™em_g‘ *è
e
->
d©a
;

173 
keybuf
[
KEY_MAX_LENGTH
 * 3 + 1];

174 cÚ¡ * cÚ¡ 
was_found_m­
[] = {

177 
	`ur›ncode
(
Ë
->
key
, 
keybuf
,†e->
nkey
, 
LOGGER_PARSE_SCRATCH
);

178 
tÙ®
 = 
	`¢´štf
(
sü©ch
, 
LOGGER_PARSE_SCRATCH
,

180 ()
e
->
tv
.
tv_£c
, (ë->tv.
tv_u£c
, (èe->
gid
,

181 
keybuf
, 
was_found_m­
[
Ë
->
was_found
],†e->
şsid
);

182  
tÙ®
;

183 
	}
}

185 
	$_logg”_th»ad_·r£_“
(
log’Œy
 *
e
, *
sü©ch
) {

186 
tÙ®
;

187 
keybuf
[
KEY_MAX_LENGTH
 * 3 + 1];

188 
log’Œy_eviùiÚ
 *
Ë
 = (log’Œy_eviùiÚ *è
e
->
d©a
;

189 
	`ur›ncode
(
Ë
->
key
, 
keybuf
,†e->
nkey
, 
LOGGER_PARSE_SCRATCH
);

190 
tÙ®
 = 
	`¢´štf
(
sü©ch
, 
LOGGER_PARSE_SCRATCH
,

192 ()
e
->
tv
.
tv_£c
, (ë->tv.
tv_u£c
, (èe->
gid
,

193 
keybuf
, (
Ë
->
™_æags
 & 
ITEM_FETCHED
) ? "yes" : "no",

194 ()
Ë
->
ex±ime
,†e->
Ïtime
,†e->
şsid
);

196  
tÙ®
;

197 
	}
}

200 
logg”_·r£_’Œy_»t
 
	$logg”_th»ad_·r£_’Œy
(
log’Œy
 *
e
, 
logg”_¡©s
 *
ls
,

201 *
sü©ch
, *
sü©ch_Ën
) {

202 
tÙ®
 = 0;

204 
e
->
ev’t
) {

205 
LOGGER_TEXT_ENTRY
:

206 
tÙ®
 = 
	`¢´štf
(
sü©ch
, 
LOGGER_PARSE_SCRATCH
, "ts=%d.%d gid=%llu %s\n",

207 ()
e
->
tv
.
tv_£c
, (ë->tv.
tv_u£c
,

208 (è
e
->
gid
, (*èe->
d©a
);

210 
LOGGER_EVICTION_ENTRY
:

211 
tÙ®
 = 
	`_logg”_th»ad_·r£_“
(
e
, 
sü©ch
);

213 
LOGGER_ITEM_GET_ENTRY
:

214 
tÙ®
 = 
	`_logg”_th»ad_·r£_ige
(
e
, 
sü©ch
);

216 
LOGGER_ITEM_STORE_ENTRY
:

217 
tÙ®
 = 
	`_logg”_th»ad_·r£_i£
(
e
, 
sü©ch
);

222 ià(
tÙ®
 >ğ
LOGGER_PARSE_SCRATCH
 ||otal <= 0) {

223 
	`L_DEBUG
("LOGGER: Failedo flatten†ogƒntry!\n");

224  
LOGGER_PARSE_ENTRY_FAILED
;

226 *
sü©ch_Ën
 = 
tÙ®
;

229  
LOGGER_PARSE_ENTRY_OK
;

230 
	}
}

233 
	$logg”_th»ad_wr™e_’Œy
(
log’Œy
 *
e
, 
logg”_¡©s
 *
ls
,

234 *
sü©ch
, 
sü©ch_Ën
) {

235 
x
, 
tÙ®
;

237 
x
 = 0; x < 
WATCHER_LIMIT
; x++) {

238 
logg”_w©ch”
 *
w
 = 
w©ch”s
[
x
];

239 *
sk_sü
 = 
NULL
;

240 ià(
w
 =ğ
NULL
 || (
e
->
eæags
 & w->eflags) == 0)

246 !
w
->
çed_æush
 &&

247 (
sk_sü
 = (*è
	`bbuf_»que¡
(
w
->
buf
, 
sü©ch_Ën
 + 128)è=ğ
NULL
) {

248 ià(
	`logg”_th»ad_pŞl_w©ch”s
(0, 
x
) <= 0) {

249 
	`L_DEBUG
("LOGGER: W©ch” had‚Øä“ s·û fÜ†šoàsiz(%d)\n", 
sü©ch_Ën
 + 128);

250 
w
->
çed_æush
 = 
Œue
;

254 ià(
w
->
çed_æush
) {

255 
	`L_DEBUG
("LOGGER: Fa¡ sk³d fÜ w©ch” [%d] dutØçed_æush\n", 
w
->
sfd
);

256 
w
->
sk³d
++;

257 
ls
->
w©ch”_sk³d
++;

261 ià(
w
->
sk³d
 > 0) {

262 
tÙ®
 = 
	`¢´štf
(
sk_sü
, 128, "sk³d=%Îu\n", (è
w
->
sk³d
);

263 ià(
tÙ®
 >= 128 ||otal <= 0) {

264 
	`L_DEBUG
("LOGGER: FaedØæ©‹Àsk³d mes§gštØw©ch” [%d]\n", 
w
->
sfd
);

265 
w
->
sk³d
++;

266 
ls
->
w©ch”_sk³d
++;

269 
	`bbuf_push
(
w
->
buf
, 
tÙ®
);

270 
w
->
sk³d
 = 0;

273 
	`bbuf_ofãr
(
w
->
buf
, (*è
sü©ch
, 
sü©ch_Ën
);

274 
ls
->
w©ch”_£Á
++;

276 
	}
}

283 
	$logg”_th»ad_şo£_w©ch”
(
logg”_w©ch”
 *
w
) {

284 
	`L_DEBUG
("LOGGER: Closing dead watcher\n");

285 
w©ch”s
[
w
->
id
] = 
NULL
;

286 
	`sid‘h»ad_cÚn_şo£
(
w
->
c
);

287 
w©ch”_couÁ
--;

288 
	`bbuf_ä“
(
w
->
buf
);

289 
	`ä“
(
w
);

290 
	`logg”_£t_æags
();

291 
	}
}

296 
	$logg”_th»ad_»ad
(
logg”
 *
l
, 
logg”_¡©s
 *
ls
) {

297 
size
;

298 
pos
 = 0;

299 *
d©a
;

300 
sü©ch
[
LOGGER_PARSE_SCRATCH
];

301 
log’Œy
 *
e
;

302 
	`±h»ad_mu‹x_lock
(&
l
->
mu‹x
);

303 
d©a
 = 
	`bbuf_³ek_®l
(
l
->
buf
, &
size
);

304 
	`±h»ad_mu‹x_uÆock
(&
l
->
mu‹x
);

306 ià(
d©a
 =ğ
NULL
) {

309 
	`L_DEBUG
("LOGGER: GÙ %d by‹ äom bbufãr\n", 
size
);

312 
pos
 < 
size
 && 
w©ch”_couÁ
 > 0) {

313 
logg”_·r£_’Œy_»t
 
»t
;

314 
sü©ch_Ën
 = 0;

315 
e
 = (
log’Œy
 *è(
d©a
 + 
pos
);

316 
»t
 = 
	`logg”_th»ad_·r£_’Œy
(
e
, 
ls
, 
sü©ch
, &
sü©ch_Ën
);

317 ià(
»t
 !ğ
LOGGER_PARSE_ENTRY_OK
) {

319 
	`årštf
(
¡d”r
, "LOGGER: Failedo…arse†ogƒntry\n");

321 
	`logg”_th»ad_wr™e_’Œy
(
e
, 
ls
, 
sü©ch
, 
sü©ch_Ën
);

323 
pos
 +ğ(
log’Œy
è+ 
e
->
size
;

325 
	`as£¹
(
pos
 <ğ
size
);

327 
	`±h»ad_mu‹x_lock
(&
l
->
mu‹x
);

328 
d©a
 = 
	`bbuf_pŞl
(
l
->
buf
, 
size
);

329 
ls
->
wÜk”_wr™‹n
 +ğ
l
->
wr™‹n
;

330 
ls
->
wÜk”_drİ³d
 +ğ
l
->
drİ³d
;

331 
l
->
wr™‹n
 = 0;

332 
l
->
drİ³d
 = 0;

333 
	`±h»ad_mu‹x_uÆock
(&
l
->
mu‹x
);

334 ià(
d©a
 =ğ
NULL
) {

335 
	`årštf
(
¡d”r
, "LOGGER: unexpectedly couldn't‡dvance buf…ointer\n");

336 
	`as£¹
(0);

338  
size
;

339 
	}
}

352 
	$logg”_th»ad_pŞl_w©ch”s
(
fÜû_pŞl
, 
w©ch”
) {

353 
x
;

354 
nfd
 = 0;

355 *
d©a
;

356 
d©a_size
 = 0;

357 
æushed
 = 0;

359 
x
 = 0; x < 
WATCHER_LIMIT
; x++) {

360 
logg”_w©ch”
 *
w
 = 
w©ch”s
[
x
];

361 ià(
w
 =ğ
NULL
 || (
w©ch”
 !ğ
WATCHER_ALL
 && 
x
 != watcher))

364 
d©a
 = 
	`bbuf_³ek_®l
(
w
->
buf
, &
d©a_size
);

365 ià(
d©a
 !ğ
NULL
) {

366 
w©ch”s_pŞlfds
[
nfd
].
fd
 = 
w
->
sfd
;

367 
w©ch”s_pŞlfds
[
nfd
].
ev’ts
 = 
POLLOUT
;

368 
nfd
++;

369 } ià(
fÜû_pŞl
) {

370 
w©ch”s_pŞlfds
[
nfd
].
fd
 = 
w
->
sfd
;

371 
w©ch”s_pŞlfds
[
nfd
].
ev’ts
 = 
POLLIN
;

372 
nfd
++;

377 
w
->
çed_æush
 = 
çl£
;

380 ià(
nfd
 == 0)

384 
»t
 = 
	`pŞl
(
w©ch”s_pŞlfds
, 
nfd
, 0);

386 ià(
»t
 < 0) {

387 
	`³¼Ü
("something failed with†oggerhread watcher fd…olling");

391 
nfd
 = 0;

392 
x
 = 0; x < 
WATCHER_LIMIT
; x++) {

393 
logg”_w©ch”
 *
w
 = 
w©ch”s
[
x
];

394 ià(
w
 =ğ
NULL
)

397 
d©a_size
 = 0;

401 ià(
w©ch”s_pŞlfds
[
nfd
].
»v’ts
 & 
POLLIN
) {

402 
buf
[1];

403 
»s
 = 
	`»ad
(
w
->
sfd
, 
buf
, 1);

404 ià(
»s
 =ğ0 || (» =ğ-1 && (
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EWOULDBLOCK
))) {

405 
	`L_DEBUG
("LOGGER: watcher closed„emotely\n");

406 
	`logg”_th»ad_şo£_w©ch”
(
w
);

407 
nfd
++;

411 ià((
d©a
 = 
	`bbuf_³ek_®l
(
w
->
buf
, &
d©a_size
)è!ğ
NULL
) {

412 ià(
w©ch”s_pŞlfds
[
nfd
].
»v’ts
 & (
POLLHUP
|
POLLERR
)) {

413 
	`L_DEBUG
("LOGGER: watcher closed during…oll() call\n");

414 
	`logg”_th»ad_şo£_w©ch”
(
w
);

415 } ià(
w©ch”s_pŞlfds
[
nfd
].
»v’ts
 & 
POLLOUT
) {

416 
tÙ®
 = 0;

419 
w
->
t
) {

420 
LOGGER_WATCHER_STDERR
:

421 
tÙ®
 = 
	`fwr™e
(
d©a
, 1, 
d©a_size
, 
¡d”r
);

423 
LOGGER_WATCHER_CLIENT
:

424 
tÙ®
 = 
	`wr™e
(
w
->
sfd
, 
d©a
, 
d©a_size
);

428 
	`L_DEBUG
("LOGGER:…Şl(èwrÙ%dØ%d (d©a_size: %dè(bbuf_u£d: %d)\n", 
tÙ®
, 
w
->
sfd
,

429 
d©a_size
, 
	`bbuf_u£d
(
w
->
buf
));

430 ià(
tÙ®
 == -1) {

431 ià(
”ºo
 !ğ
EAGAIN
 &&ƒ¼nØ!ğ
EWOULDBLOCK
) {

432 
	`logg”_th»ad_şo£_w©ch”
(
w
);

434 
	`L_DEBUG
("LOGGER: watcher hit EAGAIN\n");

435 } ià(
tÙ®
 == 0) {

436 
	`logg”_th»ad_şo£_w©ch”
(
w
);

438 
	`bbuf_pŞl
(
w
->
buf
, 
tÙ®
);

439 
æushed
 +ğ
tÙ®
;

443 
nfd
++;

445  
æushed
;

446 
	}
}

448 
	$logg”_th»ad_sum_¡©s
(
logg”_¡©s
 *
ls
) {

449 
	`STATS_LOCK
();

450 
¡©s
.
log_wÜk”_drİ³d
 +ğ
ls
->
wÜk”_drİ³d
;

451 
¡©s
.
log_wÜk”_wr™‹n
 +ğ
ls
->
wÜk”_wr™‹n
;

452 
¡©s
.
log_w©ch”_sk³d
 +ğ
ls
->
w©ch”_sk³d
;

453 
¡©s
.
log_w©ch”_£Á
 +ğ
ls
->
w©ch”_£Á
;

454 
	`STATS_UNLOCK
();

455 
	}
}

457 
	#MAX_LOGGER_SLEEP
 100000

	)

458 
	#MIN_LOGGER_SLEEP
 0

	)

461 *
	$logg”_th»ad
(*
¬g
) {

462 
u£cÚds_t
 
to_¦“p
 = 
MIN_LOGGER_SLEEP
;

463 
	`L_DEBUG
("LOGGER: Starting†oggerhread\n");

464 
do_run_logg”_th»ad
) {

465 
found_logs
 = 0;

466 
logg”
 *
l
;

467 
logg”_¡©s
 
ls
;

468 
	`mem£t
(&
ls
, 0, (
logg”_¡©s
));

469 ià(
to_¦“p
)

470 
	`u¦“p
(
to_¦“p
);

473 
	`±h»ad_mu‹x_lock
(&
logg”_¡ack_lock
);

474 
l
 = 
logg”_¡ack_h—d
;† !ğ
NULL
;†ö->
Ãxt
) {

476 
found_logs
 +ğ
	`logg”_th»ad_»ad
(
l
, &
ls
);

479 
	`logg”_th»ad_pŞl_w©ch”s
(1, 
WATCHER_ALL
);

480 
	`±h»ad_mu‹x_uÆock
(&
logg”_¡ack_lock
);

483 ià(!
found_logs
) {

484 ià(
to_¦“p
 < 
MAX_LOGGER_SLEEP
)

485 
to_¦“p
 += 50;

487 
to_¦“p
 /= 2;

488 ià(
to_¦“p
 < 50)

489 
to_¦“p
 = 
MIN_LOGGER_SLEEP
;

491 
	`logg”_th»ad_sum_¡©s
(&
ls
);

494  
NULL
;

495 
	}
}

497 
	$¡¬t_logg”_th»ad
() {

498 
»t
;

499 
do_run_logg”_th»ad
 = 1;

500 ià((
»t
 = 
	`±h»ad_ü—‹
(&
logg”_tid
, 
NULL
,

501 
logg”_th»ad
, 
NULL
)) != 0) {

502 
	`årštf
(
¡d”r
, "Cª'ˆ¡¬ˆlogg”h»ad: %s\n", 
	`¡»¼Ü
(
»t
));

506 
	}
}

520 
	$logg”_š™
() {

525 
logg”_¡ack_h—d
 = 0;

526 
logg”_¡ack_
 = 0;

527 
	`±h»ad_key_ü—‹
(&
logg”_key
, 
NULL
);

529 ià(
	`¡¬t_logg”_th»ad
() != 0) {

530 
	`abÜt
();

534 
	`STATS_LOCK
();

535 
¡©s
.
log_wÜk”_drİ³d
 = 0;

536 
¡©s
.
log_wÜk”_wr™‹n
 = 0;

537 
¡©s
.
log_w©ch”_sk³d
 = 0;

538 
¡©s
.
log_w©ch”_£Á
 = 0;

539 
	`STATS_UNLOCK
();

544 
	}
}

549 
logg”
 *
	$logg”_ü—‹
() {

550 
	`L_DEBUG
("LOGGER: Creating‡nd†inking‚ew†ogger instance\n");

551 
logg”
 *
l
 = 
	`ÿÎoc
(1, (logger));

552 ià(
l
 =ğ
NULL
) {

553  
NULL
;

556 
l
->
buf
 = 
	`bbuf_Ãw
(
£‰šgs
.
logg”_buf_size
);

557 ià(
l
->
buf
 =ğ
NULL
) {

558 
	`ä“
(
l
);

559  
NULL
;

562 
l
->
’Œy_m­
 = 
deçuÉ_’Œ›s
;

564 
	`±h»ad_mu‹x_š™
(&
l
->
mu‹x
, 
NULL
);

565 
	`±h»ad_£t¥ecific
(
logg”_key
, 
l
);

568 
	`logg”_lšk_q
(
l
);

569  
l
;

570 
	}
}

574 
	$_logg”_log_eviùiÚs
(
log’Œy
 *
e
, 
™em
 *
™
) {

575 
log’Œy_eviùiÚ
 *
Ë
 = (log’Œy_eviùiÚ *è
e
->
d©a
;

576 
Ë
->
ex±ime
 = (
™
->ex±im> 0è? ()(™->ex±im- 
cu¼’t_time
) : () -1;

577 
Ë
->
Ïtime
 = 
cu¼’t_time
 - 
™
->
time
;

578 
Ë
->
™_æags
 = 
™
->it_flags;

579 
Ë
->
nkey
 = 
™
->nkey;

580 
Ë
->
şsid
 = 
	`ITEM_şsid
(
™
);

581 
	`memıy
(
Ë
->
key
, 
	`ITEM_key
(
™
), it->
nkey
);

582 
e
->
size
 = (
log’Œy_eviùiÚ
è+ 
Ë
->
nkey
;

583 
	}
}

591 
	$_logg”_log_™em_g‘
(
log’Œy
 *
e
, cÚ¡ 
was_found
, cÚ¡ *
key
,

592 cÚ¡ 
nkey
, cÚ¡ 
ušt8_t
 
şsid
) {

593 
log’Œy_™em_g‘
 *
Ë
 = (log’Œy_™em_g‘ *è
e
->
d©a
;

594 
Ë
->
was_found
 = was_found;

595 
Ë
->
nkey
 =‚key;

596 
Ë
->
şsid
 = clsid;

597 
	`memıy
(
Ë
->
key
, key, 
nkey
);

598 
e
->
size
 = (
log’Œy_™em_g‘
è+ 
nkey
;

599 
	}
}

601 
	$_logg”_log_™em_¡Üe
(
log’Œy
 *
e
, cÚ¡ 
¡Üe_™em_ty³
 
¡©us
,

602 cÚ¡ 
comm
, *
key
, cÚ¡ 
nkey
, 
»l_time_t
 
‰l
, cÚ¡ 
ušt8_t
 
şsid
) {

603 
log’Œy_™em_¡Üe
 *
Ë
 = (log’Œy_™em_¡Ü*è
e
->
d©a
;

604 
Ë
->
¡©us
 = status;

605 
Ë
->
cmd
 = 
comm
;

606 
Ë
->
nkey
 =‚key;

607 
Ë
->
şsid
 = clsid;

608 ià(
‰l
 != 0) {

609 
Ë
->
‰l
 = - 
cu¼’t_time
;

611 
Ë
->
‰l
 = 0;

613 
	`memıy
(
Ë
->
key
, key, 
nkey
);

614 
e
->
size
 = (
log’Œy_™em_¡Üe
è+ 
nkey
;

615 
	}
}

621 
logg”_»t_ty³
 
	$logg”_log
(
logg”
 *
l
, cÚ¡ 
log_’Œy_ty³
 
ev’t
, cÚ¡ *
’Œy
, ...) {

622 
bbuf_t
 *
buf
 = 
l
->buf;

623 
boŞ
 
no¥aû
 = 
çl£
;

624 
va_li¡
 
­
;

625 
tÙ®
 = 0;

626 
log’Œy
 *
e
;

628 cÚ¡ 
’Œy_d‘as
 *
d
 = &
l
->
’Œy_m­
[
ev’t
];

629 
»qËn
 = 
d
->reqlen;

631 
	`±h»ad_mu‹x_lock
(&
l
->
mu‹x
);

633 
e
 = (
log’Œy
 *è
	`bbuf_»que¡
(
buf
, (Öog’Œyè+ 
»qËn
));

634 ià(
e
 =ğ
NULL
) {

635 
	`±h»ad_mu‹x_uÆock
(&
l
->
mu‹x
);

636 
l
->
drİ³d
++;

637  
LOGGER_RET_NOSPACE
;

639 
e
->
gid
 = 
	`logg”_g‘_gid
();

640 
e
->
ev’t
 = 
d
->
subty³
;

644 
e
->
eæags
 = 
d
->eflags;

648 
	`g‘timeofday
(&
e
->
tv
, 
NULL
);

650 
d
->
subty³
) {

651 
LOGGER_TEXT_ENTRY
:

652 
	`va_¡¬t
(
­
, 
’Œy
);

653 
tÙ®
 = 
	`v¢´štf
((*è
e
->
d©a
, 
»qËn
, 
d
->
fÜm©
, 
­
);

654 
	`va_’d
(
­
);

655 ià(
tÙ®
 >ğ
»qËn
 ||otal <= 0) {

656 
	`årštf
(
¡d”r
, "LOGGER: FaedØv¢´štà¨‹xˆ’Œy: (tÙ®è%d\n", 
tÙ®
);

659 
e
->
size
 = 
tÙ®
 + 1;

662 
LOGGER_EVICTION_ENTRY
:

663 
	`_logg”_log_eviùiÚs
(
e
, (
™em
 *)
’Œy
);

665 
LOGGER_ITEM_GET_ENTRY
:

666 
	`va_¡¬t
(
­
, 
’Œy
);

667 
was_found
 = 
	`va_¬g
(
­
, );

668 *
key
 = 
	`va_¬g
(
­
, *);

669 
size_t
 
nkey
 = 
	`va_¬g
(
­
, size_t);

670 
ušt8_t
 
gşsid
 = 
	`va_¬g
(
­
, );

671 
	`_logg”_log_™em_g‘
(
e
, 
was_found
, 
key
, 
nkey
, 
gşsid
);

672 
	`va_’d
(
­
);

674 
LOGGER_ITEM_STORE_ENTRY
:

675 
	`va_¡¬t
(
­
, 
’Œy
);

676 
¡Üe_™em_ty³
 
¡©us
 = 
	`va_¬g
(
­
, store_item_type);

677 
comm
 = 
	`va_¬g
(
­
, );

678 *
skey
 = 
	`va_¬g
(
­
, *);

679 
size_t
 
¢key
 = 
	`va_¬g
(
­
, size_t);

680 
»l_time_t
 
¡
 = 
	`va_¬g
(
­
,„el_time_t);

681 
ušt8_t
 
sşsid
 = 
	`va_¬g
(
­
, );

682 
	`_logg”_log_™em_¡Üe
(
e
, 
¡©us
, 
comm
, 
skey
, 
¢key
, 
¡
, 
sşsid
);

687 ià(
	`bbuf_push
(
buf
, ((
log’Œy
è+ 
e
->
size
)) == 0) {

688 
	`årštf
(
¡d”r
, "LOGGER: Failedo bipbuf…ush‡extƒntry\n");

689 
	`±h»ad_mu‹x_uÆock
(&
l
->
mu‹x
);

690  
LOGGER_RET_ERR
;

692 
l
->
wr™‹n
++;

693 
	`L_DEBUG
("LOGGER: Reque¡ed %d by‹s, wrÙ%lu by‹s\n", 
»qËn
,

694 ((
log’Œy
è+ 
e
->
size
));

696 
	`±h»ad_mu‹x_uÆock
(&
l
->
mu‹x
);

698 ià(
no¥aû
) {

699  
LOGGER_RET_NOSPACE
;

701  
LOGGER_RET_OK
;

703 
	}
}

709 
logg”_add_w©ch”_»t
 
	$logg”_add_w©ch”
(*
c
, cÚ¡ 
sfd
, 
ušt16_t
 
f
) {

710 
x
;

711 
logg”_w©ch”
 *
w
 = 
NULL
;

712 
	`±h»ad_mu‹x_lock
(&
logg”_¡ack_lock
);

713 ià(
w©ch”_couÁ
 >ğ
WATCHER_LIMIT
) {

714  
LOGGER_ADD_WATCHER_TOO_MANY
;

717 
x
 = 0; x < 
WATCHER_LIMIT
; x++) {

718 ià(
w©ch”s
[
x
] =ğ
NULL
)

722 
w
 = 
	`ÿÎoc
(1, (
logg”_w©ch”
));

723 ià(
w
 =ğ
NULL
) {

724 
	`±h»ad_mu‹x_uÆock
(&
logg”_¡ack_lock
);

725  
LOGGER_ADD_WATCHER_FAILED
;

727 
w
->
c
 = c;

728 
w
->
sfd
 = sfd;

729 ià(
sfd
 =ğ0 && 
c
 =ğ
NULL
) {

730 
w
->
t
 = 
LOGGER_WATCHER_STDERR
;

732 
w
->
t
 = 
LOGGER_WATCHER_CLIENT
;

734 
w
->
id
 = 
x
;

735 
w
->
eæags
 = 
f
;

736 
w
->
buf
 = 
	`bbuf_Ãw
(
£‰šgs
.
logg”_w©ch”_buf_size
);

737 ià(
w
->
buf
 =ğ
NULL
) {

738 
	`ä“
(
w
);

739 
	`±h»ad_mu‹x_uÆock
(&
logg”_¡ack_lock
);

740  
LOGGER_ADD_WATCHER_FAILED
;

742 
	`bbuf_ofãr
(
w
->
buf
, (*) "OK\r\n", 4);

744 
w©ch”s
[
x
] = 
w
;

745 
w©ch”_couÁ
++;

747 
	`logg”_£t_æags
();

749 
	`±h»ad_mu‹x_uÆock
(&
logg”_¡ack_lock
);

750  
LOGGER_ADD_WATCHER_OK
;

751 
	}
}

	@logger.h

2 #iâdeà
LOGGER_H


3 
	#LOGGER_H


	)

5 
	~"bbufãr.h
"

8 
	#LOGGER_BUF_SIZE
 1024 * 64

	)

9 
	#LOGGER_WATCHER_BUF_SIZE
 1024 * 256

	)

10 
	#LOGGER_ENTRY_MAX_SIZE
 2048

	)

11 
	#GET_LOGGER
(è((
logg”
 *è
	`±h»ad_g‘¥ecific
(
logg”_key
));

	)

14 
	t»l_time_t
;

16 
	elog_’Œy_ty³
 {

17 
	mLOGGER_ASCII_CMD
 = 0,

18 
	mLOGGER_EVICTION
,

19 
	mLOGGER_ITEM_GET
,

20 
	mLOGGER_ITEM_STORE
,

21 
	mLOGGER_CRAWLER_STATUS
,

24 
	elog_’Œy_subty³
 {

25 
	mLOGGER_TEXT_ENTRY
 = 0,

26 
	mLOGGER_EVICTION_ENTRY
,

27 
	mLOGGER_ITEM_GET_ENTRY
,

28 
	mLOGGER_ITEM_STORE_ENTRY


31 
	elogg”_»t_ty³
 {

32 
	mLOGGER_RET_OK
 = 0,

33 
	mLOGGER_RET_NOSPACE
,

34 
	mLOGGER_RET_ERR


37 
	elogg”_·r£_’Œy_»t
 {

38 
	mLOGGER_PARSE_ENTRY_OK
 = 0,

39 
	mLOGGER_PARSE_ENTRY_FULLBUF
,

40 
	mLOGGER_PARSE_ENTRY_FAILED


44 
log_’Œy_subty³
 
	msubty³
;

45 
	m»qËn
;

46 
ušt16_t
 
	meæags
;

47 *
	mfÜm©
;

48 } 
	t’Œy_d‘as
;

51 
	slog’Œy_eviùiÚ
 {

52 
	mex±ime
;

53 
ušt32_t
 
	mÏtime
;

54 
ušt16_t
 
	m™_æags
;

55 
ušt8_t
 
	mnkey
;

56 
ušt8_t
 
	mşsid
;

57 
	mkey
[];

60 
	slog’Œy_™em_g‘
 {

61 
ušt8_t
 
	mwas_found
;

62 
ušt8_t
 
	mnkey
;

63 
ušt8_t
 
	mşsid
;

64 
	mkey
[];

67 
	slog’Œy_™em_¡Üe
 {

68 
	m¡©us
;

69 
	mcmd
;

70 
»l_time_t
 
	m‰l
;

71 
ušt8_t
 
	mnkey
;

72 
ušt8_t
 
	mşsid
;

73 
	mkey
[];

78 
	s_log’Œy
 {

79 
log_’Œy_subty³
 
	mev’t
;

80 
ušt16_t
 
	meæags
;

81 
ušt64_t
 
	mgid
;

82 
timev®
 
	mtv
;

83 
	msize
;

85 *
	m’Œy
;

86 
	m’d
;

87 } 
	md©a
[];

88 } 
	tlog’Œy
;

90 
	#LOG_SYSEVENTS
 (1<<1è

	)

91 
	#LOG_FETCHERS
 (1<<2è

	)

92 
	#LOG_MUTATIONS
 (1<<3è

	)

93 
	#LOG_SYSERRORS
 (1<<4è

	)

94 
	#LOG_CONNEVENTS
 (1<<5è

	)

95 
	#LOG_EVICTIONS
 (1<<6è

	)

96 
	#LOG_STRICT
 (1<<7è

	)

97 
	#LOG_RAWCMDS
 (1<<9è

	)

99 
	s_logg”
 {

100 
_logg”
 *
	m´ev
;

101 
_logg”
 *
	mÃxt
;

102 
±h»ad_mu‹x_t
 
	mmu‹x
;

103 
ušt64_t
 
	mwr™‹n
;

104 
ušt64_t
 
	mdrİ³d
;

105 
ušt64_t
 
	mblocked
;

106 
ušt16_t
 
	mãtch”_¿tio
;

107 
ušt16_t
 
	mmutiÚ_¿tio
;

108 
ušt16_t
 
	meæags
;

109 
bbuf_t
 *
	mbuf
;

110 cÚ¡ 
’Œy_d‘as
 *
	m’Œy_m­
;

111 } 
	tlogg”
;

113 
	elogg”_w©ch”_ty³
 {

114 
	mLOGGER_WATCHER_STDERR
 = 0,

115 
	mLOGGER_WATCHER_CLIENT
 = 1

119 *
	mc
;

120 
	msfd
;

121 
	mid
;

122 
ušt64_t
 
	msk³d
;

123 
boŞ
 
	mçed_æush
;

124 
logg”_w©ch”_ty³
 
	mt
;

125 
ušt16_t
 
	meæags
;

126 
bbuf_t
 *
	mbuf
;

127 } 
	tlogg”_w©ch”
;

130 
	slogg”_¡©s
 {

131 
ušt64_t
 
	mwÜk”_drİ³d
;

132 
ušt64_t
 
	mwÜk”_wr™‹n
;

133 
ušt64_t
 
	mw©ch”_sk³d
;

134 
ušt64_t
 
	mw©ch”_£Á
;

137 
±h»ad_key_t
 
logg”_key
;

141 
logg”_š™
();

142 
logg”
 *
logg”_ü—‹
();

144 
	#LOGGER_LOG
(
l
, 
æag
, 
ty³
, ...) \

146 
logg”
 *
myl
 = 
l
; \

147 ià(
l
 =ğ
NULL
) \

148 
myl
 = 
	`GET_LOGGER
(); \

149 ià(
myl
->
eæags
 & 
æag
) \

150 
	`logg”_log
(
myl
, 
ty³
, 
__VA_ARGS__
); \

151 } 0)

	)

153 
logg”_»t_ty³
 
logg”_log
(
logg”
 *
l
, cÚ¡ 
log_’Œy_ty³
 
ev’t
, cÚ¡ *
’Œy
, ...);

155 
	elogg”_add_w©ch”_»t
 {

156 
	mLOGGER_ADD_WATCHER_TOO_MANY
 = 0,

157 
	mLOGGER_ADD_WATCHER_OK
,

158 
	mLOGGER_ADD_WATCHER_FAILED


161 
logg”_add_w©ch”_»t
 
logg”_add_w©ch”
(*
c
, cÚ¡ 
sfd
, 
ušt16_t
 
f
);

	@memcached.c

16 
	~"memÿched.h
"

17 
	~<sys/¡©.h
>

18 
	~<sys/sock‘.h
>

19 
	~<sys/un.h
>

20 
	~<sigÇl.h
>

21 
	~<sys/·¿m.h
>

22 
	~<sys/»sourû.h
>

23 
	~<sys/uio.h
>

24 
	~<ùy³.h
>

25 
	~<¡d¬g.h
>

29 #iâdeà
_P1003_1B_VISIBLE


30 
	#_P1003_1B_VISIBLE


	)

33 #iâdeà
__Ãed_IOV_MAX


34 
	#__Ãed_IOV_MAX


	)

36 
	~<pwd.h
>

37 
	~<sys/mmª.h
>

38 
	~<fú.h
>

39 
	~<Ãtš‘/tı.h
>

40 
	~<¬·/š‘.h
>

41 
	~<”ºo.h
>

42 
	~<¡dlib.h
>

43 
	~<¡dio.h
>

44 
	~<¡ršg.h
>

45 
	~<time.h
>

46 
	~<as£¹.h
>

47 
	~<lim™s.h
>

48 
	~<sy£x™s.h
>

49 
	~<¡ddef.h
>

52 #iâdeà
IOV_MAX


53 #ià
defšed
(
__F»eBSD__
è|| defšed(
__APPLE__
è|| defšed(
__GNU__
)

54 
	#IOV_MAX
 1024

	)

57 #iâdeà
MAXPATHLEN


58 
	#MAXPATHLEN
 4096

	)

66 
drive_machše
(
cÚn
 *
c
);

67 
Ãw_sock‘
(
addršfo
 *
ai
);

68 
Œy_»ad_commªd
(
cÚn
 *
c
);

70 
	eŒy_»ad_»suÉ
 {

71 
	mREAD_DATA_RECEIVED
,

72 
	mREAD_NO_DATA_RECEIVED
,

73 
	mREAD_ERROR
,

74 
	mREAD_MEMORY_ERROR


77 
Œy_»ad_»suÉ
 
Œy_»ad_ÃtwÜk
(
cÚn
 *
c
);

78 
Œy_»ad_»suÉ
 
Œy_»ad_udp
(
cÚn
 *
c
);

80 
cÚn_£t_¡©e
(
cÚn
 *
c
, 
cÚn_¡©es
 
¡©e
);

81 
¡¬t_cÚn_timeout_th»ad
();

84 
¡©s_š™
();

85 
£rv”_¡©s
(
ADD_STAT
 
add_¡©s
, 
cÚn
 *
c
);

86 
´oûss_¡©_£‰šgs
(
ADD_STAT
 
add_¡©s
, *
c
);

87 
cÚn_to_¡r
(cÚ¡ 
cÚn
 *
c
, *
buf
);

91 
£‰šgs_š™
();

94 
ev’t_hªdËr
(cÚ¡ 
fd
, cÚ¡ 
which
, *
¬g
);

95 
cÚn_şo£
(
cÚn
 *
c
);

96 
cÚn_š™
();

97 
boŞ
 
upd©e_ev’t
(
cÚn
 *
c
, cÚ¡ 
Ãw_æags
);

98 
com¶‘e_Ä—d
(
cÚn
 *
c
);

99 
´oûss_commªd
(
cÚn
 *
c
, *
commªd
);

100 
wr™e_ªd_ä“
(
cÚn
 *
c
, *
buf
, 
by‹s
);

101 
’su»_iov_¥aû
(
cÚn
 *
c
);

102 
add_iov
(
cÚn
 *
c
, cÚ¡ *
buf
, 
Ën
);

103 
add_chunked_™em_iovs
(
cÚn
 *
c
, 
™em
 *
™
, 
Ën
);

104 
add_msghdr
(
cÚn
 *
c
);

105 
wr™e_bš_”rÜ
(
cÚn
 *
c
, 
´ÙocŞ_bš¬y_»¥Ú£_¡©us
 
”r
,

106 cÚ¡ *
”r¡r
, 
sw®low
);

108 
cÚn_ä“
(
cÚn
 *
c
);

111 
¡©s
 
	g¡©s
;

112 
¡©s_¡©e
 
	g¡©s_¡©e
;

113 
£‰šgs
 
	g£‰šgs
;

114 
time_t
 
	g´oûss_¡¬‹d
;

115 
cÚn
 **
	gcÚns
;

117 
¦ab_»b®ªû
 
	g¦ab_»b®
;

118 vŞ©
	g¦ab_»b®ªû_sigÇl
;

121 
cÚn
 *
	gli¡’_cÚn
 = 
NULL
;

122 
	gmax_fds
;

123 
ev’t_ba£
 *
	gmaš_ba£
;

125 
	eŒªsm™_»suÉ
 {

126 
	mTRANSMIT_COMPLETE
,

127 
	mTRANSMIT_INCOMPLETE
,

128 
	mTRANSMIT_SOFT_ERROR
,

129 
	mTRANSMIT_HARD_ERROR


132 
Œªsm™_»suÉ
 
Œªsm™
(
cÚn
 *
c
);

139 vŞ©
boŞ
 
	g®low_Ãw_cÚns
 = 
Œue
;

140 
ev’t
 
	gmaxcÚn£v’t
;

141 
	$maxcÚns_hªdËr
(cÚ¡ 
fd
, cÚ¡ 
which
, *
¬g
) {

142 
timev®
 
t
 = {.
tv_£c
 = 0, .
tv_u£c
 = 10000};

144 ià(
fd
 =ğ-42 || 
®low_Ãw_cÚns
 =ğ
çl£
) {

146 
	`evtim”_£t
(&
maxcÚn£v’t
, 
maxcÚns_hªdËr
, 0);

147 
	`ev’t_ba£_£t
(
maš_ba£
, &
maxcÚn£v’t
);

148 
	`evtim”_add
(&
maxcÚn£v’t
, &
t
);

150 
	`evtim”_d–
(&
maxcÚn£v’t
);

151 
	`acû±_Ãw_cÚns
(
Œue
);

153 
	}
}

155 
	#REALTIME_MAXDELTA
 60*60*24*30

	)

162 
»l_time_t
 
	$»®time
(cÚ¡ 
time_t
 
ex±ime
) {

165 ià(
ex±ime
 == 0)  0;

167 ià(
ex±ime
 > 
REALTIME_MAXDELTA
) {

174 ià(
ex±ime
 <ğ
´oûss_¡¬‹d
)

175  (
»l_time_t
)1;

176  (
»l_time_t
)(
ex±ime
 - 
´oûss_¡¬‹d
);

178  (
»l_time_t
)(
ex±ime
 + 
cu¼’t_time
);

180 
	}
}

182 
	$¡©s_š™
() {

183 
	`mem£t
(&
¡©s
, 0, (stats));

184 
	`mem£t
(&
¡©s_¡©e
, 0, (stats_state));

185 
¡©s_¡©e
.
acû±šg_cÚns
 = 
Œue
;

191 
´oûss_¡¬‹d
 = 
	`time
(0è- 
ITEM_UPDATE_INTERVAL
 - 2;

192 
	`¡©s_´efix_š™
();

193 
	}
}

195 
	$¡©s_»£t
() {

196 
	`STATS_LOCK
();

197 
	`mem£t
(&
¡©s
, 0, (stats));

198 
	`¡©s_´efix_ş—r
();

199 
	`STATS_UNLOCK
();

200 
	`th»adloÿl_¡©s_»£t
();

201 
	`™em_¡©s_»£t
();

202 
	}
}

204 
	$£‰šgs_š™
() {

205 
£‰šgs
.
u£_ÿs
 = 
Œue
;

206 
£‰šgs
.
acûss
 = 0700;

207 
£‰šgs
.
pÜt
 = 11211;

208 
£‰šgs
.
udµÜt
 = 11211;

210 
£‰šgs
.
š‹r
 = 
NULL
;

211 
£‰šgs
.
maxby‹s
 = 64 * 1024 * 1024;

212 
£‰šgs
.
maxcÚns
 = 1024;

213 
£‰šgs
.
v”bo£
 = 0;

214 
£‰šgs
.
Şde¡_live
 = 0;

215 
£‰šgs
.
Şde¡_ÿs
 = 0;

216 
£‰šgs
.
eviù_to_ä“
 = 1;

217 
£‰šgs
.
sock‘·th
 = 
NULL
;

218 
£‰šgs
.
çùÜ
 = 1.25;

219 
£‰šgs
.
chunk_size
 = 48;

220 
£‰šgs
.
num_th»ads
 = 4;

221 
£‰šgs
.
num_th»ads_³r_udp
 = 0;

222 
£‰šgs
.
´efix_d–im™”
 = ':';

223 
£‰šgs
.
d‘a_’abËd
 = 0;

224 
£‰šgs
.
»qs_³r_ev’t
 = 20;

225 
£‰šgs
.
backlog
 = 1024;

226 
£‰šgs
.
bšdšg_´ÙocŞ
 = 
ÃgÙŸtšg_´Ù
;

227 
£‰šgs
.
™em_size_max
 = 1024 * 1024;

228 
£‰šgs
.
¦ab_·ge_size
 = 1024 * 1024;

229 
£‰šgs
.
¦ab_chunk_size_max
 = s‘tšgs.
¦ab_·ge_size
;

230 
£‰šgs
.
§¦
 = 
çl£
;

231 
£‰šgs
.
maxcÚns_ç¡
 = 
çl£
;

232 
£‰šgs
.
Ìu_üawËr
 = 
çl£
;

233 
£‰šgs
.
Ìu_üawËr_¦“p
 = 100;

234 
£‰šgs
.
Ìu_üawËr_toüawl
 = 0;

235 
£‰šgs
.
Ìu_mašš”_th»ad
 = 
çl£
;

236 
£‰šgs
.
hÙ_Ìu_pù
 = 32;

237 
£‰šgs
.
w¬m_Ìu_pù
 = 32;

238 
£‰šgs
.
expœez”o_dÛs_nÙ_eviù
 = 
çl£
;

239 
£‰šgs
.
idË_timeout
 = 0;

240 
£‰šgs
.
hashpow”_š™
 = 0;

241 
£‰šgs
.
¦ab_»assign
 = 
çl£
;

242 
£‰šgs
.
¦ab_automove
 = 0;

243 
£‰šgs
.
shutdown_commªd
 = 
çl£
;

244 
£‰šgs
.
_»·œ_time
 = 
TAIL_REPAIR_TIME_DEFAULT
;

245 
£‰šgs
.
æush_’abËd
 = 
Œue
;

246 
£‰šgs
.
dump_’abËd
 = 
Œue
;

247 
£‰šgs
.
üawls_³r¦“p
 = 1000;

248 
£‰šgs
.
logg”_w©ch”_buf_size
 = 
LOGGER_WATCHER_BUF_SIZE
;

249 
£‰šgs
.
logg”_buf_size
 = 
LOGGER_BUF_SIZE
;

250 
	}
}

257 
	$add_msghdr
(
cÚn
 *
c
)

259 
msghdr
 *
msg
;

261 
	`as£¹
(
c
 !ğ
NULL
);

263 ià(
c
->
msgsize
 =ğc->
msgu£d
) {

264 
msg
 = 
	`»®loc
(
c
->
msgli¡
, c->
msgsize
 * 2 * (
msghdr
));

265 ià(! 
msg
) {

266 
	`STATS_LOCK
();

267 
¡©s
.
m®loc_çs
++;

268 
	`STATS_UNLOCK
();

271 
c
->
msgli¡
 = 
msg
;

272 
c
->
msgsize
 *= 2;

275 
msg
 = 
c
->
msgli¡
 + c->
msgu£d
;

279 
	`mem£t
(
msg
, 0, (
msghdr
));

281 
msg
->
msg_iov
 = &
c
->
iov
[c->
iovu£d
];

283 ià(
	`IS_UDP
(
c
->
Œª¥Üt
è&& c->
»que¡_addr_size
 > 0) {

284 
msg
->
msg_Çme
 = &
c
->
»que¡_addr
;

285 
msg
->
msg_Çm–’
 = 
c
->
»que¡_addr_size
;

288 
c
->
msgby‹s
 = 0;

289 
c
->
msgu£d
++;

291 ià(
	`IS_UDP
(
c
->
Œª¥Üt
)) {

293  
	`add_iov
(
c
, 
NULL
, 
UDP_HEADER_SIZE
);

297 
	}
}

299 
±h»ad_mu‹x_t
 
cÚn_lock
;

302 
±h»ad_t
 
	gcÚn_timeout_tid
;

304 
	#CONNS_PER_SLICE
 100

	)

305 
	#TIMEOUT_MSG_SIZE
 (1 + ())

	)

306 *
	$cÚn_timeout_th»ad
(*
¬g
) {

307 
i
;

308 
cÚn
 *
c
;

309 
buf
[
TIMEOUT_MSG_SIZE
];

310 
»l_time_t
 
Şde¡_Ï¡_cmd
;

311 
¦“p_time
;

312 
u£cÚds_t
 
time¦iû
 = 1000000 / (
max_fds
 / 
CONNS_PER_SLICE
);

315 ià(
£‰šgs
.
v”bo£
 > 2)

316 
	`årštf
(
¡d”r
, "idleimeouthread‡top of connection†ist\n");

318 
Şde¡_Ï¡_cmd
 = 
cu¼’t_time
;

320 
i
 = 0; i < 
max_fds
; i++) {

321 ià((
i
 % 
CONNS_PER_SLICE
) == 0) {

322 ià(
£‰šgs
.
v”bo£
 > 2)

323 
	`årštf
(
¡d”r
, "idleimeouthread sleeping for %ulus\n",

324 
time¦iû
);

325 
	`u¦“p
(
time¦iû
);

328 ià(!
cÚns
[
i
])

331 
c
 = 
cÚns
[
i
];

333 ià(!
	`IS_TCP
(
c
->
Œª¥Üt
))

336 ià(
c
->
¡©e
 !ğ
cÚn_Ãw_cmd
 && c->¡©!ğ
cÚn_»ad
)

339 ià((
cu¼’t_time
 - 
c
->
Ï¡_cmd_time
è> 
£‰šgs
.
idË_timeout
) {

340 
buf
[0] = 't';

341 
	`memıy
(&
buf
[1], &
i
, ());

342 ià(
	`wr™e
(
c
->
th»ad
->
nÙify_£nd_fd
, 
buf
, 
TIMEOUT_MSG_SIZE
)

343 !ğ
TIMEOUT_MSG_SIZE
)

344 
	`³¼Ü
("Failedo writeimeouto‚otify…ipe");

346 ià(
c
->
Ï¡_cmd_time
 < 
Şde¡_Ï¡_cmd
)

347 
Şde¡_Ï¡_cmd
 = 
c
->
Ï¡_cmd_time
;

352 
¦“p_time
 = 
£‰šgs
.
idË_timeout
 - (
cu¼’t_time
 - 
Şde¡_Ï¡_cmd
) + 1;

353 ià(
¦“p_time
 <= 0)

354 
¦“p_time
 = 1;

356 ià(
£‰šgs
.
v”bo£
 > 2)

357 
	`årštf
(
¡d”r
,

359 
¦“p_time
);

360 
	`u¦“p
((
u£cÚds_t
è
¦“p_time
 * 1000000);

363  
NULL
;

364 
	}
}

366 
	$¡¬t_cÚn_timeout_th»ad
() {

367 
»t
;

369 ià(
£‰šgs
.
idË_timeout
 == 0)

372 ià((
»t
 = 
	`±h»ad_ü—‹
(&
cÚn_timeout_tid
, 
NULL
,

373 
cÚn_timeout_th»ad
, 
NULL
)) != 0) {

374 
	`årštf
(
¡d”r
, "Can't create idle connectionimeouthread: %s\n",

375 
	`¡»¼Ü
(
»t
));

380 
	}
}

392 
	$cÚn_š™
() {

394 
Ãxt_fd
 = 
	`dup
(1);

395 
h—droom
 = 10;

396 
¾im™
 
¾
;

398 
max_fds
 = 
£‰šgs
.
maxcÚns
 + 
h—droom
 + 
Ãxt_fd
;

401 ià(
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾
) == 0) {

402 
max_fds
 = 
¾
.
¾im_max
;

404 
	`årštf
(
¡d”r
, "Failedo query maximum file descriptor; "

408 
	`şo£
(
Ãxt_fd
);

410 ià((
cÚns
 = 
	`ÿÎoc
(
max_fds
, (
cÚn
 *))è=ğ
NULL
) {

411 
	`årštf
(
¡d”r
, "Failedo‡llocate connection structures\n");

413 
	`ex™
(1);

415 
	}
}

417 cÚ¡ *
	$´Ù_‹xt
(
´ÙocŞ
 
´Ù
) {

418 *
rv
 = "unknown";

419 
´Ù
) {

420 
ascii_´Ù
:

421 
rv
 = "ascii";

423 
bš¬y_´Ù
:

424 
rv
 = "binary";

426 
ÃgÙŸtšg_´Ù
:

427 
rv
 = "auto-negotiate";

430  
rv
;

431 
	}
}

433 
	$cÚn_şo£_idË
(
cÚn
 *
c
) {

434 ià(
£‰šgs
.
idË_timeout
 > 0 &&

435 (
cu¼’t_time
 - 
c
->
Ï¡_cmd_time
è> 
£‰šgs
.
idË_timeout
) {

436 ià(
c
->
¡©e
 !ğ
cÚn_Ãw_cmd
 && c->¡©!ğ
cÚn_»ad
) {

437 ià(
£‰šgs
.
v”bo£
 > 1)

438 
	`årštf
(
¡d”r
,

439 "fd %d wªt tØtimeout, buˆi¢'ˆš„—d s‹", 
c
->
sfd
);

443 ià(
£‰šgs
.
v”bo£
 > 1)

444 
	`årštf
(
¡d”r
, "Closšg idË fd %d\n", 
c
->
sfd
);

446 
c
->
th»ad
->
¡©s
.
idË_kicks
++;

448 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

449 
	`drive_machše
(
c
);

451 
	}
}

454 
	$cÚn_wÜk”_»add
(
cÚn
 *
c
) {

455 
c
->
ev_æags
 = 
EV_READ
 | 
EV_PERSIST
;

456 
	`ev’t_£t
(&
c
->
ev’t
, c->
sfd
, c->
ev_æags
, 
ev’t_hªdËr
, (*)c);

457 
	`ev’t_ba£_£t
(
c
->
th»ad
->
ba£
, &c->
ev’t
);

458 
c
->
¡©e
 = 
cÚn_Ãw_cmd
;

460 ià(
	`ev’t_add
(&
c
->
ev’t
, 0) == -1) {

461 
	`³¼Ü
("event_add");

463 
	}
}

465 
cÚn
 *
	$cÚn_Ãw
(cÚ¡ 
sfd
, 
cÚn_¡©es
 
š™_¡©e
,

466 cÚ¡ 
ev’t_æags
,

467 cÚ¡ 
»ad_bufãr_size
, 
ÃtwÜk_Œª¥Üt
 
Œª¥Üt
,

468 
ev’t_ba£
 *
ba£
) {

469 
cÚn
 *
c
;

471 
	`as£¹
(
sfd
 >ğ0 && sfd < 
max_fds
);

472 
c
 = 
cÚns
[
sfd
];

474 ià(
NULL
 =ğ
c
) {

475 ià(!(
c
 = (
cÚn
 *)
	`ÿÎoc
(1, (conn)))) {

476 
	`STATS_LOCK
();

477 
¡©s
.
m®loc_çs
++;

478 
	`STATS_UNLOCK
();

479 
	`årštf
(
¡d”r
, "Failedo‡llocate connection object\n");

480  
NULL
;

482 
	`MEMCACHED_CONN_CREATE
(
c
);

484 
c
->
rbuf
 = c->
wbuf
 = 0;

485 
c
->
i¡
 = 0;

486 
c
->
suffixli¡
 = 0;

487 
c
->
iov
 = 0;

488 
c
->
msgli¡
 = 0;

489 
c
->
hdrbuf
 = 0;

491 
c
->
rsize
 = 
»ad_bufãr_size
;

492 
c
->
wsize
 = 
DATA_BUFFER_SIZE
;

493 
c
->
isize
 = 
ITEM_LIST_INITIAL
;

494 
c
->
suffixsize
 = 
SUFFIX_LIST_INITIAL
;

495 
c
->
iovsize
 = 
IOV_LIST_INITIAL
;

496 
c
->
msgsize
 = 
MSG_LIST_INITIAL
;

497 
c
->
hdrsize
 = 0;

499 
c
->
rbuf
 = (*)
	`m®loc
((
size_t
)c->
rsize
);

500 
c
->
wbuf
 = (*)
	`m®loc
((
size_t
)c->
wsize
);

501 
c
->
i¡
 = (
™em
 **)
	`m®loc
((™em *è* c->
isize
);

502 
c
->
suffixli¡
 = (**)
	`m®loc
((*è* c->
suffixsize
);

503 
c
->
iov
 = (
iovec
 *)
	`m®loc
((iovecè* c->
iovsize
);

504 
c
->
msgli¡
 = (
msghdr
 *)
	`m®loc
((msghdrè* c->
msgsize
);

506 ià(
c
->
rbuf
 =ğ0 || c->
wbuf
 =ğ0 || c->
i¡
 =ğ0 || c->
iov
 == 0 ||

507 
c
->
msgli¡
 =ğ0 || c->
suffixli¡
 == 0) {

508 
	`cÚn_ä“
(
c
);

509 
	`STATS_LOCK
();

510 
¡©s
.
m®loc_çs
++;

511 
	`STATS_UNLOCK
();

512 
	`årštf
(
¡d”r
, "Failedo‡llocate buffers for connection\n");

513  
NULL
;

516 
	`STATS_LOCK
();

517 
¡©s_¡©e
.
cÚn_¡ruùs
++;

518 
	`STATS_UNLOCK
();

520 
c
->
sfd
 = sfd;

521 
cÚns
[
sfd
] = 
c
;

524 
c
->
Œª¥Üt
 =ransport;

525 
c
->
´ÙocŞ
 = 
£‰šgs
.
bšdšg_´ÙocŞ
;

530 ià(!
£‰šgs
.
sock‘·th
) {

531 
c
->
»que¡_addr_size
 = (c->
»que¡_addr
);

533 
c
->
»que¡_addr_size
 = 0;

536 ià(
Œª¥Üt
 =ğ
tı_Œª¥Üt
 && 
š™_¡©e
 =ğ
cÚn_Ãw_cmd
) {

537 ià(
	`g‘³”Çme
(
sfd
, (
sockaddr
 *è&
c
->
»que¡_addr
,

538 &
c
->
»que¡_addr_size
)) {

539 
	`³¼Ü
("getpeername");

540 
	`mem£t
(&
c
->
»que¡_addr
, 0, (c->request_addr));

544 ià(
£‰šgs
.
v”bo£
 > 1) {

545 ià(
š™_¡©e
 =ğ
cÚn_li¡’šg
) {

546 
	`årštf
(
¡d”r
, "<%d s”v”†i¡’šg (%s)\n", 
sfd
,

547 
	`´Ù_‹xt
(
c
->
´ÙocŞ
));

548 } ià(
	`IS_UDP
(
Œª¥Üt
)) {

549 
	`årštf
(
¡d”r
, "<%d s”v”†i¡’šg (udp)\n", 
sfd
);

550 } ià(
c
->
´ÙocŞ
 =ğ
ÃgÙŸtšg_´Ù
) {

551 
	`årštf
(
¡d”r
, "<%d‚ew‡uto-negotiating client connection\n",

552 
sfd
);

553 } ià(
c
->
´ÙocŞ
 =ğ
ascii_´Ù
) {

554 
	`årštf
(
¡d”r
, "<%d‚ew‡sci˜ş›Á cÚÃùiÚ.\n", 
sfd
);

555 } ià(
c
->
´ÙocŞ
 =ğ
bš¬y_´Ù
) {

556 
	`årštf
(
¡d”r
, "<%d‚ew bš¬y cl›Á cÚÃùiÚ.\n", 
sfd
);

558 
	`årštf
(
¡d”r
, "<%d‚ew unknown (%d) client connection\n",

559 
sfd
, 
c
->
´ÙocŞ
);

560 
	`as£¹
(
çl£
);

564 
c
->
¡©e
 = 
š™_¡©e
;

565 
c
->
¾by‹s
 = 0;

566 
c
->
cmd
 = -1;

567 
c
->
rby‹s
 = c->
wby‹s
 = 0;

568 
c
->
wcu¼
 = c->
wbuf
;

569 
c
->
rcu¼
 = c->
rbuf
;

570 
c
->
r™em
 = 0;

571 
c
->
icu¼
 = c->
i¡
;

572 
c
->
suffixcu¼
 = c->
suffixli¡
;

573 
c
->
eá
 = 0;

574 
c
->
suffixËá
 = 0;

575 
c
->
iovu£d
 = 0;

576 
c
->
msgcu¼
 = 0;

577 
c
->
msgu£d
 = 0;

578 
c
->
auth’tiÿ‹d
 = 
çl£
;

579 
c
->
Ï¡_cmd_time
 = 
cu¼’t_time
;

581 
c
->
wr™e_ªd_go
 = 
š™_¡©e
;

582 
c
->
wr™e_ªd_ä“
 = 0;

583 
c
->
™em
 = 0;

585 
c
->
nÜ•ly
 = 
çl£
;

587 
	`ev’t_£t
(&
c
->
ev’t
, 
sfd
, 
ev’t_æags
, 
ev’t_hªdËr
, (*)c);

588 
	`ev’t_ba£_£t
(
ba£
, &
c
->
ev’t
);

589 
c
->
ev_æags
 = 
ev’t_æags
;

591 ià(
	`ev’t_add
(&
c
->
ev’t
, 0) == -1) {

592 
	`³¼Ü
("event_add");

593  
NULL
;

596 
	`STATS_LOCK
();

597 
¡©s_¡©e
.
cu¼_cÚns
++;

598 
¡©s
.
tÙ®_cÚns
++;

599 
	`STATS_UNLOCK
();

601 
	`MEMCACHED_CONN_ALLOCATE
(
c
->
sfd
);

603  
c
;

604 
	}
}

606 
	$cÚn_»Ëa£_™ems
(
cÚn
 *
c
) {

607 
	`as£¹
(
c
 !ğ
NULL
);

609 ià(
c
->
™em
) {

610 
	`™em_»move
(
c
->
™em
);

611 
c
->
™em
 = 0;

614 
c
->
eá
 > 0) {

615 
™em
 *
™
 = *(
c
->
icu¼
);

616 
	`as£¹
((
™
->
™_æags
 & 
ITEM_SLABBED
) == 0);

617 
	`™em_»move
(
™
);

618 
c
->
icu¼
++;

619 
c
->
eá
--;

622 ià(
c
->
suffixËá
 != 0) {

623 ; 
c
->
suffixËá
 > 0; c->suffixËá--, c->
suffixcu¼
++) {

624 
	`ÿche_ä“
(
c
->
th»ad
->
suffix_ÿche
, *(c->
suffixcu¼
));

628 
c
->
icu¼
 = c->
i¡
;

629 
c
->
suffixcu¼
 = c->
suffixli¡
;

630 
	}
}

632 
	$cÚn_ş—nup
(
cÚn
 *
c
) {

633 
	`as£¹
(
c
 !ğ
NULL
);

635 
	`cÚn_»Ëa£_™ems
(
c
);

637 ià(
c
->
wr™e_ªd_ä“
) {

638 
	`ä“
(
c
->
wr™e_ªd_ä“
);

639 
c
->
wr™e_ªd_ä“
 = 0;

642 ià(
c
->
§¦_cÚn
) {

643 
	`as£¹
(
£‰šgs
.
§¦
);

644 
	`§¦_di¥o£
(&
c
->
§¦_cÚn
);

645 
c
->
§¦_cÚn
 = 
NULL
;

648 ià(
	`IS_UDP
(
c
->
Œª¥Üt
)) {

649 
	`cÚn_£t_¡©e
(
c
, 
cÚn_»ad
);

651 
	}
}

656 
	$cÚn_ä“
(
cÚn
 *
c
) {

657 ià(
c
) {

658 
	`as£¹
(
c
 !ğ
NULL
);

659 
	`as£¹
(
c
->
sfd
 >ğ0 && c->sfd < 
max_fds
);

661 
	`MEMCACHED_CONN_DESTROY
(
c
);

662 
cÚns
[
c
->
sfd
] = 
NULL
;

663 ià(
c
->
hdrbuf
)

664 
	`ä“
(
c
->
hdrbuf
);

665 ià(
c
->
msgli¡
)

666 
	`ä“
(
c
->
msgli¡
);

667 ià(
c
->
rbuf
)

668 
	`ä“
(
c
->
rbuf
);

669 ià(
c
->
wbuf
)

670 
	`ä“
(
c
->
wbuf
);

671 ià(
c
->
i¡
)

672 
	`ä“
(
c
->
i¡
);

673 ià(
c
->
suffixli¡
)

674 
	`ä“
(
c
->
suffixli¡
);

675 ià(
c
->
iov
)

676 
	`ä“
(
c
->
iov
);

677 
	`ä“
(
c
);

679 
	}
}

681 
	$cÚn_şo£
(
cÚn
 *
c
) {

682 
	`as£¹
(
c
 !ğ
NULL
);

685 
	`ev’t_d–
(&
c
->
ev’t
);

687 ià(
£‰šgs
.
v”bo£
 > 1)

688 
	`årštf
(
¡d”r
, "<%d cÚÃùiÚ clo£d.\n", 
c
->
sfd
);

690 
	`cÚn_ş—nup
(
c
);

692 
	`MEMCACHED_CONN_RELEASE
(
c
->
sfd
);

693 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şo£d
);

694 
	`şo£
(
c
->
sfd
);

696 
	`±h»ad_mu‹x_lock
(&
cÚn_lock
);

697 
®low_Ãw_cÚns
 = 
Œue
;

698 
	`±h»ad_mu‹x_uÆock
(&
cÚn_lock
);

700 
	`STATS_LOCK
();

701 
¡©s_¡©e
.
cu¼_cÚns
--;

702 
	`STATS_UNLOCK
();

705 
	}
}

715 
	$cÚn_shršk
(
cÚn
 *
c
) {

716 
	`as£¹
(
c
 !ğ
NULL
);

718 ià(
	`IS_UDP
(
c
->
Œª¥Üt
))

721 ià(
c
->
rsize
 > 
READ_BUFFER_HIGHWAT
 && c->
rby‹s
 < 
DATA_BUFFER_SIZE
) {

722 *
Ãwbuf
;

724 ià(
c
->
rcu¼
 !ğc->
rbuf
)

725 
	`memmove
(
c
->
rbuf
, c->
rcu¼
, (
size_t
)c->
rby‹s
);

727 
Ãwbuf
 = (*)
	`»®loc
((*)
c
->
rbuf
, 
DATA_BUFFER_SIZE
);

729 ià(
Ãwbuf
) {

730 
c
->
rbuf
 = 
Ãwbuf
;

731 
c
->
rsize
 = 
DATA_BUFFER_SIZE
;

734 
c
->
rcu¼
 = c->
rbuf
;

737 ià(
c
->
isize
 > 
ITEM_LIST_HIGHWAT
) {

738 
™em
 **
Ãwbuf
 = (™em**è
	`»®loc
((*)
c
->
i¡
, 
ITEM_LIST_INITIAL
 * (c->ilist[0]));

739 ià(
Ãwbuf
) {

740 
c
->
i¡
 = 
Ãwbuf
;

741 
c
->
isize
 = 
ITEM_LIST_INITIAL
;

746 ià(
c
->
msgsize
 > 
MSG_LIST_HIGHWAT
) {

747 
msghdr
 *
Ãwbuf
 = (msghd¸*è
	`»®loc
((*)
c
->
msgli¡
, 
MSG_LIST_INITIAL
 * (c->msglist[0]));

748 ià(
Ãwbuf
) {

749 
c
->
msgli¡
 = 
Ãwbuf
;

750 
c
->
msgsize
 = 
MSG_LIST_INITIAL
;

755 ià(
c
->
iovsize
 > 
IOV_LIST_HIGHWAT
) {

756 
iovec
 *
Ãwbuf
 = (ioveø*è
	`»®loc
((*)
c
->
iov
, 
IOV_LIST_INITIAL
 * (c->iov[0]));

757 ià(
Ãwbuf
) {

758 
c
->
iov
 = 
Ãwbuf
;

759 
c
->
iovsize
 = 
IOV_LIST_INITIAL
;

763 
	}
}

768 cÚ¡ *
	$¡©e_‹xt
(
cÚn_¡©es
 
¡©e
) {

769 cÚ¡ * cÚ¡ 
¡©’ames
[] = { "conn_listening",

781  
¡©’ames
[
¡©e
];

782 
	}
}

789 
	$cÚn_£t_¡©e
(
cÚn
 *
c
, 
cÚn_¡©es
 
¡©e
) {

790 
	`as£¹
(
c
 !ğ
NULL
);

791 
	`as£¹
(
¡©e
 >ğ
cÚn_li¡’šg
 && s‹ < 
cÚn_max_¡©e
);

793 ià(
¡©e
 !ğ
c
->state) {

794 ià(
£‰šgs
.
v”bo£
 > 2) {

795 
	`årštf
(
¡d”r
, "%d: going from %so %s\n",

796 
c
->
sfd
, 
	`¡©e_‹xt
(c->
¡©e
),

797 
	`¡©e_‹xt
(
¡©e
));

800 ià(
¡©e
 =ğ
cÚn_wr™e
 || s‹ =ğ
cÚn_mwr™e
) {

801 
	`MEMCACHED_PROCESS_COMMAND_END
(
c
->
sfd
, c->
wbuf
, c->
wby‹s
);

803 
c
->
¡©e
 = state;

805 
	}
}

813 
	$’su»_iov_¥aû
(
cÚn
 *
c
) {

814 
	`as£¹
(
c
 !ğ
NULL
);

816 ià(
c
->
iovu£d
 >ğc->
iovsize
) {

817 
i
, 
iovnum
;

818 
iovec
 *
Ãw_iov
 = (ioveø*)
	`»®loc
(
c
->
iov
,

819 (
c
->
iovsize
 * 2è* (
iovec
));

820 ià(! 
Ãw_iov
) {

821 
	`STATS_LOCK
();

822 
¡©s
.
m®loc_çs
++;

823 
	`STATS_UNLOCK
();

826 
c
->
iov
 = 
Ãw_iov
;

827 
c
->
iovsize
 *= 2;

830 
i
 = 0, 
iovnum
 = 0; i < 
c
->
msgu£d
; i++) {

831 
c
->
msgli¡
[
i
].
msg_iov
 = &c->
iov
[
iovnum
];

832 
iovnum
 +ğ
c
->
msgli¡
[
i
].
msg_iovËn
;

837 
	}
}

847 
	$add_iov
(
cÚn
 *
c
, cÚ¡ *
buf
, 
Ën
) {

848 
msghdr
 *
m
;

849 
Ëáov”
;

850 
boŞ
 
lim™_to_mtu
;

852 
	`as£¹
(
c
 !ğ
NULL
);

855 
m
 = &
c
->
msgli¡
[c->
msgu£d
 - 1];

861 
lim™_to_mtu
 = 
	`IS_UDP
(
c
->
Œª¥Üt
è|| (1 =ğc->
msgu£d
);

864 ià(
m
->
msg_iovËn
 =ğ
IOV_MAX
 ||

865 (
lim™_to_mtu
 && 
c
->
msgby‹s
 >ğ
UDP_MAX_PAYLOAD_SIZE
)) {

866 
	`add_msghdr
(
c
);

867 
m
 = &
c
->
msgli¡
[c->
msgu£d
 - 1];

870 ià(
	`’su»_iov_¥aû
(
c
) != 0)

874 ià(
lim™_to_mtu
 && 
Ën
 + 
c
->
msgby‹s
 > 
UDP_MAX_PAYLOAD_SIZE
) {

875 
Ëáov”
 = 
Ën
 + 
c
->
msgby‹s
 - 
UDP_MAX_PAYLOAD_SIZE
;

876 
Ën
 -ğ
Ëáov”
;

878 
Ëáov”
 = 0;

881 
m
 = &
c
->
msgli¡
[c->
msgu£d
 - 1];

882 
m
->
msg_iov
[m->
msg_iovËn
].
iov_ba£
 = (*)
buf
;

883 
m
->
msg_iov
[m->
msg_iovËn
].
iov_Ën
 = 
Ën
;

885 
c
->
msgby‹s
 +ğ
Ën
;

886 
c
->
iovu£d
++;

887 
m
->
msg_iovËn
++;

889 
buf
 = ((*)bufè+ 
Ën
;

890 
Ën
 = 
Ëáov”
;

891 } 
Ëáov”
 > 0);

894 
	}
}

896 
	$add_chunked_™em_iovs
(
cÚn
 *
c
, 
™em
 *
™
, 
Ën
) {

897 
	`as£¹
(
™
->
™_æags
 & 
ITEM_CHUNKED
);

898 
™em_chunk
 *
ch
 = (™em_chunk *è
	`ITEM_d©a
(
™
);

899 
ch
) {

900 
todo
 = (
Ën
 > 
ch
->
u£d
) ? ch->used :†en;

901 ià(
	`add_iov
(
c
, 
ch
->
d©a
, 
todo
) != 0) {

904 
ch
 = ch->
Ãxt
;

905 
Ën
 -ğ
todo
;

908 
	}
}

913 
	$bud_udp_h—d”s
(
cÚn
 *
c
) {

914 
i
;

915 *
hdr
;

917 
	`as£¹
(
c
 !ğ
NULL
);

919 ià(
c
->
msgu£d
 > c->
hdrsize
) {

920 *
Ãw_hdrbuf
;

921 ià(
c
->
hdrbuf
) {

922 
Ãw_hdrbuf
 = 
	`»®loc
(
c
->
hdrbuf
, c->
msgu£d
 * 2 * 
UDP_HEADER_SIZE
);

924 
Ãw_hdrbuf
 = 
	`m®loc
(
c
->
msgu£d
 * 2 * 
UDP_HEADER_SIZE
);

927 ià(! 
Ãw_hdrbuf
) {

928 
	`STATS_LOCK
();

929 
¡©s
.
m®loc_çs
++;

930 
	`STATS_UNLOCK
();

933 
c
->
hdrbuf
 = (*)
Ãw_hdrbuf
;

934 
c
->
hdrsize
 = c->
msgu£d
 * 2;

937 
hdr
 = 
c
->
hdrbuf
;

938 
i
 = 0; i < 
c
->
msgu£d
; i++) {

939 
c
->
msgli¡
[
i
].
msg_iov
[0].
iov_ba£
 = (*)
hdr
;

940 
c
->
msgli¡
[
i
].
msg_iov
[0].
iov_Ën
 = 
UDP_HEADER_SIZE
;

941 *
hdr
++ = 
c
->
»que¡_id
 / 256;

942 *
hdr
++ = 
c
->
»que¡_id
 % 256;

943 *
hdr
++ = 
i
 / 256;

944 *
hdr
++ = 
i
 % 256;

945 *
hdr
++ = 
c
->
msgu£d
 / 256;

946 *
hdr
++ = 
c
->
msgu£d
 % 256;

947 *
hdr
++ = 0;

948 *
hdr
++ = 0;

949 
	`as£¹
((*è
hdr
 =ğ(
ÿddr_t
)
c
->
msgli¡
[
i
].
msg_iov
[0].
iov_ba£
 + 
UDP_HEADER_SIZE
);

953 
	}
}

956 
	$out_¡ršg
(
cÚn
 *
c
, cÚ¡ *
¡r
) {

957 
size_t
 
Ën
;

959 
	`as£¹
(
c
 !ğ
NULL
);

961 ià(
c
->
nÜ•ly
) {

962 ià(
£‰šgs
.
v”bo£
 > 1)

963 
	`årštf
(
¡d”r
, ">%d NOREPLY %s\n", 
c
->
sfd
, 
¡r
);

964 
c
->
nÜ•ly
 = 
çl£
;

965 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ãw_cmd
);

969 ià(
£‰šgs
.
v”bo£
 > 1)

970 
	`årštf
(
¡d”r
, ">%d %s\n", 
c
->
sfd
, 
¡r
);

973 
c
->
msgcu¼
 = 0;

974 
c
->
msgu£d
 = 0;

975 
c
->
iovu£d
 = 0;

976 
	`add_msghdr
(
c
);

978 
Ën
 = 
	`¡¾’
(
¡r
);

979 ià((
Ën
 + 2è> 
c
->
wsize
) {

981 
¡r
 = "SERVER_ERROR output†ineoo†ong";

982 
Ën
 = 
	`¡¾’
(
¡r
);

985 
	`memıy
(
c
->
wbuf
, 
¡r
, 
Ën
);

986 
	`memıy
(
c
->
wbuf
 + 
Ën
, "\r\n", 2);

987 
c
->
wby‹s
 = 
Ën
 + 2;

988 
c
->
wcu¼
 = c->
wbuf
;

990 
	`cÚn_£t_¡©e
(
c
, 
cÚn_wr™e
);

991 
c
->
wr™e_ªd_go
 = 
cÚn_Ãw_cmd
;

993 
	}
}

999 
	$out_of_memÜy
(
cÚn
 *
c
, *
ascii_”rÜ
) {

1000 cÚ¡ 
”rÜ_´efix
[] = "SERVER_ERROR ";

1001 cÚ¡ 
”rÜ_´efix_Ën
 = (
”rÜ_´efix
) - 1;

1003 ià(
c
->
´ÙocŞ
 =ğ
bš¬y_´Ù
) {

1005 ià(!
	`¡ºcmp
(
ascii_”rÜ
, 
”rÜ_´efix
, 
”rÜ_´efix_Ën
)) {

1006 
ascii_”rÜ
 +ğ
”rÜ_´efix_Ën
;

1008 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_ENOMEM
, 
ascii_”rÜ
, 0);

1010 
	`out_¡ršg
(
c
, 
ascii_”rÜ
);

1012 
	}
}

1018 
	$com¶‘e_Ä—d_ascii
(
cÚn
 *
c
) {

1019 
	`as£¹
(
c
 !ğ
NULL
);

1021 
™em
 *
™
 = 
c
->item;

1022 
comm
 = 
c
->
cmd
;

1023 
¡Üe_™em_ty³
 
»t
;

1024 
boŞ
 
is_v®id
 = 
çl£
;

1026 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1027 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
£t_cmds
++;

1028 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1030 ià((
™
->
™_æags
 & 
ITEM_CHUNKED
) == 0) {

1031 ià(
	`¡ºcmp
(
	`ITEM_d©a
(
™
è+ it->
nby‹s
 - 2, "\r\n", 2) == 0) {

1032 
is_v®id
 = 
Œue
;

1035 
buf
[2];

1037 
™em_chunk
 *
ch
 = (™em_chunk *è
c
->
r™em
;

1038 
	`as£¹
(
ch
->
u£d
 != 0);

1042 ià(
ch
->
u£d
 > 1) {

1043 
buf
[0] = 
ch
->
d©a
[ch->
u£d
 - 2];

1044 
buf
[1] = 
ch
->
d©a
[ch->
u£d
 - 1];

1046 
	`as£¹
(
ch
->
´ev
);

1047 
	`as£¹
(
ch
->
u£d
 == 1);

1048 
buf
[0] = 
ch
->
´ev
->
d©a
[ch->´ev->
u£d
 - 1];

1049 
buf
[1] = 
ch
->
d©a
[ch->
u£d
 - 1];

1051 ià(
	`¡ºcmp
(
buf
, "\r\n", 2) == 0) {

1052 
is_v®id
 = 
Œue
;

1054 
	`as£¹
(1 == 0);

1058 ià(!
is_v®id
) {

1059 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad data chunk");

1061 
»t
 = 
	`¡Üe_™em
(
™
, 
comm
, 
c
);

1063 #ifdeà
ENABLE_DTRACE


1064 
ušt64_t
 
ÿs
 = 
	`ITEM_g‘_ÿs
(
™
);

1065 
c
->
cmd
) {

1066 
NREAD_ADD
:

1067 
	`MEMCACHED_COMMAND_ADD
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1068 (
»t
 =ğ1è? 
™
->
nby‹s
 : -1, 
ÿs
);

1070 
NREAD_REPLACE
:

1071 
	`MEMCACHED_COMMAND_REPLACE
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1072 (
»t
 =ğ1è? 
™
->
nby‹s
 : -1, 
ÿs
);

1074 
NREAD_APPEND
:

1075 
	`MEMCACHED_COMMAND_APPEND
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1076 (
»t
 =ğ1è? 
™
->
nby‹s
 : -1, 
ÿs
);

1078 
NREAD_PREPEND
:

1079 
	`MEMCACHED_COMMAND_PREPEND
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1080 (
»t
 =ğ1è? 
™
->
nby‹s
 : -1, 
ÿs
);

1082 
NREAD_SET
:

1083 
	`MEMCACHED_COMMAND_SET
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1084 (
»t
 =ğ1è? 
™
->
nby‹s
 : -1, 
ÿs
);

1086 
NREAD_CAS
:

1087 
	`MEMCACHED_COMMAND_CAS
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
, it->
nby‹s
,

1088 
ÿs
);

1093 
»t
) {

1094 
STORED
:

1095 
	`out_¡ršg
(
c
, "STORED");

1097 
EXISTS
:

1098 
	`out_¡ršg
(
c
, "EXISTS");

1100 
NOT_FOUND
:

1101 
	`out_¡ršg
(
c
, "NOT_FOUND");

1103 
NOT_STORED
:

1104 
	`out_¡ršg
(
c
, "NOT_STORED");

1107 
	`out_¡ršg
(
c
, "SERVER_ERROR Unhandled storageype.");

1112 
	`™em_»move
(
c
->
™em
);

1113 
c
->
™em
 = 0;

1114 
	}
}

1119 * 
	$bš¬y_g‘_»que¡
(
cÚn
 *
c
) {

1120 *
»t
 = 
c
->
rcu¼
;

1121 
»t
 -ğ((
c
->
bš¬y_h—d”
è+ c->bš¬y_h—d”.
»que¡
.
keyËn
 +

1122 
c
->
bš¬y_h—d”
.
»que¡
.
ex’
);

1124 
	`as£¹
(
»t
 >ğ
c
->
rbuf
);

1125  
»t
;

1126 
	}
}

1131 * 
	$bš¬y_g‘_key
(
cÚn
 *
c
) {

1132  
c
->
rcu¼
 - (c->
bš¬y_h—d”
.
»que¡
.
keyËn
);

1133 
	}
}

1135 
	$add_bš_h—d”
(
cÚn
 *
c
, 
ušt16_t
 
”r
, 
ušt8_t
 
hdr_Ën
, ušt16_ˆ
key_Ën
, 
ušt32_t
 
body_Ën
) {

1136 
´ÙocŞ_bš¬y_»¥Ú£_h—d”
* 
h—d”
;

1138 
	`as£¹
(
c
);

1140 
c
->
msgcu¼
 = 0;

1141 
c
->
msgu£d
 = 0;

1142 
c
->
iovu£d
 = 0;

1143 ià(
	`add_msghdr
(
c
) != 0) {

1147 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory‡dding binary header");

1151 
h—d”
 = (
´ÙocŞ_bš¬y_»¥Ú£_h—d”
 *)
c
->
wbuf
;

1153 
h—d”
->
»¥Ú£
.
magic
 = (
ušt8_t
)
PROTOCOL_BINARY_RES
;

1154 
h—d”
->
»¥Ú£
.
İcode
 = 
c
->
bš¬y_h—d”
.
»que¡
.opcode;

1155 
h—d”
->
»¥Ú£
.
keyËn
 = (
ušt16_t
)
	`htÚs
(
key_Ën
);

1157 
h—d”
->
»¥Ú£
.
ex’
 = (
ušt8_t
)
hdr_Ën
;

1158 
h—d”
->
»¥Ú£
.
d©©y³
 = (
ušt8_t
)
PROTOCOL_BINARY_RAW_BYTES
;

1159 
h—d”
->
»¥Ú£
.
¡©us
 = (
ušt16_t
)
	`htÚs
(
”r
);

1161 
h—d”
->
»¥Ú£
.
bodyËn
 = 
	`htÚl
(
body_Ën
);

1162 
h—d”
->
»¥Ú£
.
İaque
 = 
c
->opaque;

1163 
h—d”
->
»¥Ú£
.
ÿs
 = 
	`htÚÎ
(
c
->cas);

1165 ià(
£‰šgs
.
v”bo£
 > 1) {

1166 
ii
;

1167 
	`årštf
(
¡d”r
, ">%d Wr™šg bš„e¥Ú£:", 
c
->
sfd
);

1168 
ii
 = 0; i˜< (
h—d”
->
by‹s
); ++ii) {

1169 ià(
ii
 % 4 == 0) {

1170 
	`årštf
(
¡d”r
, "\n>%d ", 
c
->
sfd
);

1172 
	`årštf
(
¡d”r
, " 0x%02x", 
h—d”
->
by‹s
[
ii
]);

1174 
	`årštf
(
¡d”r
, "\n");

1177 
	`add_iov
(
c
, c->
wbuf
, (
h—d”
->
»¥Ú£
));

1178 
	}
}

1185 
	$wr™e_bš_”rÜ
(
cÚn
 *
c
, 
´ÙocŞ_bš¬y_»¥Ú£_¡©us
 
”r
,

1186 cÚ¡ *
”r¡r
, 
sw®low
) {

1187 
size_t
 
Ën
;

1189 ià(!
”r¡r
) {

1190 
”r
) {

1191 
PROTOCOL_BINARY_RESPONSE_ENOMEM
:

1192 
”r¡r
 = "Out of memory";

1194 
PROTOCOL_BINARY_RESPONSE_UNKNOWN_COMMAND
:

1195 
”r¡r
 = "Unknown command";

1197 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
:

1198 
”r¡r
 = "Not found";

1200 
PROTOCOL_BINARY_RESPONSE_EINVAL
:

1201 
”r¡r
 = "Invalid‡rguments";

1203 
PROTOCOL_BINARY_RESPONSE_KEY_EEXISTS
:

1204 
”r¡r
 = "Dataƒxists for key.";

1206 
PROTOCOL_BINARY_RESPONSE_E2BIG
:

1207 
”r¡r
 = "Too†arge.";

1209 
PROTOCOL_BINARY_RESPONSE_DELTA_BADVAL
:

1210 
”r¡r
 = "Non-numeric server-side value for incr or decr";

1212 
PROTOCOL_BINARY_RESPONSE_NOT_STORED
:

1213 
”r¡r
 = "Not stored.";

1215 
PROTOCOL_BINARY_RESPONSE_AUTH_ERROR
:

1216 
”r¡r
 = "Auth failure.";

1219 
	`as£¹
(
çl£
);

1220 
”r¡r
 = "UNHANDLED ERROR";

1221 
	`årštf
(
¡d”r
, ">%d UNHANDLED ERROR: %d\n", 
c
->
sfd
, 
”r
);

1225 ià(
£‰šgs
.
v”bo£
 > 1) {

1226 
	`årštf
(
¡d”r
, ">%d Wr™šg‡À”rÜ: %s\n", 
c
->
sfd
, 
”r¡r
);

1229 
Ën
 = 
	`¡¾’
(
”r¡r
);

1230 
	`add_bš_h—d”
(
c
, 
”r
, 0, 0, 
Ën
);

1231 ià(
Ën
 > 0) {

1232 
	`add_iov
(
c
, 
”r¡r
, 
Ën
);

1234 
	`cÚn_£t_¡©e
(
c
, 
cÚn_mwr™e
);

1235 if(
sw®low
 > 0) {

1236 
c
->
sby‹s
 = 
sw®low
;

1237 
c
->
wr™e_ªd_go
 = 
cÚn_sw®low
;

1239 
c
->
wr™e_ªd_go
 = 
cÚn_Ãw_cmd
;

1241 
	}
}

1244 
	$wr™e_bš_»¥Ú£
(
cÚn
 *
c
, *
d
, 
hËn
, 
keyËn
, 
dËn
) {

1245 ià(!
c
->
nÜ•ly
 || c->
cmd
 =ğ
PROTOCOL_BINARY_CMD_GET
 ||

1246 
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_GETK
) {

1247 
	`add_bš_h—d”
(
c
, 0, 
hËn
, 
keyËn
, 
dËn
);

1248 if(
dËn
 > 0) {

1249 
	`add_iov
(
c
, 
d
, 
dËn
);

1251 
	`cÚn_£t_¡©e
(
c
, 
cÚn_mwr™e
);

1252 
c
->
wr™e_ªd_go
 = 
cÚn_Ãw_cmd
;

1254 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ãw_cmd
);

1256 
	}
}

1258 
	$com¶‘e_šü_bš
(
cÚn
 *
c
) {

1259 
™em
 *
™
;

1260 *
key
;

1261 
size_t
 
nkey
;

1263 
tmpbuf
[
INCR_MAX_STORAGE_LEN
];

1264 
ušt64_t
 
ÿs
 = 0;

1266 
´ÙocŞ_bš¬y_»¥Ú£_šü
* 
r¥
 = (´ÙocŞ_bš¬y_»¥Ú£_šü*)
c
->
wbuf
;

1267 
´ÙocŞ_bš¬y_»que¡_šü
* 
»q
 = 
	`bš¬y_g‘_»que¡
(
c
);

1269 
	`as£¹
(
c
 !ğ
NULL
);

1270 
	`as£¹
(
c
->
wsize
 >ğ(*
r¥
));

1273 
»q
->
mes§ge
.
body
.
d–
 = 
	`ÁohÎ
(req->message.body.delta);

1274 
»q
->
mes§ge
.
body
.
š™Ÿl
 = 
	`ÁohÎ
(req->message.body.initial);

1275 
»q
->
mes§ge
.
body
.
expœ©iÚ
 = 
	`Áohl
(req->message.body.expiration);

1276 
key
 = 
	`bš¬y_g‘_key
(
c
);

1277 
nkey
 = 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
;

1279 ià(
£‰šgs
.
v”bo£
 > 1) {

1280 
i
;

1281 
	`årštf
(
¡d”r
, "incr ");

1283 
i
 = 0; i < 
nkey
; i++) {

1284 
	`årštf
(
¡d”r
, "%c", 
key
[
i
]);

1286 
	`årštf
(
¡d”r
, " %lld, %llu, %d\n",

1287 ()
»q
->
mes§ge
.
body
.
d–
,

1288 ()
»q
->
mes§ge
.
body
.
š™Ÿl
,

1289 
»q
->
mes§ge
.
body
.
expœ©iÚ
);

1292 ià(
c
->
bš¬y_h—d”
.
»que¡
.
ÿs
 != 0) {

1293 
ÿs
 = 
c
->
bš¬y_h—d”
.
»que¡
.cas;

1295 
	`add_d–
(
c
, 
key
, 
nkey
, c->
cmd
 =ğ
PROTOCOL_BINARY_CMD_INCREMENT
,

1296 
»q
->
mes§ge
.
body
.
d–
, 
tmpbuf
,

1297 &
ÿs
)) {

1298 
OK
:

1299 
r¥
->
mes§ge
.
body
.
v®ue
 = 
	`htÚÎ
(
	`¡¹ouÎ
(
tmpbuf
, 
NULL
, 10));

1300 ià(
ÿs
) {

1301 
c
->
ÿs
 = cas;

1303 
	`wr™e_bš_»¥Ú£
(
c
, &
r¥
->
mes§ge
.
body
, 0, 0,

1304 (
r¥
->
mes§ge
.
body
.
v®ue
));

1306 
NON_NUMERIC
:

1307 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_DELTA_BADVAL
, 
NULL
, 0);

1309 
EOM
:

1310 
	`out_of_memÜy
(
c
, "SERVER_ERROR Out of memory incrementing value");

1312 
DELTA_ITEM_NOT_FOUND
:

1313 ià(
»q
->
mes§ge
.
body
.
expœ©iÚ
 != 0xffffffff) {

1315 
r¥
->
mes§ge
.
body
.
v®ue
 = 
	`htÚÎ
(
»q
->mes§ge.body.
š™Ÿl
);

1317 
	`¢´štf
(
tmpbuf
, 
INCR_MAX_STORAGE_LEN
, "%llu",

1318 ()
»q
->
mes§ge
.
body
.
š™Ÿl
);

1319 
»s
 = 
	`¡¾’
(
tmpbuf
);

1320 
™
 = 
	`™em_®loc
(
key
, 
nkey
, 0, 
	`»®time
(
»q
->
mes§ge
.
body
.
expœ©iÚ
),

1321 
»s
 + 2);

1323 ià(
™
 !ğ
NULL
) {

1324 
	`memıy
(
	`ITEM_d©a
(
™
), 
tmpbuf
, 
»s
);

1325 
	`memıy
(
	`ITEM_d©a
(
™
è+ 
»s
, "\r\n", 2);

1327 ià(
	`¡Üe_™em
(
™
, 
NREAD_ADD
, 
c
)) {

1328 
c
->
ÿs
 = 
	`ITEM_g‘_ÿs
(
™
);

1329 
	`wr™e_bš_»¥Ú£
(
c
, &
r¥
->
mes§ge
.
body
, 0, 0, Ô¥->mes§ge.body.
v®ue
));

1331 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_NOT_STORED
,

1332 
NULL
, 0);

1334 
	`™em_»move
(
™
);

1336 
	`out_of_memÜy
(
c
,

1340 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1341 ià(
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_INCREMENT
) {

1342 
c
->
th»ad
->
¡©s
.
šü_mis£s
++;

1344 
c
->
th»ad
->
¡©s
.
deü_mis£s
++;

1346 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1348 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
, 
NULL
, 0);

1351 
DELTA_ITEM_CAS_MISMATCH
:

1352 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_EEXISTS
, 
NULL
, 0);

1355 
	}
}

1357 
	$com¶‘e_upd©e_bš
(
cÚn
 *
c
) {

1358 
´ÙocŞ_bš¬y_»¥Ú£_¡©us
 
’o
 = 
PROTOCOL_BINARY_RESPONSE_EINVAL
;

1359 
¡Üe_™em_ty³
 
»t
 = 
NOT_STORED
;

1360 
	`as£¹
(
c
 !ğ
NULL
);

1362 
™em
 *
™
 = 
c
->item;

1364 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1365 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
£t_cmds
++;

1366 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1370 ià((
™
->
™_æags
 & 
ITEM_CHUNKED
) == 0) {

1371 *(
	`ITEM_d©a
(
™
è+ it->
nby‹s
 - 2) = '\r';

1372 *(
	`ITEM_d©a
(
™
è+ it->
nby‹s
 - 1) = '\n';

1374 
	`as£¹
(
c
->
r™em
);

1375 
™em_chunk
 *
ch
 = (™em_chunk *è
c
->
r™em
;

1376 ià(
ch
->
size
 =ğch->
u£d
)

1377 
ch
 = ch->
Ãxt
;

1378 ià(
ch
->
size
 - ch->
u£d
 > 1) {

1379 
ch
->
d©a
[ch->
u£d
 + 1] = '\r';

1380 
ch
->
d©a
[ch->
u£d
 + 2] = '\n';

1381 
ch
->
u£d
 += 2;

1383 
ch
->
d©a
[ch->
u£d
 + 1] = '\r';

1384 
ch
->
Ãxt
->
d©a
[0] = '\n';

1385 
ch
->
u£d
++;

1386 
ch
->
Ãxt
->
u£d
++;

1387 
	`as£¹
(
ch
->
size
 =ğch->
u£d
);

1391 
»t
 = 
	`¡Üe_™em
(
™
, 
c
->
cmd
, c);

1393 #ifdeà
ENABLE_DTRACE


1394 
ušt64_t
 
ÿs
 = 
	`ITEM_g‘_ÿs
(
™
);

1395 
c
->
cmd
) {

1396 
NREAD_ADD
:

1397 
	`MEMCACHED_COMMAND_ADD
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1398 (
»t
 =ğ
STORED
è? 
™
->
nby‹s
 : -1, 
ÿs
);

1400 
NREAD_REPLACE
:

1401 
	`MEMCACHED_COMMAND_REPLACE
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1402 (
»t
 =ğ
STORED
è? 
™
->
nby‹s
 : -1, 
ÿs
);

1404 
NREAD_APPEND
:

1405 
	`MEMCACHED_COMMAND_APPEND
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1406 (
»t
 =ğ
STORED
è? 
™
->
nby‹s
 : -1, 
ÿs
);

1408 
NREAD_PREPEND
:

1409 
	`MEMCACHED_COMMAND_PREPEND
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1410 (
»t
 =ğ
STORED
è? 
™
->
nby‹s
 : -1, 
ÿs
);

1412 
NREAD_SET
:

1413 
	`MEMCACHED_COMMAND_SET
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1414 (
»t
 =ğ
STORED
è? 
™
->
nby‹s
 : -1, 
ÿs
);

1419 
»t
) {

1420 
STORED
:

1422 
	`wr™e_bš_»¥Ú£
(
c
, 
NULL
, 0, 0, 0);

1424 
EXISTS
:

1425 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_EEXISTS
, 
NULL
, 0);

1427 
NOT_FOUND
:

1428 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
, 
NULL
, 0);

1430 
NOT_STORED
:

1431 
TOO_LARGE
:

1432 
NO_MEMORY
:

1433 ià(
c
->
cmd
 =ğ
NREAD_ADD
) {

1434 
’o
 = 
PROTOCOL_BINARY_RESPONSE_KEY_EEXISTS
;

1435 } if(
c
->
cmd
 =ğ
NREAD_REPLACE
) {

1436 
’o
 = 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
;

1438 
’o
 = 
PROTOCOL_BINARY_RESPONSE_NOT_STORED
;

1440 
	`wr™e_bš_”rÜ
(
c
, 
’o
, 
NULL
, 0);

1443 
	`™em_»move
(
c
->
™em
);

1444 
c
->
™em
 = 0;

1445 
	}
}

1447 
	$´oûss_bš_g‘_Ü_touch
(
cÚn
 *
c
) {

1448 
™em
 *
™
;

1450 
´ÙocŞ_bš¬y_»¥Ú£_g‘
* 
r¥
 = (´ÙocŞ_bš¬y_»¥Ú£_g‘*)
c
->
wbuf
;

1451 * 
key
 = 
	`bš¬y_g‘_key
(
c
);

1452 
size_t
 
nkey
 = 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
;

1453 
should_touch
 = (
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_TOUCH
 ||

1454 
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_GAT
 ||

1455 
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_GATK
);

1456 
should_»tuº_key
 = (
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_GETK
 ||

1457 
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_GATK
);

1458 
should_»tuº_v®ue
 = (
c
->
cmd
 !ğ
PROTOCOL_BINARY_CMD_TOUCH
);

1460 ià(
£‰šgs
.
v”bo£
 > 1) {

1461 
	`årštf
(
¡d”r
, "<%d % ", 
c
->
sfd
, 
should_touch
 ? "TOUCH" : "GET");

1462 ià(
	`fwr™e
(
key
, 1, 
nkey
, 
¡d”r
)) {}

1463 
	`åutc
('\n', 
¡d”r
);

1466 ià(
should_touch
) {

1467 
´ÙocŞ_bš¬y_»que¡_touch
 *
t
 = 
	`bš¬y_g‘_»que¡
(
c
);

1468 
time_t
 
ex±ime
 = 
	`Áohl
(
t
->
mes§ge
.
body
.
expœ©iÚ
);

1470 
™
 = 
	`™em_touch
(
key
, 
nkey
, 
	`»®time
(
ex±ime
), 
c
);

1472 
™
 = 
	`™em_g‘
(
key
, 
nkey
, 
c
);

1475 ià(
™
) {

1477 
ušt16_t
 
keyËn
 = 0;

1478 
ušt32_t
 
bodyËn
 = (
r¥
->
mes§ge
.
body
è+ (
™
->
nby‹s
 - 2);

1480 
	`™em_upd©e
(
™
);

1481 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1482 ià(
should_touch
) {

1483 
c
->
th»ad
->
¡©s
.
touch_cmds
++;

1484 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
touch_h™s
++;

1486 
c
->
th»ad
->
¡©s
.
g‘_cmds
++;

1487 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
g‘_h™s
++;

1489 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1491 ià(
should_touch
) {

1492 
	`MEMCACHED_COMMAND_TOUCH
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1493 
™
->
nby‹s
, 
	`ITEM_g‘_ÿs
(it));

1495 
	`MEMCACHED_COMMAND_GET
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

1496 
™
->
nby‹s
, 
	`ITEM_g‘_ÿs
(it));

1499 ià(
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_TOUCH
) {

1500 
bodyËn
 -ğ
™
->
nby‹s
 - 2;

1501 } ià(
should_»tuº_key
) {

1502 
bodyËn
 +ğ
nkey
;

1503 
keyËn
 = 
nkey
;

1506 
	`add_bš_h—d”
(
c
, 0, (
r¥
->
mes§ge
.
body
), 
keyËn
, 
bodyËn
);

1507 
r¥
->
mes§ge
.
h—d”
.
»¥Ú£
.
ÿs
 = 
	`htÚÎ
(
	`ITEM_g‘_ÿs
(
™
));

1510 
r¥
->
mes§ge
.
body
.
æags
 = 
	`htÚl
(
	`¡¹oul
(
	`ITEM_suffix
(
™
), 
NULL
, 10));

1511 
	`add_iov
(
c
, &
r¥
->
mes§ge
.
body
, (rsp->message.body));

1513 ià(
should_»tuº_key
) {

1514 
	`add_iov
(
c
, 
	`ITEM_key
(
™
), 
nkey
);

1517 ià(
should_»tuº_v®ue
) {

1519 ià((
™
->
™_æags
 & 
ITEM_CHUNKED
) == 0) {

1520 
	`add_iov
(
c
, 
	`ITEM_d©a
(
™
), it->
nby‹s
 - 2);

1522 
	`add_chunked_™em_iovs
(
c
, 
™
, it->
nby‹s
 - 2);

1526 
	`cÚn_£t_¡©e
(
c
, 
cÚn_mwr™e
);

1527 
c
->
wr™e_ªd_go
 = 
cÚn_Ãw_cmd
;

1529 
c
->
™em
 = 
™
;

1531 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1532 ià(
should_touch
) {

1533 
c
->
th»ad
->
¡©s
.
touch_cmds
++;

1534 
c
->
th»ad
->
¡©s
.
touch_mis£s
++;

1536 
c
->
th»ad
->
¡©s
.
g‘_cmds
++;

1537 
c
->
th»ad
->
¡©s
.
g‘_mis£s
++;

1539 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1541 ià(
should_touch
) {

1542 
	`MEMCACHED_COMMAND_TOUCH
(
c
->
sfd
, 
key
, 
nkey
, -1, 0);

1544 
	`MEMCACHED_COMMAND_GET
(
c
->
sfd
, 
key
, 
nkey
, -1, 0);

1547 ià(
c
->
nÜ•ly
) {

1548 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ãw_cmd
);

1550 ià(
should_»tuº_key
) {

1551 *
ofs
 = 
c
->
wbuf
 + (
´ÙocŞ_bš¬y_»¥Ú£_h—d”
);

1552 
	`add_bš_h—d”
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
,

1553 0, 
nkey
,‚key);

1554 
	`memıy
(
ofs
, 
key
, 
nkey
);

1555 
	`add_iov
(
c
, 
ofs
, 
nkey
);

1556 
	`cÚn_£t_¡©e
(
c
, 
cÚn_mwr™e
);

1557 
c
->
wr™e_ªd_go
 = 
cÚn_Ãw_cmd
;

1559 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
,

1560 
NULL
, 0);

1565 ià(
£‰šgs
.
d‘a_’abËd
) {

1566 
	`¡©s_´efix_»cÜd_g‘
(
key
, 
nkey
, 
NULL
 !ğ
™
);

1568 
	}
}

1570 
	$­³nd_bš_¡©s
(cÚ¡ *
key
, cÚ¡ 
ušt16_t
 
kËn
,

1571 cÚ¡ *
v®
, cÚ¡ 
ušt32_t
 
vËn
,

1572 
cÚn
 *
c
) {

1573 *
buf
 = 
c
->
¡©s
.
bufãr
 + c->¡©s.
off£t
;

1574 
ušt32_t
 
bodyËn
 = 
kËn
 + 
vËn
;

1575 
´ÙocŞ_bš¬y_»¥Ú£_h—d”
 
h—d”
 = {

1576 .
»¥Ú£
.
magic
 = (
ušt8_t
)
PROTOCOL_BINARY_RES
,

1577 .
»¥Ú£
.
İcode
 = 
PROTOCOL_BINARY_CMD_STAT
,

1578 .
»¥Ú£
.
keyËn
 = (
ušt16_t
)
	`htÚs
(
kËn
),

1579 .
»¥Ú£
.
d©©y³
 = (
ušt8_t
)
PROTOCOL_BINARY_RAW_BYTES
,

1580 .
»¥Ú£
.
bodyËn
 = 
	`htÚl
(bodylen),

1581 .
»¥Ú£
.
İaque
 = 
c
->opaque

1584 
	`memıy
(
buf
, 
h—d”
.
by‹s
, (h—d”.
»¥Ú£
));

1585 
buf
 +ğ(
h—d”
.
»¥Ú£
);

1587 ià(
kËn
 > 0) {

1588 
	`memıy
(
buf
, 
key
, 
kËn
);

1589 
buf
 +ğ
kËn
;

1591 ià(
vËn
 > 0) {

1592 
	`memıy
(
buf
, 
v®
, 
vËn
);

1596 
c
->
¡©s
.
off£t
 +ğ(
h—d”
.
»¥Ú£
è+ 
bodyËn
;

1597 
	}
}

1599 
	$­³nd_ascii_¡©s
(cÚ¡ *
key
, cÚ¡ 
ušt16_t
 
kËn
,

1600 cÚ¡ *
v®
, cÚ¡ 
ušt32_t
 
vËn
,

1601 
cÚn
 *
c
) {

1602 *
pos
 = 
c
->
¡©s
.
bufãr
 + c->¡©s.
off£t
;

1603 
ušt32_t
 
nby‹s
 = 0;

1604 
»maššg
 = 
c
->
¡©s
.
size
 - c->¡©s.
off£t
;

1605 
room
 = 
»maššg
 - 1;

1607 ià(
kËn
 =ğ0 && 
vËn
 == 0) {

1608 
nby‹s
 = 
	`¢´štf
(
pos
, 
room
, "END\r\n");

1609 } ià(
vËn
 == 0) {

1610 
nby‹s
 = 
	`¢´štf
(
pos
, 
room
, "STAT %s\r\n", 
key
);

1612 
nby‹s
 = 
	`¢´štf
(
pos
, 
room
, "STAT % %s\r\n", 
key
, 
v®
);

1615 
c
->
¡©s
.
off£t
 +ğ
nby‹s
;

1616 
	}
}

1618 
boŞ
 
	$grow_¡©s_buf
(
cÚn
 *
c
, 
size_t
 
Ãeded
) {

1619 
size_t
 
nsize
 = 
c
->
¡©s
.
size
;

1620 
size_t
 
avaabË
 = 
nsize
 - 
c
->
¡©s
.
off£t
;

1621 
boŞ
 
rv
 = 
Œue
;

1624 ià(
c
->
¡©s
.
bufãr
 =ğ
NULL
) {

1625 
nsize
 = 1024;

1626 
avaabË
 = 
c
->
¡©s
.
size
 = c->¡©s.
off£t
 = 0;

1629 
Ãeded
 > 
avaabË
) {

1630 
	`as£¹
(
nsize
 > 0);

1631 
nsize
 =‚size << 1;

1632 
avaabË
 = 
nsize
 - 
c
->
¡©s
.
off£t
;

1635 ià(
nsize
 !ğ
c
->
¡©s
.
size
) {

1636 *
±r
 = 
	`»®loc
(
c
->
¡©s
.
bufãr
, 
nsize
);

1637 ià(
±r
) {

1638 
c
->
¡©s
.
bufãr
 = 
±r
;

1639 
c
->
¡©s
.
size
 = 
nsize
;

1641 
	`STATS_LOCK
();

1642 
¡©s
.
m®loc_çs
++;

1643 
	`STATS_UNLOCK
();

1644 
rv
 = 
çl£
;

1648  
rv
;

1649 
	}
}

1651 
	$­³nd_¡©s
(cÚ¡ *
key
, cÚ¡ 
ušt16_t
 
kËn
,

1652 cÚ¡ *
v®
, cÚ¡ 
ušt32_t
 
vËn
,

1653 cÚ¡ *
cook›
)

1656 ià(
kËn
 =ğ0 && 
vËn
 > 0) {

1660 
cÚn
 *
c
 = (cÚn*)
cook›
;

1662 ià(
c
->
´ÙocŞ
 =ğ
bš¬y_´Ù
) {

1663 
size_t
 
Ãeded
 = 
vËn
 + 
kËn
 + (
´ÙocŞ_bš¬y_»¥Ú£_h—d”
);

1664 ià(!
	`grow_¡©s_buf
(
c
, 
Ãeded
)) {

1667 
	`­³nd_bš_¡©s
(
key
, 
kËn
, 
v®
, 
vËn
, 
c
);

1669 
size_t
 
Ãeded
 = 
vËn
 + 
kËn
 + 10;

1670 ià(!
	`grow_¡©s_buf
(
c
, 
Ãeded
)) {

1673 
	`­³nd_ascii_¡©s
(
key
, 
kËn
, 
v®
, 
vËn
, 
c
);

1676 
	`as£¹
(
c
->
¡©s
.
off£t
 <ğc->¡©s.
size
);

1677 
	}
}

1679 
	$´oûss_bš_¡©
(
cÚn
 *
c
) {

1680 *
subcommªd
 = 
	`bš¬y_g‘_key
(
c
);

1681 
size_t
 
nkey
 = 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
;

1683 ià(
£‰šgs
.
v”bo£
 > 1) {

1684 
ii
;

1685 
	`årštf
(
¡d”r
, "<%d STATS ", 
c
->
sfd
);

1686 
ii
 = 0; i˜< 
nkey
; ++ii) {

1687 
	`årštf
(
¡d”r
, "%c", 
subcommªd
[
ii
]);

1689 
	`årštf
(
¡d”r
, "\n");

1692 ià(
nkey
 == 0) {

1694 
	`£rv”_¡©s
(&
­³nd_¡©s
, 
c
);

1695 ()
	`g‘_¡©s
(
NULL
, 0, &
­³nd_¡©s
, 
c
);

1696 } ià(
	`¡ºcmp
(
subcommªd
, "reset", 5) == 0) {

1697 
	`¡©s_»£t
();

1698 } ià(
	`¡ºcmp
(
subcommªd
, "settings", 8) == 0) {

1699 
	`´oûss_¡©_£‰šgs
(&
­³nd_¡©s
, 
c
);

1700 } ià(
	`¡ºcmp
(
subcommªd
, "detail", 6) == 0) {

1701 *
subcmd_pos
 = 
subcommªd
 + 6;

1702 ià(
	`¡ºcmp
(
subcmd_pos
, " dump", 5) == 0) {

1703 
Ën
;

1704 *
dump_buf
 = 
	`¡©s_´efix_dump
(&
Ën
);

1705 ià(
dump_buf
 =ğ
NULL
 || 
Ën
 <= 0) {

1706 
	`out_of_memÜy
(
c
, "SERVER_ERROR Out of memory generating stats");

1709 
	`­³nd_¡©s
("d‘aed", 
	`¡¾’
("d‘aed"), 
dump_buf
, 
Ën
, 
c
);

1710 
	`ä“
(
dump_buf
);

1712 } ià(
	`¡ºcmp
(
subcmd_pos
, " on", 3) == 0) {

1713 
£‰šgs
.
d‘a_’abËd
 = 1;

1714 } ià(
	`¡ºcmp
(
subcmd_pos
, " off", 4) == 0) {

1715 
£‰šgs
.
d‘a_’abËd
 = 0;

1717 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
, 
NULL
, 0);

1721 ià(
	`g‘_¡©s
(
subcommªd
, 
nkey
, &
­³nd_¡©s
, 
c
)) {

1722 ià(
c
->
¡©s
.
bufãr
 =ğ
NULL
) {

1723 
	`out_of_memÜy
(
c
, "SERVER_ERROR Out of memory generating stats");

1725 
	`wr™e_ªd_ä“
(
c
, c->
¡©s
.
bufãr
, c->¡©s.
off£t
);

1726 
c
->
¡©s
.
bufãr
 = 
NULL
;

1729 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
, 
NULL
, 0);

1736 
	`­³nd_¡©s
(
NULL
, 0, NULL, 0, 
c
);

1737 ià(
c
->
¡©s
.
bufãr
 =ğ
NULL
) {

1738 
	`out_of_memÜy
(
c
, "SERVER_ERROR Out of memory…reparingo send stats");

1740 
	`wr™e_ªd_ä“
(
c
, c->
¡©s
.
bufãr
, c->¡©s.
off£t
);

1741 
c
->
¡©s
.
bufãr
 = 
NULL
;

1743 
	}
}

1745 
	$bš_»ad_key
(
cÚn
 *
c
, 
bš_sub¡©es
 
Ãxt_sub¡©e
, 
exŒa
) {

1746 
	`as£¹
(
c
);

1747 
c
->
sub¡©e
 = 
Ãxt_sub¡©e
;

1748 
c
->
¾by‹s
 = c->
keyËn
 + 
exŒa
;

1751 
±rdiff_t
 
off£t
 = 
c
->
rcu¼
 + (
´ÙocŞ_bš¬y_»que¡_h—d”
è- c->
rbuf
;

1752 ià(
c
->
¾by‹s
 > c->
rsize
 - 
off£t
) {

1753 
size_t
 
nsize
 = 
c
->
rsize
;

1754 
size_t
 
size
 = 
c
->
¾by‹s
 + (
´ÙocŞ_bš¬y_»que¡_h—d”
);

1756 
size
 > 
nsize
) {

1757 
nsize
 *= 2;

1760 ià(
nsize
 !ğ
c
->
rsize
) {

1761 ià(
£‰šgs
.
v”bo£
 > 1) {

1762 
	`årštf
(
¡d”r
, "%d: Needo grow buffer from %luo %lu\n",

1763 
c
->
sfd
, ()c->
rsize
, ()
nsize
);

1765 *
Ãwm
 = 
	`»®loc
(
c
->
rbuf
, 
nsize
);

1766 ià(
Ãwm
 =ğ
NULL
) {

1767 
	`STATS_LOCK
();

1768 
¡©s
.
m®loc_çs
++;

1769 
	`STATS_UNLOCK
();

1770 ià(
£‰šgs
.
v”bo£
) {

1771 
	`årštf
(
¡d”r
, "%d: Failedo grow buffer.. closing connection\n",

1772 
c
->
sfd
);

1774 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

1778 
c
->
rbuf
ğ
Ãwm
;

1780 
c
->
rcu¼
 = c->
rbuf
 + 
off£t
 - (
´ÙocŞ_bš¬y_»que¡_h—d”
);

1781 
c
->
rsize
 = 
nsize
;

1783 ià(
c
->
rbuf
 !ğc->
rcu¼
) {

1784 
	`memmove
(
c
->
rbuf
, c->
rcu¼
, c->
rby‹s
);

1785 
c
->
rcu¼
 = c->
rbuf
;

1786 ià(
£‰šgs
.
v”bo£
 > 1) {

1787 
	`årštf
(
¡d”r
, "%d: R•ack iÅuˆbufãr\n", 
c
->
sfd
);

1793 
c
->
r™em
 = c->
rcu¼
 + (
´ÙocŞ_bš¬y_»que¡_h—d”
);

1794 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ä—d
);

1795 
	}
}

1798 
	$hªdË_bš¬y_´ÙocŞ_”rÜ
(
cÚn
 *
c
) {

1799 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_EINVAL
, 
NULL
, 0);

1800 ià(
£‰šgs
.
v”bo£
) {

1801 
	`årštf
(
¡d”r
, "Protocolƒrror (opcode %02x), close connection %d\n",

1802 
c
->
bš¬y_h—d”
.
»que¡
.
İcode
, c->
sfd
);

1804 
c
->
wr™e_ªd_go
 = 
cÚn_şosšg
;

1805 
	}
}

1807 
	$š™_§¦_cÚn
(
cÚn
 *
c
) {

1808 
	`as£¹
(
c
);

1810 ià(!
£‰šgs
.
§¦
)

1813 
c
->
auth’tiÿ‹d
 = 
çl£
;

1815 ià(!
c
->
§¦_cÚn
) {

1816 
»suÉ
=
	`§¦_£rv”_Ãw
("memcached",

1817 
NULL
,

1818 
my_§¦_ho¡Çme
[0] ? my_§¦_ho¡Çm: 
NULL
,

1819 
NULL
, NULL,

1820 
NULL
, 0, &
c
->
§¦_cÚn
);

1821 ià(
»suÉ
 !ğ
SASL_OK
) {

1822 ià(
£‰šgs
.
v”bo£
) {

1823 
	`årštf
(
¡d”r
, "Failedo initialize SASL conn.\n");

1825 
c
->
§¦_cÚn
 = 
NULL
;

1828 
	}
}

1830 
	$bš_li¡_§¦_mechs
(
cÚn
 *
c
) {

1832 ià(!
£‰šgs
.
§¦
) {

1833 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_UNKNOWN_COMMAND
, 
NULL
,

1834 
c
->
bš¬y_h—d”
.
»que¡
.
bodyËn


1835 - 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
);

1839 
	`š™_§¦_cÚn
(
c
);

1840 cÚ¡ *
»suÉ_¡ršg
 = 
NULL
;

1841 
¡ršg_Ëngth
 = 0;

1842 
»suÉ
=
	`§¦_li¡mech
(
c
->
§¦_cÚn
, 
NULL
,

1846 &
»suÉ_¡ršg
, &
¡ršg_Ëngth
,

1847 
NULL
);

1848 ià(
»suÉ
 !ğ
SASL_OK
) {

1850 ià(
£‰šgs
.
v”bo£
) {

1851 
	`årštf
(
¡d”r
, "Failedo†ist SASL mechanisms.\n");

1853 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_AUTH_ERROR
, 
NULL
, 0);

1856 
	`wr™e_bš_»¥Ú£
(
c
, (*)
»suÉ_¡ršg
, 0, 0, 
¡ršg_Ëngth
);

1857 
	}
}

1859 
	$´oûss_bš_§¦_auth
(
cÚn
 *
c
) {

1861 ià(!
£‰šgs
.
§¦
) {

1862 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_UNKNOWN_COMMAND
, 
NULL
,

1863 
c
->
bš¬y_h—d”
.
»que¡
.
bodyËn


1864 - 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
);

1868 
	`as£¹
(
c
->
bš¬y_h—d”
.
»que¡
.
ex’
 == 0);

1870 
nkey
 = 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
;

1871 
vËn
 = 
c
->
bš¬y_h—d”
.
»que¡
.
bodyËn
 - 
nkey
;

1873 ià(
nkey
 > 
MAX_SASL_MECH_LEN
) {

1874 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_EINVAL
, 
NULL
, 
vËn
);

1875 
c
->
wr™e_ªd_go
 = 
cÚn_sw®low
;

1879 *
key
 = 
	`bš¬y_g‘_key
(
c
);

1880 
	`as£¹
(
key
);

1882 
™em
 *
™
 = 
	`™em_®loc
(
key
, 
nkey
, 0, 0, 
vËn
+2);

1885 ià(
™
 =ğ0 || (™->
™_æags
 & 
ITEM_CHUNKED
)) {

1886 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_ENOMEM
, 
NULL
, 
vËn
);

1887 
c
->
wr™e_ªd_go
 = 
cÚn_sw®low
;

1891 
c
->
™em
 = 
™
;

1892 
c
->
r™em
 = 
	`ITEM_d©a
(
™
);

1893 
c
->
¾by‹s
 = 
vËn
;

1894 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ä—d
);

1895 
c
->
sub¡©e
 = 
bš_»adšg_§¦_auth_d©a
;

1896 
	}
}

1898 
	$´oûss_bš_com¶‘e_§¦_auth
(
cÚn
 *
c
) {

1899 
	`as£¹
(
£‰šgs
.
§¦
);

1900 cÚ¡ *
out
 = 
NULL
;

1901 
ou’
 = 0;

1903 
	`as£¹
(
c
->
™em
);

1904 
	`š™_§¦_cÚn
(
c
);

1906 
nkey
 = 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
;

1907 
vËn
 = 
c
->
bš¬y_h—d”
.
»que¡
.
bodyËn
 - 
nkey
;

1909 ià(
nkey
 > ((
™em
*è
c
->item)->nkey) {

1910 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_EINVAL
, 
NULL
, 
vËn
);

1911 
c
->
wr™e_ªd_go
 = 
cÚn_sw®low
;

1912 
	`™em_uÆšk
(
c
->
™em
);

1916 
mech
[
nkey
+1];

1917 
	`memıy
(
mech
, 
	`ITEM_key
((
™em
*)
c
->™em), 
nkey
);

1918 
mech
[
nkey
] = 0x00;

1920 ià(
£‰šgs
.
v”bo£
)

1921 
	`årštf
(
¡d”r
, "mech: ``%s'' w™h %d by‹ oàd©a\n", 
mech
, 
vËn
);

1923 cÚ¡ *
ch®Ënge
 = 
vËn
 =ğ0 ? 
NULL
 : 
	`ITEM_d©a
((
™em
*è
c
->item);

1925 ià(
vËn
 > ((
™em
*è
c
->™em)->
nby‹s
) {

1926 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_EINVAL
, 
NULL
, 
vËn
);

1927 
c
->
wr™e_ªd_go
 = 
cÚn_sw®low
;

1928 
	`™em_uÆšk
(
c
->
™em
);

1932 
»suÉ
=-1;

1934 
c
->
cmd
) {

1935 
PROTOCOL_BINARY_CMD_SASL_AUTH
:

1936 
»suÉ
 = 
	`§¦_£rv”_¡¬t
(
c
->
§¦_cÚn
, 
mech
,

1937 
ch®Ënge
, 
vËn
,

1938 &
out
, &
ou’
);

1940 
PROTOCOL_BINARY_CMD_SASL_STEP
:

1941 
»suÉ
 = 
	`§¦_£rv”_¡•
(
c
->
§¦_cÚn
,

1942 
ch®Ënge
, 
vËn
,

1943 &
out
, &
ou’
);

1946 
	`as£¹
(
çl£
);

1949 ià(
£‰šgs
.
v”bo£
) {

1950 
	`årštf
(
¡d”r
, "Unhandled command %d with challenge %s\n",

1951 
c
->
cmd
, 
ch®Ënge
);

1956 
	`™em_uÆšk
(
c
->
™em
);

1958 ià(
£‰šgs
.
v”bo£
) {

1959 
	`årštf
(
¡d”r
, "§¦„esuÉ code: %d\n", 
»suÉ
);

1962 
»suÉ
) {

1963 
SASL_OK
:

1964 
c
->
auth’tiÿ‹d
 = 
Œue
;

1965 
	`wr™e_bš_»¥Ú£
(
c
, "Auth’tiÿ‹d", 0, 0, 
	`¡¾’
("Authenticated"));

1966 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1967 
c
->
th»ad
->
¡©s
.
auth_cmds
++;

1968 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1970 
SASL_CONTINUE
:

1971 
	`add_bš_h—d”
(
c
, 
PROTOCOL_BINARY_RESPONSE_AUTH_CONTINUE
, 0, 0, 
ou’
);

1972 if(
ou’
 > 0) {

1973 
	`add_iov
(
c
, 
out
, 
ou’
);

1975 
	`cÚn_£t_¡©e
(
c
, 
cÚn_mwr™e
);

1976 
c
->
wr™e_ªd_go
 = 
cÚn_Ãw_cmd
;

1979 ià(
£‰šgs
.
v”bo£
)

1980 
	`årštf
(
¡d”r
, "UnknowÀ§¦„e¥Ú£: %d\n", 
»suÉ
);

1981 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_AUTH_ERROR
, 
NULL
, 0);

1982 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1983 
c
->
th»ad
->
¡©s
.
auth_cmds
++;

1984 
c
->
th»ad
->
¡©s
.
auth_”rÜs
++;

1985 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

1987 
	}
}

1989 
boŞ
 
	$auth’tiÿ‹d
(
cÚn
 *
c
) {

1990 
	`as£¹
(
£‰šgs
.
§¦
);

1991 
boŞ
 
rv
 = 
çl£
;

1993 
c
->
cmd
) {

1994 
PROTOCOL_BINARY_CMD_SASL_LIST_MECHS
:

1995 
PROTOCOL_BINARY_CMD_SASL_AUTH
:

1996 
PROTOCOL_BINARY_CMD_SASL_STEP
:

1997 
PROTOCOL_BINARY_CMD_VERSION
:

1998 
rv
 = 
Œue
;

2001 
rv
 = 
c
->
auth’tiÿ‹d
;

2004 ià(
£‰šgs
.
v”bo£
 > 1) {

2005 
	`årštf
(
¡d”r
, "authenticated() in cmd 0x%02x is %s\n",

2006 
c
->
cmd
, 
rv
 ? "true" : "false");

2009  
rv
;

2010 
	}
}

2012 
	$di¥©ch_bš_commªd
(
cÚn
 *
c
) {

2013 
´ÙocŞ_”rÜ
 = 0;

2015 
ušt8_t
 
ex’
 = 
c
->
bš¬y_h—d”
.
»que¡
.extlen;

2016 
ušt16_t
 
keyËn
 = 
c
->
bš¬y_h—d”
.
»que¡
.keylen;

2017 
ušt32_t
 
bodyËn
 = 
c
->
bš¬y_h—d”
.
»que¡
.bodylen;

2019 ià(
keyËn
 > 
bodyËn
 || keyËÀ+ 
ex’
 > bodylen) {

2020 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_UNKNOWN_COMMAND
, 
NULL
, 0);

2021 
c
->
wr™e_ªd_go
 = 
cÚn_şosšg
;

2025 ià(
£‰šgs
.
§¦
 && !
	`auth’tiÿ‹d
(
c
)) {

2026 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_AUTH_ERROR
, 
NULL
, 0);

2027 
c
->
wr™e_ªd_go
 = 
cÚn_şosšg
;

2031 
	`MEMCACHED_PROCESS_COMMAND_START
(
c
->
sfd
, c->
rcu¼
, c->
rby‹s
);

2032 
c
->
nÜ•ly
 = 
Œue
;

2035 ià(
keyËn
 > 
KEY_MAX_LENGTH
) {

2036 
	`hªdË_bš¬y_´ÙocŞ_”rÜ
(
c
);

2040 
c
->
cmd
) {

2041 
PROTOCOL_BINARY_CMD_SETQ
:

2042 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_SET
;

2044 
PROTOCOL_BINARY_CMD_ADDQ
:

2045 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_ADD
;

2047 
PROTOCOL_BINARY_CMD_REPLACEQ
:

2048 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_REPLACE
;

2050 
PROTOCOL_BINARY_CMD_DELETEQ
:

2051 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_DELETE
;

2053 
PROTOCOL_BINARY_CMD_INCREMENTQ
:

2054 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_INCREMENT
;

2056 
PROTOCOL_BINARY_CMD_DECREMENTQ
:

2057 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_DECREMENT
;

2059 
PROTOCOL_BINARY_CMD_QUITQ
:

2060 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_QUIT
;

2062 
PROTOCOL_BINARY_CMD_FLUSHQ
:

2063 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_FLUSH
;

2065 
PROTOCOL_BINARY_CMD_APPENDQ
:

2066 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_APPEND
;

2068 
PROTOCOL_BINARY_CMD_PREPENDQ
:

2069 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_PREPEND
;

2071 
PROTOCOL_BINARY_CMD_GETQ
:

2072 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_GET
;

2074 
PROTOCOL_BINARY_CMD_GETKQ
:

2075 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_GETK
;

2077 
PROTOCOL_BINARY_CMD_GATQ
:

2078 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_GAT
;

2080 
PROTOCOL_BINARY_CMD_GATKQ
:

2081 
c
->
cmd
 = 
PROTOCOL_BINARY_CMD_GATK
;

2084 
c
->
nÜ•ly
 = 
çl£
;

2087 
c
->
cmd
) {

2088 
PROTOCOL_BINARY_CMD_VERSION
:

2089 ià(
ex’
 =ğ0 && 
keyËn
 =ğ0 && 
bodyËn
 == 0) {

2090 
	`wr™e_bš_»¥Ú£
(
c
, 
VERSION
, 0, 0, 
	`¡¾’
(VERSION));

2092 
´ÙocŞ_”rÜ
 = 1;

2095 
PROTOCOL_BINARY_CMD_FLUSH
:

2096 ià(
keyËn
 =ğ0 && 
bodyËn
 =ğ
ex’
 && (extlen == 0 ||ƒxtlen == 4)) {

2097 
	`bš_»ad_key
(
c
, 
bš_»ad_æush_ex±ime
, 
ex’
);

2099 
´ÙocŞ_”rÜ
 = 1;

2102 
PROTOCOL_BINARY_CMD_NOOP
:

2103 ià(
ex’
 =ğ0 && 
keyËn
 =ğ0 && 
bodyËn
 == 0) {

2104 
	`wr™e_bš_»¥Ú£
(
c
, 
NULL
, 0, 0, 0);

2106 
´ÙocŞ_”rÜ
 = 1;

2109 
PROTOCOL_BINARY_CMD_SET
:

2110 
PROTOCOL_BINARY_CMD_ADD
:

2111 
PROTOCOL_BINARY_CMD_REPLACE
:

2112 ià(
ex’
 =ğ8 && 
keyËn
 !ğ0 && 
bodyËn
 >= (keylen + 8)) {

2113 
	`bš_»ad_key
(
c
, 
bš_»adšg_£t_h—d”
, 8);

2115 
´ÙocŞ_”rÜ
 = 1;

2118 
PROTOCOL_BINARY_CMD_GETQ
:

2119 
PROTOCOL_BINARY_CMD_GET
:

2120 
PROTOCOL_BINARY_CMD_GETKQ
:

2121 
PROTOCOL_BINARY_CMD_GETK
:

2122 ià(
ex’
 =ğ0 && 
bodyËn
 =ğ
keyËn
 && keylen > 0) {

2123 
	`bš_»ad_key
(
c
, 
bš_»adšg_g‘_key
, 0);

2125 
´ÙocŞ_”rÜ
 = 1;

2128 
PROTOCOL_BINARY_CMD_DELETE
:

2129 ià(
keyËn
 > 0 && 
ex’
 =ğ0 && 
bodyËn
 == keylen) {

2130 
	`bš_»ad_key
(
c
, 
bš_»adšg_d–_h—d”
, 
ex’
);

2132 
´ÙocŞ_”rÜ
 = 1;

2135 
PROTOCOL_BINARY_CMD_INCREMENT
:

2136 
PROTOCOL_BINARY_CMD_DECREMENT
:

2137 ià(
keyËn
 > 0 && 
ex’
 =ğ20 && 
bodyËn
 == (keylen +ƒxtlen)) {

2138 
	`bš_»ad_key
(
c
, 
bš_»adšg_šü_h—d”
, 20);

2140 
´ÙocŞ_”rÜ
 = 1;

2143 
PROTOCOL_BINARY_CMD_APPEND
:

2144 
PROTOCOL_BINARY_CMD_PREPEND
:

2145 ià(
keyËn
 > 0 && 
ex’
 == 0) {

2146 
	`bš_»ad_key
(
c
, 
bš_»adšg_£t_h—d”
, 0);

2148 
´ÙocŞ_”rÜ
 = 1;

2151 
PROTOCOL_BINARY_CMD_STAT
:

2152 ià(
ex’
 == 0) {

2153 
	`bš_»ad_key
(
c
, 
bš_»adšg_¡©
, 0);

2155 
´ÙocŞ_”rÜ
 = 1;

2158 
PROTOCOL_BINARY_CMD_QUIT
:

2159 ià(
keyËn
 =ğ0 && 
ex’
 =ğ0 && 
bodyËn
 == 0) {

2160 
	`wr™e_bš_»¥Ú£
(
c
, 
NULL
, 0, 0, 0);

2161 
c
->
wr™e_ªd_go
 = 
cÚn_şosšg
;

2162 ià(
c
->
nÜ•ly
) {

2163 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

2166 
´ÙocŞ_”rÜ
 = 1;

2169 
PROTOCOL_BINARY_CMD_SASL_LIST_MECHS
:

2170 ià(
ex’
 =ğ0 && 
keyËn
 =ğ0 && 
bodyËn
 == 0) {

2171 
	`bš_li¡_§¦_mechs
(
c
);

2173 
´ÙocŞ_”rÜ
 = 1;

2176 
PROTOCOL_BINARY_CMD_SASL_AUTH
:

2177 
PROTOCOL_BINARY_CMD_SASL_STEP
:

2178 ià(
ex’
 =ğ0 && 
keyËn
 != 0) {

2179 
	`bš_»ad_key
(
c
, 
bš_»adšg_§¦_auth
, 0);

2181 
´ÙocŞ_”rÜ
 = 1;

2184 
PROTOCOL_BINARY_CMD_TOUCH
:

2185 
PROTOCOL_BINARY_CMD_GAT
:

2186 
PROTOCOL_BINARY_CMD_GATQ
:

2187 
PROTOCOL_BINARY_CMD_GATK
:

2188 
PROTOCOL_BINARY_CMD_GATKQ
:

2189 ià(
ex’
 =ğ4 && 
keyËn
 != 0) {

2190 
	`bš_»ad_key
(
c
, 
bš_»adšg_touch_key
, 4);

2192 
´ÙocŞ_”rÜ
 = 1;

2196 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_UNKNOWN_COMMAND
, 
NULL
,

2197 
bodyËn
);

2200 ià(
´ÙocŞ_”rÜ
)

2201 
	`hªdË_bš¬y_´ÙocŞ_”rÜ
(
c
);

2202 
	}
}

2204 
	$´oûss_bš_upd©e
(
cÚn
 *
c
) {

2205 *
key
;

2206 
nkey
;

2207 
vËn
;

2208 
™em
 *
™
;

2209 
´ÙocŞ_bš¬y_»que¡_£t
* 
»q
 = 
	`bš¬y_g‘_»que¡
(
c
);

2211 
	`as£¹
(
c
 !ğ
NULL
);

2213 
key
 = 
	`bš¬y_g‘_key
(
c
);

2214 
nkey
 = 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
;

2217 
»q
->
mes§ge
.
body
.
æags
 = 
	`Áohl
(req->message.body.flags);

2218 
»q
->
mes§ge
.
body
.
expœ©iÚ
 = 
	`Áohl
(req->message.body.expiration);

2220 
vËn
 = 
c
->
bš¬y_h—d”
.
»que¡
.
bodyËn
 - (
nkey
 + c->bš¬y_h—d”.»que¡.
ex’
);

2222 ià(
£‰šgs
.
v”bo£
 > 1) {

2223 
ii
;

2224 ià(
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_ADD
) {

2225 
	`årštf
(
¡d”r
, "<%d ADD ", 
c
->
sfd
);

2226 } ià(
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_SET
) {

2227 
	`årštf
(
¡d”r
, "<%d SET ", 
c
->
sfd
);

2229 
	`årštf
(
¡d”r
, "<%d REPLACE ", 
c
->
sfd
);

2231 
ii
 = 0; i˜< 
nkey
; ++ii) {

2232 
	`årštf
(
¡d”r
, "%c", 
key
[
ii
]);

2235 
	`årštf
(
¡d”r
, " V®uËÀi %d", 
vËn
);

2236 
	`årštf
(
¡d”r
, "\n");

2239 ià(
£‰šgs
.
d‘a_’abËd
) {

2240 
	`¡©s_´efix_»cÜd_£t
(
key
, 
nkey
);

2243 
™
 = 
	`™em_®loc
(
key
, 
nkey
, 
»q
->
mes§ge
.
body
.
æags
,

2244 
	`»®time
(
»q
->
mes§ge
.
body
.
expœ©iÚ
), 
vËn
+2);

2246 ià(
™
 == 0) {

2247 
¡Üe_™em_ty³
 
¡©us
;

2248 ià(! 
	`™em_size_ok
(
nkey
, 
»q
->
mes§ge
.
body
.
æags
, 
vËn
 + 2)) {

2249 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_E2BIG
, 
NULL
, 
vËn
);

2250 
¡©us
 = 
TOO_LARGE
;

2252 
	`out_of_memÜy
(
c
, "SERVER_ERROR Out of memory‡llocating item");

2254 
c
->
sby‹s
 = 
vËn
;

2255 
¡©us
 = 
NO_MEMORY
;

2258 
	`LOGGER_LOG
(
c
->
th»ad
->
l
, 
LOG_MUTATIONS
, 
LOGGER_ITEM_STORE
,

2259 
NULL
, 
¡©us
, 0, 
key
, 
nkey
, 
™
->
ex±ime
, 
	`ITEM_şsid
(it));

2263 ià(
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_SET
) {

2264 
™
 = 
	`™em_g‘
(
key
, 
nkey
, 
c
);

2265 ià(
™
) {

2266 
	`™em_uÆšk
(
™
);

2267 
	`™em_»move
(
™
);

2272 
c
->
wr™e_ªd_go
 = 
cÚn_sw®low
;

2276 
	`ITEM_£t_ÿs
(
™
, 
c
->
bš¬y_h—d”
.
»que¡
.
ÿs
);

2278 
c
->
cmd
) {

2279 
PROTOCOL_BINARY_CMD_ADD
:

2280 
c
->
cmd
 = 
NREAD_ADD
;

2282 
PROTOCOL_BINARY_CMD_SET
:

2283 
c
->
cmd
 = 
NREAD_SET
;

2285 
PROTOCOL_BINARY_CMD_REPLACE
:

2286 
c
->
cmd
 = 
NREAD_REPLACE
;

2289 
	`as£¹
(0);

2292 ià(
	`ITEM_g‘_ÿs
(
™
) != 0) {

2293 
c
->
cmd
 = 
NREAD_CAS
;

2296 
c
->
™em
 = 
™
;

2297 
c
->
r™em
 = 
	`ITEM_d©a
(
™
);

2298 
c
->
¾by‹s
 = 
vËn
;

2299 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ä—d
);

2300 
c
->
sub¡©e
 = 
bš_»ad_£t_v®ue
;

2301 
	}
}

2303 
	$´oûss_bš_­³nd_´•’d
(
cÚn
 *
c
) {

2304 *
key
;

2305 
nkey
;

2306 
vËn
;

2307 
™em
 *
™
;

2309 
	`as£¹
(
c
 !ğ
NULL
);

2311 
key
 = 
	`bš¬y_g‘_key
(
c
);

2312 
nkey
 = 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
;

2313 
vËn
 = 
c
->
bš¬y_h—d”
.
»que¡
.
bodyËn
 - 
nkey
;

2315 ià(
£‰šgs
.
v”bo£
 > 1) {

2316 
	`årštf
(
¡d”r
, "V®uËÀi %d\n", 
vËn
);

2319 ià(
£‰šgs
.
d‘a_’abËd
) {

2320 
	`¡©s_´efix_»cÜd_£t
(
key
, 
nkey
);

2323 
™
 = 
	`™em_®loc
(
key
, 
nkey
, 0, 0, 
vËn
+2);

2325 ià(
™
 == 0) {

2326 ià(! 
	`™em_size_ok
(
nkey
, 0, 
vËn
 + 2)) {

2327 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_E2BIG
, 
NULL
, 
vËn
);

2329 
	`out_of_memÜy
(
c
, "SERVER_ERROR Out of memory‡llocating item");

2331 
c
->
sby‹s
 = 
vËn
;

2334 
c
->
wr™e_ªd_go
 = 
cÚn_sw®low
;

2338 
	`ITEM_£t_ÿs
(
™
, 
c
->
bš¬y_h—d”
.
»que¡
.
ÿs
);

2340 
c
->
cmd
) {

2341 
PROTOCOL_BINARY_CMD_APPEND
:

2342 
c
->
cmd
 = 
NREAD_APPEND
;

2344 
PROTOCOL_BINARY_CMD_PREPEND
:

2345 
c
->
cmd
 = 
NREAD_PREPEND
;

2348 
	`as£¹
(0);

2351 
c
->
™em
 = 
™
;

2352 
c
->
r™em
 = 
	`ITEM_d©a
(
™
);

2353 
c
->
¾by‹s
 = 
vËn
;

2354 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ä—d
);

2355 
c
->
sub¡©e
 = 
bš_»ad_£t_v®ue
;

2356 
	}
}

2358 
	$´oûss_bš_æush
(
cÚn
 *
c
) {

2359 
time_t
 
ex±ime
 = 0;

2360 
´ÙocŞ_bš¬y_»que¡_æush
* 
»q
 = 
	`bš¬y_g‘_»que¡
(
c
);

2361 
»l_time_t
 
Ãw_Şde¡
 = 0;

2363 ià(!
£‰šgs
.
æush_’abËd
) {

2365 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_AUTH_ERROR
, 
NULL
, 0);

2369 ià(
c
->
bš¬y_h—d”
.
»que¡
.
ex’
 =ğ(
»q
->
mes§ge
.
body
)) {

2370 
ex±ime
 = 
	`Áohl
(
»q
->
mes§ge
.
body
.
expœ©iÚ
);

2373 ià(
ex±ime
 > 0) {

2374 
Ãw_Şde¡
 = 
	`»®time
(
ex±ime
);

2376 
Ãw_Şde¡
 = 
cu¼’t_time
;

2378 ià(
£‰šgs
.
u£_ÿs
) {

2379 
£‰šgs
.
Şde¡_live
 = 
Ãw_Şde¡
 - 1;

2380 ià(
£‰šgs
.
Şde¡_live
 <ğ
cu¼’t_time
)

2381 
£‰šgs
.
Şde¡_ÿs
 = 
	`g‘_ÿs_id
();

2383 
£‰šgs
.
Şde¡_live
 = 
Ãw_Şde¡
;

2386 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2387 
c
->
th»ad
->
¡©s
.
æush_cmds
++;

2388 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2390 
	`wr™e_bš_»¥Ú£
(
c
, 
NULL
, 0, 0, 0);

2391 
	}
}

2393 
	$´oûss_bš_d–‘e
(
cÚn
 *
c
) {

2394 
™em
 *
™
;

2396 
´ÙocŞ_bš¬y_»que¡_d–‘e
* 
»q
 = 
	`bš¬y_g‘_»que¡
(
c
);

2398 * 
key
 = 
	`bš¬y_g‘_key
(
c
);

2399 
size_t
 
nkey
 = 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
;

2401 
	`as£¹
(
c
 !ğ
NULL
);

2403 ià(
£‰šgs
.
v”bo£
 > 1) {

2404 
ii
;

2405 
	`årštf
(
¡d”r
, "Deleting ");

2406 
ii
 = 0; i˜< 
nkey
; ++ii) {

2407 
	`årštf
(
¡d”r
, "%c", 
key
[
ii
]);

2409 
	`årštf
(
¡d”r
, "\n");

2412 ià(
£‰šgs
.
d‘a_’abËd
) {

2413 
	`¡©s_´efix_»cÜd_d–‘e
(
key
, 
nkey
);

2416 
™
 = 
	`™em_g‘
(
key
, 
nkey
, 
c
);

2417 ià(
™
) {

2418 
ušt64_t
 
ÿs
 = 
	`ÁohÎ
(
»q
->
mes§ge
.
h—d”
.
»que¡
.cas);

2419 ià(
ÿs
 =ğ0 || ca =ğ
	`ITEM_g‘_ÿs
(
™
)) {

2420 
	`MEMCACHED_COMMAND_DELETE
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
);

2421 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2422 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
d–‘e_h™s
++;

2423 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2424 
	`™em_uÆšk
(
™
);

2425 
	`wr™e_bš_»¥Ú£
(
c
, 
NULL
, 0, 0, 0);

2427 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_EEXISTS
, 
NULL
, 0);

2429 
	`™em_»move
(
™
);

2431 
	`wr™e_bš_”rÜ
(
c
, 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
, 
NULL
, 0);

2432 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2433 
c
->
th»ad
->
¡©s
.
d–‘e_mis£s
++;

2434 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2436 
	}
}

2438 
	$com¶‘e_Ä—d_bš¬y
(
cÚn
 *
c
) {

2439 
	`as£¹
(
c
 !ğ
NULL
);

2440 
	`as£¹
(
c
->
cmd
 >= 0);

2442 
c
->
sub¡©e
) {

2443 
bš_»adšg_£t_h—d”
:

2444 ià(
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_APPEND
 ||

2445 
c
->
cmd
 =ğ
PROTOCOL_BINARY_CMD_PREPEND
) {

2446 
	`´oûss_bš_­³nd_´•’d
(
c
);

2448 
	`´oûss_bš_upd©e
(
c
);

2451 
bš_»ad_£t_v®ue
:

2452 
	`com¶‘e_upd©e_bš
(
c
);

2454 
bš_»adšg_g‘_key
:

2455 
bš_»adšg_touch_key
:

2456 
	`´oûss_bš_g‘_Ü_touch
(
c
);

2458 
bš_»adšg_¡©
:

2459 
	`´oûss_bš_¡©
(
c
);

2461 
bš_»adšg_d–_h—d”
:

2462 
	`´oûss_bš_d–‘e
(
c
);

2464 
bš_»adšg_šü_h—d”
:

2465 
	`com¶‘e_šü_bš
(
c
);

2467 
bš_»ad_æush_ex±ime
:

2468 
	`´oûss_bš_æush
(
c
);

2470 
bš_»adšg_§¦_auth
:

2471 
	`´oûss_bš_§¦_auth
(
c
);

2473 
bš_»adšg_§¦_auth_d©a
:

2474 
	`´oûss_bš_com¶‘e_§¦_auth
(
c
);

2477 
	`årštf
(
¡d”r
, "NÙ hªdlšg sub¡©%d\n", 
c
->
sub¡©e
);

2478 
	`as£¹
(0);

2480 
	}
}

2482 
	$»£t_cmd_hªdËr
(
cÚn
 *
c
) {

2483 
c
->
cmd
 = -1;

2484 
c
->
sub¡©e
 = 
bš_no_¡©e
;

2485 if(
c
->
™em
 !ğ
NULL
) {

2486 
	`™em_»move
(
c
->
™em
);

2487 
c
->
™em
 = 
NULL
;

2489 
	`cÚn_shršk
(
c
);

2490 ià(
c
->
rby‹s
 > 0) {

2491 
	`cÚn_£t_¡©e
(
c
, 
cÚn_·r£_cmd
);

2493 
	`cÚn_£t_¡©e
(
c
, 
cÚn_wa™šg
);

2495 
	}
}

2497 
	$com¶‘e_Ä—d
(
cÚn
 *
c
) {

2498 
	`as£¹
(
c
 !ğ
NULL
);

2499 
	`as£¹
(
c
->
´ÙocŞ
 =ğ
ascii_´Ù


2500 || 
c
->
´ÙocŞ
 =ğ
bš¬y_´Ù
);

2502 ià(
c
->
´ÙocŞ
 =ğ
ascii_´Ù
) {

2503 
	`com¶‘e_Ä—d_ascii
(
c
);

2504 } ià(
c
->
´ÙocŞ
 =ğ
bš¬y_´Ù
) {

2505 
	`com¶‘e_Ä—d_bš¬y
(
c
);

2507 
	}
}

2511 
	$_¡Üe_™em_cİy_chunks
(
™em
 *
d_™
, i‹m *
s_™
, cÚ¡ 
Ën
) {

2512 
™em_chunk
 *
dch
 = (™em_chunk *è
	`ITEM_d©a
(
d_™
);

2514 
dch
->
size
 =ğdch->
u£d
) {

2515 
dch
 = dch->
Ãxt
;

2518 ià(
s_™
->
™_æags
 & 
ITEM_CHUNKED
) {

2519 
»maš
 = 
Ën
;

2520 
™em_chunk
 *
sch
 = (™em_chunk *è
	`ITEM_d©a
(
s_™
);

2521 
cİ›d
 = 0;

2525 
sch
 && 
dch
 && 
»maš
) {

2526 
	`as£¹
(
dch
->
u£d
 <ğdch->
size
);

2527 
todo
 = (
dch
->
size
 - dch->
u£d
 < 
sch
->u£d - 
cİ›d
)

2528 ? 
dch
->
size
 - dch->
u£d
 : 
sch
->u£d - 
cİ›d
;

2529 ià(
»maš
 < 
todo
)

2530 
todo
 = 
»maš
;

2531 
	`memıy
(
dch
->
d©a
 + dch->
u£d
, 
sch
->d©¨+ 
cİ›d
, 
todo
);

2532 
dch
->
u£d
 +ğ
todo
;

2533 
cİ›d
 +ğ
todo
;

2534 
»maš
 -ğ
todo
;

2535 
	`as£¹
(
dch
->
u£d
 <ğdch->
size
);

2536 ià(
dch
->
size
 =ğdch->
u£d
) {

2537 
dch
 = dch->
Ãxt
;

2539 
	`as£¹
(
cİ›d
 <ğ
sch
->
u£d
);

2540 ià(
cİ›d
 =ğ
sch
->
u£d
) {

2541 
cİ›d
 = 0;

2542 
sch
 = sch->
Ãxt
;

2546 
	`as£¹
(
»maš
 == 0);

2548 
dÚe
 = 0;

2550 
Ën
 > 
dÚe
 && 
dch
) {

2551 
todo
 = (
dch
->
size
 - dch->
u£d
 < 
Ën
 - 
dÚe
)

2552 ? 
dch
->
size
 - dch->
u£d
 : 
Ën
 - 
dÚe
;

2553 
	`as£¹
(
dch
->
size
 - dch->
u£d
 != 0);

2554 
	`memıy
(
dch
->
d©a
 + dch->
u£d
, 
	`ITEM_d©a
(
s_™
è+ 
dÚe
, 
todo
);

2555 
dÚe
 +ğ
todo
;

2556 
dch
->
u£d
 +ğ
todo
;

2557 
	`as£¹
(
dch
->
u£d
 <ğdch->
size
);

2558 ià(
dch
->
size
 =ğdch->
u£d
)

2559 
dch
 = dch->
Ãxt
;

2561 
	`as£¹
(
Ën
 =ğ
dÚe
);

2563 
	}
}

2565 
	$_¡Üe_™em_cİy_d©a
(
comm
, 
™em
 *
Şd_™
, i‹m *
Ãw_™
, i‹m *
add_™
) {

2566 ià(
comm
 =ğ
NREAD_APPEND
) {

2567 ià(
Ãw_™
->
™_æags
 & 
ITEM_CHUNKED
) {

2568 
	`_¡Üe_™em_cİy_chunks
(
Ãw_™
, 
Şd_™
, old_™->
nby‹s
 - 2);

2569 
	`_¡Üe_™em_cİy_chunks
(
Ãw_™
, 
add_™
,‡dd_™->
nby‹s
);

2571 
	`memıy
(
	`ITEM_d©a
(
Ãw_™
), ITEM_d©a(
Şd_™
), old_™->
nby‹s
);

2572 
	`memıy
(
	`ITEM_d©a
(
Ãw_™
è+ 
Şd_™
->
nby‹s
 - 2 , ITEM_d©a(
add_™
),‡dd_it->nbytes);

2576 ià(
Ãw_™
->
™_æags
 & 
ITEM_CHUNKED
) {

2577 
	`_¡Üe_™em_cİy_chunks
(
Ãw_™
, 
add_™
,‡dd_™->
nby‹s
 - 2);

2578 
	`_¡Üe_™em_cİy_chunks
(
Ãw_™
, 
Şd_™
, old_™->
nby‹s
);

2580 
	`memıy
(
	`ITEM_d©a
(
Ãw_™
), ITEM_d©a(
add_™
),‡dd_™->
nby‹s
);

2581 
	`memıy
(
	`ITEM_d©a
(
Ãw_™
è+ 
add_™
->
nby‹s
 - 2 , ITEM_d©a(
Şd_™
), old_it->nbytes);

2584 
	}
}

2592 
¡Üe_™em_ty³
 
	$do_¡Üe_™em
(
™em
 *
™
, 
comm
, 
cÚn
 *
c
, cÚ¡ 
ušt32_t
 
hv
) {

2593 *
key
 = 
	`ITEM_key
(
™
);

2594 
™em
 *
Şd_™
 = 
	`do_™em_g‘
(
key
, 
™
->
nkey
, 
hv
, 
c
);

2595 
¡Üe_™em_ty³
 
¡Üed
 = 
NOT_STORED
;

2597 
™em
 *
Ãw_™
 = 
NULL
;

2598 
ušt32_t
 
æags
;

2600 ià(
Şd_™
 !ğ
NULL
 && 
comm
 =ğ
NREAD_ADD
) {

2602 
	`do_™em_upd©e
(
Şd_™
);

2603 } ià(!
Şd_™
 && (
comm
 =ğ
NREAD_REPLACE


2604 || 
comm
 =ğ
NREAD_APPEND
 || comm =ğ
NREAD_PREPEND
))

2607 } ià(
comm
 =ğ
NREAD_CAS
) {

2609 if(
Şd_™
 =ğ
NULL
) {

2611 
¡Üed
 = 
NOT_FOUND
;

2612 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2613 
c
->
th»ad
->
¡©s
.
ÿs_mis£s
++;

2614 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2616 ià(
	`ITEM_g‘_ÿs
(
™
è=ğITEM_g‘_ÿs(
Şd_™
)) {

2620 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2621 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
Şd_™
)].
ÿs_h™s
++;

2622 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2624 
	`™em_»¶aû
(
Şd_™
, 
™
, 
hv
);

2625 
¡Üed
 = 
STORED
;

2627 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2628 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
Şd_™
)].
ÿs_badv®
++;

2629 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

2631 if(
£‰šgs
.
v”bo£
 > 1) {

2632 
	`årštf
(
¡d”r
, "CAS: failure:ƒxpected %llu, got %llu\n",

2633 ()
	`ITEM_g‘_ÿs
(
Şd_™
),

2634 ()
	`ITEM_g‘_ÿs
(
™
));

2636 
¡Üed
 = 
EXISTS
;

2639 
çed_®loc
 = 0;

2644 ià(
comm
 =ğ
NREAD_APPEND
 || comm =ğ
NREAD_PREPEND
) {

2648 ià(
	`ITEM_g‘_ÿs
(
™
) != 0) {

2650 ià(
	`ITEM_g‘_ÿs
(
™
è!ğITEM_g‘_ÿs(
Şd_™
)) {

2651 
¡Üed
 = 
EXISTS
;

2655 ià(
¡Üed
 =ğ
NOT_STORED
) {

2659 
æags
 = (
ušt32_t
è
	`¡¹oul
(
	`ITEM_suffix
(
Şd_™
), (**è
NULL
, 10);

2661 
Ãw_™
 = 
	`do_™em_®loc
(
key
, 
™
->
nkey
, 
æags
, 
Şd_™
->
ex±ime
, it->
nby‹s
 + old_it->nbytes - 2 );

2663 ià(
Ãw_™
 =ğ
NULL
) {

2664 
çed_®loc
 = 1;

2665 
¡Üed
 = 
NOT_STORED
;

2668 
	`_¡Üe_™em_cİy_d©a
(
comm
, 
Şd_™
, 
Ãw_™
, 
™
);

2670 
™
 = 
Ãw_™
;

2675 ià(
¡Üed
 =ğ
NOT_STORED
 && 
çed_®loc
 == 0) {

2676 ià(
Şd_™
 !ğ
NULL
)

2677 
	`™em_»¶aû
(
Şd_™
, 
™
, 
hv
);

2679 
	`do_™em_lšk
(
™
, 
hv
);

2681 
c
->
ÿs
 = 
	`ITEM_g‘_ÿs
(
™
);

2683 
¡Üed
 = 
STORED
;

2687 ià(
Şd_™
 !ğ
NULL
)

2688 
	`do_™em_»move
(
Şd_™
);

2689 ià(
Ãw_™
 !ğ
NULL
)

2690 
	`do_™em_»move
(
Ãw_™
);

2692 ià(
¡Üed
 =ğ
STORED
) {

2693 
c
->
ÿs
 = 
	`ITEM_g‘_ÿs
(
™
);

2695 
	`LOGGER_LOG
(
c
->
th»ad
->
l
, 
LOG_MUTATIONS
, 
LOGGER_ITEM_STORE
, 
NULL
,

2696 
¡Üed
, 
comm
, 
	`ITEM_key
(
™
), it->
nkey
, it->
ex±ime
, 
	`ITEM_şsid
(it));

2698  
¡Üed
;

2699 
	}
}

2701 
	stok’_s
 {

2702 *
	mv®ue
;

2703 
size_t
 
	mËngth
;

2704 } 
	ttok’_t
;

2706 
	#COMMAND_TOKEN
 0

	)

2707 
	#SUBCOMMAND_TOKEN
 1

	)

2708 
	#KEY_TOKEN
 1

	)

2710 
	#MAX_TOKENS
 8

	)

2729 
size_t
 
	$tok’ize_commªd
(*
commªd
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
max_tok’s
) {

2730 *
s
, *
e
;

2731 
size_t
 
Áok’s
 = 0;

2732 
size_t
 
Ën
 = 
	`¡¾’
(
commªd
);

2733 
i
 = 0;

2735 
	`as£¹
(
commªd
 !ğ
NULL
 && 
tok’s
 !ğNULL && 
max_tok’s
 > 1);

2737 
s
 = 
e
 = 
commªd
;

2738 
i
 = 0; i < 
Ën
; i++) {

2739 ià(*
e
 == ' ') {

2740 ià(
s
 !ğ
e
) {

2741 
tok’s
[
Áok’s
].
v®ue
 = 
s
;

2742 
tok’s
[
Áok’s
].
Ëngth
 = 
e
 - 
s
;

2743 
Áok’s
++;

2744 *
e
 = '\0';

2745 ià(
Áok’s
 =ğ
max_tok’s
 - 1) {

2746 
e
++;

2747 
s
 = 
e
;

2751 
s
 = 
e
 + 1;

2753 
e
++;

2756 ià(
s
 !ğ
e
) {

2757 
tok’s
[
Áok’s
].
v®ue
 = 
s
;

2758 
tok’s
[
Áok’s
].
Ëngth
 = 
e
 - 
s
;

2759 
Áok’s
++;

2766 
tok’s
[
Áok’s
].
v®ue
 = *
e
 =ğ'\0' ? 
NULL
 :ƒ;

2767 
tok’s
[
Áok’s
].
Ëngth
 = 0;

2768 
Áok’s
++;

2770  
Áok’s
;

2771 
	}
}

2774 
	$wr™e_ªd_ä“
(
cÚn
 *
c
, *
buf
, 
by‹s
) {

2775 ià(
buf
) {

2776 
c
->
wr™e_ªd_ä“
 = 
buf
;

2777 
c
->
wcu¼
 = 
buf
;

2778 
c
->
wby‹s
 = 
by‹s
;

2779 
	`cÚn_£t_¡©e
(
c
, 
cÚn_wr™e
);

2780 
c
->
wr™e_ªd_go
 = 
cÚn_Ãw_cmd
;

2782 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory writing stats");

2784 
	}
}

2786 
šlše
 
boŞ
 
	$£t_nÜ•ly_maybe
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, 
size_t
 
Áok’s
)

2788 
nÜ•ly_šdex
 = 
Áok’s
 - 2;

2797 ià(
tok’s
[
nÜ•ly_šdex
].
v®ue


2798 && 
	`¡rcmp
(
tok’s
[
nÜ•ly_šdex
].
v®ue
, "noreply") == 0) {

2799 
c
->
nÜ•ly
 = 
Œue
;

2801  
c
->
nÜ•ly
;

2802 
	}
}

2804 
	$­³nd_¡©
(cÚ¡ *
Çme
, 
ADD_STAT
 
add_¡©s
, 
cÚn
 *
c
,

2805 cÚ¡ *
fmt
, ...) {

2806 
v®_¡r
[
STAT_VAL_LEN
];

2807 
vËn
;

2808 
va_li¡
 
­
;

2810 
	`as£¹
(
Çme
);

2811 
	`as£¹
(
add_¡©s
);

2812 
	`as£¹
(
c
);

2813 
	`as£¹
(
fmt
);

2815 
	`va_¡¬t
(
­
, 
fmt
);

2816 
vËn
 = 
	`v¢´štf
(
v®_¡r
, (v®_¡rè- 1, 
fmt
, 
­
);

2817 
	`va_’d
(
­
);

2819 
	`add_¡©s
(
Çme
, 
	`¡¾’
Òame), 
v®_¡r
, 
vËn
, 
c
);

2820 
	}
}

2822 
šlše
 
	$´oûss_¡©s_d‘a
(
cÚn
 *
c
, cÚ¡ *
commªd
) {

2823 
	`as£¹
(
c
 !ğ
NULL
);

2825 ià(
	`¡rcmp
(
commªd
, "on") == 0) {

2826 
£‰šgs
.
d‘a_’abËd
 = 1;

2827 
	`out_¡ršg
(
c
, "OK");

2829 ià(
	`¡rcmp
(
commªd
, "off") == 0) {

2830 
£‰šgs
.
d‘a_’abËd
 = 0;

2831 
	`out_¡ršg
(
c
, "OK");

2833 ià(
	`¡rcmp
(
commªd
, "dump") == 0) {

2834 
Ën
;

2835 *
¡©s
 = 
	`¡©s_´efix_dump
(&
Ën
);

2836 
	`wr™e_ªd_ä“
(
c
, 
¡©s
, 
Ën
);

2839 
	`out_¡ršg
(
c
, "CLIENT_ERROR usage: stats detail on|off|dump");

2841 
	}
}

2844 
	$£rv”_¡©s
(
ADD_STAT
 
add_¡©s
, 
cÚn
 *
c
) {

2845 
pid_t
 
pid
 = 
	`g‘pid
();

2846 
»l_time_t
 
now
 = 
cu¼’t_time
;

2848 
th»ad_¡©s
hread_stats;

2849 
	`th»adloÿl_¡©s_agg»g©e
(&
th»ad_¡©s
);

2850 
¦ab_¡©s
 slab_stats;

2851 
	`¦ab_¡©s_agg»g©e
(&
th»ad_¡©s
, &
¦ab_¡©s
);

2853 #iâdeà
WIN32


2854 
ru§ge
 
u§ge
;

2855 
	`g‘ru§ge
(
RUSAGE_SELF
, &
u§ge
);

2858 
	`STATS_LOCK
();

2860 
	`APPEND_STAT
("pid", "%lu", ()
pid
);

2861 
	`APPEND_STAT
("u±ime", "%u", 
now
 - 
ITEM_UPDATE_INTERVAL
);

2862 
	`APPEND_STAT
("time", "%ld", 
now
 + ()
´oûss_¡¬‹d
);

2863 
	`APPEND_STAT
("v”siÚ", "%s", 
VERSION
);

2864 
	`APPEND_STAT
("libev’t", "%s", 
	`ev’t_g‘_v”siÚ
());

2865 
	`APPEND_STAT
("pointer_size", "%d", ()(8 * (*)));

2867 #iâdeà
WIN32


2868 
	`­³nd_¡©
("ru§ge_u£r", 
add_¡©s
, 
c
, "%ld.%06ld",

2869 ()
u§ge
.
ru_utime
.
tv_£c
,

2870 ()
u§ge
.
ru_utime
.
tv_u£c
);

2871 
	`­³nd_¡©
("ru§ge_sy¡em", 
add_¡©s
, 
c
, "%ld.%06ld",

2872 ()
u§ge
.
ru_¡ime
.
tv_£c
,

2873 ()
u§ge
.
ru_¡ime
.
tv_u£c
);

2876 
	`APPEND_STAT
("cu¼_cÚÃùiÚs", "%Îu", ()
¡©s_¡©e
.
cu¼_cÚns
 - 1);

2877 
	`APPEND_STAT
("tÙ®_cÚÃùiÚs", "%Îu", ()
¡©s
.
tÙ®_cÚns
);

2878 ià(
£‰šgs
.
maxcÚns_ç¡
) {

2879 
	`APPEND_STAT
("»jeùed_cÚÃùiÚs", "%Îu", ()
¡©s
.
»jeùed_cÚns
);

2881 
	`APPEND_STAT
("cÚÃùiÚ_¡ruùu»s", "%u", 
¡©s_¡©e
.
cÚn_¡ruùs
);

2882 
	`APPEND_STAT
("»£rved_fds", "%u", 
¡©s_¡©e
.
»£rved_fds
);

2883 
	`APPEND_STAT
("cmd_g‘", "%Îu", ()
th»ad_¡©s
.
g‘_cmds
);

2884 
	`APPEND_STAT
("cmd_£t", "%Îu", ()
¦ab_¡©s
.
£t_cmds
);

2885 
	`APPEND_STAT
("cmd_æush", "%Îu", ()
th»ad_¡©s
.
æush_cmds
);

2886 
	`APPEND_STAT
("cmd_touch", "%Îu", ()
th»ad_¡©s
.
touch_cmds
);

2887 
	`APPEND_STAT
("g‘_h™s", "%Îu", ()
¦ab_¡©s
.
g‘_h™s
);

2888 
	`APPEND_STAT
("g‘_mis£s", "%Îu", ()
th»ad_¡©s
.
g‘_mis£s
);

2889 
	`APPEND_STAT
("g‘_expœed", "%Îu", ()
th»ad_¡©s
.
g‘_expœed
);

2890 
	`APPEND_STAT
("g‘_æushed", "%Îu", ()
th»ad_¡©s
.
g‘_æushed
);

2891 
	`APPEND_STAT
("d–‘e_mis£s", "%Îu", ()
th»ad_¡©s
.
d–‘e_mis£s
);

2892 
	`APPEND_STAT
("d–‘e_h™s", "%Îu", ()
¦ab_¡©s
.
d–‘e_h™s
);

2893 
	`APPEND_STAT
("šü_mis£s", "%Îu", ()
th»ad_¡©s
.
šü_mis£s
);

2894 
	`APPEND_STAT
("šü_h™s", "%Îu", ()
¦ab_¡©s
.
šü_h™s
);

2895 
	`APPEND_STAT
("deü_mis£s", "%Îu", ()
th»ad_¡©s
.
deü_mis£s
);

2896 
	`APPEND_STAT
("deü_h™s", "%Îu", ()
¦ab_¡©s
.
deü_h™s
);

2897 
	`APPEND_STAT
("ÿs_mis£s", "%Îu", ()
th»ad_¡©s
.
ÿs_mis£s
);

2898 
	`APPEND_STAT
("ÿs_h™s", "%Îu", ()
¦ab_¡©s
.
ÿs_h™s
);

2899 
	`APPEND_STAT
("ÿs_badv®", "%Îu", ()
¦ab_¡©s
.
ÿs_badv®
);

2900 
	`APPEND_STAT
("touch_h™s", "%Îu", ()
¦ab_¡©s
.
touch_h™s
);

2901 
	`APPEND_STAT
("touch_mis£s", "%Îu", ()
th»ad_¡©s
.
touch_mis£s
);

2902 
	`APPEND_STAT
("auth_cmds", "%Îu", ()
th»ad_¡©s
.
auth_cmds
);

2903 
	`APPEND_STAT
("auth_”rÜs", "%Îu", ()
th»ad_¡©s
.
auth_”rÜs
);

2904 ià(
£‰šgs
.
idË_timeout
) {

2905 
	`APPEND_STAT
("idË_kicks", "%Îu", ()
th»ad_¡©s
.
idË_kicks
);

2907 
	`APPEND_STAT
("by‹s_»ad", "%Îu", ()
th»ad_¡©s
.
by‹s_»ad
);

2908 
	`APPEND_STAT
("by‹s_wr™‹n", "%Îu", ()
th»ad_¡©s
.
by‹s_wr™‹n
);

2909 
	`APPEND_STAT
("lim™_maxby‹s", "%Îu", ()
£‰šgs
.
maxby‹s
);

2910 
	`APPEND_STAT
("acû±šg_cÚns", "%u", 
¡©s_¡©e
.
acû±šg_cÚns
);

2911 
	`APPEND_STAT
("li¡’_di§bËd_num", "%Îu", ()
¡©s
.
li¡’_di§bËd_num
);

2912 
	`APPEND_STAT
("time_š_li¡’_di§bËd_us", "%Îu", 
¡©s
.
time_š_li¡’_di§bËd_us
);

2913 
	`APPEND_STAT
("th»ads", "%d", 
£‰šgs
.
num_th»ads
);

2914 
	`APPEND_STAT
("cÚn_y›lds", "%Îu", ()
th»ad_¡©s
.
cÚn_y›lds
);

2915 
	`APPEND_STAT
("hash_pow”_Ëv–", "%u", 
¡©s_¡©e
.
hash_pow”_Ëv–
);

2916 
	`APPEND_STAT
("hash_by‹s", "%Îu", ()
¡©s_¡©e
.
hash_by‹s
);

2917 
	`APPEND_STAT
("hash_is_ex·ndšg", "%u", 
¡©s_¡©e
.
hash_is_ex·ndšg
);

2918 ià(
£‰šgs
.
¦ab_»assign
) {

2919 
	`APPEND_STAT
("¦ab_»assign_»scues", "%Îu", 
¡©s
.
¦ab_»assign_»scues
);

2920 
	`APPEND_STAT
("¦ab_»assign_chunk_»scues", "%Îu", 
¡©s
.
¦ab_»assign_chunk_»scues
);

2921 
	`APPEND_STAT
("¦ab_»assign_eviùiÚs_nomem", "%Îu", 
¡©s
.
¦ab_»assign_eviùiÚs_nomem
);

2922 
	`APPEND_STAT
("¦ab_»assign_šlše_»şaim", "%Îu", 
¡©s
.
¦ab_»assign_šlše_»şaim
);

2923 
	`APPEND_STAT
("¦ab_»assign_busy_™ems", "%Îu", 
¡©s
.
¦ab_»assign_busy_™ems
);

2924 
	`APPEND_STAT
("¦ab_»assign_ruÂšg", "%u", 
¡©s_¡©e
.
¦ab_»assign_ruÂšg
);

2925 
	`APPEND_STAT
("¦abs_moved", "%Îu", 
¡©s
.
¦abs_moved
);

2927 ià(
£‰šgs
.
Ìu_üawËr
) {

2928 
	`APPEND_STAT
("Ìu_üawËr_ruÂšg", "%u", 
¡©s_¡©e
.
Ìu_üawËr_ruÂšg
);

2929 
	`APPEND_STAT
("Ìu_üawËr_¡¬ts", "%u", 
¡©s
.
Ìu_üawËr_¡¬ts
);

2931 ià(
£‰šgs
.
Ìu_mašš”_th»ad
) {

2932 
	`APPEND_STAT
("Ìu_mašš”_juggËs", "%Îu", ()
¡©s
.
Ìu_mašš”_juggËs
);

2934 
	`APPEND_STAT
("malloc_fails", "%llu",

2935 ()
¡©s
.
m®loc_çs
);

2936 
	`APPEND_STAT
("log_wÜk”_drİ³d", "%Îu", ()
¡©s
.
log_wÜk”_drİ³d
);

2937 
	`APPEND_STAT
("log_wÜk”_wr™‹n", "%Îu", ()
¡©s
.
log_wÜk”_wr™‹n
);

2938 
	`APPEND_STAT
("log_w©ch”_sk³d", "%Îu", ()
¡©s
.
log_w©ch”_sk³d
);

2939 
	`APPEND_STAT
("log_w©ch”_£Á", "%Îu", ()
¡©s
.
log_w©ch”_£Á
);

2940 
	`STATS_UNLOCK
();

2941 
	}
}

2943 
	$´oûss_¡©_£‰šgs
(
ADD_STAT
 
add_¡©s
, *
c
) {

2944 
	`as£¹
(
add_¡©s
);

2945 
	`APPEND_STAT
("maxby‹s", "%Îu", ()
£‰šgs
.
maxby‹s
);

2946 
	`APPEND_STAT
("maxcÚns", "%d", 
£‰šgs
.
maxcÚns
);

2947 
	`APPEND_STAT
("tıpÜt", "%d", 
£‰šgs
.
pÜt
);

2948 
	`APPEND_STAT
("udµÜt", "%d", 
£‰šgs
.
udµÜt
);

2949 
	`APPEND_STAT
("š‹r", "%s", 
£‰šgs
.
š‹r
 ? settings.inter : "NULL");

2950 
	`APPEND_STAT
("v”bos™y", "%d", 
£‰šgs
.
v”bo£
);

2951 
	`APPEND_STAT
("Şde¡", "%lu", ()
£‰šgs
.
Şde¡_live
);

2952 
	`APPEND_STAT
("eviùiÚs", "%s", 
£‰šgs
.
eviù_to_ä“
 ? "on" : "off");

2953 
	`APPEND_STAT
("domain_socket", "%s",

2954 
£‰šgs
.
sock‘·th
 ? settings.socketpath : "NULL");

2955 
	`APPEND_STAT
("umask", "%o", 
£‰šgs
.
acûss
);

2956 
	`APPEND_STAT
("growth_çùÜ", "%.2f", 
£‰šgs
.
çùÜ
);

2957 
	`APPEND_STAT
("chunk_size", "%d", 
£‰šgs
.
chunk_size
);

2958 
	`APPEND_STAT
("num_th»ads", "%d", 
£‰šgs
.
num_th»ads
);

2959 
	`APPEND_STAT
("num_th»ads_³r_udp", "%d", 
£‰šgs
.
num_th»ads_³r_udp
);

2960 
	`APPEND_STAT
("¡©_key_´efix", "%c", 
£‰šgs
.
´efix_d–im™”
);

2961 
	`APPEND_STAT
("detail_enabled", "%s",

2962 
£‰šgs
.
d‘a_’abËd
 ? "yes" : "no");

2963 
	`APPEND_STAT
("»qs_³r_ev’t", "%d", 
£‰šgs
.
»qs_³r_ev’t
);

2964 
	`APPEND_STAT
("ÿs_’abËd", "%s", 
£‰šgs
.
u£_ÿs
 ? "yes" : "no");

2965 
	`APPEND_STAT
("tı_backlog", "%d", 
£‰šgs
.
backlog
);

2966 
	`APPEND_STAT
("binding_protocol", "%s",

2967 
	`´Ù_‹xt
(
£‰šgs
.
bšdšg_´ÙocŞ
));

2968 
	`APPEND_STAT
("auth_’abËd_§¦", "%s", 
£‰šgs
.
§¦
 ? "yes" : "no");

2969 
	`APPEND_STAT
("™em_size_max", "%d", 
£‰šgs
.
™em_size_max
);

2970 
	`APPEND_STAT
("maxcÚns_ç¡", "%s", 
£‰šgs
.
maxcÚns_ç¡
 ? "yes" : "no");

2971 
	`APPEND_STAT
("hashpow”_š™", "%d", 
£‰šgs
.
hashpow”_š™
);

2972 
	`APPEND_STAT
("¦ab_»assign", "%s", 
£‰šgs
.
¦ab_»assign
 ? "yes" : "no");

2973 
	`APPEND_STAT
("¦ab_automove", "%d", 
£‰šgs
.
¦ab_automove
);

2974 
	`APPEND_STAT
("¦ab_chunk_max", "%d", 
£‰šgs
.
¦ab_chunk_size_max
);

2975 
	`APPEND_STAT
("Ìu_üawËr", "%s", 
£‰šgs
.
Ìu_üawËr
 ? "yes" : "no");

2976 
	`APPEND_STAT
("Ìu_üawËr_¦“p", "%d", 
£‰šgs
.
Ìu_üawËr_¦“p
);

2977 
	`APPEND_STAT
("Ìu_üawËr_toüawl", "%lu", ()
£‰šgs
.
Ìu_üawËr_toüawl
);

2978 
	`APPEND_STAT
("_»·œ_time", "%d", 
£‰šgs
.
_»·œ_time
);

2979 
	`APPEND_STAT
("æush_’abËd", "%s", 
£‰šgs
.
æush_’abËd
 ? "yes" : "no");

2980 
	`APPEND_STAT
("dump_’abËd", "%s", 
£‰šgs
.
dump_’abËd
 ? "yes" : "no");

2981 
	`APPEND_STAT
("hash_®gÜ™hm", "%s", 
£‰šgs
.
hash_®gÜ™hm
);

2982 
	`APPEND_STAT
("Ìu_mašš”_th»ad", "%s", 
£‰šgs
.
Ìu_mašš”_th»ad
 ? "yes" : "no");

2983 
	`APPEND_STAT
("hÙ_Ìu_pù", "%d", 
£‰šgs
.
hÙ_Ìu_pù
);

2984 
	`APPEND_STAT
("w¬m_Ìu_pù", "%d", 
£‰šgs
.
w¬m_Ìu_pù
);

2985 
	`APPEND_STAT
("expœez”o_dÛs_nÙ_eviù", "%s", 
£‰šgs
.
expœez”o_dÛs_nÙ_eviù
 ? "yes" : "no");

2986 
	`APPEND_STAT
("idË_timeout", "%d", 
£‰šgs
.
idË_timeout
);

2987 
	`APPEND_STAT
("w©ch”_logbuf_size", "%u", 
£‰šgs
.
logg”_w©ch”_buf_size
);

2988 
	`APPEND_STAT
("wÜk”_logbuf_size", "%u", 
£‰šgs
.
logg”_buf_size
);

2989 
	`APPEND_STAT
("Œack_sizes", "%s", 
	`™em_¡©s_sizes_¡©us
() ? "yes" : "no");

2990 
	}
}

2992 
	$cÚn_to_¡r
(cÚ¡ 
cÚn
 *
c
, *
buf
) {

2993 
addr_‹xt
[
MAXPATHLEN
];

2995 ià(!
c
) {

2996 
	`¡rıy
(
buf
, "<null>");

2997 } ià(
c
->
¡©e
 =ğ
cÚn_şo£d
) {

2998 
	`¡rıy
(
buf
, "<closed>");

3000 cÚ¡ *
´ÙÚame
 = "?";

3001 
sockaddr_š6
 
loÿl_addr
;

3002 
sockaddr
 *
addr
 = (*)&
c
->
»que¡_addr
;

3003 
af
;

3004 
pÜt
 = 0;

3007 ià(
c
->
¡©e
 =ğ
cÚn_li¡’šg
 ||

3008 (
	`IS_UDP
(
c
->
Œª¥Üt
) &&

3009 
c
->
¡©e
 =ğ
cÚn_»ad
)) {

3010 
sockËn_t
 
loÿl_addr_Ën
 = (
loÿl_addr
);

3012 ià(
	`g‘sockÇme
(
c
->
sfd
,

3013 (
sockaddr
 *)&
loÿl_addr
,

3014 &
loÿl_addr_Ën
) == 0) {

3015 
addr
 = (
sockaddr
 *)&
loÿl_addr
;

3019 
af
 = 
addr
->
§_çmy
;

3020 
addr_‹xt
[0] = '\0';

3022 
af
) {

3023 
AF_INET
:

3024 (è
	`š‘_Áİ
(
af
,

3025 &((
sockaddr_š
 *)
addr
)->
sš_addr
,

3026 
addr_‹xt
,

3027 (
addr_‹xt
) - 1);

3028 
pÜt
 = 
	`Áohs
(((
sockaddr_š
 *)
addr
)->
sš_pÜt
);

3029 
´ÙÚame
 = 
	`IS_UDP
(
c
->
Œª¥Üt
) ? "udp" : "tcp";

3032 
AF_INET6
:

3033 
addr_‹xt
[0] = '[';

3034 
addr_‹xt
[1] = '\0';

3035 ià(
	`š‘_Áİ
(
af
,

3036 &((
sockaddr_š6
 *)
addr
)->
sš6_addr
,

3037 
addr_‹xt
 + 1,

3038 (
addr_‹xt
) - 2)) {

3039 
	`¡rÿt
(
addr_‹xt
, "]");

3041 
pÜt
 = 
	`Áohs
(((
sockaddr_š6
 *)
addr
)->
sš6_pÜt
);

3042 
´ÙÚame
 = 
	`IS_UDP
(
c
->
Œª¥Üt
) ? "udp6" : "tcp6";

3045 
AF_UNIX
:

3046 
	`¡ºıy
(
addr_‹xt
,

3047 ((
sockaddr_un
 *)
addr
)->
sun_·th
,

3048 (
addr_‹xt
) - 1);

3049 
addr_‹xt
[(addr_text)-1] = '\0';

3050 
´ÙÚame
 = "unix";

3054 ià(
	`¡¾’
(
addr_‹xt
) < 2) {

3059 
	`¥rštf
(
addr_‹xt
, "<AF %d>", 
af
);

3062 ià(
pÜt
) {

3063 
	`¥rštf
(
buf
, "%s:%s:%u", 
´ÙÚame
, 
addr_‹xt
, 
pÜt
);

3065 
	`¥rštf
(
buf
, "%s:%s", 
´ÙÚame
, 
addr_‹xt
);

3068 
	}
}

3070 
	$´oûss_¡©s_cÚns
(
ADD_STAT
 
add_¡©s
, *
c
) {

3071 
i
;

3072 
key_¡r
[
STAT_KEY_LEN
];

3073 
v®_¡r
[
STAT_VAL_LEN
];

3074 
cÚn_Çme
[
MAXPATHLEN
 + ("unix:")];

3075 
kËn
 = 0, 
vËn
 = 0;

3077 
	`as£¹
(
add_¡©s
);

3079 
i
 = 0; i < 
max_fds
; i++) {

3080 ià(
cÚns
[
i
]) {

3086 ià(
cÚns
[
i
]->
¡©e
 !ğ
cÚn_şo£d
) {

3087 
	`cÚn_to_¡r
(
cÚns
[
i
], 
cÚn_Çme
);

3089 
	`APPEND_NUM_STAT
(
i
, "addr", "%s", 
cÚn_Çme
);

3090 
	`APPEND_NUM_STAT
(
i
, "state", "%s",

3091 
	`¡©e_‹xt
(
cÚns
[
i
]->
¡©e
));

3092 
	`APPEND_NUM_STAT
(
i
, "secs_since_last_cmd", "%d",

3093 
cu¼’t_time
 - 
cÚns
[
i
]->
Ï¡_cmd_time
);

3097 
	}
}

3099 
	$´oûss_¡©
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
) {

3100 cÚ¡ *
subcommªd
 = 
tok’s
[
SUBCOMMAND_TOKEN
].
v®ue
;

3101 
	`as£¹
(
c
 !ğ
NULL
);

3103 ià(
Áok’s
 < 2) {

3104 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine");

3108 ià(
Áok’s
 == 2) {

3109 
	`£rv”_¡©s
(&
­³nd_¡©s
, 
c
);

3110 ()
	`g‘_¡©s
(
NULL
, 0, &
­³nd_¡©s
, 
c
);

3111 } ià(
	`¡rcmp
(
subcommªd
, "reset") == 0) {

3112 
	`¡©s_»£t
();

3113 
	`out_¡ršg
(
c
, "RESET");

3115 } ià(
	`¡rcmp
(
subcommªd
, "detail") == 0) {

3117 ià(
Áok’s
 < 4)

3118 
	`´oûss_¡©s_d‘a
(
c
, "");

3120 
	`´oûss_¡©s_d‘a
(
c
, 
tok’s
[2].
v®ue
);

3123 } ià(
	`¡rcmp
(
subcommªd
, "settings") == 0) {

3124 
	`´oûss_¡©_£‰šgs
(&
­³nd_¡©s
, 
c
);

3125 } ià(
	`¡rcmp
(
subcommªd
, "cachedump") == 0) {

3126 *
buf
;

3127 
by‹s
, 
id
, 
lim™
 = 0;

3129 ià(!
£‰šgs
.
dump_’abËd
) {

3130 
	`out_¡ršg
(
c
, "CLIENT_ERROR stats cachedump‚ot‡llowed");

3134 ià(
Áok’s
 < 5) {

3135 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine");

3139 ià(!
	`§ã_¡¹oul
(
tok’s
[2].
v®ue
, &
id
) ||

3140 !
	`§ã_¡¹oul
(
tok’s
[3].
v®ue
, &
lim™
)) {

3141 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3145 ià(
id
 >ğ
MAX_NUMBER_OF_SLAB_CLASSES
) {

3146 
	`out_¡ršg
(
c
, "CLIENT_ERROR Illegal slab id");

3150 
buf
 = 
	`™em_ÿchedump
(
id
, 
lim™
, &
by‹s
);

3151 
	`wr™e_ªd_ä“
(
c
, 
buf
, 
by‹s
);

3153 } ià(
	`¡rcmp
(
subcommªd
, "conns") == 0) {

3154 
	`´oûss_¡©s_cÚns
(&
­³nd_¡©s
, 
c
);

3158 ià(
	`g‘_¡©s
(
subcommªd
, 
	`¡¾’
(subcommªd), &
­³nd_¡©s
, 
c
)) {

3159 ià(
c
->
¡©s
.
bufãr
 =ğ
NULL
) {

3160 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory writing stats");

3162 
	`wr™e_ªd_ä“
(
c
, c->
¡©s
.
bufãr
, c->¡©s.
off£t
);

3163 
c
->
¡©s
.
bufãr
 = 
NULL
;

3166 
	`out_¡ršg
(
c
, "ERROR");

3172 
	`­³nd_¡©s
(
NULL
, 0, NULL, 0, 
c
);

3174 ià(
c
->
¡©s
.
bufãr
 =ğ
NULL
) {

3175 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory writing stats");

3177 
	`wr™e_ªd_ä“
(
c
, c->
¡©s
.
bufãr
, c->¡©s.
off£t
);

3178 
c
->
¡©s
.
bufãr
 = 
NULL
;

3180 
	}
}

3183 
šlše
 
	$´oûss_g‘_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, 
size_t
 
Áok’s
, 
boŞ
 
»tuº_ÿs
) {

3184 *
key
;

3185 
size_t
 
nkey
;

3186 
i
 = 0;

3187 
™em
 *
™
;

3188 
tok’_t
 *
key_tok’
 = &
tok’s
[
KEY_TOKEN
];

3189 *
suffix
;

3190 
	`as£¹
(
c
 !ğ
NULL
);

3193 
key_tok’
->
Ëngth
 != 0) {

3195 
key
 = 
key_tok’
->
v®ue
;

3196 
nkey
 = 
key_tok’
->
Ëngth
;

3198 if(
nkey
 > 
KEY_MAX_LENGTH
) {

3199 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3200 
i
-- > 0) {

3201 
	`™em_»move
(*(
c
->
i¡
 + 
i
));

3206 
™
 = 
	`™em_g‘
(
key
, 
nkey
, 
c
);

3207 ià(
£‰šgs
.
d‘a_’abËd
) {

3208 
	`¡©s_´efix_»cÜd_g‘
(
key
, 
nkey
, 
NULL
 !ğ
™
);

3210 ià(
™
) {

3211 ià(
i
 >ğ
c
->
isize
) {

3212 
™em
 **
Ãw_li¡
 = 
	`»®loc
(
c
->
i¡
, (™em *è* c->
isize
 * 2);

3213 ià(
Ãw_li¡
) {

3214 
c
->
isize
 *= 2;

3215 
c
->
i¡
 = 
Ãw_li¡
;

3217 
	`STATS_LOCK
();

3218 
¡©s
.
m®loc_çs
++;

3219 
	`STATS_UNLOCK
();

3220 
	`™em_»move
(
™
);

3233 ià(
»tuº_ÿs
)

3235 
	`MEMCACHED_COMMAND_GET
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

3236 
™
->
nby‹s
, 
	`ITEM_g‘_ÿs
(it));

3238 ià(
i
 >ğ
c
->
suffixsize
) {

3239 **
Ãw_suffix_li¡
 = 
	`»®loc
(
c
->
suffixli¡
,

3240 (*è* 
c
->
suffixsize
 * 2);

3241 ià(
Ãw_suffix_li¡
) {

3242 
c
->
suffixsize
 *= 2;

3243 
c
->
suffixli¡
 = 
Ãw_suffix_li¡
;

3245 
	`STATS_LOCK
();

3246 
¡©s
.
m®loc_çs
++;

3247 
	`STATS_UNLOCK
();

3248 
	`™em_»move
(
™
);

3253 
suffix
 = 
	`ÿche_®loc
(
c
->
th»ad
->
suffix_ÿche
);

3254 ià(
suffix
 =ğ
NULL
) {

3255 
	`STATS_LOCK
();

3256 
¡©s
.
m®loc_çs
++;

3257 
	`STATS_UNLOCK
();

3258 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory making CAS suffix");

3259 
	`™em_»move
(
™
);

3260 
i
-- > 0) {

3261 
	`™em_»move
(*(
c
->
i¡
 + 
i
));

3265 *(
c
->
suffixli¡
 + 
i
èğ
suffix
;

3266 
suffix_Ën
 = 
	`¢´štf
(
suffix
, 
SUFFIX_SIZE
,

3268 ()
	`ITEM_g‘_ÿs
(
™
));

3269 ià(
	`add_iov
(
c
, "VALUE ", 6) != 0 ||

3270 
	`add_iov
(
c
, 
	`ITEM_key
(
™
), it->
nkey
) != 0 ||

3271 
	`add_iov
(
c
, 
	`ITEM_suffix
(
™
), it->
nsuffix
 - 2) != 0 ||

3272 
	`add_iov
(
c
, 
suffix
, 
suffix_Ën
) != 0)

3274 
	`™em_»move
(
™
);

3277 ià((
™
->
™_æags
 & 
ITEM_CHUNKED
) == 0) {

3278 
	`add_iov
(
c
, 
	`ITEM_d©a
(
™
), it->
nby‹s
);

3279 } ià(
	`add_chunked_™em_iovs
(
c
, 
™
, it->
nby‹s
) != 0) {

3280 
	`™em_»move
(
™
);

3286 
	`MEMCACHED_COMMAND_GET
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
,

3287 
™
->
nby‹s
, 
	`ITEM_g‘_ÿs
(it));

3288 ià(
	`add_iov
(
c
, "VALUE ", 6) != 0 ||

3289 
	`add_iov
(
c
, 
	`ITEM_key
(
™
), it->
nkey
) != 0)

3291 
	`™em_»move
(
™
);

3294 ià((
™
->
™_æags
 & 
ITEM_CHUNKED
) == 0)

3296 ià(
	`add_iov
(
c
, 
	`ITEM_suffix
(
™
), it->
nsuffix
 + it->
nby‹s
) != 0)

3298 
	`™em_»move
(
™
);

3301 } ià(
	`add_iov
(
c
, 
	`ITEM_suffix
(
™
), it->
nsuffix
) != 0 ||

3302 
	`add_chunked_™em_iovs
(
c
, 
™
, it->
nby‹s
) != 0) {

3303 
	`™em_»move
(
™
);

3309 ià(
£‰šgs
.
v”bo£
 > 1) {

3310 
ii
;

3311 
	`årštf
(
¡d”r
, ">%d s’dšg key ", 
c
->
sfd
);

3312 
ii
 = 0; i˜< 
™
->
nkey
; ++ii) {

3313 
	`årštf
(
¡d”r
, "%c", 
key
[
ii
]);

3315 
	`årštf
(
¡d”r
, "\n");

3319 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3320 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
g‘_h™s
++;

3321 
c
->
th»ad
->
¡©s
.
g‘_cmds
++;

3322 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3323 
	`™em_upd©e
(
™
);

3324 *(
c
->
i¡
 + 
i
èğ
™
;

3325 
i
++;

3328 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3329 
c
->
th»ad
->
¡©s
.
g‘_mis£s
++;

3330 
c
->
th»ad
->
¡©s
.
g‘_cmds
++;

3331 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3332 
	`MEMCACHED_COMMAND_GET
(
c
->
sfd
, 
key
, 
nkey
, -1, 0);

3335 
key_tok’
++;

3342 if(
key_tok’
->
v®ue
 !ğ
NULL
) {

3343 
Áok’s
 = 
	`tok’ize_commªd
(
key_tok’
->
v®ue
, 
tok’s
, 
MAX_TOKENS
);

3344 
key_tok’
 = 
tok’s
;

3347 } 
key_tok’
->
v®ue
 !ğ
NULL
);

3349 
c
->
icu¼
 = c->
i¡
;

3350 
c
->
eá
 = 
i
;

3351 ià(
»tuº_ÿs
) {

3352 
c
->
suffixcu¼
 = c->
suffixli¡
;

3353 
c
->
suffixËá
 = 
i
;

3356 ià(
£‰šgs
.
v”bo£
 > 1)

3357 
	`årštf
(
¡d”r
, ">%d END\n", 
c
->
sfd
);

3364 ià(
key_tok’
->
v®ue
 !ğ
NULL
 || 
	`add_iov
(
c
, "END\r\n", 5) != 0

3365 || (
	`IS_UDP
(
c
->
Œª¥Üt
è&& 
	`bud_udp_h—d”s
(c) != 0)) {

3366 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory writing get„esponse");

3369 
	`cÚn_£t_¡©e
(
c
, 
cÚn_mwr™e
);

3370 
c
->
msgcu¼
 = 0;

3372 
	}
}

3374 
	$´oûss_upd©e_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
, 
comm
, 
boŞ
 
hªdË_ÿs
) {

3375 *
key
;

3376 
size_t
 
nkey
;

3377 
æags
;

3378 
št32_t
 
ex±ime_št
 = 0;

3379 
time_t
 
ex±ime
;

3380 
vËn
;

3381 
ušt64_t
 
»q_ÿs_id
=0;

3382 
™em
 *
™
;

3384 
	`as£¹
(
c
 !ğ
NULL
);

3386 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3388 ià(
tok’s
[
KEY_TOKEN
].
Ëngth
 > 
KEY_MAX_LENGTH
) {

3389 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3393 
key
 = 
tok’s
[
KEY_TOKEN
].
v®ue
;

3394 
nkey
 = 
tok’s
[
KEY_TOKEN
].
Ëngth
;

3396 ià(! (
	`§ã_¡¹oul
(
tok’s
[2].
v®ue
, (
ušt32_t
 *)&
æags
)

3397 && 
	`§ã_¡¹Ş
(
tok’s
[3].
v®ue
, &
ex±ime_št
)

3398 && 
	`§ã_¡¹Ş
(
tok’s
[4].
v®ue
, (
št32_t
 *)&
vËn
))) {

3399 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3404 
ex±ime
 = 
ex±ime_št
;

3409 ià(
ex±ime
 < 0)

3410 
ex±ime
 = 
REALTIME_MAXDELTA
 + 1;

3413 ià(
hªdË_ÿs
) {

3414 ià(!
	`§ã_¡¹ouÎ
(
tok’s
[5].
v®ue
, &
»q_ÿs_id
)) {

3415 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3420 ià(
vËn
 < 0 || vËÀ> (
INT_MAX
 - 2)) {

3421 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3424 
vËn
 += 2;

3426 ià(
£‰šgs
.
d‘a_’abËd
) {

3427 
	`¡©s_´efix_»cÜd_£t
(
key
, 
nkey
);

3430 
™
 = 
	`™em_®loc
(
key
, 
nkey
, 
æags
, 
	`»®time
(
ex±ime
), 
vËn
);

3432 ià(
™
 == 0) {

3433 
¡Üe_™em_ty³
 
¡©us
;

3434 ià(! 
	`™em_size_ok
(
nkey
, 
æags
, 
vËn
)) {

3435 
	`out_¡ršg
(
c
, "SERVER_ERROR objectoo†arge for cache");

3436 
¡©us
 = 
TOO_LARGE
;

3438 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory storing object");

3439 
¡©us
 = 
NO_MEMORY
;

3441 
	`LOGGER_LOG
(
c
->
th»ad
->
l
, 
LOG_MUTATIONS
, 
LOGGER_ITEM_STORE
,

3442 
NULL
, 
¡©us
, 
comm
, 
key
, 
nkey
, 0, 0);

3444 
c
->
wr™e_ªd_go
 = 
cÚn_sw®low
;

3445 
c
->
sby‹s
 = 
vËn
;

3449 ià(
comm
 =ğ
NREAD_SET
) {

3450 
™
 = 
	`™em_g‘
(
key
, 
nkey
, 
c
);

3451 ià(
™
) {

3452 
	`™em_uÆšk
(
™
);

3453 
	`™em_»move
(
™
);

3459 
	`ITEM_£t_ÿs
(
™
, 
»q_ÿs_id
);

3461 
c
->
™em
 = 
™
;

3462 
c
->
r™em
 = 
	`ITEM_d©a
(
™
);

3463 
c
->
¾by‹s
 = 
™
->
nby‹s
;

3464 
c
->
cmd
 = 
comm
;

3465 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ä—d
);

3466 
	}
}

3468 
	$´oûss_touch_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
) {

3469 *
key
;

3470 
size_t
 
nkey
;

3471 
št32_t
 
ex±ime_št
 = 0;

3472 
™em
 *
™
;

3474 
	`as£¹
(
c
 !ğ
NULL
);

3476 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3478 ià(
tok’s
[
KEY_TOKEN
].
Ëngth
 > 
KEY_MAX_LENGTH
) {

3479 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3483 
key
 = 
tok’s
[
KEY_TOKEN
].
v®ue
;

3484 
nkey
 = 
tok’s
[
KEY_TOKEN
].
Ëngth
;

3486 ià(!
	`§ã_¡¹Ş
(
tok’s
[2].
v®ue
, &
ex±ime_št
)) {

3487 
	`out_¡ršg
(
c
, "CLIENT_ERROR invalidƒxptime‡rgument");

3491 
™
 = 
	`™em_touch
(
key
, 
nkey
, 
	`»®time
(
ex±ime_št
), 
c
);

3492 ià(
™
) {

3493 
	`™em_upd©e
(
™
);

3494 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3495 
c
->
th»ad
->
¡©s
.
touch_cmds
++;

3496 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
touch_h™s
++;

3497 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3499 
	`out_¡ršg
(
c
, "TOUCHED");

3500 
	`™em_»move
(
™
);

3502 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3503 
c
->
th»ad
->
¡©s
.
touch_cmds
++;

3504 
c
->
th»ad
->
¡©s
.
touch_mis£s
++;

3505 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3507 
	`out_¡ršg
(
c
, "NOT_FOUND");

3509 
	}
}

3511 
	$´oûss_¬™hm‘ic_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
, cÚ¡ 
boŞ
 
šü
) {

3512 
‹mp
[
INCR_MAX_STORAGE_LEN
];

3513 
ušt64_t
 
d–
;

3514 *
key
;

3515 
size_t
 
nkey
;

3517 
	`as£¹
(
c
 !ğ
NULL
);

3519 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3521 ià(
tok’s
[
KEY_TOKEN
].
Ëngth
 > 
KEY_MAX_LENGTH
) {

3522 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3526 
key
 = 
tok’s
[
KEY_TOKEN
].
v®ue
;

3527 
nkey
 = 
tok’s
[
KEY_TOKEN
].
Ëngth
;

3529 ià(!
	`§ã_¡¹ouÎ
(
tok’s
[2].
v®ue
, &
d–
)) {

3530 
	`out_¡ršg
(
c
, "CLIENT_ERROR invalid‚umeric delta‡rgument");

3534 
	`add_d–
(
c
, 
key
, 
nkey
, 
šü
, 
d–
, 
‹mp
, 
NULL
)) {

3535 
OK
:

3536 
	`out_¡ršg
(
c
, 
‹mp
);

3538 
NON_NUMERIC
:

3539 
	`out_¡ršg
(
c
, "CLIENT_ERROR cannot increment or decrement‚on-numeric value");

3541 
EOM
:

3542 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory");

3544 
DELTA_ITEM_NOT_FOUND
:

3545 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3546 ià(
šü
) {

3547 
c
->
th»ad
->
¡©s
.
šü_mis£s
++;

3549 
c
->
th»ad
->
¡©s
.
deü_mis£s
++;

3551 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3553 
	`out_¡ršg
(
c
, "NOT_FOUND");

3555 
DELTA_ITEM_CAS_MISMATCH
:

3558 
	}
}

3571 
d–_»suÉ_ty³
 
	$do_add_d–
(
cÚn
 *
c
, cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
,

3572 cÚ¡ 
boŞ
 
šü
, cÚ¡ 
št64_t
 
d–
,

3573 *
buf
, 
ušt64_t
 *
ÿs
,

3574 cÚ¡ 
ušt32_t
 
hv
) {

3575 *
±r
;

3576 
ušt64_t
 
v®ue
;

3577 
»s
;

3578 
™em
 *
™
;

3580 
™
 = 
	`do_™em_g‘
(
key
, 
nkey
, 
hv
, 
c
);

3581 ià(!
™
) {

3582  
DELTA_ITEM_NOT_FOUND
;

3587 ià(
™
->
nby‹s
 <ğ2 || (™->
™_æags
 & 
ITEM_CHUNKED
) != 0) {

3588  
NON_NUMERIC
;

3591 ià(
ÿs
 !ğ
NULL
 && *ÿ !ğ0 && 
	`ITEM_g‘_ÿs
(
™
) != *cas) {

3592 
	`do_™em_»move
(
™
);

3593  
DELTA_ITEM_CAS_MISMATCH
;

3596 
±r
 = 
	`ITEM_d©a
(
™
);

3598 ià(!
	`§ã_¡¹ouÎ
(
±r
, &
v®ue
)) {

3599 
	`do_™em_»move
(
™
);

3600  
NON_NUMERIC
;

3603 ià(
šü
) {

3604 
v®ue
 +ğ
d–
;

3605 
	`MEMCACHED_COMMAND_INCR
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
, 
v®ue
);

3607 if(
d–
 > 
v®ue
) {

3608 
v®ue
 = 0;

3610 
v®ue
 -ğ
d–
;

3612 
	`MEMCACHED_COMMAND_DECR
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
, 
v®ue
);

3615 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3616 ià(
šü
) {

3617 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
šü_h™s
++;

3619 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
deü_h™s
++;

3621 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3623 
	`¢´štf
(
buf
, 
INCR_MAX_STORAGE_LEN
, "%Îu", ()
v®ue
);

3624 
»s
 = 
	`¡¾’
(
buf
);

3628 ià(
»s
 + 2 <ğ
™
->
nby‹s
 && it->
»fcouÁ
 == 2) {

3634 
	`™em_¡©s_sizes_»move
(
™
);

3635 
	`ITEM_£t_ÿs
(
™
, (
£‰šgs
.
u£_ÿs
è? 
	`g‘_ÿs_id
() : 0);

3636 
	`™em_¡©s_sizes_add
(
™
);

3637 
	`memıy
(
	`ITEM_d©a
(
™
), 
buf
, 
»s
);

3638 
	`mem£t
(
	`ITEM_d©a
(
™
è+ 
»s
, ' ', it->
nby‹s
 -„es - 2);

3639 
	`do_™em_upd©e
(
™
);

3640 } ià(
™
->
»fcouÁ
 > 1) {

3641 
™em
 *
Ãw_™
;

3642 
ušt32_t
 
æags
 = (ušt32_tè
	`¡¹oul
(
	`ITEM_suffix
(
™
)+1, (**è
NULL
, 10);

3643 
Ãw_™
 = 
	`do_™em_®loc
(
	`ITEM_key
(
™
), it->
nkey
, 
æags
, it->
ex±ime
, 
»s
 + 2);

3644 ià(
Ãw_™
 == 0) {

3645 
	`do_™em_»move
(
™
);

3646  
EOM
;

3648 
	`memıy
(
	`ITEM_d©a
(
Ãw_™
), 
buf
, 
»s
);

3649 
	`memıy
(
	`ITEM_d©a
(
Ãw_™
è+ 
»s
, "\r\n", 2);

3650 
	`™em_»¶aû
(
™
, 
Ãw_™
, 
hv
);

3653 
	`ITEM_£t_ÿs
(
™
, (
£‰šgs
.
u£_ÿs
è? 
	`ITEM_g‘_ÿs
(
Ãw_™
) : 0);

3654 
	`do_™em_»move
(
Ãw_™
);

3658 ià(
£‰šgs
.
v”bo£
) {

3659 
	`årštf
(
¡d”r
, "Triedo do incr/decr on invalid item\n");

3661 ià(
™
->
»fcouÁ
 == 1)

3662 
	`do_™em_»move
(
™
);

3663  
DELTA_ITEM_NOT_FOUND
;

3666 ià(
ÿs
) {

3667 *
ÿs
 = 
	`ITEM_g‘_ÿs
(
™
);

3669 
	`do_™em_»move
(
™
);

3670  
OK
;

3671 
	}
}

3673 
	$´oûss_d–‘e_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
) {

3674 *
key
;

3675 
size_t
 
nkey
;

3676 
™em
 *
™
;

3678 
	`as£¹
(
c
 !ğ
NULL
);

3680 ià(
Áok’s
 > 3) {

3681 
boŞ
 
hŞd_is_z”o
 = 
	`¡rcmp
(
tok’s
[
KEY_TOKEN
+1].
v®ue
, "0") == 0;

3682 
boŞ
 
£ts_nÜ•ly
 = 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3683 
boŞ
 
v®id
 = (
Áok’s
 =ğ4 && (
hŞd_is_z”o
 || 
£ts_nÜ•ly
))

3684 || (
Áok’s
 =ğ5 && 
hŞd_is_z”o
 && 
£ts_nÜ•ly
);

3685 ià(!
v®id
) {

3686 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format. "

3693 
key
 = 
tok’s
[
KEY_TOKEN
].
v®ue
;

3694 
nkey
 = 
tok’s
[
KEY_TOKEN
].
Ëngth
;

3696 if(
nkey
 > 
KEY_MAX_LENGTH
) {

3697 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3701 ià(
£‰šgs
.
d‘a_’abËd
) {

3702 
	`¡©s_´efix_»cÜd_d–‘e
(
key
, 
nkey
);

3705 
™
 = 
	`™em_g‘
(
key
, 
nkey
, 
c
);

3706 ià(
™
) {

3707 
	`MEMCACHED_COMMAND_DELETE
(
c
->
sfd
, 
	`ITEM_key
(
™
), it->
nkey
);

3709 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3710 
c
->
th»ad
->
¡©s
.
¦ab_¡©s
[
	`ITEM_şsid
(
™
)].
d–‘e_h™s
++;

3711 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3713 
	`™em_uÆšk
(
™
);

3714 
	`™em_»move
(
™
);

3715 
	`out_¡ršg
(
c
, "DELETED");

3717 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3718 
c
->
th»ad
->
¡©s
.
d–‘e_mis£s
++;

3719 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3721 
	`out_¡ršg
(
c
, "NOT_FOUND");

3723 
	}
}

3725 
	$´oûss_v”bos™y_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
) {

3726 
Ëv–
;

3728 
	`as£¹
(
c
 !ğ
NULL
);

3730 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3732 
Ëv–
 = 
	`¡¹oul
(
tok’s
[1].
v®ue
, 
NULL
, 10);

3733 
£‰šgs
.
v”bo£
 = 
Ëv–
 > 
MAX_VERBOSITY_LEVEL
 ? MAX_VERBOSITY_LEVEL :†evel;

3734 
	`out_¡ršg
(
c
, "OK");

3736 
	}
}

3738 
	$´oûss_¦abs_automove_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
) {

3739 
Ëv–
;

3741 
	`as£¹
(
c
 !ğ
NULL
);

3743 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3745 
Ëv–
 = 
	`¡¹oul
(
tok’s
[2].
v®ue
, 
NULL
, 10);

3746 ià(
Ëv–
 == 0) {

3747 
£‰šgs
.
¦ab_automove
 = 0;

3748 } ià(
Ëv–
 == 1 ||†evel == 2) {

3749 
£‰šgs
.
¦ab_automove
 = 
Ëv–
;

3751 
	`out_¡ršg
(
c
, "ERROR");

3754 
	`out_¡ršg
(
c
, "OK");

3756 
	}
}

3759 
	$´oûss_w©ch_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
) {

3760 
ušt16_t
 
f
 = 0;

3761 
x
;

3762 
	`as£¹
(
c
 !ğ
NULL
);

3764 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3765 ià(
Áok’s
 > 2) {

3766 
x
 = 
COMMAND_TOKEN
 + 1; x < 
Áok’s
 - 1; x++) {

3767 ià((
	`¡rcmp
(
tok’s
[
x
].
v®ue
, "rawcmds") == 0)) {

3768 
f
 |ğ
LOG_RAWCMDS
;

3769 } ià((
	`¡rcmp
(
tok’s
[
x
].
v®ue
, "evictions") == 0)) {

3770 
f
 |ğ
LOG_EVICTIONS
;

3771 } ià((
	`¡rcmp
(
tok’s
[
x
].
v®ue
, "fetchers") == 0)) {

3772 
f
 |ğ
LOG_FETCHERS
;

3773 } ià((
	`¡rcmp
(
tok’s
[
x
].
v®ue
, "mutations") == 0)) {

3774 
f
 |ğ
LOG_MUTATIONS
;

3775 } ià((
	`¡rcmp
(
tok’s
[
x
].
v®ue
, "sysevents") == 0)) {

3776 
f
 |ğ
LOG_SYSEVENTS
;

3778 
	`out_¡ršg
(
c
, "ERROR");

3783 
f
 |ğ
LOG_FETCHERS
;

3786 
	`logg”_add_w©ch”
(
c
, c->
sfd
, 
f
)) {

3787 
LOGGER_ADD_WATCHER_TOO_MANY
:

3788 
	`out_¡ršg
(
c
, "WATCHER_TOO_MANY†og watcher†imit„eached");

3790 
LOGGER_ADD_WATCHER_FAILED
:

3791 
	`out_¡ršg
(
c
, "WATCHER_FAILED failedo‡dd†og watcher");

3793 
LOGGER_ADD_WATCHER_OK
:

3794 
	`cÚn_£t_¡©e
(
c
, 
cÚn_w©ch
);

3795 
	`ev’t_d–
(&
c
->
ev’t
);

3798 
	}
}

3800 
	$´oûss_memlim™_commªd
(
cÚn
 *
c
, 
tok’_t
 *
tok’s
, cÚ¡ 
size_t
 
Áok’s
) {

3801 
ušt32_t
 
memlim™
;

3802 
	`as£¹
(
c
 !ğ
NULL
);

3804 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3806 ià(!
	`§ã_¡¹oul
(
tok’s
[1].
v®ue
, &
memlim™
)) {

3807 
	`out_¡ršg
(
c
, "ERROR");

3809 ià(
memlim™
 < 8) {

3810 
	`out_¡ršg
(
c
, "MEMLIMIT_TOO_SMALL cannot set maxbyteso†esshan 8m");

3812 ià(
	`¦abs_adju¡_mem_lim™
((
size_t
è
memlim™
 * 1024 * 1024)) {

3813 ià(
£‰šgs
.
v”bo£
 > 0) {

3814 
	`årštf
(
¡d”r
, "maxby‹ adju¡edØ%Îum\n", ()
memlim™
);

3817 
	`out_¡ršg
(
c
, "OK");

3819 
	`out_¡ršg
(
c
, "MEMLIMIT_ADJUST_FAILED out of bounds or unableo‡djust");

3823 
	}
}

3825 
	$´oûss_commªd
(
cÚn
 *
c
, *
commªd
) {

3827 
tok’_t
 
tok’s
[
MAX_TOKENS
];

3828 
size_t
 
Áok’s
;

3829 
comm
;

3831 
	`as£¹
(
c
 !ğ
NULL
);

3833 
	`MEMCACHED_PROCESS_COMMAND_START
(
c
->
sfd
, c->
rcu¼
, c->
rby‹s
);

3835 ià(
£‰šgs
.
v”bo£
 > 1)

3836 
	`årštf
(
¡d”r
, "<%d %s\n", 
c
->
sfd
, 
commªd
);

3843 
c
->
msgcu¼
 = 0;

3844 
c
->
msgu£d
 = 0;

3845 
c
->
iovu£d
 = 0;

3846 ià(
	`add_msghdr
(
c
) != 0) {

3847 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory…reparing„esponse");

3851 
Áok’s
 = 
	`tok’ize_commªd
(
commªd
, 
tok’s
, 
MAX_TOKENS
);

3852 ià(
Áok’s
 >= 3 &&

3853 ((
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "get") == 0) ||

3854 (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "bget") == 0))) {

3856 
	`´oûss_g‘_commªd
(
c
, 
tok’s
, 
Áok’s
, 
çl£
);

3858 } ià((
Áok’s
 == 6 ||‚tokens == 7) &&

3859 ((
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "add"è=ğ0 && (
comm
 = 
NREAD_ADD
)) ||

3860 (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "£t"è=ğ0 && (
comm
 = 
NREAD_SET
)) ||

3861 (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "»¶aû"è=ğ0 && (
comm
 = 
NREAD_REPLACE
)) ||

3862 (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "´•’d"è=ğ0 && (
comm
 = 
NREAD_PREPEND
)) ||

3863 (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "­³nd"è=ğ0 && (
comm
 = 
NREAD_APPEND
)) )) {

3865 
	`´oûss_upd©e_commªd
(
c
, 
tok’s
, 
Áok’s
, 
comm
, 
çl£
);

3867 } ià((
Áok’s
 =ğ7 ||‚tok’ =ğ8è&& (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "ÿs"è=ğ0 && (
comm
 = 
NREAD_CAS
))) {

3869 
	`´oûss_upd©e_commªd
(
c
, 
tok’s
, 
Áok’s
, 
comm
, 
Œue
);

3871 } ià((
Áok’s
 =ğ4 ||‚tok’ =ğ5è&& (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "incr") == 0)) {

3873 
	`´oûss_¬™hm‘ic_commªd
(
c
, 
tok’s
, 
Áok’s
, 1);

3875 } ià(
Áok’s
 >ğ3 && (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "gets") == 0)) {

3877 
	`´oûss_g‘_commªd
(
c
, 
tok’s
, 
Áok’s
, 
Œue
);

3879 } ià((
Áok’s
 =ğ4 ||‚tok’ =ğ5è&& (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "decr") == 0)) {

3881 
	`´oûss_¬™hm‘ic_commªd
(
c
, 
tok’s
, 
Áok’s
, 0);

3883 } ià(
Áok’s
 >ğ3 &&‚tok’ <ğ5 && (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "delete") == 0)) {

3885 
	`´oûss_d–‘e_commªd
(
c
, 
tok’s
, 
Áok’s
);

3887 } ià((
Áok’s
 =ğ4 ||‚tok’ =ğ5è&& (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "touch") == 0)) {

3889 
	`´oûss_touch_commªd
(
c
, 
tok’s
, 
Áok’s
);

3891 } ià(
Áok’s
 >ğ2 && (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "stats") == 0)) {

3893 
	`´oûss_¡©
(
c
, 
tok’s
, 
Áok’s
);

3895 } ià(
Áok’s
 >ğ2 &&‚tok’ <ğ4 && (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "flush_all") == 0)) {

3896 
time_t
 
ex±ime
 = 0;

3897 
»l_time_t
 
Ãw_Şde¡
 = 0;

3899 
	`£t_nÜ•ly_maybe
(
c
, 
tok’s
, 
Áok’s
);

3901 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3902 
c
->
th»ad
->
¡©s
.
æush_cmds
++;

3903 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

3905 ià(!
£‰šgs
.
æush_’abËd
) {

3907 
	`out_¡ršg
(
c
, "CLIENT_ERROR flush_all‚ot‡llowed");

3911 ià(
Áok’s
 !ğ(
c
->
nÜ•ly
 ? 3 : 2)) {

3912 
ex±ime
 = 
	`¡¹Ş
(
tok’s
[1].
v®ue
, 
NULL
, 10);

3913 if(
”ºo
 =ğ
ERANGE
) {

3914 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3925 ià(
ex±ime
 > 0) {

3926 
Ãw_Şde¡
 = 
	`»®time
(
ex±ime
);

3928 
Ãw_Şde¡
 = 
cu¼’t_time
;

3931 ià(
£‰šgs
.
u£_ÿs
) {

3932 
£‰šgs
.
Şde¡_live
 = 
Ãw_Şde¡
 - 1;

3933 ià(
£‰šgs
.
Şde¡_live
 <ğ
cu¼’t_time
)

3934 
£‰šgs
.
Şde¡_ÿs
 = 
	`g‘_ÿs_id
();

3936 
£‰šgs
.
Şde¡_live
 = 
Ãw_Şde¡
;

3938 
	`out_¡ršg
(
c
, "OK");

3941 } ià(
Áok’s
 =ğ2 && (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "version") == 0)) {

3943 
	`out_¡ršg
(
c
, "VERSION " 
VERSION
);

3945 } ià(
Áok’s
 =ğ2 && (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "quit") == 0)) {

3947 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

3949 } ià(
Áok’s
 =ğ2 && (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "shutdown") == 0)) {

3951 ià(
£‰šgs
.
shutdown_commªd
) {

3952 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

3953 
	`¿i£
(
SIGINT
);

3955 
	`out_¡ršg
(
c
, "ERROR: shutdown‚otƒnabled");

3958 } ià(
Áok’s
 > 1 && 
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "slabs") == 0) {

3959 ià(
Áok’s
 =ğ5 && 
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
 + 1].
v®ue
, "reassign") == 0) {

3960 
¤c
, 
d¡
, 
rv
;

3962 ià(
£‰šgs
.
¦ab_»assign
 =ğ
çl£
) {

3963 
	`out_¡ršg
(
c
, "CLIENT_ERROR slab„eassignment disabled");

3967 
¤c
 = 
	`¡¹Ş
(
tok’s
[2].
v®ue
, 
NULL
, 10);

3968 
d¡
 = 
	`¡¹Ş
(
tok’s
[3].
v®ue
, 
NULL
, 10);

3970 ià(
”ºo
 =ğ
ERANGE
) {

3971 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

3975 
rv
 = 
	`¦abs_»assign
(
¤c
, 
d¡
);

3976 
rv
) {

3977 
REASSIGN_OK
:

3978 
	`out_¡ršg
(
c
, "OK");

3980 
REASSIGN_RUNNING
:

3981 
	`out_¡ršg
(
c
, "BUSY currently…rocessing„eassign„equest");

3983 
REASSIGN_BADCLASS
:

3984 
	`out_¡ršg
(
c
, "BADCLASS invalid src or dst class id");

3986 
REASSIGN_NOSPARE
:

3987 
	`out_¡ršg
(
c
, "NOSPARE source class has‚o spare…ages");

3989 
REASSIGN_SRC_DST_SAME
:

3990 
	`out_¡ršg
(
c
, "SAME src‡nd dst class‡re identical");

3994 } ià(
Áok’s
 == 4 &&

3995 (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
 + 1].
v®ue
, "automove") == 0)) {

3996 
	`´oûss_¦abs_automove_commªd
(
c
, 
tok’s
, 
Áok’s
);

3998 
	`out_¡ršg
(
c
, "ERROR");

4000 } ià(
Áok’s
 > 1 && 
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "lru_crawler") == 0) {

4001 ià(
Áok’s
 =ğ4 && 
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
 + 1].
v®ue
, "crawl") == 0) {

4002 
rv
;

4003 ià(
£‰šgs
.
Ìu_üawËr
 =ğ
çl£
) {

4004 
	`out_¡ršg
(
c
, "CLIENT_ERROR†ru crawler disabled");

4008 
rv
 = 
	`Ìu_üawËr_üawl
(
tok’s
[2].
v®ue
, 
CRAWLER_EXPIRED
, 
NULL
, 0);

4009 
rv
) {

4010 
CRAWLER_OK
:

4011 
	`out_¡ršg
(
c
, "OK");

4013 
CRAWLER_RUNNING
:

4014 
	`out_¡ršg
(
c
, "BUSY currently…rocessing crawler„equest");

4016 
CRAWLER_BADCLASS
:

4017 
	`out_¡ršg
(
c
, "BADCLASS invalid class id");

4019 
CRAWLER_NOTSTARTED
:

4020 
	`out_¡ršg
(
c
, "NOTSTARTED‚o itemso crawl");

4022 
CRAWLER_ERROR
:

4023 
	`out_¡ršg
(
c
, "ERROR‡n unknownƒrror happened");

4027 } ià(
Áok’s
 =ğ4 && 
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
 + 1].
v®ue
, "metadump") == 0) {

4028 ià(
£‰šgs
.
Ìu_üawËr
 =ğ
çl£
) {

4029 
	`out_¡ršg
(
c
, "CLIENT_ERROR†ru crawler disabled");

4032 ià(!
£‰šgs
.
dump_’abËd
) {

4033 
	`out_¡ršg
(
c
, "ERROR metadump‚ot‡llowed");

4037 
rv
 = 
	`Ìu_üawËr_üawl
(
tok’s
[2].
v®ue
, 
CRAWLER_METADUMP
,

4038 
c
, c->
sfd
);

4039 
rv
) {

4040 
CRAWLER_OK
:

4041 
	`out_¡ršg
(
c
, "OK");

4043 
	`cÚn_£t_¡©e
(
c
, 
cÚn_w©ch
);

4044 
	`ev’t_d–
(&
c
->
ev’t
);

4046 
CRAWLER_RUNNING
:

4047 
	`out_¡ršg
(
c
, "BUSY currently…rocessing crawler„equest");

4049 
CRAWLER_BADCLASS
:

4050 
	`out_¡ršg
(
c
, "BADCLASS invalid class id");

4052 
CRAWLER_NOTSTARTED
:

4053 
	`out_¡ršg
(
c
, "NOTSTARTED‚o itemso crawl");

4055 
CRAWLER_ERROR
:

4056 
	`out_¡ršg
(
c
, "ERROR‡n unknownƒrror happened");

4060 } ià(
Áok’s
 =ğ4 && 
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
 + 1].
v®ue
, "tocrawl") == 0) {

4061 
ušt32_t
 
toüawl
;

4062 ià(!
	`§ã_¡¹oul
(
tok’s
[2].
v®ue
, &
toüawl
)) {

4063 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

4066 
£‰šgs
.
Ìu_üawËr_toüawl
 = 
toüawl
;

4067 
	`out_¡ršg
(
c
, "OK");

4069 } ià(
Áok’s
 =ğ4 && 
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
 + 1].
v®ue
, "sleep") == 0) {

4070 
ušt32_t
 
to¦“p
;

4071 ià(!
	`§ã_¡¹oul
(
tok’s
[2].
v®ue
, &
to¦“p
)) {

4072 
	`out_¡ršg
(
c
, "CLIENT_ERROR bad command†ine format");

4075 ià(
to¦“p
 > 1000000) {

4076 
	`out_¡ršg
(
c
, "CLIENT_ERROR sleep must be one second or†ess");

4079 
£‰šgs
.
Ìu_üawËr_¦“p
 = 
to¦“p
;

4080 
	`out_¡ršg
(
c
, "OK");

4082 } ià(
Áok’s
 == 3) {

4083 ià((
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
 + 1].
v®ue
, "enable") == 0)) {

4084 ià(
	`¡¬t_™em_üawËr_th»ad
() == 0) {

4085 
	`out_¡ršg
(
c
, "OK");

4087 
	`out_¡ršg
(
c
, "ERROR failedo start†ru crawlerhread");

4089 } ià((
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
 + 1].
v®ue
, "disable") == 0)) {

4090 ià(
	`¡İ_™em_üawËr_th»ad
() == 0) {

4091 
	`out_¡ršg
(
c
, "OK");

4093 
	`out_¡ršg
(
c
, "ERROR failedo stop†ru crawlerhread");

4096 
	`out_¡ršg
(
c
, "ERROR");

4100 
	`out_¡ršg
(
c
, "ERROR");

4102 } ià(
Áok’s
 > 1 && 
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "watch") == 0) {

4103 
	`´oûss_w©ch_commªd
(
c
, 
tok’s
, 
Áok’s
);

4104 } ià((
Áok’s
 =ğ3 ||‚tok’ =ğ4è&& (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "cache_memlimit") == 0)) {

4105 
	`´oûss_memlim™_commªd
(
c
, 
tok’s
, 
Áok’s
);

4106 } ià((
Áok’s
 =ğ3 ||‚tok’ =ğ4è&& (
	`¡rcmp
(
tok’s
[
COMMAND_TOKEN
].
v®ue
, "verbosity") == 0)) {

4107 
	`´oûss_v”bos™y_commªd
(
c
, 
tok’s
, 
Áok’s
);

4109 
	`out_¡ršg
(
c
, "ERROR");

4112 
	}
}

4117 
	$Œy_»ad_commªd
(
cÚn
 *
c
) {

4118 
	`as£¹
(
c
 !ğ
NULL
);

4119 
	`as£¹
(
c
->
rcu¼
 <ğ(c->
rbuf
 + c->
rsize
));

4120 
	`as£¹
(
c
->
rby‹s
 > 0);

4122 ià(
c
->
´ÙocŞ
 =ğ
ÃgÙŸtšg_´Ù
 || c->
Œª¥Üt
 =ğ
udp_Œª¥Üt
) {

4123 ià(()
c
->
rbuf
[0] =ğ()
PROTOCOL_BINARY_REQ
) {

4124 
c
->
´ÙocŞ
 = 
bš¬y_´Ù
;

4126 
c
->
´ÙocŞ
 = 
ascii_´Ù
;

4129 ià(
£‰šgs
.
v”bo£
 > 1) {

4130 
	`årštf
(
¡d”r
, "%d: Cl›Á usšgh% ´ÙocŞ\n", 
c
->
sfd
,

4131 
	`´Ù_‹xt
(
c
->
´ÙocŞ
));

4135 ià(
c
->
´ÙocŞ
 =ğ
bš¬y_´Ù
) {

4137 ià(
c
->
rby‹s
 < (c->
bš¬y_h—d”
)) {

4141 #ifdeà
NEED_ALIGN


4142 ià((()(
c
->
rcu¼
)) % 8 != 0) {

4144 
	`memmove
(
c
->
rbuf
, c->
rcu¼
, c->
rby‹s
);

4145 
c
->
rcu¼
 = c->
rbuf
;

4146 ià(
£‰šgs
.
v”bo£
 > 1) {

4147 
	`årštf
(
¡d”r
, "%d: R—ligÀšpuˆbufãr\n", 
c
->
sfd
);

4151 
´ÙocŞ_bš¬y_»que¡_h—d”
* 
»q
;

4152 
»q
 = (
´ÙocŞ_bš¬y_»que¡_h—d”
*)
c
->
rcu¼
;

4154 ià(
£‰šgs
.
v”bo£
 > 1) {

4156 
ii
;

4157 
	`årštf
(
¡d”r
, "<%d R—d bš¬y…rÙocŞ d©a:", 
c
->
sfd
);

4158 
ii
 = 0; i˜< (
»q
->
by‹s
); ++ii) {

4159 ià(
ii
 % 4 == 0) {

4160 
	`årštf
(
¡d”r
, "\n<%d ", 
c
->
sfd
);

4162 
	`årštf
(
¡d”r
, " 0x%02x", 
»q
->
by‹s
[
ii
]);

4164 
	`årštf
(
¡d”r
, "\n");

4167 
c
->
bš¬y_h—d”
 = *
»q
;

4168 
c
->
bš¬y_h—d”
.
»que¡
.
keyËn
 = 
	`Áohs
(
»q
->request.keylen);

4169 
c
->
bš¬y_h—d”
.
»que¡
.
bodyËn
 = 
	`Áohl
(
»q
->request.bodylen);

4170 
c
->
bš¬y_h—d”
.
»que¡
.
ÿs
 = 
	`ÁohÎ
(
»q
->request.cas);

4172 ià(
c
->
bš¬y_h—d”
.
»que¡
.
magic
 !ğ
PROTOCOL_BINARY_REQ
) {

4173 ià(
£‰šgs
.
v”bo£
) {

4174 
	`årštf
(
¡d”r
, "Invalid magic: %x\n",

4175 
c
->
bš¬y_h—d”
.
»que¡
.
magic
);

4177 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4181 
c
->
msgcu¼
 = 0;

4182 
c
->
msgu£d
 = 0;

4183 
c
->
iovu£d
 = 0;

4184 ià(
	`add_msghdr
(
c
) != 0) {

4185 
	`out_of_memÜy
(
c
,

4190 
c
->
cmd
 = c->
bš¬y_h—d”
.
»que¡
.
İcode
;

4191 
c
->
keyËn
 = c->
bš¬y_h—d”
.
»que¡
.keylen;

4192 
c
->
İaque
 = c->
bš¬y_h—d”
.
»que¡
.opaque;

4194 
c
->
ÿs
 = 0;

4196 
	`di¥©ch_bš_commªd
(
c
);

4198 
c
->
rby‹s
 -ğ(c->
bš¬y_h—d”
);

4199 
c
->
rcu¼
 +ğ(c->
bš¬y_h—d”
);

4202 *
–
, *
cÚt
;

4204 ià(
c
->
rby‹s
 == 0)

4207 
–
 = 
	`memchr
(
c
->
rcu¼
, '\n', c->
rby‹s
);

4208 ià(!
–
) {

4209 ià(
c
->
rby‹s
 > 1024) {

4214 *
±r
 = 
c
->
rcu¼
;

4215 *
±r
 == ' ') {

4216 ++
±r
;

4219 ià(
±r
 - 
c
->
rcu¼
 > 100 ||

4220 (
	`¡ºcmp
(
±r
, "get ", 4) && strncmp(ptr, "gets ", 5))) {

4222 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4229 
cÚt
 = 
–
 + 1;

4230 ià((
–
 - 
c
->
rcu¼
) > 1 && *(el - 1) == '\r') {

4231 
–
--;

4233 *
–
 = '\0';

4235 
	`as£¹
(
cÚt
 <ğ(
c
->
rcu¼
 + c->
rby‹s
));

4237 
c
->
Ï¡_cmd_time
 = 
cu¼’t_time
;

4238 
	`´oûss_commªd
(
c
, c->
rcu¼
);

4240 
c
->
rby‹s
 -ğ(
cÚt
 - c->
rcu¼
);

4241 
c
->
rcu¼
 = 
cÚt
;

4243 
	`as£¹
(
c
->
rcu¼
 <ğ(c->
rbuf
 + c->
rsize
));

4247 
	}
}

4252 
Œy_»ad_»suÉ
 
	$Œy_»ad_udp
(
cÚn
 *
c
) {

4253 
»s
;

4255 
	`as£¹
(
c
 !ğ
NULL
);

4257 
c
->
»que¡_addr_size
 = (c->
»que¡_addr
);

4258 
»s
 = 
	`»cväom
(
c
->
sfd
, c->
rbuf
, c->
rsize
,

4259 0, (
sockaddr
 *)&
c
->
»que¡_addr
,

4260 &
c
->
»que¡_addr_size
);

4261 ià(
»s
 > 8) {

4262 *
buf
 = (*)
c
->
rbuf
;

4263 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4264 
c
->
th»ad
->
¡©s
.
by‹s_»ad
 +ğ
»s
;

4265 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4268 
c
->
»que¡_id
 = 
buf
[0] * 256 + buf[1];

4271 ià(
buf
[4] != 0 || buf[5] != 1) {

4272 
	`out_¡ršg
(
c
, "SERVER_ERROR multi-packet„equest‚ot supported");

4273  
READ_NO_DATA_RECEIVED
;

4277 
»s
 -= 8;

4278 
	`memmove
(
c
->
rbuf
, c->rbuà+ 8, 
»s
);

4280 
c
->
rby‹s
 = 
»s
;

4281 
c
->
rcu¼
 = c->
rbuf
;

4282  
READ_DATA_RECEIVED
;

4284  
READ_NO_DATA_RECEIVED
;

4285 
	}
}

4299 
Œy_»ad_»suÉ
 
	$Œy_»ad_ÃtwÜk
(
cÚn
 *
c
) {

4300 
Œy_»ad_»suÉ
 
gÙd©a
 = 
READ_NO_DATA_RECEIVED
;

4301 
»s
;

4302 
num_®locs
 = 0;

4303 
	`as£¹
(
c
 !ğ
NULL
);

4305 ià(
c
->
rcu¼
 !ğc->
rbuf
) {

4306 ià(
c
->
rby‹s
 != 0)

4307 
	`memmove
(
c
->
rbuf
, c->
rcu¼
, c->
rby‹s
);

4308 
c
->
rcu¼
 = c->
rbuf
;

4312 ià(
c
->
rby‹s
 >ğc->
rsize
) {

4313 ià(
num_®locs
 == 4) {

4314  
gÙd©a
;

4316 ++
num_®locs
;

4317 *
Ãw_rbuf
 = 
	`»®loc
(
c
->
rbuf
, c->
rsize
 * 2);

4318 ià(!
Ãw_rbuf
) {

4319 
	`STATS_LOCK
();

4320 
¡©s
.
m®loc_çs
++;

4321 
	`STATS_UNLOCK
();

4322 ià(
£‰šgs
.
v”bo£
 > 0) {

4323 
	`årštf
(
¡d”r
, "Couldn't„ealloc input buffer\n");

4325 
c
->
rby‹s
 = 0;

4326 
	`out_of_memÜy
(
c
, "SERVER_ERROR out of memory„eading„equest");

4327 
c
->
wr™e_ªd_go
 = 
cÚn_şosšg
;

4328  
READ_MEMORY_ERROR
;

4330 
c
->
rcu¼
 = c->
rbuf
 = 
Ãw_rbuf
;

4331 
c
->
rsize
 *= 2;

4334 
ava
 = 
c
->
rsize
 - c->
rby‹s
;

4335 
»s
 = 
	`»ad
(
c
->
sfd
, c->
rbuf
 + c->
rby‹s
, 
ava
);

4336 ià(
»s
 > 0) {

4337 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4338 
c
->
th»ad
->
¡©s
.
by‹s_»ad
 +ğ
»s
;

4339 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4340 
gÙd©a
 = 
READ_DATA_RECEIVED
;

4341 
c
->
rby‹s
 +ğ
»s
;

4342 ià(
»s
 =ğ
ava
) {

4348 ià(
»s
 == 0) {

4349  
READ_ERROR
;

4351 ià(
»s
 == -1) {

4352 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

4355  
READ_ERROR
;

4358  
gÙd©a
;

4359 
	}
}

4361 
boŞ
 
	$upd©e_ev’t
(
cÚn
 *
c
, cÚ¡ 
Ãw_æags
) {

4362 
	`as£¹
(
c
 !ğ
NULL
);

4364 
ev’t_ba£
 *
ba£
 = 
c
->
ev’t
.
ev_ba£
;

4365 ià(
c
->
ev_æags
 =ğ
Ãw_æags
)

4366  
Œue
;

4367 ià(
	`ev’t_d–
(&
c
->
ev’t
è=ğ-1è 
çl£
;

4368 
	`ev’t_£t
(&
c
->
ev’t
, c->
sfd
, 
Ãw_æags
, 
ev’t_hªdËr
, (*)c);

4369 
	`ev’t_ba£_£t
(
ba£
, &
c
->
ev’t
);

4370 
c
->
ev_æags
 = 
Ãw_æags
;

4371 ià(
	`ev’t_add
(&
c
->
ev’t
, 0è=ğ-1è 
çl£
;

4372  
Œue
;

4373 
	}
}

4378 
	$do_acû±_Ãw_cÚns
(cÚ¡ 
boŞ
 
do_acû±
) {

4379 
cÚn
 *
Ãxt
;

4381 
Ãxt
 = 
li¡’_cÚn
;‚ext;‚ext =‚ext->next) {

4382 ià(
do_acû±
) {

4383 
	`upd©e_ev’t
(
Ãxt
, 
EV_READ
 | 
EV_PERSIST
);

4384 ià(
	`li¡’
(
Ãxt
->
sfd
, 
£‰šgs
.
backlog
) != 0) {

4385 
	`³¼Ü
("listen");

4389 
	`upd©e_ev’t
(
Ãxt
, 0);

4390 ià(
	`li¡’
(
Ãxt
->
sfd
, 0) != 0) {

4391 
	`³¼Ü
("listen");

4396 ià(
do_acû±
) {

4397 
timev®
 
maxcÚns_ex™ed
;

4398 
ušt64_t
 
–­£d_us
;

4399 
	`g‘timeofday
(&
maxcÚns_ex™ed
,
NULL
);

4400 
	`STATS_LOCK
();

4401 
–­£d_us
 =

4402 (
maxcÚns_ex™ed
.
tv_£c
 - 
¡©s
.
maxcÚns_’‹»d
.tv_sec) * 1000000

4403 + (
maxcÚns_ex™ed
.
tv_u£c
 - 
¡©s
.
maxcÚns_’‹»d
.tv_usec);

4404 
¡©s
.
time_š_li¡’_di§bËd_us
 +ğ
–­£d_us
;

4405 
¡©s_¡©e
.
acû±šg_cÚns
 = 
Œue
;

4406 
	`STATS_UNLOCK
();

4408 
	`STATS_LOCK
();

4409 
¡©s_¡©e
.
acû±šg_cÚns
 = 
çl£
;

4410 
	`g‘timeofday
(&
¡©s
.
maxcÚns_’‹»d
,
NULL
);

4411 
¡©s
.
li¡’_di§bËd_num
++;

4412 
	`STATS_UNLOCK
();

4413 
®low_Ãw_cÚns
 = 
çl£
;

4414 
	`maxcÚns_hªdËr
(-42, 0, 0);

4416 
	}
}

4427 
Œªsm™_»suÉ
 
	$Œªsm™
(
cÚn
 *
c
) {

4428 
	`as£¹
(
c
 !ğ
NULL
);

4430 ià(
c
->
msgcu¼
 < c->
msgu£d
 &&

4431 
c
->
msgli¡
[c->
msgcu¼
].
msg_iovËn
 == 0) {

4433 
c
->
msgcu¼
++;

4435 ià(
c
->
msgcu¼
 < c->
msgu£d
) {

4436 
ssize_t
 
»s
;

4437 
msghdr
 *
m
 = &
c
->
msgli¡
[c->
msgcu¼
];

4439 
»s
 = 
	`£ndmsg
(
c
->
sfd
, 
m
, 0);

4440 ià(
»s
 > 0) {

4441 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4442 
c
->
th»ad
->
¡©s
.
by‹s_wr™‹n
 +ğ
»s
;

4443 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4447 
m
->
msg_iovËn
 > 0 && 
»s
 >ğm->
msg_iov
->
iov_Ën
) {

4448 
»s
 -ğ
m
->
msg_iov
->
iov_Ën
;

4449 
m
->
msg_iovËn
--;

4450 
m
->
msg_iov
++;

4455 ià(
»s
 > 0) {

4456 
m
->
msg_iov
->
iov_ba£
 = (
ÿddr_t
)m->msg_iov->iov_ba£ + 
»s
;

4457 
m
->
msg_iov
->
iov_Ën
 -ğ
»s
;

4459  
TRANSMIT_INCOMPLETE
;

4461 ià(
»s
 =ğ-1 && (
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
)) {

4462 ià(!
	`upd©e_ev’t
(
c
, 
EV_WRITE
 | 
EV_PERSIST
)) {

4463 ià(
£‰šgs
.
v”bo£
 > 0)

4464 
	`årštf
(
¡d”r
, "Couldn't updateƒvent\n");

4465 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4466  
TRANSMIT_HARD_ERROR
;

4468  
TRANSMIT_SOFT_ERROR
;

4472 ià(
£‰šgs
.
v”bo£
 > 0)

4473 
	`³¼Ü
("Failedo write,‡nd‚ot dueo blocking");

4475 ià(
	`IS_UDP
(
c
->
Œª¥Üt
))

4476 
	`cÚn_£t_¡©e
(
c
, 
cÚn_»ad
);

4478 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4479  
TRANSMIT_HARD_ERROR
;

4481  
TRANSMIT_COMPLETE
;

4483 
	}
}

4489 
	$»ad_što_chunked_™em
(
cÚn
 *
c
) {

4490 
tÙ®
 = 0;

4491 
»s
;

4492 
	`as£¹
(
c
->
rcu¼
 !ğc->
r™em
);

4494 
c
->
¾by‹s
 > 0) {

4495 
™em_chunk
 *
ch
 = (™em_chunk *)
c
->
r™em
;

4496 
unu£d
 = 
ch
->
size
 - ch->
u£d
;

4498 ià(
c
->
rby‹s
 > 0) {

4499 
tÙ®
 = 0;

4500 
tocİy
 = 
c
->
rby‹s
 > c->
¾by‹s
 ? c->rlbytes : c->rbytes;

4501 
tocİy
 =ocİy > 
unu£d
 ? unused :ocopy;

4502 ià(
c
->
r™em
 !ğc->
rcu¼
) {

4503 
	`memmove
(
ch
->
d©a
 + ch->
u£d
, 
c
->
rcu¼
, 
tocİy
);

4505 
tÙ®
 +ğ
tocİy
;

4506 
c
->
¾by‹s
 -ğ
tocİy
;

4507 
c
->
rcu¼
 +ğ
tocİy
;

4508 
c
->
rby‹s
 -ğ
tocİy
;

4509 
ch
->
u£d
 +ğ
tocİy
;

4510 ià(
c
->
¾by‹s
 == 0) {

4515 
»s
 = 
	`»ad
(
c
->
sfd
, 
ch
->
d©a
 + ch->
u£d
,

4516 (
unu£d
 > 
c
->
¾by‹s
 ? c->rlbytes : unused));

4517 ià(
»s
 > 0) {

4518 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4519 
c
->
th»ad
->
¡©s
.
by‹s_»ad
 +ğ
»s
;

4520 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4521 
ch
->
u£d
 +ğ
»s
;

4522 
tÙ®
 +ğ
»s
;

4523 
c
->
¾by‹s
 -ğ
»s
;

4526 
tÙ®
 = 
»s
;

4531 
	`as£¹
(
ch
->
u£d
 <ğch->
size
);

4532 ià(
ch
->
size
 =ğch->
u£d
) {

4533 ià(
ch
->
Ãxt
) {

4534 
c
->
r™em
 = (*è
ch
->
Ãxt
;

4537 
	`as£¹
(
c
->
¾by‹s
 == 0);

4542  
tÙ®
;

4543 
	}
}

4545 
	$drive_machše
(
cÚn
 *
c
) {

4546 
boŞ
 
¡İ
 = 
çl£
;

4547 
sfd
;

4548 
sockËn_t
 
add¾’
;

4549 
sockaddr_¡Üage
 
addr
;

4550 
Äeqs
 = 
£‰šgs
.
»qs_³r_ev’t
;

4551 
»s
;

4552 cÚ¡ *
¡r
;

4553 #ifdeà
HAVE_ACCEPT4


4554 
u£_acû±4
 = 1;

4556 
u£_acû±4
 = 0;

4559 
	`as£¹
(
c
 !ğ
NULL
);

4561 !
¡İ
) {

4563 
c
->
¡©e
) {

4564 
cÚn_li¡’šg
:

4565 
add¾’
 = (
addr
);

4566 
sfd
 = 
	`acû±
(
c
->sfd, (
sockaddr
 *)&
addr
, &
add¾’
);

4567 ià(
sfd
 == -1) {

4568 ià(
u£_acû±4
 && 
”ºo
 =ğ
ENOSYS
) {

4569 
u£_acû±4
 = 0;

4572 
	`³¼Ü
(
u£_acû±4
 ? "accept4()" : "accept()");

4573 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

4575 
¡İ
 = 
Œue
;

4576 } ià(
”ºo
 =ğ
EMFILE
) {

4577 ià(
£‰šgs
.
v”bo£
 > 0)

4578 
	`årštf
(
¡d”r
, "Too many open connections\n");

4579 
	`acû±_Ãw_cÚns
(
çl£
);

4580 
¡İ
 = 
Œue
;

4582 
	`³¼Ü
("accept()");

4583 
¡İ
 = 
Œue
;

4587 ià(!
u£_acû±4
) {

4588 ià(
	`fú
(
sfd
, 
F_SETFL
, fú(sfd, 
F_GETFL
è| 
O_NONBLOCK
) < 0) {

4589 
	`³¼Ü
("setting O_NONBLOCK");

4590 
	`şo£
(
sfd
);

4595 ià(
£‰šgs
.
maxcÚns_ç¡
 &&

4596 
¡©s_¡©e
.
cu¼_cÚns
 + sts_¡©e.
»£rved_fds
 >ğ
£‰šgs
.
maxcÚns
 - 1) {

4597 
¡r
 = "ERROR Too many open connections\r\n";

4598 
»s
 = 
	`wr™e
(
sfd
, 
¡r
, 
	`¡¾’
(str));

4599 
	`şo£
(
sfd
);

4600 
	`STATS_LOCK
();

4601 
¡©s
.
»jeùed_cÚns
++;

4602 
	`STATS_UNLOCK
();

4604 
	`di¥©ch_cÚn_Ãw
(
sfd
, 
cÚn_Ãw_cmd
, 
EV_READ
 | 
EV_PERSIST
,

4605 
DATA_BUFFER_SIZE
, 
c
->
Œª¥Üt
);

4608 
¡İ
 = 
Œue
;

4611 
cÚn_wa™šg
:

4612 ià(!
	`upd©e_ev’t
(
c
, 
EV_READ
 | 
EV_PERSIST
)) {

4613 ià(
£‰šgs
.
v”bo£
 > 0)

4614 
	`årštf
(
¡d”r
, "Couldn't updateƒvent\n");

4615 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4619 
	`cÚn_£t_¡©e
(
c
, 
cÚn_»ad
);

4620 
¡İ
 = 
Œue
;

4623 
cÚn_»ad
:

4624 
»s
 = 
	`IS_UDP
(
c
->
Œª¥Üt
è? 
	`Œy_»ad_udp
(cè: 
	`Œy_»ad_ÃtwÜk
(c);

4626 
»s
) {

4627 
READ_NO_DATA_RECEIVED
:

4628 
	`cÚn_£t_¡©e
(
c
, 
cÚn_wa™šg
);

4630 
READ_DATA_RECEIVED
:

4631 
	`cÚn_£t_¡©e
(
c
, 
cÚn_·r£_cmd
);

4633 
READ_ERROR
:

4634 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4636 
READ_MEMORY_ERROR
:

4642 
cÚn_·r£_cmd
 :

4643 ià(
	`Œy_»ad_commªd
(
c
) == 0) {

4645 
	`cÚn_£t_¡©e
(
c
, 
cÚn_wa™šg
);

4650 
cÚn_Ãw_cmd
:

4654 --
Äeqs
;

4655 ià(
Äeqs
 >= 0) {

4656 
	`»£t_cmd_hªdËr
(
c
);

4658 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4659 
c
->
th»ad
->
¡©s
.
cÚn_y›lds
++;

4660 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4661 ià(
c
->
rby‹s
 > 0) {

4668 ià(!
	`upd©e_ev’t
(
c
, 
EV_WRITE
 | 
EV_PERSIST
)) {

4669 ià(
£‰šgs
.
v”bo£
 > 0)

4670 
	`årštf
(
¡d”r
, "Couldn't updateƒvent\n");

4671 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4675 
¡İ
 = 
Œue
;

4679 
cÚn_Ä—d
:

4680 ià(
c
->
¾by‹s
 == 0) {

4681 
	`com¶‘e_Ä—d
(
c
);

4686 ià(
c
->
¾by‹s
 < 0) {

4687 ià(
£‰šgs
.
v”bo£
) {

4688 
	`årštf
(
¡d”r
, "Inv®id„lby‹ tØ»ad:†’ %d\n", 
c
->
¾by‹s
);

4690 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4694 ià(!
c
->
™em
 || (((™em *)c->™em)->
™_æags
 & 
ITEM_CHUNKED
) == 0) {

4696 ià(
c
->
rby‹s
 > 0) {

4697 
tocİy
 = 
c
->
rby‹s
 > c->
¾by‹s
 ? c->rlbytes : c->rbytes;

4698 ià(
c
->
r™em
 !ğc->
rcu¼
) {

4699 
	`memmove
(
c
->
r™em
, c->
rcu¼
, 
tocİy
);

4701 
c
->
r™em
 +ğ
tocİy
;

4702 
c
->
¾by‹s
 -ğ
tocİy
;

4703 
c
->
rcu¼
 +ğ
tocİy
;

4704 
c
->
rby‹s
 -ğ
tocİy
;

4705 ià(
c
->
¾by‹s
 == 0) {

4711 
»s
 = 
	`»ad
(
c
->
sfd
, c->
r™em
, c->
¾by‹s
);

4712 ià(
»s
 > 0) {

4713 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4714 
c
->
th»ad
->
¡©s
.
by‹s_»ad
 +ğ
»s
;

4715 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4716 ià(
c
->
rcu¼
 =ğc->
r™em
) {

4717 
c
->
rcu¼
 +ğ
»s
;

4719 
c
->
r™em
 +ğ
»s
;

4720 
c
->
¾by‹s
 -ğ
»s
;

4724 
»s
 = 
	`»ad_što_chunked_™em
(
c
);

4725 ià(
»s
 > 0)

4729 ià(
»s
 == 0) {

4730 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4734 ià(
»s
 =ğ-1 && (
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
)) {

4735 ià(!
	`upd©e_ev’t
(
c
, 
EV_READ
 | 
EV_PERSIST
)) {

4736 ià(
£‰šgs
.
v”bo£
 > 0)

4737 
	`årštf
(
¡d”r
, "Couldn't updateƒvent\n");

4738 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4741 
¡İ
 = 
Œue
;

4745 ià(
£‰šgs
.
v”bo£
 > 0) {

4746 
	`årštf
(
¡d”r
, "Failedo„ead,‡nd‚ot dueo blocking:\n"

4749 
”ºo
, 
	`¡»¼Ü
(errno),

4750 ()
c
->
rcu¼
, ()c->
r™em
, ()c->
rbuf
,

4751 ()
c
->
¾by‹s
, ()c->
rsize
);

4753 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4756 
cÚn_sw®low
:

4758 ià(
c
->
sby‹s
 == 0) {

4759 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ãw_cmd
);

4764 ià(
c
->
rby‹s
 > 0) {

4765 
tocİy
 = 
c
->
rby‹s
 > c->
sby‹s
 ? c->sbytes : c->rbytes;

4766 
c
->
sby‹s
 -ğ
tocİy
;

4767 
c
->
rcu¼
 +ğ
tocİy
;

4768 
c
->
rby‹s
 -ğ
tocİy
;

4773 
»s
 = 
	`»ad
(
c
->
sfd
, c->
rbuf
, c->
rsize
 > c->
sby‹s
 ? c->sbytes : c->rsize);

4774 ià(
»s
 > 0) {

4775 
	`±h»ad_mu‹x_lock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4776 
c
->
th»ad
->
¡©s
.
by‹s_»ad
 +ğ
»s
;

4777 
	`±h»ad_mu‹x_uÆock
(&
c
->
th»ad
->
¡©s
.
mu‹x
);

4778 
c
->
sby‹s
 -ğ
»s
;

4781 ià(
»s
 == 0) {

4782 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4785 ià(
»s
 =ğ-1 && (
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
)) {

4786 ià(!
	`upd©e_ev’t
(
c
, 
EV_READ
 | 
EV_PERSIST
)) {

4787 ià(
£‰šgs
.
v”bo£
 > 0)

4788 
	`årštf
(
¡d”r
, "Couldn't updateƒvent\n");

4789 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4792 
¡İ
 = 
Œue
;

4796 ià(
£‰šgs
.
v”bo£
 > 0)

4797 
	`årštf
(
¡d”r
, "Failedo„ead,‡nd‚ot dueo blocking\n");

4798 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4801 
cÚn_wr™e
:

4807 ià(
c
->
iovu£d
 =ğ0 || (
	`IS_UDP
(c->
Œª¥Üt
) && c->iovused == 1)) {

4808 ià(
	`add_iov
(
c
, c->
wcu¼
, c->
wby‹s
) != 0) {

4809 ià(
£‰šgs
.
v”bo£
 > 0)

4810 
	`årštf
(
¡d”r
, "Couldn't build„esponse\n");

4811 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4818 
cÚn_mwr™e
:

4819 ià(
	`IS_UDP
(
c
->
Œª¥Üt
è&& c->
msgcu¼
 =ğ0 && 
	`bud_udp_h—d”s
(c) != 0) {

4820 ià(
£‰šgs
.
v”bo£
 > 0)

4821 
	`årštf
(
¡d”r
, "Failedo build UDP headers\n");

4822 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4825 
	`Œªsm™
(
c
)) {

4826 
TRANSMIT_COMPLETE
:

4827 ià(
c
->
¡©e
 =ğ
cÚn_mwr™e
) {

4828 
	`cÚn_»Ëa£_™ems
(
c
);

4830 if(
c
->
´ÙocŞ
 =ğ
bš¬y_´Ù
) {

4831 
	`cÚn_£t_¡©e
(
c
, c->
wr™e_ªd_go
);

4833 
	`cÚn_£t_¡©e
(
c
, 
cÚn_Ãw_cmd
);

4835 } ià(
c
->
¡©e
 =ğ
cÚn_wr™e
) {

4836 ià(
c
->
wr™e_ªd_ä“
) {

4837 
	`ä“
(
c
->
wr™e_ªd_ä“
);

4838 
c
->
wr™e_ªd_ä“
 = 0;

4840 
	`cÚn_£t_¡©e
(
c
, c->
wr™e_ªd_go
);

4842 ià(
£‰šgs
.
v”bo£
 > 0)

4843 
	`årštf
(
¡d”r
, "UÃx³ùed s‹ %d\n", 
c
->
¡©e
);

4844 
	`cÚn_£t_¡©e
(
c
, 
cÚn_şosšg
);

4848 
TRANSMIT_INCOMPLETE
:

4849 
TRANSMIT_HARD_ERROR
:

4852 
TRANSMIT_SOFT_ERROR
:

4853 
¡İ
 = 
Œue
;

4858 
cÚn_şosšg
:

4859 ià(
	`IS_UDP
(
c
->
Œª¥Üt
))

4860 
	`cÚn_ş—nup
(
c
);

4862 
	`cÚn_şo£
(
c
);

4863 
¡İ
 = 
Œue
;

4866 
cÚn_şo£d
:

4868 
	`abÜt
();

4871 
cÚn_w©ch
:

4873 
¡İ
 = 
Œue
;

4875 
cÚn_max_¡©e
:

4876 
	`as£¹
(
çl£
);

4882 
	}
}

4884 
	$ev’t_hªdËr
(cÚ¡ 
fd
, cÚ¡ 
which
, *
¬g
) {

4885 
cÚn
 *
c
;

4887 
c
 = (
cÚn
 *)
¬g
;

4888 
	`as£¹
(
c
 !ğ
NULL
);

4890 
c
->
which
 = which;

4893 ià(
fd
 !ğ
c
->
sfd
) {

4894 ià(
£‰šgs
.
v”bo£
 > 0)

4895 
	`årštf
(
¡d”r
, "Catastrophic:ƒvent fd doesn't match conn fd!\n");

4896 
	`cÚn_şo£
(
c
);

4900 
	`drive_machše
(
c
);

4904 
	}
}

4906 
	$Ãw_sock‘
(
addršfo
 *
ai
) {

4907 
sfd
;

4908 
æags
;

4910 ià((
sfd
 = 
	`sock‘
(
ai
->
ai_çmy
,‡i->
ai_sockty³
,‡i->
ai_´ÙocŞ
)) == -1) {

4914 ià((
æags
 = 
	`fú
(
sfd
, 
F_GETFL
, 0)) < 0 ||

4915 
	`fú
(
sfd
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
) < 0) {

4916 
	`³¼Ü
("setting O_NONBLOCK");

4917 
	`şo£
(
sfd
);

4920  
sfd
;

4921 
	}
}

4927 
	$maximize_¢dbuf
(cÚ¡ 
sfd
) {

4928 
sockËn_t
 
štsize
 = ();

4929 
Ï¡_good
 = 0;

4930 
mš
, 
max
, 
avg
;

4931 
Şd_size
;

4934 ià(
	`g‘sockİt
(
sfd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
Şd_size
, &
štsize
) != 0) {

4935 ià(
£‰šgs
.
v”bo£
 > 0)

4936 
	`³¼Ü
("getsockopt(SO_SNDBUF)");

4941 
mš
 = 
Şd_size
;

4942 
max
 = 
MAX_SENDBUF_SIZE
;

4944 
mš
 <ğ
max
) {

4945 
avg
 = (()(
mš
 + 
max
)) / 2;

4946 ià(
	`£tsockİt
(
sfd
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*)&
avg
, 
štsize
) == 0) {

4947 
Ï¡_good
 = 
avg
;

4948 
mš
 = 
avg
 + 1;

4950 
max
 = 
avg
 - 1;

4954 ià(
£‰šgs
.
v”bo£
 > 1)

4955 
	`årštf
(
¡d”r
, "<%d s’d bufã¸wa %d,‚ow %d\n", 
sfd
, 
Şd_size
, 
Ï¡_good
);

4956 
	}
}

4967 
	$£rv”_sock‘
(cÚ¡ *
š‹rçû
,

4968 
pÜt
,

4969 
ÃtwÜk_Œª¥Üt
 
Œª¥Üt
,

4970 
FILE
 *
pÜŠumb”_fe
) {

4971 
sfd
;

4972 
lšg”
 
lšg
 = {0, 0};

4973 
addršfo
 *
ai
;

4974 
addršfo
 *
Ãxt
;

4975 
addršfo
 
hšts
 = { .
ai_æags
 = 
AI_PASSIVE
,

4976 .
ai_çmy
 = 
AF_UNSPEC
 };

4977 
pÜt_buf
[
NI_MAXSERV
];

4978 
”rÜ
;

4979 
sucûss
 = 0;

4980 
æags
 =1;

4982 
hšts
.
ai_sockty³
 = 
	`IS_UDP
(
Œª¥Üt
è? 
SOCK_DGRAM
 : 
SOCK_STREAM
;

4984 ià(
pÜt
 == -1) {

4985 
pÜt
 = 0;

4987 
	`¢´štf
(
pÜt_buf
, ÕÜt_buf), "%d", 
pÜt
);

4988 
”rÜ
ğ
	`g‘addršfo
(
š‹rçû
, 
pÜt_buf
, &
hšts
, &
ai
);

4989 ià(
”rÜ
 != 0) {

4990 ià(
”rÜ
 !ğ
EAI_SYSTEM
)

4991 
	`årštf
(
¡d”r
, "g‘addršfo(): %s\n", 
	`gai_¡»¼Ü
(
”rÜ
));

4993 
	`³¼Ü
("getaddrinfo()");

4997 
Ãxt
ğ
ai
;‚ext;‚extğÃxt->
ai_Ãxt
) {

4998 
cÚn
 *
li¡’_cÚn_add
;

4999 ià((
sfd
 = 
	`Ãw_sock‘
(
Ãxt
)) == -1) {

5003 ià(
”ºo
 =ğ
EMFILE
) {

5005 
	`³¼Ü
("server_socket");

5006 
	`ex™
(
EX_OSERR
);

5011 
	`£tsockİt
(
sfd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
æags
, (flags));

5012 ià(
	`IS_UDP
(
Œª¥Üt
)) {

5013 
	`maximize_¢dbuf
(
sfd
);

5015 
”rÜ
 = 
	`£tsockİt
(
sfd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, (*)&
æags
, (flags));

5016 ià(
”rÜ
 != 0)

5017 
	`³¼Ü
("setsockopt");

5019 
”rÜ
 = 
	`£tsockİt
(
sfd
, 
SOL_SOCKET
, 
SO_LINGER
, (*)&
lšg
, (ling));

5020 ià(
”rÜ
 != 0)

5021 
	`³¼Ü
("setsockopt");

5023 
”rÜ
 = 
	`£tsockİt
(
sfd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
æags
, (flags));

5024 ià(
”rÜ
 != 0)

5025 
	`³¼Ü
("setsockopt");

5028 ià(
	`bšd
(
sfd
, 
Ãxt
->
ai_addr
,‚ext->
ai_add¾’
) == -1) {

5029 ià(
”ºo
 !ğ
EADDRINUSE
) {

5030 
	`³¼Ü
("bind()");

5031 
	`şo£
(
sfd
);

5032 
	`ä“addršfo
(
ai
);

5035 
	`şo£
(
sfd
);

5038 
sucûss
++;

5039 ià(!
	`IS_UDP
(
Œª¥Üt
è&& 
	`li¡’
(
sfd
, 
£‰šgs
.
backlog
) == -1) {

5040 
	`³¼Ü
("listen()");

5041 
	`şo£
(
sfd
);

5042 
	`ä“addršfo
(
ai
);

5045 ià(
pÜŠumb”_fe
 !ğ
NULL
 &&

5046 (
Ãxt
->
ai_addr
->
§_çmy
 =ğ
AF_INET
 ||

5047 
Ãxt
->
ai_addr
->
§_çmy
 =ğ
AF_INET6
)) {

5049 
sockaddr_š
 
š
;

5050 
sockaddr_š6
 
š6
;

5051 } 
my_sockaddr
;

5052 
sockËn_t
 
Ën
 = (
my_sockaddr
);

5053 ià(
	`g‘sockÇme
(
sfd
, (
sockaddr
*)&
my_sockaddr
, &
Ën
)==0) {

5054 ià(
Ãxt
->
ai_addr
->
§_çmy
 =ğ
AF_INET
) {

5055 
	`årštf
(
pÜŠumb”_fe
, "%s INET: %u\n",

5056 
	`IS_UDP
(
Œª¥Üt
) ? "UDP" : "TCP",

5057 
	`Áohs
(
my_sockaddr
.
š
.
sš_pÜt
));

5059 
	`årštf
(
pÜŠumb”_fe
, "%s INET6: %u\n",

5060 
	`IS_UDP
(
Œª¥Üt
) ? "UDP" : "TCP",

5061 
	`Áohs
(
my_sockaddr
.
š6
.
sš6_pÜt
));

5067 ià(
	`IS_UDP
(
Œª¥Üt
)) {

5068 
c
;

5070 
c
 = 0; c < 
£‰šgs
.
num_th»ads_³r_udp
; c++) {

5079 
³r_th»ad_fd
 = 
c
 ? 
	`dup
(
sfd
) : sfd;

5080 
	`di¥©ch_cÚn_Ãw
(
³r_th»ad_fd
, 
cÚn_»ad
,

5081 
EV_READ
 | 
EV_PERSIST
,

5082 
UDP_READ_BUFFER_SIZE
, 
Œª¥Üt
);

5085 ià(!(
li¡’_cÚn_add
 = 
	`cÚn_Ãw
(
sfd
, 
cÚn_li¡’šg
,

5086 
EV_READ
 | 
EV_PERSIST
, 1,

5087 
Œª¥Üt
, 
maš_ba£
))) {

5088 
	`årštf
(
¡d”r
, "failedo create†istening connection\n");

5089 
	`ex™
(
EXIT_FAILURE
);

5091 
li¡’_cÚn_add
->
Ãxt
 = 
li¡’_cÚn
;

5092 
li¡’_cÚn
 = 
li¡’_cÚn_add
;

5096 
	`ä“addršfo
(
ai
);

5099  
sucûss
 == 0;

5100 
	}
}

5102 
	$£rv”_sock‘s
(
pÜt
, 
ÃtwÜk_Œª¥Üt
 
Œª¥Üt
,

5103 
FILE
 *
pÜŠumb”_fe
) {

5104 ià(
£‰šgs
.
š‹r
 =ğ
NULL
) {

5105  
	`£rv”_sock‘
(
£‰šgs
.
š‹r
, 
pÜt
, 
Œª¥Üt
, 
pÜŠumb”_fe
);

5108 *
b
;

5109 
»t
 = 0;

5110 *
li¡
 = 
	`¡rdup
(
£‰šgs
.
š‹r
);

5112 ià(
li¡
 =ğ
NULL
) {

5113 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for…arsing server interface string\n");

5116 *
p
 = 
	`¡¹ok_r
(
li¡
, ";,", &
b
);

5117 
p
 !ğ
NULL
;

5118 
p
 = 
	`¡¹ok_r
(
NULL
, ";,", &
b
)) {

5119 
the_pÜt
 = 
pÜt
;

5121 *
h
 = 
NULL
;

5122 ià(*
p
 == '[') {

5125 *
e
 = 
	`¡rchr
(
p
, ']');

5126 ià(
e
 =ğ
NULL
) {

5127 
	`årštf
(
¡d”r
, "Inv®id IPV6‡dd»ss: \"%s\"", 
p
);

5130 
h
 = ++
p
;

5131 *
e
 = '\0';

5132 
p
 = ++
e
;

5135 *
s
 = 
	`¡rchr
(
p
, ':');

5136 ià(
s
 !ğ
NULL
) {

5141 ià(
	`¡rchr
(
s
 + 1, ':'è=ğ
NULL
 || 
h
 != NULL) {

5142 *
s
 = '\0';

5143 ++
s
;

5144 ià(!
	`§ã_¡¹Ş
(
s
, &
the_pÜt
)) {

5145 
	`årštf
(
¡d”r
, "Inv®id…Üˆnumb”: \"%s\"", 
s
);

5151 ià(
h
 !ğ
NULL
)

5152 
p
 = 
h
;

5154 ià(
	`¡rcmp
(
p
, "*") == 0) {

5155 
p
 = 
NULL
;

5157 
»t
 |ğ
	`£rv”_sock‘
(
p
, 
the_pÜt
, 
Œª¥Üt
, 
pÜŠumb”_fe
);

5159 
	`ä“
(
li¡
);

5160  
»t
;

5162 
	}
}

5164 
	$Ãw_sock‘_unix
() {

5165 
sfd
;

5166 
æags
;

5168 ià((
sfd
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0)) == -1) {

5169 
	`³¼Ü
("socket()");

5173 ià((
æags
 = 
	`fú
(
sfd
, 
F_GETFL
, 0)) < 0 ||

5174 
	`fú
(
sfd
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
) < 0) {

5175 
	`³¼Ü
("setting O_NONBLOCK");

5176 
	`şo£
(
sfd
);

5179  
sfd
;

5180 
	}
}

5182 
	$£rv”_sock‘_unix
(cÚ¡ *
·th
, 
acûss_mask
) {

5183 
sfd
;

5184 
lšg”
 
lšg
 = {0, 0};

5185 
sockaddr_un
 
addr
;

5186 
¡©
 
t¡©
;

5187 
æags
 =1;

5188 
Şd_umask
;

5190 ià(!
·th
) {

5194 ià((
sfd
 = 
	`Ãw_sock‘_unix
()) == -1) {

5201 ià(
	`l¡©
(
·th
, &
t¡©
) == 0) {

5202 ià(
	`S_ISSOCK
(
t¡©
.
¡_mode
))

5203 
	`uÆšk
(
·th
);

5206 
	`£tsockİt
(
sfd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
æags
, (flags));

5207 
	`£tsockİt
(
sfd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, (*)&
æags
, (flags));

5208 
	`£tsockİt
(
sfd
, 
SOL_SOCKET
, 
SO_LINGER
, (*)&
lšg
, (ling));

5214 
	`mem£t
(&
addr
, 0, (addr));

5216 
addr
.
sun_çmy
 = 
AF_UNIX
;

5217 
	`¡ºıy
(
addr
.
sun_·th
, 
·th
, (addr.sun_path) - 1);

5218 
	`as£¹
(
	`¡rcmp
(
addr
.
sun_·th
, 
·th
) == 0);

5219 
Şd_umask
 = 
	`umask
Ğ~(
acûss_mask
&0777));

5220 ià(
	`bšd
(
sfd
, (
sockaddr
 *)&
addr
, (addr)) == -1) {

5221 
	`³¼Ü
("bind()");

5222 
	`şo£
(
sfd
);

5223 
	`umask
(
Şd_umask
);

5226 
	`umask
(
Şd_umask
);

5227 ià(
	`li¡’
(
sfd
, 
£‰šgs
.
backlog
) == -1) {

5228 
	`³¼Ü
("listen()");

5229 
	`şo£
(
sfd
);

5232 ià(!(
li¡’_cÚn
 = 
	`cÚn_Ãw
(
sfd
, 
cÚn_li¡’šg
,

5233 
EV_READ
 | 
EV_PERSIST
, 1,

5234 
loÿl_Œª¥Üt
, 
maš_ba£
))) {

5235 
	`årštf
(
¡d”r
, "failedo create†istening connection\n");

5236 
	`ex™
(
EXIT_FAILURE
);

5240 
	}
}

5250 vŞ©
»l_time_t
 
	gcu¼’t_time
;

5251 
ev’t
 
	gşockev’t
;

5257 
	$şock_hªdËr
(cÚ¡ 
fd
, cÚ¡ 
which
, *
¬g
) {

5258 
timev®
 
t
 = {.
tv_£c
 = 1, .
tv_u£c
 = 0};

5259 
boŞ
 
š™Ÿlized
 = 
çl£
;

5260 #ià
	`defšed
(
HAVE_CLOCK_GETTIME
è&& defšed(
CLOCK_MONOTONIC
)

5261 
boŞ
 
mÚÙÚic
 = 
çl£
;

5262 
time_t
 
mÚÙÚic_¡¬t
;

5265 ià(
š™Ÿlized
) {

5267 
	`evtim”_d–
(&
şockev’t
);

5269 
š™Ÿlized
 = 
Œue
;

5272 #ià
	`defšed
(
HAVE_CLOCK_GETTIME
è&& defšed(
CLOCK_MONOTONIC
)

5273 
time¥ec
 
ts
;

5274 ià(
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ts
) == 0) {

5275 
mÚÙÚic
 = 
Œue
;

5276 
mÚÙÚic_¡¬t
 = 
ts
.
tv_£c
 - 
ITEM_UPDATE_INTERVAL
 - 2;

5281 
	`evtim”_£t
(&
şockev’t
, 
şock_hªdËr
, 0);

5282 
	`ev’t_ba£_£t
(
maš_ba£
, &
şockev’t
);

5283 
	`evtim”_add
(&
şockev’t
, &
t
);

5285 #ià
	`defšed
(
HAVE_CLOCK_GETTIME
è&& defšed(
CLOCK_MONOTONIC
)

5286 ià(
mÚÙÚic
) {

5287 
time¥ec
 
ts
;

5288 ià(
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ts
) == -1)

5290 
cu¼’t_time
 = (
»l_time_t
è(
ts
.
tv_£c
 - 
mÚÙÚic_¡¬t
);

5295 
timev®
 
tv
;

5296 
	`g‘timeofday
(&
tv
, 
NULL
);

5297 
cu¼’t_time
 = (
»l_time_t
è(
tv
.
tv_£c
 - 
´oûss_¡¬‹d
);

5299 
	}
}

5301 
	$u§ge
() {

5302 
	`´štf
(
PACKAGE
 " " 
VERSION
 "\n");

5303 
	`´štf
("-p <num> TCP…ort‚umbero†isten on (default: 11211)\n"

5335 
	`´štf
("-L Tryo use†arge memory…ages (if‡vailable). Increasing\n"

5340 
	`´štf
("-D <char> Use <char>‡she delimiter between key…refixes‡nd IDs.\n"

5345 
	`´štf
("-t <num>‚umber ofhreadso use (default: 4)\n");

5346 
	`´štf
("-R Maximum‚umber of„equests…erƒvent,†imitshe‚umber of\n"

5349 
	`´štf
("-C Disable use of CAS\n");

5350 
	`´štf
("-b <num> Sethe backlog queue†imit (default: 1024)\n");

5351 
	`´štf
("-B Binding…rotocol - one of‡scii, binary, or‡uto (default)\n");

5352 
	`´štf
("-I Overridehe size ofƒach slab…age. Adjusts max item size\n"

5354 #ifdeà
ENABLE_SASL


5355 
	`´štf
("-S Turn on Sasl‡uthentication\n");

5357 
	`´štf
("-F Disable flush_all command\n");

5358 
	`´štf
("-X Disable stats cachedump‡nd†ru_crawler metadump commands\n");

5359 
	`´štf
("-o Comma separated†ist ofƒxtended orƒxperimental options\n"

5394 
	}
}

5396 
	$u§ge_liûn£
() {

5397 
	`´štf
(
PACKAGE
 " " 
VERSION
 "\n\n");

5398 
	`´štf
(

5465 
	}
}

5467 
	$§ve_pid
(cÚ¡ *
pid_fe
) {

5468 
FILE
 *
å
;

5469 ià(
	`acûss
(
pid_fe
, 
F_OK
) == 0) {

5470 ià((
å
 = 
	`fİ’
(
pid_fe
, "r")è!ğ
NULL
) {

5471 
bufãr
[1024];

5472 ià(
	`fg‘s
(
bufãr
, (bufãr), 
å
è!ğ
NULL
) {

5473 
pid
;

5474 ià(
	`§ã_¡¹oul
(
bufãr
, &
pid
è&& 
	`kl
((
pid_t
)pid, 0) == 0) {

5475 
	`årštf
(
¡d”r
, "WARNING: Thpid fcÚšedhfŞlowšg (ruÂšgèpid: %u\n", 
pid
);

5478 
	`fşo£
(
å
);

5487 
tmp_pid_fe
[1024];

5488 
	`¢´štf
(
tmp_pid_fe
, Ñmp_pid_fe), "%s.tmp", 
pid_fe
);

5490 ià((
å
 = 
	`fİ’
(
tmp_pid_fe
, "w")è=ğ
NULL
) {

5491 
	`v³¼Ü
("Could‚Ù o³Àthpid f% fÜ wr™šg", 
tmp_pid_fe
);

5495 
	`årštf
(
å
,"%ld\n", ()
	`g‘pid
());

5496 ià(
	`fşo£
(
å
) == -1) {

5497 
	`v³¼Ü
("Could‚Ù clo£hpid f%s", 
tmp_pid_fe
);

5500 ià(
	`»Çme
(
tmp_pid_fe
, 
pid_fe
) != 0) {

5501 
	`v³¼Ü
("Could‚ot„enamehe…id file from %so %s",

5502 
tmp_pid_fe
, 
pid_fe
);

5504 
	}
}

5506 
	$»move_pidfe
(cÚ¡ *
pid_fe
) {

5507 ià(
pid_fe
 =ğ
NULL
)

5510 ià(
	`uÆšk
(
pid_fe
) != 0) {

5511 
	`v³¼Ü
("Could‚Ù„emovthpid f%s", 
pid_fe
);

5514 
	}
}

5516 
	$sig_hªdËr
(cÚ¡ 
sig
) {

5517 
	`´štf
("SigÇÈhªdËd: %s.\n", 
	`¡rsigÇl
(
sig
));

5518 
	`ex™
(
EXIT_SUCCESS
);

5519 
	}
}

5521 #iâdeà
HAVE_SIGIGNORE


5522 
	$sigignÜe
(
sig
) {

5523 
sigaùiÚ
 
§
 = { .
§_hªdËr
 = 
SIG_IGN
, .
§_æags
 = 0 };

5525 ià(
	`sigem±y£t
(&
§
.
§_mask
è=ğ-1 || 
	`sigaùiÚ
(
sig
, &sa, 0) == -1) {

5529 
	}
}

5537 
	$’abË_Ïrge_·ges
() {

5538 #ià
	`defšed
(
HAVE_GETPAGESIZES
è&& defšed(
HAVE_MEMCNTL
)

5539 
»t
 = -1;

5540 
size_t
 
sizes
[32];

5541 
ava
 = 
	`g‘·gesizes
(
sizes
, 32);

5542 ià(
ava
 != -1) {

5543 
size_t
 
max
 = 
sizes
[0];

5544 
memú_mha
 
¬g
 = {0};

5545 
ii
;

5547 
ii
 = 1; i˜< 
ava
; ++ii) {

5548 ià(
max
 < 
sizes
[
ii
]) {

5549 
max
 = 
sizes
[
ii
];

5553 
¬g
.
mha_æags
 = 0;

5554 
¬g
.
mha_·gesize
 = 
max
;

5555 
¬g
.
mha_cmd
 = 
MHA_MAPSIZE_BSSBRK
;

5557 ià(
	`memú
(0, 0, 
MC_HAT_ADVISE
, (
ÿddr_t
)&
¬g
, 0, 0) == -1) {

5558 
	`årštf
(
¡d”r
, "Failedo set†arge…ages: %s\n",

5559 
	`¡»¼Ü
(
”ºo
));

5560 
	`årštf
(
¡d”r
, "Will use default…age size\n");

5562 
»t
 = 0;

5565 
	`årštf
(
¡d”r
, "Failedo get supported…agesizes: %s\n",

5566 
	`¡»¼Ü
(
”ºo
));

5567 
	`årštf
(
¡d”r
, "Will use default…age size\n");

5570  
»t
;

5574 
	}
}

5580 
boŞ
 
	$§n™ycheck
() {

5582 cÚ¡ *
ev”
 = 
	`ev’t_g‘_v”siÚ
();

5583 ià(
ev”
 !ğ
NULL
) {

5584 ià(
	`¡ºcmp
(
ev”
, "1.", 2) == 0) {

5586 ià(('0' <ğ
ev”
[2] &&ƒv”[2] < '3'è&& !
	`isdig™
(ever[3])) {

5587 
	`årštf
(
¡d”r
, "You‡re using†ibevent %s.\nPlease upgradeo"

5589 
	`ev’t_g‘_v”siÚ
());

5590  
çl£
;

5595  
Œue
;

5596 
	}
}

5598 
boŞ
 
	$_·r£_¦ab_sizes
(*
s
, 
ušt32_t
 *
¦ab_sizes
) {

5599 *
b
 = 
NULL
;

5600 
ušt32_t
 
size
 = 0;

5601 
i
 = 0;

5602 
ušt32_t
 
Ï¡_size
 = 0;

5604 ià(
	`¡¾’
(
s
) < 1)

5605  
çl£
;

5607 *
p
 = 
	`¡¹ok_r
(
s
, "-", &
b
);

5608 
p
 !ğ
NULL
;

5609 
p
 = 
	`¡¹ok_r
(
NULL
, "-", &
b
)) {

5610 ià(!
	`§ã_¡¹oul
(
p
, &
size
è|| siz< 
£‰šgs
.
chunk_size


5611 || 
size
 > 
£‰šgs
.
¦ab_chunk_size_max
) {

5612 
	`årštf
(
¡d”r
, "¦ab siz%u i ouˆoàv®id„ªge\n", 
size
);

5613  
çl£
;

5615 ià(
Ï¡_size
 >ğ
size
) {

5616 
	`årštf
(
¡d”r
, "¦ab siz%u cªnÙ blow”hª o¸equ®Ø¨´eviou şas size\n", 
size
);

5617  
çl£
;

5619 ià(
size
 <ğ
Ï¡_size
 + 
CHUNK_ALIGN_BYTES
) {

5620 
	`årštf
(
¡d”r
, "slab size %u must be‡t†east %d bytes†argerhan…revious class\n",

5621 
size
, 
CHUNK_ALIGN_BYTES
);

5622  
çl£
;

5624 
¦ab_sizes
[
i
++] = 
size
;

5625 
Ï¡_size
 = 
size
;

5626 ià(
i
 >ğ
MAX_NUMBER_OF_SLAB_CLASSES
-1) {

5627 
	`årštf
(
¡d”r
, "too many slab classes specified\n");

5628  
çl£
;

5632 
¦ab_sizes
[
i
] = 0;

5633  
Œue
;

5634 
	}
}

5636 
	$maš
 (
¬gc
, **
¬gv
) {

5638 
	`£‰šgs_š™
();

5641 
	`š™_Ìu_üawËr
();

5642 
	`š™_Ìu_mašš”
();

5644 
	`hash_š™
(
hash_ty³
) != 0

5647 
maš_ba£
 = 
	`ev’t_š™
();

5650 
	`logg”_š™
();

5651 
	`¡©s_š™
();

5652 
	`assoc_š™
(
£‰šgs
.
hashpow”_š™
);

5653 
	`cÚn_š™
();

5654 
	`¦abs_š™
(
£‰šgs
.
maxby‹s
, s‘tšgs.
çùÜ
, 
´—Îoÿ‹
,

5655 
u£_¦ab_sizes
 ? 
¦ab_sizes
 : 
NULL
);

5661 ià(
	`sigignÜe
(
SIGPIPE
) == -1) {

5662 
	`³¼Ü
("failedo ignore SIGPIPE; sigaction");

5663 
	`ex™
(
EX_OSERR
);

5667 
	`memÿched_th»ad_š™
(
£‰šgs
.
num_th»ads
);

5669 ià(
	`¡¬t_assoc_maš‹Çnû_th»ad
() == -1) {

5672 ià(
¡¬t_Ìu_üawËr
 && 
	`¡¬t_™em_üawËr_th»ad
() != 0) {

5675 ià(
¡¬t_Ìu_mašš”
 && 
	`¡¬t_Ìu_mašš”_th»ad
() != 0) {

5678 ià(
£‰šgs
.
¦ab_»assign
 &&

5679 
	`¡¬t_¦ab_maš‹Çnû_th»ad
() == -1) {

5682 ià(
£‰šgs
.
idË_timeout
 && 
	`¡¬t_cÚn_timeout_th»ad
() == -1) {

5686 
	`şock_hªdËr
(0, 0, 0);

5689 ià(
£‰šgs
.
sock‘·th
 !ğ
NULL
) {

5690 
”ºo
 = 0;

5691 ià(
	`£rv”_sock‘_unix
(
£‰šgs
.
sock‘·th
,£‰šgs.
acûss
)) {

5692 
	`v³¼Ü
("çedØli¡’ oÀUNIX sock‘: %s", 
£‰šgs
.
sock‘·th
);

5693 
	`ex™
(
EX_OSERR
);

5698 ià(
£‰šgs
.
sock‘·th
 =ğ
NULL
) {

5699 cÚ¡ *
pÜŠumb”_f’ame
 = 
	`g‘’v
("MEMCACHED_PORT_FILENAME");

5700 *
‹mp_pÜŠumb”_f’ame
 = 
NULL
;

5701 
size_t
 
Ën
;

5702 
FILE
 *
pÜŠumb”_fe
 = 
NULL
;

5704 ià(
pÜŠumb”_f’ame
 !ğ
NULL
) {

5705 
Ën
 = 
	`¡¾’
(
pÜŠumb”_f’ame
)+4+1;

5706 
‹mp_pÜŠumb”_f’ame
 = 
	`m®loc
(
Ën
);

5707 
	`¢´štf
(
‹mp_pÜŠumb”_f’ame
,

5708 
Ën
,

5709 "%s.lck", 
pÜŠumb”_f’ame
);

5711 
pÜŠumb”_fe
 = 
	`fİ’
(
‹mp_pÜŠumb”_f’ame
, "a");

5712 ià(
pÜŠumb”_fe
 =ğ
NULL
) {

5713 
	`årštf
(
¡d”r
, "Failedo open \"%s\": %s\n",

5714 
‹mp_pÜŠumb”_f’ame
, 
	`¡»¼Ü
(
”ºo
));

5718 
”ºo
 = 0;

5719 ià(
£‰šgs
.
pÜt
 && 
	`£rv”_sock‘s
(£‰šgs.pÜt, 
tı_Œª¥Üt
,

5720 
pÜŠumb”_fe
)) {

5721 
	`v³¼Ü
("çedØli¡’ oÀTCP…Üˆ%d", 
£‰šgs
.
pÜt
);

5722 
	`ex™
(
EX_OSERR
);

5733 
”ºo
 = 0;

5734 ià(
£‰šgs
.
udµÜt
 && 
	`£rv”_sock‘s
(£‰šgs.udµÜt, 
udp_Œª¥Üt
,

5735 
pÜŠumb”_fe
)) {

5736 
	`v³¼Ü
("çedØli¡’ oÀUDP…Üˆ%d", 
£‰šgs
.
udµÜt
);

5737 
	`ex™
(
EX_OSERR
);

5740 ià(
pÜŠumb”_fe
) {

5741 
	`fşo£
(
pÜŠumb”_fe
);

5742 
	`»Çme
(
‹mp_pÜŠumb”_f’ame
, 
pÜŠumb”_f’ame
);

5743 
	`ä“
(
‹mp_pÜŠumb”_f’ame
);

5750 
	`u¦“p
(1000);

5751 ià(
¡©s_¡©e
.
cu¼_cÚns
 + sts_¡©e.
»£rved_fds
 >ğ
£‰šgs
.
maxcÚns
 - 1) {

5752 
	`årštf
(
¡d”r
, "Maxconns setting isoo†ow, use -co increase.\n");

5753 
	`ex™
(
EXIT_FAILURE
);

5756 ià(
pid_fe
 !ğ
NULL
) {

5757 
	`§ve_pid
(
pid_fe
);

5761 
	`drİ_´iveges
();

5764 
	`ur›ncode_š™
();

5767 ià(
	`ev’t_ba£_loİ
(
maš_ba£
, 0) != 0) {

5768 
»tv®
 = 
EXIT_FAILURE
;

5771 
	`¡İ_assoc_maš‹Çnû_th»ad
();

5773 
	`»move_pidfe
(
pid_fe
);

5774 
	`ä“
(
£‰šgs
.
š‹r
);

5775 
	`ä“
(
l_sock‘
);

5776 
	`ä“
(
u_sock‘
);

5778  
»tv®
;

5779 
	}
}

	@memcached.h

8 #ifdeà
HAVE_CONFIG_H


9 
	~"cÚfig.h
"

12 
	~<sys/ty³s.h
>

13 
	~<sys/sock‘.h
>

14 
	~<sys/time.h
>

15 
	~<Ãtš‘/š.h
>

16 
	~<ev’t.h
>

17 
	~<Ãtdb.h
>

18 
	~<±h»ad.h
>

19 
	~<uni¡d.h
>

20 
	~<as£¹.h
>

22 
	~"´ÙocŞ_bš¬y.h
"

23 
	~"ÿche.h
"

24 
	~"logg”.h
"

26 
	~"§¦_defs.h
"

29 
	#KEY_MAX_LENGTH
 250

	)

32 
	#INCR_MAX_STORAGE_LEN
 24

	)

34 
	#DATA_BUFFER_SIZE
 2048

	)

35 
	#UDP_READ_BUFFER_SIZE
 65536

	)

36 
	#UDP_MAX_PAYLOAD_SIZE
 1400

	)

37 
	#UDP_HEADER_SIZE
 8

	)

38 
	#MAX_SENDBUF_SIZE
 (256 * 1024 * 1024)

	)

41 
	#SUFFIX_SIZE
 24

	)

44 
	#ITEM_LIST_INITIAL
 200

	)

47 
	#SUFFIX_LIST_INITIAL
 20

	)

50 
	#IOV_LIST_INITIAL
 400

	)

53 
	#MSG_LIST_INITIAL
 10

	)

56 
	#READ_BUFFER_HIGHWAT
 8192

	)

57 
	#ITEM_LIST_HIGHWAT
 400

	)

58 
	#IOV_LIST_HIGHWAT
 600

	)

59 
	#MSG_LIST_HIGHWAT
 100

	)

62 
	#MIN_BIN_PKT_LENGTH
 16

	)

63 
	#BIN_PKT_HDR_WORDS
 (
MIN_BIN_PKT_LENGTH
/(
ušt32_t
))

	)

66 
	#HASHPOWER_DEFAULT
 16

	)

73 
	#ITEM_UPDATE_INTERVAL
 60

	)

76 #ià
HAVE_UNISTD_H


77 
	~<uni¡d.h
>

81 
	#POWER_SMALLEST
 1

	)

82 
	#POWER_LARGEST
 256

	)

83 
	#SLAB_GLOBAL_PAGE_POOL
 0

	)

84 
	#CHUNK_ALIGN_BYTES
 8

	)

86 
	#MAX_NUMBER_OF_SLAB_CLASSES
 (63 + 1)

	)

90 
	#TAIL_REPAIR_TIME_DEFAULT
 0

	)

93 
	#ITEM_g‘_ÿs
(
i
è(((i)->
™_æags
 & 
ITEM_CAS
) ? \

94 (
i
)->
d©a
->
ÿs
 : (
ušt64_t
)0)

	)

96 
	#ITEM_£t_ÿs
(
i
,
v
) { \

97 ià((
i
)->
™_æags
 & 
ITEM_CAS
) { \

98 (
i
)->
d©a
->
ÿs
 = 
v
; \

100 }

	)

102 
	#ITEM_key
(
™em
è(((*)&((™em)->
d©a
)) \

103 + (((
™em
)->
™_æags
 & 
ITEM_CAS
è? (
ušt64_t
è: 0))

	)

105 
	#ITEM_suffix
(
™em
è((*è&((™em)->
d©a
è+ (™em)->
nkey
 + 1 \

106 + (((
™em
)->
™_æags
 & 
ITEM_CAS
è? (
ušt64_t
è: 0))

	)

108 
	#ITEM_d©a
(
™em
è((*è&((™em)->
d©a
è+ (™em)->
nkey
 + 1 \

109 + (
™em
)->
nsuffix
 \

110 + (((
™em
)->
™_æags
 & 
ITEM_CAS
è? (
ušt64_t
è: 0))

	)

112 
	#ITEM_ÁÙ®
(
™em
è((
_¡r™em
è+ (™em)->
nkey
 + 1 \

113 + (
™em
)->
nsuffix
 + (™em)->
nby‹s
 \

114 + (((
™em
)->
™_æags
 & 
ITEM_CAS
è? (
ušt64_t
è: 0))

	)

116 
	#ITEM_şsid
(
™em
è((™em)->
¦abs_şsid
 & ~(3<<6))

	)

118 
	#STAT_KEY_LEN
 128

	)

119 
	#STAT_VAL_LEN
 128

	)

122 
	#APPEND_STAT
(
Çme
, 
fmt
, 
v®
) \

123 
	`­³nd_¡©
(
Çme
, 
add_¡©s
, 
c
, 
fmt
, 
v®
);

	)

127 
	#APPEND_NUM_FMT_STAT
(
Çme_fmt
, 
num
, 
Çme
, 
fmt
, 
v®
) \

128 
kËn
 = 
	`¢´štf
(
key_¡r
, 
STAT_KEY_LEN
, 
Çme_fmt
, 
num
, 
Çme
); \

129 
vËn
 = 
	`¢´štf
(
v®_¡r
, 
STAT_VAL_LEN
, 
fmt
, 
v®
); \

130 
	`add_¡©s
(
key_¡r
, 
kËn
, 
v®_¡r
, 
vËn
, 
c
);

	)

133 
	#APPEND_NUM_STAT
(
num
, 
Çme
, 
fmt
, 
v®
) \

134 
	`APPEND_NUM_FMT_STAT
("%d:%s", 
num
, 
Çme
, 
fmt
, 
v®
)

	)

145 (*
	tADD_STAT
)(cÚ¡ *
	tkey
, cÚ¡ 
	tušt16_t
 
	tkËn
,

146 cÚ¡ *
	tv®
, cÚ¡ 
	tušt32_t
 
	tvËn
,

147 cÚ¡ *
	tcook›
);

155 
	ecÚn_¡©es
 {

156 
cÚn_li¡’šg
,

157 
cÚn_Ãw_cmd
,

158 
cÚn_wa™šg
,

159 
cÚn_»ad
,

160 
cÚn_·r£_cmd
,

161 
cÚn_wr™e
,

162 
cÚn_Ä—d
,

163 
cÚn_sw®low
,

164 
cÚn_şosšg
,

165 
cÚn_mwr™e
,

166 
cÚn_şo£d
,

167 
cÚn_w©ch
,

168 
cÚn_max_¡©e


171 
	ebš_sub¡©es
 {

172 
bš_no_¡©e
,

173 
bš_»adšg_£t_h—d”
,

174 
bš_»adšg_ÿs_h—d”
,

175 
bš_»ad_£t_v®ue
,

176 
bš_»adšg_g‘_key
,

177 
bš_»adšg_¡©
,

178 
bš_»adšg_d–_h—d”
,

179 
bš_»adšg_šü_h—d”
,

180 
bš_»ad_æush_ex±ime
,

181 
bš_»adšg_§¦_auth
,

182 
bš_»adšg_§¦_auth_d©a
,

183 
bš_»adšg_touch_key
,

186 
	e´ÙocŞ
 {

187 
ascii_´Ù
 = 3,

188 
bš¬y_´Ù
,

189 
ÃgÙŸtšg_´Ù


192 
	eÃtwÜk_Œª¥Üt
 {

193 
loÿl_Œª¥Üt
,

194 
tı_Œª¥Üt
,

195 
udp_Œª¥Üt


198 
	e·u£_th»ad_ty³s
 {

199 
PAUSE_WORKER_THREADS
 = 0,

200 
PAUSE_ALL_THREADS
,

201 
RESUME_ALL_THREADS
,

202 
RESUME_WORKER_THREADS


205 
	#IS_TCP
(
x
è(x =ğ
tı_Œª¥Üt
)

	)

206 
	#IS_UDP
(
x
è(x =ğ
udp_Œª¥Üt
)

	)

208 
	#NREAD_ADD
 1

	)

209 
	#NREAD_SET
 2

	)

210 
	#NREAD_REPLACE
 3

	)

211 
	#NREAD_APPEND
 4

	)

212 
	#NREAD_PREPEND
 5

	)

213 
	#NREAD_CAS
 6

	)

215 
	e¡Üe_™em_ty³
 {

216 
NOT_STORED
=0, 
STORED
, 
EXISTS
, 
NOT_FOUND
, 
TOO_LARGE
, 
NO_MEMORY


219 
	ed–_»suÉ_ty³
 {

220 
OK
, 
NON_NUMERIC
, 
EOM
, 
DELTA_ITEM_NOT_FOUND
, 
DELTA_ITEM_CAS_MISMATCH


231 
	#SLAB_STATS_FIELDS
 \

232 
	`X
(
£t_cmds
) \

233 
	`X
(
g‘_h™s
) \

234 
	`X
(
touch_h™s
) \

235 
	`X
(
d–‘e_h™s
) \

236 
	`X
(
ÿs_h™s
) \

237 
	`X
(
ÿs_badv®
) \

238 
	`X
(
šü_h™s
) \

239 
	`X
(
deü_h™s
)

	)

242 
	s¦ab_¡©s
 {

243 
	#X
(
Çme
è
ušt64_t
‚ame;

	)

244 
SLAB_STATS_FIELDS


245 #undeà
X


248 
	#THREAD_STATS_FIELDS
 \

249 
	`X
(
g‘_cmds
) \

250 
	`X
(
g‘_mis£s
) \

251 
	`X
(
g‘_expœed
) \

252 
	`X
(
g‘_æushed
) \

253 
	`X
(
touch_cmds
) \

254 
	`X
(
touch_mis£s
) \

255 
	`X
(
d–‘e_mis£s
) \

256 
	`X
(
šü_mis£s
) \

257 
	`X
(
deü_mis£s
) \

258 
	`X
(
ÿs_mis£s
) \

259 
	`X
(
by‹s_»ad
) \

260 
	`X
(
by‹s_wr™‹n
) \

261 
	`X
(
æush_cmds
) \

262 
	`X
(
cÚn_y›lds
) \

263 
	`X
(
auth_cmds
) \

264 
	`X
(
auth_”rÜs
) \

265 
	`X
(
idË_kicks
è

	)

270 
	sth»ad_¡©s
 {

271 
±h»ad_mu‹x_t
 
mu‹x
;

272 
	#X
(
Çme
è
ušt64_t
‚ame;

	)

273 
THREAD_STATS_FIELDS


274 #undeà
X


275 
¦ab_¡©s
 sÏb_¡©s[
MAX_NUMBER_OF_SLAB_CLASSES
];

281 
	s¡©s
 {

282 
ušt64_t
 
tÙ®_™ems
;

283 
ušt64_t
 
tÙ®_cÚns
;

284 
ušt64_t
 
»jeùed_cÚns
;

285 
ušt64_t
 
m®loc_çs
;

286 
ušt64_t
 
li¡’_di§bËd_num
;

287 
ušt64_t
 
¦abs_moved
;

288 
ušt64_t
 
¦ab_»assign_»scues
;

289 
ušt64_t
 
¦ab_»assign_eviùiÚs_nomem
;

290 
ušt64_t
 
¦ab_»assign_šlše_»şaim
;

291 
ušt64_t
 
¦ab_»assign_chunk_»scues
;

292 
ušt64_t
 
¦ab_»assign_busy_™ems
;

293 
ušt64_t
 
Ìu_üawËr_¡¬ts
;

294 
ušt64_t
 
Ìu_mašš”_juggËs
;

295 
ušt64_t
 
time_š_li¡’_di§bËd_us
;

296 
ušt64_t
 
log_wÜk”_drİ³d
;

297 
ušt64_t
 
log_wÜk”_wr™‹n
;

298 
ušt64_t
 
log_w©ch”_sk³d
;

299 
ušt64_t
 
log_w©ch”_£Á
;

300 
timev®
 
maxcÚns_’‹»d
;

307 
	s¡©s_¡©e
 {

308 
ušt64_t
 
cu¼_™ems
;

309 
ušt64_t
 
cu¼_by‹s
;

310 
ušt64_t
 
cu¼_cÚns
;

311 
ušt64_t
 
hash_by‹s
;

312 
cÚn_¡ruùs
;

313 
»£rved_fds
;

314 
hash_pow”_Ëv–
;

315 
boŞ
 
hash_is_ex·ndšg
;

316 
boŞ
 
acû±šg_cÚns
;

317 
boŞ
 
¦ab_»assign_ruÂšg
;

318 
boŞ
 
Ìu_üawËr_ruÂšg
;

321 
	#MAX_VERBOSITY_LEVEL
 2

	)

327 
	s£‰šgs
 {

328 
size_t
 
maxby‹s
;

329 
maxcÚns
;

330 
pÜt
;

331 
udµÜt
;

332 *
š‹r
;

333 
v”bo£
;

334 
»l_time_t
 
Şde¡_live
;

335 
ušt64_t
 
Şde¡_ÿs
;

336 
eviù_to_ä“
;

337 *
sock‘·th
;

338 
acûss
;

339 
çùÜ
;

340 
chunk_size
;

341 
num_th»ads
;

342 
num_th»ads_³r_udp
;

343 
´efix_d–im™”
;

344 
d‘a_’abËd
;

345 
»qs_³r_ev’t
;

347 
boŞ
 
u£_ÿs
;

348 
´ÙocŞ
 
bšdšg_´ÙocŞ
;

349 
backlog
;

350 
™em_size_max
;

351 
¦ab_chunk_size_max
;

352 
¦ab_·ge_size
;

353 
boŞ
 
§¦
;

354 
boŞ
 
maxcÚns_ç¡
;

355 
boŞ
 
Ìu_üawËr
;

356 
boŞ
 
Ìu_mašš”_th»ad
;

357 
boŞ
 
¦ab_»assign
;

358 
¦ab_automove
;

359 
hashpow”_š™
;

360 
boŞ
 
shutdown_commªd
;

361 
_»·œ_time
;

362 
boŞ
 
æush_’abËd
;

363 
boŞ
 
dump_’abËd
;

364 *
hash_®gÜ™hm
;

365 
Ìu_üawËr_¦“p
;

366 
ušt32_t
 
Ìu_üawËr_toüawl
;

367 
hÙ_Ìu_pù
;

368 
w¬m_Ìu_pù
;

369 
üawls_³r¦“p
;

370 
boŞ
 
expœez”o_dÛs_nÙ_eviù
;

371 
idË_timeout
;

372 
logg”_w©ch”_buf_size
;

373 
logg”_buf_size
;

376 
¡©s
 stats;

377 
¡©s_¡©e
 stats_state;

378 
time_t
 
´oûss_¡¬‹d
;

379 
£‰šgs
 settings;

381 
	#ITEM_LINKED
 1

	)

382 
	#ITEM_CAS
 2

	)

385 
	#ITEM_SLABBED
 4

	)

388 
	#ITEM_FETCHED
 8

	)

390 
	#ITEM_ACTIVE
 16

	)

392 
	#ITEM_CHUNKED
 32

	)

393 
	#ITEM_CHUNK
 64

	)

398 
	s_¡r™em
 {

400 
_¡r™em
 *
Ãxt
;

401 
_¡r™em
 *
´ev
;

403 
_¡r™em
 *
h_Ãxt
;

404 
»l_time_t
 
time
;

405 
»l_time_t
 
ex±ime
;

406 
nby‹s
;

407 
»fcouÁ
;

408 
ušt8_t
 
nsuffix
;

409 
ušt8_t
 
™_æags
;

410 
ušt8_t
 
¦abs_şsid
;

411 
ušt8_t
 
nkey
;

415 
ušt64_t
 
ÿs
;

416 
’d
;

417 } 
d©a
[];

422 } 
	t™em
;

425 
	eüawËr_run_ty³
 {

426 
CRAWLER_EXPIRED
=0, 
CRAWLER_METADUMP


430 
_¡r™em
 *
Ãxt
;

431 
_¡r™em
 *
´ev
;

432 
_¡r™em
 *
h_Ãxt
;

433 
»l_time_t
 
time
;

434 
»l_time_t
 
ex±ime
;

435 
nby‹s
;

436 
»fcouÁ
;

437 
ušt8_t
 
nsuffix
;

438 
ušt8_t
 
™_æags
;

439 
ušt8_t
 
¦abs_şsid
;

440 
ušt8_t
 
nkey
;

441 
ušt32_t
 
»maššg
;

442 
ušt64_t
 
»şaimed
;

443 
ušt64_t
 
unãtched
;

444 
ušt64_t
 
checked
;

445 } 
	tüawËr
;

448 
	s_¡rchunk
 {

449 
_¡rchunk
 *
Ãxt
;

450 
_¡rchunk
 *
´ev
;

451 
_¡r™em
 *
h—d
;

452 
size
;

453 
u£d
;

454 
nby‹s
;

455 
»fcouÁ
;

456 
ušt8_t
 
nsuffix
;

457 
ušt8_t
 
™_æags
;

458 
ušt8_t
 
¦abs_şsid
;

459 
d©a
[];

460 } 
	t™em_chunk
;

463 
±h»ad_t
 
th»ad_id
;

464 
ev’t_ba£
 *
ba£
;

465 
ev’t
 
nÙify_ev’t
;

466 
nÙify_»ûive_fd
;

467 
nÙify_£nd_fd
;

468 
th»ad_¡©s
 
¡©s
;

469 
cÚn_queue
 *
Ãw_cÚn_queue
;

470 
ÿche_t
 *
suffix_ÿche
;

471 
logg”
 *
l
;

472 } 
	tLIBEVENT_THREAD
;

477 
cÚn
 
	tcÚn
;

478 
	scÚn
 {

479 
sfd
;

480 
§¦_cÚn_t
 *
§¦_cÚn
;

481 
boŞ
 
auth’tiÿ‹d
;

482 
cÚn_¡©es
 
¡©e
;

483 
bš_sub¡©es
 
sub¡©e
;

484 
»l_time_t
 
Ï¡_cmd_time
;

485 
ev’t
ƒvent;

486 
ev_æags
;

487 
which
;

489 *
rbuf
;

490 *
rcu¼
;

491 
rsize
;

492 
rby‹s
;

494 *
wbuf
;

495 *
wcu¼
;

496 
wsize
;

497 
wby‹s
;

499 
cÚn_¡©es
 
wr™e_ªd_go
;

500 *
wr™e_ªd_ä“
;

502 *
r™em
;

503 
¾by‹s
;

513 *
™em
;

516 
sby‹s
;

519 
iovec
 *
iov
;

520 
iovsize
;

521 
iovu£d
;

523 
msghdr
 *
msgli¡
;

524 
msgsize
;

525 
msgu£d
;

526 
msgcu¼
;

527 
msgby‹s
;

529 
™em
 **
i¡
;

530 
isize
;

531 
™em
 **
icu¼
;

532 
eá
;

534 **
suffixli¡
;

535 
suffixsize
;

536 **
suffixcu¼
;

537 
suffixËá
;

539 
´ÙocŞ
…rotocol;

540 
ÃtwÜk_Œª¥Üt
 
Œª¥Üt
;

543 
»que¡_id
;

544 
sockaddr_š6
 
»que¡_addr
;

545 
sockËn_t
 
»que¡_addr_size
;

546 *
hdrbuf
;

547 
hdrsize
;

549 
boŞ
 
nÜ•ly
;

552 *
bufãr
;

553 
size_t
 
size
;

554 
size_t
 
off£t
;

555 } 
¡©s
;

559 
´ÙocŞ_bš¬y_»que¡_h—d”
 
bš¬y_h—d”
;

560 
ušt64_t
 
ÿs
;

561 
cmd
;

562 
İaque
;

563 
keyËn
;

564 
cÚn
 *
Ãxt
;

565 
LIBEVENT_THREAD
 *
th»ad
;

569 
cÚn
 **
cÚns
;

572 vŞ©
»l_time_t
 
cu¼’t_time
;

575 vŞ©
¦ab_»b®ªû_sigÇl
;

577 
	s¦ab_»b®ªû
 {

578 *
¦ab_¡¬t
;

579 *
¦ab_’d
;

580 *
¦ab_pos
;

581 
s_şsid
;

582 
d_şsid
;

583 
ušt32_t
 
busy_™ems
;

584 
ušt32_t
 
»scues
;

585 
ušt32_t
 
eviùiÚs_nomem
;

586 
ušt32_t
 
šlše_»şaim
;

587 
ušt32_t
 
chunk_»scues
;

588 
ušt8_t
 
dÚe
;

591 
¦ab_»b®ªû
 
¦ab_»b®
;

596 
	`do_acû±_Ãw_cÚns
(cÚ¡ 
boŞ
 
do_acû±
);

597 
d–_»suÉ_ty³
 
	`do_add_d–
(
cÚn
 *
c
, cÚ¡ *
key
,

598 cÚ¡ 
size_t
 
nkey
, cÚ¡ 
boŞ
 
šü
,

599 cÚ¡ 
št64_t
 
d–
, *
buf
,

600 
ušt64_t
 *
ÿs
, cÚ¡ 
ušt32_t
 
hv
);

601 
¡Üe_™em_ty³
 
	`do_¡Üe_™em
(
™em
 *™em, 
comm
, 
cÚn
* 
c
, cÚ¡ 
ušt32_t
 
hv
);

602 
cÚn
 *
	`cÚn_Ãw
(cÚ¡ 
sfd
, cÚ¡ 
cÚn_¡©es
 
š™_¡©e
, cÚ¡ 
ev’t_æags
, cÚ¡ 
»ad_bufãr_size
, 
ÃtwÜk_Œª¥Üt
 
Œª¥Üt
, 
ev’t_ba£
 *
ba£
);

603 
	`cÚn_wÜk”_»add
(
cÚn
 *
c
);

604 
	`d«mÚize
(
nochdœ
, 
noşo£
);

606 
	#mu‹x_lock
(
x
è
	`±h»ad_mu‹x_lock
(x)

	)

607 
	#mu‹x_uÆock
(
x
è
	`±h»ad_mu‹x_uÆock
(x)

	)

609 
	~"¡©s.h
"

610 
	~"¦abs.h
"

611 
	~"assoc.h
"

612 
	~"™ems.h
"

613 
	~"üawËr.h
"

614 
	~"Œaû.h
"

615 
	~"hash.h
"

616 
	~"ut.h
"

625 
	`memÿched_th»ad_š™
(
Áh»ads
);

626 
	`»di¥©ch_cÚn
(
cÚn
 *
c
);

627 
	`di¥©ch_cÚn_Ãw
(
sfd
, 
cÚn_¡©es
 
š™_¡©e
, 
ev’t_æags
, 
»ad_bufãr_size
, 
ÃtwÜk_Œª¥Üt
 
Œª¥Üt
);

628 
	`sid‘h»ad_cÚn_şo£
(
cÚn
 *
c
);

631 
d–_»suÉ_ty³
 
	`add_d–
(
cÚn
 *
c
, cÚ¡ *
key
,

632 cÚ¡ 
size_t
 
nkey
, cÚ¡ 
šü
,

633 cÚ¡ 
št64_t
 
d–
, *
buf
,

634 
ušt64_t
 *
ÿs
);

635 
	`acû±_Ãw_cÚns
(cÚ¡ 
boŞ
 
do_acû±
);

636 
cÚn
 *
	`cÚn_äom_ä“li¡
();

637 
boŞ
 
	`cÚn_add_to_ä“li¡
(
cÚn
 *
c
);

638 
	`cÚn_şo£_idË
(
cÚn
 *
c
);

639 
™em
 *
	`™em_®loc
(*
key
, 
size_t
 
nkey
, 
æags
, 
»l_time_t
 
ex±ime
, 
nby‹s
);

640 
™em
 *
	`™em_g‘
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, 
cÚn
 *
c
);

641 
™em
 *
	`™em_touch
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, 
ušt32_t
 
ex±ime
, 
cÚn
 *
c
);

642 
	`™em_lšk
(
™em
 *
™
);

643 
	`™em_»move
(
™em
 *
™
);

644 
	`™em_»¶aû
(
™em
 *
™
, i‹m *
Ãw_™
, cÚ¡ 
ušt32_t
 
hv
);

645 
	`™em_uÆšk
(
™em
 *
™
);

646 
	`™em_upd©e
(
™em
 *
™
);

648 
	`™em_lock
(
ušt32_t
 
hv
);

649 *
	`™em_Œylock
(
ušt32_t
 
hv
);

650 
	`™em_Œylock_uÆock
(*
¬g
);

651 
	`™em_uÆock
(
ušt32_t
 
hv
);

652 
	`·u£_th»ads
(
·u£_th»ad_ty³s
 
ty³
);

653 
	`»fcouÁ_šü
(*
»fcouÁ
);

654 
	`»fcouÁ_deü
(*
»fcouÁ
);

655 
	`STATS_LOCK
();

656 
	`STATS_UNLOCK
();

657 
	`th»adloÿl_¡©s_»£t
();

658 
	`th»adloÿl_¡©s_agg»g©e
(
th»ad_¡©s
 *
¡©s
);

659 
	`¦ab_¡©s_agg»g©e
(
th»ad_¡©s
 *
¡©s
, 
¦ab_¡©s
 *
out
);

662 
	`­³nd_¡©
(cÚ¡ *
Çme
, 
ADD_STAT
 
add_¡©s
, 
cÚn
 *
c
,

663 cÚ¡ *
fmt
, ...);

665 
¡Üe_™em_ty³
 
	`¡Üe_™em
(
™em
 *™em, 
comm
, 
cÚn
 *
c
);

667 #ià
HAVE_DROP_PRIVILEGES


668 
	`drİ_´iveges
();

670 
	#drİ_´iveges
()

	)

674 #ià!
	`defšed
(
__GNUC__
è|| (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 < 96)

675 
	#__butš_ex³ù
(
x
, 
ex³ùed_v®ue
è(x)

	)

678 
	#lik–y
(
x
è
	`__butš_ex³ù
((x),1)

	)

679 
	#uÆik–y
(
x
è
	`__butš_ex³ù
((x),0)

	)

	@murmur3_hash.c

10 
	~"murmur3_hash.h
"

17 #ià
defšed
(
_MSC_VER
)

19 
	#FORCE_INLINE
 
__fÜûšlše


	)

21 
	~<¡dlib.h
>

23 
	#ROTL32
(
x
,
y
è
	`_rÙl
(x,y)

	)

25 
	#BIG_CONSTANT
(
x
è(x)

	)

31 
	#FORCE_INLINE
 
šlše
 
	`__©Œibu‹__
((
®ways_šlše
))

	)

33 
šlše
 
ušt32_t
 
	$rÙl32
 ( 
ušt32_t
 
x
, 
št8_t
 
r
 )

35  (
x
 << 
r
) | (x >> (32 -„));

36 
	}
}

38 
	#ROTL32
(
x
,
y
è
	`rÙl32
(x,y)

	)

40 
	#BIG_CONSTANT
(
x
è(x##
LLU
)

	)

48 
FORCE_INLINE
 
ušt32_t
 
	$g‘block32
 ( cÚ¡ 
ušt32_t
 * 
p
, 
i
 )

50  
p
[
i
];

51 
	}
}

56 
FORCE_INLINE
 
ušt32_t
 
	$fmix32
 ( 
ušt32_t
 
h
 )

58 
h
 ^= h >> 16;

59 
h
 *= 0x85ebca6b;

60 
h
 ^= h >> 13;

61 
h
 *= 0xc2b2ae35;

62 
h
 ^= h >> 16;

64  
h
;

65 
	}
}

71 
ušt32_t
 
	$MurmurHash3_x86_32
 ( cÚ¡ * 
key
, 
size_t
 
Ëngth
)

73 cÚ¡ 
ušt8_t
 * 
d©a
 = (cÚ¡ ušt8_t*)
key
;

74 cÚ¡ 
nblocks
 = 
Ëngth
 / 4;

76 
ušt32_t
 
h1
 = 0;

78 
ušt32_t
 
c1
 = 0xcc9e2d51;

79 
ušt32_t
 
c2
 = 0x1b873593;

84 cÚ¡ 
ušt32_t
 * 
blocks
 = (cÚ¡ ušt32_ˆ*)(
d©a
 + 
nblocks
*4);

86 
i
 = -
nblocks
; i; i++)

88 
ušt32_t
 
k1
 = 
	`g‘block32
(
blocks
,
i
);

90 
k1
 *ğ
c1
;

91 
k1
 = 
	`ROTL32
(k1,15);

92 
k1
 *ğ
c2
;

94 
h1
 ^ğ
k1
;

95 
h1
 = 
	`ROTL32
(h1,13);

96 
h1
 = h1*5+0xe6546b64;

102 cÚ¡ 
ušt8_t
 * 

 = (cÚ¡ ušt8_t*)(
d©a
 + 
nblocks
*4);

104 
ušt32_t
 
k1
 = 0;

106 
Ëngth
 & 3)

108 3: 
k1
 ^ğ

[2] << 16;

109 2: 
k1
 ^ğ

[1] << 8;

110 1: 
k1
 ^ğ

[0];

111 
k1
 *ğ
c1
; k1 = 
	`ROTL32
(k1,15); k1 *ğ
c2
; 
h1
 ^= k1;

117 
h1
 ^ğ
Ëngth
;

119 
h1
 = 
	`fmix32
(h1);

122  
h1
;

123 
	}
}

	@murmur3_hash.h

5 #iâdeà
MURMURHASH3_H


6 
	#MURMURHASH3_H


	)

10 
	~<¡dšt.h
>

11 
	~<¡ddef.h
>

15 
ušt32_t
 
MurmurHash3_x86_32
(cÚ¡ *
key
, 
size_t
 
Ëngth
);

	@protocol_binary.h

35 #iâdeà
PROTOCOL_BINARY_H


36 
	#PROTOCOL_BINARY_H


	)

44 #ifdeà
__ılu¥lus


54 
PROTOCOL_BINARY_REQ
 = 0x80,

55 
PROTOCOL_BINARY_RES
 = 0x81

56 } 
	t´ÙocŞ_bš¬y_magic
;

63 
PROTOCOL_BINARY_RESPONSE_SUCCESS
 = 0x00,

64 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
 = 0x01,

65 
PROTOCOL_BINARY_RESPONSE_KEY_EEXISTS
 = 0x02,

66 
PROTOCOL_BINARY_RESPONSE_E2BIG
 = 0x03,

67 
PROTOCOL_BINARY_RESPONSE_EINVAL
 = 0x04,

68 
PROTOCOL_BINARY_RESPONSE_NOT_STORED
 = 0x05,

69 
PROTOCOL_BINARY_RESPONSE_DELTA_BADVAL
 = 0x06,

70 
PROTOCOL_BINARY_RESPONSE_AUTH_ERROR
 = 0x20,

71 
PROTOCOL_BINARY_RESPONSE_AUTH_CONTINUE
 = 0x21,

72 
PROTOCOL_BINARY_RESPONSE_UNKNOWN_COMMAND
 = 0x81,

73 
PROTOCOL_BINARY_RESPONSE_ENOMEM
 = 0x82

74 } 
	t´ÙocŞ_bš¬y_»¥Ú£_¡©us
;

81 
PROTOCOL_BINARY_CMD_GET
 = 0x00,

82 
PROTOCOL_BINARY_CMD_SET
 = 0x01,

83 
PROTOCOL_BINARY_CMD_ADD
 = 0x02,

84 
PROTOCOL_BINARY_CMD_REPLACE
 = 0x03,

85 
PROTOCOL_BINARY_CMD_DELETE
 = 0x04,

86 
PROTOCOL_BINARY_CMD_INCREMENT
 = 0x05,

87 
PROTOCOL_BINARY_CMD_DECREMENT
 = 0x06,

88 
PROTOCOL_BINARY_CMD_QUIT
 = 0x07,

89 
PROTOCOL_BINARY_CMD_FLUSH
 = 0x08,

90 
PROTOCOL_BINARY_CMD_GETQ
 = 0x09,

91 
PROTOCOL_BINARY_CMD_NOOP
 = 0x0a,

92 
PROTOCOL_BINARY_CMD_VERSION
 = 0x0b,

93 
PROTOCOL_BINARY_CMD_GETK
 = 0x0c,

94 
PROTOCOL_BINARY_CMD_GETKQ
 = 0x0d,

95 
PROTOCOL_BINARY_CMD_APPEND
 = 0x0e,

96 
PROTOCOL_BINARY_CMD_PREPEND
 = 0x0f,

97 
PROTOCOL_BINARY_CMD_STAT
 = 0x10,

98 
PROTOCOL_BINARY_CMD_SETQ
 = 0x11,

99 
PROTOCOL_BINARY_CMD_ADDQ
 = 0x12,

100 
PROTOCOL_BINARY_CMD_REPLACEQ
 = 0x13,

101 
PROTOCOL_BINARY_CMD_DELETEQ
 = 0x14,

102 
PROTOCOL_BINARY_CMD_INCREMENTQ
 = 0x15,

103 
PROTOCOL_BINARY_CMD_DECREMENTQ
 = 0x16,

104 
PROTOCOL_BINARY_CMD_QUITQ
 = 0x17,

105 
PROTOCOL_BINARY_CMD_FLUSHQ
 = 0x18,

106 
PROTOCOL_BINARY_CMD_APPENDQ
 = 0x19,

107 
PROTOCOL_BINARY_CMD_PREPENDQ
 = 0x1a,

108 
PROTOCOL_BINARY_CMD_TOUCH
 = 0x1c,

109 
PROTOCOL_BINARY_CMD_GAT
 = 0x1d,

110 
PROTOCOL_BINARY_CMD_GATQ
 = 0x1e,

111 
PROTOCOL_BINARY_CMD_GATK
 = 0x23,

112 
PROTOCOL_BINARY_CMD_GATKQ
 = 0x24,

114 
PROTOCOL_BINARY_CMD_SASL_LIST_MECHS
 = 0x20,

115 
PROTOCOL_BINARY_CMD_SASL_AUTH
 = 0x21,

116 
PROTOCOL_BINARY_CMD_SASL_STEP
 = 0x22,

122 
PROTOCOL_BINARY_CMD_RGET
 = 0x30,

123 
PROTOCOL_BINARY_CMD_RSET
 = 0x31,

124 
PROTOCOL_BINARY_CMD_RSETQ
 = 0x32,

125 
PROTOCOL_BINARY_CMD_RAPPEND
 = 0x33,

126 
PROTOCOL_BINARY_CMD_RAPPENDQ
 = 0x34,

127 
PROTOCOL_BINARY_CMD_RPREPEND
 = 0x35,

128 
PROTOCOL_BINARY_CMD_RPREPENDQ
 = 0x36,

129 
PROTOCOL_BINARY_CMD_RDELETE
 = 0x37,

130 
PROTOCOL_BINARY_CMD_RDELETEQ
 = 0x38,

131 
PROTOCOL_BINARY_CMD_RINCR
 = 0x39,

132 
PROTOCOL_BINARY_CMD_RINCRQ
 = 0x3a,

133 
PROTOCOL_BINARY_CMD_RDECR
 = 0x3b,

134 
PROTOCOL_BINARY_CMD_RDECRQ
 = 0x3c

137 } 
	t´ÙocŞ_bš¬y_commªd
;

144 
PROTOCOL_BINARY_RAW_BYTES
 = 0x00

145 } 
	t´ÙocŞ_bš¬y_d©©y³s
;

153 
ušt8_t
 
magic
;

154 
ušt8_t
 
İcode
;

155 
ušt16_t
 
keyËn
;

156 
ušt8_t
 
ex’
;

157 
ušt8_t
 
d©©y³
;

158 
ušt16_t
 
»£rved
;

159 
ušt32_t
 
bodyËn
;

160 
ušt32_t
 
İaque
;

161 
ušt64_t
 
ÿs
;

162 } 
»que¡
;

163 
ušt8_t
 
by‹s
[24];

164 } 
	t´ÙocŞ_bš¬y_»que¡_h—d”
;

172 
ušt8_t
 
magic
;

173 
ušt8_t
 
İcode
;

174 
ušt16_t
 
keyËn
;

175 
ušt8_t
 
ex’
;

176 
ušt8_t
 
d©©y³
;

177 
ušt16_t
 
¡©us
;

178 
ušt32_t
 
bodyËn
;

179 
ušt32_t
 
İaque
;

180 
ušt64_t
 
ÿs
;

181 } 
»¥Ú£
;

182 
ušt8_t
 
by‹s
[24];

183 } 
	t´ÙocŞ_bš¬y_»¥Ú£_h—d”
;

190 
´ÙocŞ_bš¬y_»que¡_h—d”
 
h—d”
;

191 } 
mes§ge
;

192 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»que¡_h—d”
)];

193 } 
	t´ÙocŞ_bš¬y_»que¡_no_exŒas
;

200 
´ÙocŞ_bš¬y_»¥Ú£_h—d”
 
h—d”
;

201 } 
mes§ge
;

202 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»¥Ú£_h—d”
)];

203 } 
	t´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
;

209 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_g‘
;

210 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_g‘q
;

211 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_g‘k
;

212 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_g‘kq
;

221 
´ÙocŞ_bš¬y_»¥Ú£_h—d”
 
h—d”
;

223 
ušt32_t
 
æags
;

224 } 
body
;

225 } 
mes§ge
;

226 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»¥Ú£_h—d”
) + 4];

227 } 
	t´ÙocŞ_bš¬y_»¥Ú£_g‘
;

229 
´ÙocŞ_bš¬y_»¥Ú£_g‘
 
	t´ÙocŞ_bš¬y_»¥Ú£_g‘q
;

230 
´ÙocŞ_bš¬y_»¥Ú£_g‘
 
	t´ÙocŞ_bš¬y_»¥Ú£_g‘k
;

231 
´ÙocŞ_bš¬y_»¥Ú£_g‘
 
	t´ÙocŞ_bš¬y_»¥Ú£_g‘kq
;

237 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_d–‘e
;

243 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_d–‘e
;

253 
´ÙocŞ_bš¬y_»que¡_h—d”
 
h—d”
;

255 
ušt32_t
 
expœ©iÚ
;

256 } 
body
;

257 } 
mes§ge
;

258 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»que¡_h—d”
) + 4];

259 } 
	t´ÙocŞ_bš¬y_»que¡_æush
;

265 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_æush
;

273 
´ÙocŞ_bš¬y_»que¡_h—d”
 
h—d”
;

275 
ušt32_t
 
æags
;

276 
ušt32_t
 
expœ©iÚ
;

277 } 
body
;

278 } 
mes§ge
;

279 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»que¡_h—d”
) + 8];

280 } 
	t´ÙocŞ_bš¬y_»que¡_£t
;

281 
´ÙocŞ_bš¬y_»que¡_£t
 
	t´ÙocŞ_bš¬y_»que¡_add
;

282 
´ÙocŞ_bš¬y_»que¡_£t
 
	t´ÙocŞ_bš¬y_»que¡_»¶aû
;

288 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_£t
;

289 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_add
;

290 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_»¶aû
;

296 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_noİ
;

302 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_noİ
;

311 
´ÙocŞ_bš¬y_»que¡_h—d”
 
h—d”
;

313 
ušt64_t
 
d–
;

314 
ušt64_t
 
š™Ÿl
;

315 
ušt32_t
 
expœ©iÚ
;

316 } 
body
;

317 } 
mes§ge
;

318 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»que¡_h—d”
) + 20];

319 } 
	t´ÙocŞ_bš¬y_»que¡_šü
;

320 
´ÙocŞ_bš¬y_»que¡_šü
 
	t´ÙocŞ_bš¬y_»que¡_deü
;

329 
´ÙocŞ_bš¬y_»¥Ú£_h—d”
 
h—d”
;

331 
ušt64_t
 
v®ue
;

332 } 
body
;

333 } 
mes§ge
;

334 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»¥Ú£_h—d”
) + 8];

335 } 
	t´ÙocŞ_bš¬y_»¥Ú£_šü
;

336 
´ÙocŞ_bš¬y_»¥Ú£_šü
 
	t´ÙocŞ_bš¬y_»¥Ú£_deü
;

342 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_qu™
;

348 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_qu™
;

354 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_­³nd
;

355 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_´•’d
;

361 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_­³nd
;

362 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_´•’d
;

368 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_v”siÚ
;

374 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_v”siÚ
;

381 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
	t´ÙocŞ_bš¬y_»que¡_¡©s
;

387 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_¡©s
;

394 
´ÙocŞ_bš¬y_»que¡_h—d”
 
h—d”
;

396 
ušt32_t
 
expœ©iÚ
;

397 } 
body
;

398 } 
mes§ge
;

399 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»que¡_h—d”
) + 4];

400 } 
	t´ÙocŞ_bš¬y_»que¡_touch
;

405 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
	t´ÙocŞ_bš¬y_»¥Ú£_touch
;

412 
´ÙocŞ_bš¬y_»que¡_h—d”
 
h—d”
;

414 
ušt32_t
 
expœ©iÚ
;

415 } 
body
;

416 } 
mes§ge
;

417 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»que¡_h—d”
) + 4];

418 } 
	t´ÙocŞ_bš¬y_»que¡_g©
;

420 
´ÙocŞ_bš¬y_»que¡_g©
 
	t´ÙocŞ_bš¬y_»que¡_g©q
;

421 
´ÙocŞ_bš¬y_»que¡_g©
 
	t´ÙocŞ_bš¬y_»que¡_g©k
;

422 
´ÙocŞ_bš¬y_»que¡_g©
 
	t´ÙocŞ_bš¬y_»que¡_g©kq
;

427 
´ÙocŞ_bš¬y_»¥Ú£_g‘
 
	t´ÙocŞ_bš¬y_»¥Ú£_g©
;

428 
´ÙocŞ_bš¬y_»¥Ú£_g‘
 
	t´ÙocŞ_bš¬y_»¥Ú£_g©q
;

429 
´ÙocŞ_bš¬y_»¥Ú£_g‘
 
	t´ÙocŞ_bš¬y_»¥Ú£_g©k
;

430 
´ÙocŞ_bš¬y_»¥Ú£_g‘
 
	t´ÙocŞ_bš¬y_»¥Ú£_g©kq
;

442 
´ÙocŞ_bš¬y_»¥Ú£_h—d”
 
h—d”
;

444 
ušt16_t
 
size
;

445 
ušt8_t
 
»£rved
;

446 
ušt8_t
 
æags
;

447 
ušt32_t
 
max_»suÉs
;

448 } 
body
;

449 } 
mes§ge
;

450 
ušt8_t
 
by‹s
[(
´ÙocŞ_bš¬y_»que¡_h—d”
) + 4];

451 } 
	t´ÙocŞ_bš¬y_»que¡_¿ngeİ
;

453 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_rg‘
;

454 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_r£t
;

455 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_r£tq
;

456 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_¿µ’d
;

457 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_¿µ’dq
;

458 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_½»³nd
;

459 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_½»³ndq
;

460 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_rd–‘e
;

461 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_rd–‘eq
;

462 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_ršü
;

463 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_ršüq
;

464 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_rdeü
;

465 
´ÙocŞ_bš¬y_»que¡_¿ngeİ
 
	t´ÙocŞ_bš¬y_»que¡_rdeüq
;

467 #ifdeà
__ılu¥lus


	@sasl_defs.c

2 
	~"memÿched.h
"

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<¡ršg.h
>

6 
	~<§¦/§¦¶ug.h
>

8 
	gmy_§¦_ho¡Çme
[1025];

10 #ifdeà
HAVE_SASL_CB_GETCONF


14 cÚ¡ * cÚ¡ 
	gloÿtiÚs
[] = {

17 
NULL


21 #iâdeà
HAVE_SASL_CALLBACK_FT


22 (*
	t§¦_ÿÎback_á
)();

25 #ifdeà
ENABLE_SASL_PWDB


26 
	#MAX_ENTRY_LEN
 256

	)

28 cÚ¡ *
memÿched_§¦_pwdb
;

30 
	$§¦_£rv”_u£rdb_check·ss
(
§¦_cÚn_t
 *
cÚn
,

31 *
cÚ‹xt
,

32 cÚ¡ *
u£r
,

33 cÚ¡ *
·ss
,

34 
·s¦’
,

35 
´İùx
 *propctx)

37 
size_t
 
unmËn
 = 
	`¡¾’
(
u£r
);

38 ià((
·s¦’
 + 
unmËn
è> (
MAX_ENTRY_LEN
 - 4)) {

39 
	`årštf
(
¡d”r
,

41 
u£r
, 
·s¦’
);

42  
SASL_NOAUTHZ
;

45 
FILE
 *
pwfe
 = 
	`fİ’
(
memÿched_§¦_pwdb
, "r");

46 ià(
pwfe
 =ğ
NULL
) {

47 ià(
£‰šgs
.
v”bo£
) {

48 
	`v³¼Ü
("WARNING: Failedo open sasl database <%s>",

49 
memÿched_§¦_pwdb
);

51  
SASL_NOAUTHZ
;

54 
bufãr
[
MAX_ENTRY_LEN
];

55 
boŞ
 
ok
 = 
çl£
;

57 (
	`fg‘s
(
bufãr
, (bufãr), 
pwfe
)è!ğ
NULL
) {

58 ià(
	`memcmp
(
u£r
, 
bufãr
, 
unmËn
) == 0 && buffer[unmlen] == ':') {

60 ++
unmËn
;

61 ià(
	`memcmp
(
·ss
, 
bufãr
 + 
unmËn
, 
·s¦’
) == 0 &&

62 (
bufãr
[
unmËn
 + 
·s¦’
] == ':' ||

63 
bufãr
[
unmËn
 + 
·s¦’
] == '\n' ||

64 
bufãr
[
unmËn
 + 
·s¦’
] == '\r'||

65 
bufãr
[
unmËn
 + 
·s¦’
] == '\0')) {

66 
ok
 = 
Œue
;

72 ()
	`fşo£
(
pwfe
);

73 ià(
ok
) {

74  
SASL_OK
;

77 ià(
£‰šgs
.
v”bo£
) {

78 
	`årštf
(
¡d”r
, "INFO: U£¸<%s> faedØauth’tiÿ‹\n", 
u£r
);

81  
SASL_NOAUTHZ
;

82 
	}
}

85 #ifdeà
HAVE_SASL_CB_GETCONF


86 
	$§¦_g‘cÚf
(*
cÚ‹xt
, cÚ¡ **
·th
)

88 *
·th
 = 
	`g‘’v
("SASL_CONF_PATH");

90 ià(*
·th
 =ğ
NULL
) {

91 
i
 = 0; 
loÿtiÚs
[i] !ğ
NULL
; ++i) {

92 ià(
	`acûss
(
loÿtiÚs
[
i
], 
F_OK
) == 0) {

93 *
·th
 = 
loÿtiÚs
[
i
];

99 ià(
£‰šgs
.
v”bo£
) {

100 ià(*
·th
 !ğ
NULL
) {

101 
	`årštf
(
¡d”r
, "R—dšg cÚfigu¿tiÚ from: <%s>\n", *
·th
);

103 
	`årštf
(
¡d”r
, "Failedo†ocate‡ config…ath\n");

108  (*
·th
 !ğ
NULL
è? 
SASL_OK
 : 
SASL_FAIL
;

109 
	}
}

112 
	$§¦_log
(*
cÚ‹xt
, 
Ëv–
, cÚ¡ *
mes§ge
)

114 
boŞ
 
log
 = 
Œue
;

116 
Ëv–
) {

117 
SASL_LOG_NONE
:

118 
log
 = 
çl£
;

120 
SASL_LOG_PASS
:

121 
SASL_LOG_TRACE
:

122 
SASL_LOG_DEBUG
:

123 
SASL_LOG_NOTE
:

124 ià(
£‰šgs
.
v”bo£
 < 2) {

125 
log
 = 
çl£
;

128 
SASL_LOG_WARN
:

129 
SASL_LOG_FAIL
:

130 ià(
£‰šgs
.
v”bo£
 < 1) {

131 
log
 = 
çl£
;

139 ià(
log
) {

140 
	`årštf
(
¡d”r
, "SASL (£v”™y %d): %s\n", 
Ëv–
, 
mes§ge
);

143  
SASL_OK
;

144 
	}
}

146 
§¦_ÿÎback_t
 
	g§¦_ÿÎbacks
[] = {

147 #ifdeà
ENABLE_SASL_PWDB


148 { 
SASL_CB_SERVER_USERDB_CHECKPASS
, (
§¦_ÿÎback_á
)
§¦_£rv”_u£rdb_check·ss
, 
NULL
 },

151 { 
SASL_CB_LOG
, (
§¦_ÿÎback_á
)
§¦_log
, 
NULL
 },

153 #ifdeà
HAVE_SASL_CB_GETCONF


154 { 
SASL_CB_GETCONF
, 
§¦_g‘cÚf
, 
NULL
 },

157 { 
SASL_CB_LIST_END
, 
NULL
, NULL }

160 
	$š™_§¦
() {

161 #ifdeà
ENABLE_SASL_PWDB


162 
memÿched_§¦_pwdb
 = 
	`g‘’v
("MEMCACHED_SASL_PWDB");

163 ià(
memÿched_§¦_pwdb
 =ğ
NULL
) {

164 ià(
£‰šgs
.
v”bo£
) {

165 
	`årštf
(
¡d”r
,

169 
§¦_ÿÎbacks
[0].
id
 = 
SASL_CB_LIST_END
;

170 
§¦_ÿÎbacks
[0].
´oc
 = 
NULL
;

174 
	`mem£t
(
my_§¦_ho¡Çme
, 0, (my_sasl_hostname));

175 ià(
	`g‘ho¡Çme
(
my_§¦_ho¡Çme
, (my_sasl_hostname)-1) == -1) {

176 ià(
£‰šgs
.
v”bo£
) {

177 
	`årštf
(
¡d”r
, "Error discovering hostname for SASL\n");

179 
my_§¦_ho¡Çme
[0] = '\0';

182 ià(
	`§¦_£rv”_š™
(
§¦_ÿÎbacks
, "memÿched"è!ğ
SASL_OK
) {

183 
	`årštf
(
¡d”r
, "Error initializing sasl.\n");

184 
	`ex™
(
EXIT_FAILURE
);

186 ià(
£‰šgs
.
v”bo£
) {

187 
	`årštf
(
¡d”r
, "Initialized SASL.\n");

190 
	}
}

	@sasl_defs.h

1 #iâdeà
SASL_DEFS_H


2 
	#SASL_DEFS_H
 1

	)

5 
	#MAX_SASL_MECH_LEN
 32

	)

7 #ià
defšed
(
HAVE_SASL_SASL_H
è&& defšed(
ENABLE_SASL
)

9 
	~<§¦/§¦.h
>

10 
š™_§¦
();

12 
my_§¦_ho¡Çme
[1025];

16 * 
	t§¦_cÚn_t
;

18 
	#š™_§¦
(è{}

	)

19 
	#§¦_di¥o£
(
x
è{}

	)

20 
	#§¦_£rv”_Ãw
(
a
, 
b
, 
c
, 
d
, 
e
, 
f
, 
g
, 
h
è1

	)

21 
	#§¦_li¡mech
(
a
, 
b
, 
c
, 
d
, 
e
, 
f
, 
g
, 
h
è1

	)

22 
	#§¦_£rv”_¡¬t
(
a
, 
b
, 
c
, 
d
, 
e
, 
f
è1

	)

23 
	#§¦_£rv”_¡•
(
a
, 
b
, 
c
, 
d
, 
e
è1

	)

24 
	#§¦_g‘´İ
(
a
, 
b
, 
c
è{}

	)

26 
	#SASL_OK
 0

	)

27 
	#SASL_CONTINUE
 -1

	)

	@sizes.c

1 
	~<¡dio.h
>

3 
	~"memÿched.h
"

5 
	$di¥Ïy
(cÚ¡ *
Çme
, 
size_t
 
size
) {

6 
	`´štf
("%s\t%d\n", 
Çme
, ()
size
);

7 
	}
}

9 
	$maš
(
¬gc
, **
¬gv
) {

11 
	`di¥Ïy
("SÏb Sts", (
¦ab_¡©s
));

12 
	`di¥Ïy
("Thread stats",

13 (
th»ad_¡©s
)

14 - (200 * (
¦ab_¡©s
)));

15 
	`di¥Ïy
("Glob® sts", (
¡©s
));

16 
	`di¥Ïy
("S‘tšgs", (
£‰šgs
));

17 
	`di¥Ïy
("I‹m (nØÿs)", (
™em
));

18 
	`di¥Ïy
("I‹m (ÿs)", (
™em
è+ (
ušt64_t
));

19 
	`di¥Ïy
("Libeventhread",

20 (
LIBEVENT_THREAD
è- (
th»ad_¡©s
));

21 
	`di¥Ïy
("CÚÃùiÚ", (
cÚn
));

23 
	`´štf
("----------------------------------------\n");

25 
	`di¥Ïy
("libev’ˆth»ad cumuÏtive", (
LIBEVENT_THREAD
));

26 
	`di¥Ïy
("Th»ad st cumuÏtive\t", (
th»ad_¡©s
));

29 
	}
}

	@slabs.c

10 
	~"memÿched.h
"

11 
	~<sys/¡©.h
>

12 
	~<sys/sock‘.h
>

13 
	~<sys/»sourû.h
>

14 
	~<fú.h
>

15 
	~<Ãtš‘/š.h
>

16 
	~<”ºo.h
>

17 
	~<¡dlib.h
>

18 
	~<¡dio.h
>

19 
	~<¡ršg.h
>

20 
	~<sigÇl.h
>

21 
	~<as£¹.h
>

22 
	~<±h»ad.h
>

28 
	msize
;

29 
	m³r¦ab
;

31 *
	m¦Ùs
;

32 
	m¦_cu¼
;

34 
	m¦abs
;

36 **
	m¦ab_li¡
;

37 
	mli¡_size
;

39 
size_t
 
	m»que¡ed
;

40 } 
	t¦abşass_t
;

42 
¦abşass_t
 
	g¦abşass
[
MAX_NUMBER_OF_SLAB_CLASSES
];

43 
size_t
 
	gmem_lim™
 = 0;

44 
size_t
 
	gmem_m®loûd
 = 0;

47 
boŞ
 
	gmem_lim™_»ached
 = 
çl£
;

48 
	gpow”_Ïrge¡
;

50 *
	gmem_ba£
 = 
NULL
;

51 *
	gmem_cu¼’t
 = 
NULL
;

52 
size_t
 
	gmem_ava
 = 0;

57 
±h»ad_mu‹x_t
 
	g¦abs_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

58 
±h»ad_mu‹x_t
 
	g¦abs_»b®ªû_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

63 
do_¦abs_Ãw¦ab
(cÚ¡ 
id
);

64 *
memÜy_®loÿ‹
(
size_t
 
size
);

65 
do_¦abs_ä“
(*
±r
, cÚ¡ 
size_t
 
size
, 
id
);

73 
¦abs_´—Îoÿ‹
 (cÚ¡ 
max¦abs
);

83 
	$¦abs_şsid
(cÚ¡ 
size_t
 
size
) {

84 
»s
 = 
POWER_SMALLEST
;

86 ià(
size
 =ğ0 || siz> 
£‰šgs
.
™em_size_max
)

88 
size
 > 
¦abşass
[
»s
].size)

89 ià(
»s
++ =ğ
pow”_Ïrge¡
)

90  
pow”_Ïrge¡
;

91  
»s
;

92 
	}
}

98 
	$¦abs_š™
(cÚ¡ 
size_t
 
lim™
, cÚ¡ 
çùÜ
, cÚ¡ 
boŞ
 
´—Îoc
, cÚ¡ 
ušt32_t
 *
¦ab_sizes
) {

99 
i
 = 
POWER_SMALLEST
 - 1;

100 
size
 = (
™em
è+ 
£‰šgs
.
chunk_size
;

102 
mem_lim™
 = 
lim™
;

104 ià(
´—Îoc
) {

106 
mem_ba£
 = 
	`m®loc
(
mem_lim™
);

107 ià(
mem_ba£
 !ğ
NULL
) {

108 
mem_cu¼’t
 = 
mem_ba£
;

109 
mem_ava
 = 
mem_lim™
;

111 
	`årštf
(
¡d”r
, "Warning: Failedo‡llocate„equested memory in"

116 
	`mem£t
(
¦abşass
, 0, (slabclass));

118 ++
i
 < 
MAX_NUMBER_OF_SLAB_CLASSES
-1) {

119 ià(
¦ab_sizes
 !ğ
NULL
) {

120 ià(
¦ab_sizes
[
i
-1] == 0)

122 
size
 = 
¦ab_sizes
[
i
-1];

123 } ià(
size
 >ğ
£‰šgs
.
¦ab_chunk_size_max
 / 
çùÜ
) {

127 ià(
size
 % 
CHUNK_ALIGN_BYTES
)

128 
size
 +ğ
CHUNK_ALIGN_BYTES
 - (size % CHUNK_ALIGN_BYTES);

130 
¦abşass
[
i
].
size
 = size;

131 
¦abşass
[
i
].
³r¦ab
 = 
£‰šgs
.
¦ab_·ge_size
 / sÏbşass[i].
size
;

132 ià(
¦ab_sizes
 =ğ
NULL
)

133 
size
 *ğ
çùÜ
;

134 ià(
£‰šgs
.
v”bo£
 > 1) {

135 
	`årštf
(
¡d”r
, "slab class %3d: chunk size %9u…erslab %7u\n",

136 
i
, 
¦abşass
[i].
size
, sÏbşass[i].
³r¦ab
);

140 
pow”_Ïrge¡
 = 
i
;

141 
¦abşass
[
pow”_Ïrge¡
].
size
 = 
£‰šgs
.
¦ab_chunk_size_max
;

142 
¦abşass
[
pow”_Ïrge¡
].
³r¦ab
 = 
£‰šgs
.
¦ab_·ge_size
 / s‘tšgs.
¦ab_chunk_size_max
;

143 ià(
£‰šgs
.
v”bo£
 > 1) {

144 
	`årštf
(
¡d”r
, "slab class %3d: chunk size %9u…erslab %7u\n",

145 
i
, 
¦abşass
[i].
size
, sÏbşass[i].
³r¦ab
);

150 *
t_š™Ÿl_m®loc
 = 
	`g‘’v
("T_MEMD_INITIAL_MALLOC");

151 ià(
t_š™Ÿl_m®loc
) {

152 
mem_m®loûd
 = (
size_t
)
	`©Ş
(
t_š™Ÿl_m®loc
);

157 ià(
´—Îoc
) {

158 
	`¦abs_´—Îoÿ‹
(
pow”_Ïrge¡
);

160 
	}
}

162 
	$¦abs_´—Îoÿ‹
 (cÚ¡ 
max¦abs
) {

163 
i
;

164 
´—Îoc
 = 0;

172 
i
 = 
POWER_SMALLEST
; i < 
MAX_NUMBER_OF_SLAB_CLASSES
; i++) {

173 ià(++
´—Îoc
 > 
max¦abs
)

175 ià(
	`do_¦abs_Ãw¦ab
(
i
) == 0) {

176 
	`årštf
(
¡d”r
, "Error while…reallocating slab memory!\n"

178 "©†—¡ %d megaby‹s.\n", 
pow”_Ïrge¡
);

179 
	`ex™
(1);

183 
	}
}

185 
	$grow_¦ab_li¡
 (cÚ¡ 
id
) {

186 
¦abşass_t
 *
p
 = &
¦abşass
[
id
];

187 ià(
p
->
¦abs
 =ğp->
li¡_size
) {

188 
size_t
 
Ãw_size
 = (
p
->
li¡_size
 != 0) ?…->list_size * 2 : 16;

189 *
Ãw_li¡
 = 
	`»®loc
(
p
->
¦ab_li¡
, 
Ãw_size
 * (*));

190 ià(
Ãw_li¡
 == 0)  0;

191 
p
->
li¡_size
 = 
Ãw_size
;

192 
p
->
¦ab_li¡
 = 
Ãw_li¡
;

195 
	}
}

197 
	$¥l™_¦ab_·ge_što_ä“li¡
(*
±r
, cÚ¡ 
id
) {

198 
¦abşass_t
 *
p
 = &
¦abşass
[
id
];

199 
x
;

200 
x
 = 0; x < 
p
->
³r¦ab
; x++) {

201 
	`do_¦abs_ä“
(
±r
, 0, 
id
);

202 
±r
 +ğ
p
->
size
;

204 
	}
}

207 *
	$g‘_·ge_äom_glob®_poŞ
() {

208 
¦abşass_t
 *
p
 = &
¦abşass
[
SLAB_GLOBAL_PAGE_POOL
];

209 ià(
p
->
¦abs
 < 1) {

210  
NULL
;

212 *
»t
 = 
p
->
¦ab_li¡
[p->
¦abs
 - 1];

213 
p
->
¦abs
--;

214  
»t
;

215 
	}
}

217 
	$do_¦abs_Ãw¦ab
(cÚ¡ 
id
) {

218 
¦abşass_t
 *
p
 = &
¦abşass
[
id
];

219 
¦abşass_t
 *
g
 = &
¦abşass
[
SLAB_GLOBAL_PAGE_POOL
];

220 
Ën
 = (
£‰šgs
.
¦ab_»assign
 || s‘tšgs.
¦ab_chunk_size_max
 !ğ£‰šgs.
¦ab_·ge_size
)

221 ? 
£‰šgs
.
¦ab_·ge_size


222 : 
p
->
size
 *…->
³r¦ab
;

223 *
±r
;

225 ià((
mem_lim™
 && 
mem_m®loûd
 + 
Ën
 > mem_lim™ && 
p
->
¦abs
 > 0

226 && 
g
->
¦abs
 == 0)) {

227 
mem_lim™_»ached
 = 
Œue
;

228 
	`MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED
(
id
);

232 ià((
	`grow_¦ab_li¡
(
id
) == 0) ||

233 (((
±r
 = 
	`g‘_·ge_äom_glob®_poŞ
()è=ğ
NULL
) &&

234 ((
±r
 = 
	`memÜy_®loÿ‹
((
size_t
)
Ën
)) == 0))) {

236 
	`MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED
(
id
);

240 
	`mem£t
(
±r
, 0, (
size_t
)
Ën
);

241 
	`¥l™_¦ab_·ge_što_ä“li¡
(
±r
, 
id
);

243 
p
->
¦ab_li¡
[p->
¦abs
++] = 
±r
;

244 
	`MEMCACHED_SLABS_SLABCLASS_ALLOCATE
(
id
);

247 
	}
}

250 *
	$do_¦abs_®loc_chunked
(cÚ¡ 
size_t
 
size
, 
¦abşass_t
 *
p
, 
id
) {

251 *
»t
 = 
NULL
;

252 
™em
 *
™
 = 
NULL
;

253 
x
;

254 
csize
 = 
p
->
size
 - (
™em_chunk
);

255 
chunks_»q
 = 
size
 / 
csize
;

256 ià(
size
 % 
csize
 != 0)

257 
chunks_»q
++;

258 
p
->
¦_cu¼
 < 
chunks_»q
) {

259 ià(
	`do_¦abs_Ãw¦ab
(
id
) == 0)

263 ià(
p
->
¦_cu¼
 >ğ
chunks_»q
) {

264 
™em_chunk
 *
chunk
 = 
NULL
;

267 
™
 = (
™em
 *)
p
->
¦Ùs
;

268 
p
->
¦Ùs
 = 
™
->
Ãxt
;

269 ià(
™
->
Ãxt
è™->Ãxt->
´ev
 = 0;

272 
™
->
h_Ãxt
 = (
™em
 *)
p
->
¦Ùs
;

273 
	`as£¹
(
™
->
h_Ãxt
 != 0);

274 
chunk
 = (
™em_chunk
 *è
™
->
h_Ãxt
;

277 
x
 = 0; x < 
chunks_»q
-1; x++) {

278 
chunk
->
™_æags
 &ğ~
ITEM_SLABBED
;

279 
chunk
->
™_æags
 |ğ
ITEM_CHUNK
;

281 
chunk
->
h—d
 = 
™
;

282 
chunk
->
size
 = 
p
->siz- (
™em_chunk
);

283 
chunk
->
u£d
 = 0;

284 
chunk
 = chunk->
Ãxt
;

288 
p
->
¦Ùs
 = 
chunk
;

289 ià(
chunk
 && chunk->
´ev
) {

291 
chunk
->
´ev
->
Ãxt
 = 0;

292 
chunk
->
´ev
 = 0;

295 
™
->
™_æags
 &ğ~
ITEM_SLABBED
;

296 
™
->
™_æags
 |ğ
ITEM_CHUNKED
;

297 
™
->
»fcouÁ
 = 1;

298 
p
->
¦_cu¼
 -ğ
chunks_»q
;

299 
»t
 = (*)
™
;

301 
»t
 = 
NULL
;

304  
»t
;

305 
	}
}

308 *
	$do_¦abs_®loc
(cÚ¡ 
size_t
 
size
, 
id
, 
ušt64_t
 *
tÙ®_by‹s
,

309 
æags
) {

310 
¦abşass_t
 *
p
;

311 *
»t
 = 
NULL
;

312 
™em
 *
™
 = 
NULL
;

314 ià(
id
 < 
POWER_SMALLEST
 || id > 
pow”_Ïrge¡
) {

315 
	`MEMCACHED_SLABS_ALLOCATE_FAILED
(
size
, 0);

316  
NULL
;

318 
p
 = &
¦abşass
[
id
];

319 
	`as£¹
(
p
->
¦_cu¼
 =ğ0 || ((
™em
 *í->
¦Ùs
)->
¦abs_şsid
 == 0);

320 ià(
tÙ®_by‹s
 !ğ
NULL
) {

321 *
tÙ®_by‹s
 = 
p
->
»que¡ed
;

324 ià(
size
 <ğ
p
->size) {

327 ià(
p
->
¦_cu¼
 =ğ0 && 
æags
 !ğ
SLABS_ALLOC_NO_NEWPAGE
) {

328 
	`do_¦abs_Ãw¦ab
(
id
);

331 ià(
p
->
¦_cu¼
 != 0) {

333 
™
 = (
™em
 *)
p
->
¦Ùs
;

334 
p
->
¦Ùs
 = 
™
->
Ãxt
;

335 ià(
™
->
Ãxt
è™->Ãxt->
´ev
 = 0;

338 
™
->
™_æags
 &ğ~
ITEM_SLABBED
;

339 
™
->
»fcouÁ
 = 1;

340 
p
->
¦_cu¼
--;

341 
»t
 = (*)
™
;

343 
»t
 = 
NULL
;

347 
»t
 = 
	`do_¦abs_®loc_chunked
(
size
, 
p
, 
id
);

350 ià(
»t
) {

351 
p
->
»que¡ed
 +ğ
size
;

352 
	`MEMCACHED_SLABS_ALLOCATE
(
size
, 
id
, 
p
->size, 
»t
);

354 
	`MEMCACHED_SLABS_ALLOCATE_FAILED
(
size
, 
id
);

357  
»t
;

358 
	}
}

360 
	$do_¦abs_ä“_chunked
(
™em
 *
™
, cÚ¡ 
size_t
 
size
, 
id
,

361 
¦abşass_t
 *
p
) {

362 
™em_chunk
 *
chunk
 = (™em_chunk *è
	`ITEM_d©a
(
™
);

363 
size_t
 
»®size
 = 
size
;

364 
chunk
) {

365 
»®size
 +ğ(
™em_chunk
);

366 
chunk
 = chunk->
Ãxt
;

368 
chunk
 = (
™em_chunk
 *è
	`ITEM_d©a
(
™
);

369 
chunks_found
 = 1;

371 
™
->
™_æags
 = 
ITEM_SLABBED
;

372 
™
->
¦abs_şsid
 = 0;

373 
™
->
´ev
 = 0;

374 
™
->
Ãxt
 = (
™em
 *è
chunk
->next;

375 
	`as£¹
(
™
->
Ãxt
);

377 
	`as£¹
(
™
->
Ãxt
 && (*)™->Ãxt->
´ev
 =ğ(*)
chunk
);

378 
chunk
 = chunk->
Ãxt
;

379 
chunk
->
´ev
 = (
™em_chunk
 *)
™
;

381 
chunk
) {

382 
	`as£¹
(
chunk
->
™_æags
 =ğ
ITEM_CHUNK
);

383 
chunk
->
™_æags
 = 
ITEM_SLABBED
;

384 
chunk
->
¦abs_şsid
 = 0;

385 
chunks_found
++;

386 ià(
chunk
->
Ãxt
) {

387 
chunk
 = chunk->
Ãxt
;

393 
	`as£¹
(
chunk
 && chunk->
Ãxt
 == 0);

395 
chunk
->
Ãxt
 = 
p
->
¦Ùs
;

396 ià(
chunk
->
Ãxt
èchunk->Ãxt->
´ev
 = chunk;

398 
p
->
¦Ùs
 = 
™
;

399 
p
->
¦_cu¼
 +ğ
chunks_found
;

400 
p
->
»que¡ed
 -ğ
size
;

403 
	}
}

406 
	$do_¦abs_ä“
(*
±r
, cÚ¡ 
size_t
 
size
, 
id
) {

407 
¦abşass_t
 *
p
;

408 
™em
 *
™
;

410 
	`as£¹
(
id
 >ğ
POWER_SMALLEST
 && id <ğ
pow”_Ïrge¡
);

411 ià(
id
 < 
POWER_SMALLEST
 || id > 
pow”_Ïrge¡
)

414 
	`MEMCACHED_SLABS_FREE
(
size
, 
id
, 
±r
);

415 
p
 = &
¦abşass
[
id
];

417 
™
 = (
™em
 *)
±r
;

418 ià((
™
->
™_æags
 & 
ITEM_CHUNKED
) == 0) {

419 
™
->
™_æags
 = 
ITEM_SLABBED
;

420 
™
->
¦abs_şsid
 = 0;

421 
™
->
´ev
 = 0;

422 
™
->
Ãxt
 = 
p
->
¦Ùs
;

423 ià(
™
->
Ãxt
è™->Ãxt->
´ev
 = it;

424 
p
->
¦Ùs
 = 
™
;

426 
p
->
¦_cu¼
++;

427 
p
->
»que¡ed
 -ğ
size
;

429 
	`do_¦abs_ä“_chunked
(
™
, 
size
, 
id
, 
p
);

432 
	}
}

434 
	$nz_¡rcmp
(
nzËngth
, cÚ¡ *
nz
, cÚ¡ *
z
) {

435 
zËngth
=
	`¡¾’
(
z
);

436  (
zËngth
 =ğ
nzËngth
è&& (
	`¡ºcmp
(
nz
, 
z
, zlength) == 0) ? 0 : -1;

437 
	}
}

439 
boŞ
 
	$g‘_¡©s
(cÚ¡ *
¡©_ty³
, 
nkey
, 
ADD_STAT
 
add_¡©s
, *
c
) {

440 
boŞ
 
»t
 = 
Œue
;

442 ià(
add_¡©s
 !ğ
NULL
) {

443 ià(!
¡©_ty³
) {

445 
	`STATS_LOCK
();

446 
	`APPEND_STAT
("by‹s", "%Îu", ()
¡©s_¡©e
.
cu¼_by‹s
);

447 
	`APPEND_STAT
("cu¼_™ems", "%Îu", ()
¡©s_¡©e
.
cu¼_™ems
);

448 
	`APPEND_STAT
("tÙ®_™ems", "%Îu", ()
¡©s
.
tÙ®_™ems
);

449 
	`STATS_UNLOCK
();

450 ià(
£‰šgs
.
¦ab_automove
 > 0) {

451 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

452 
	`APPEND_STAT
("¦ab_glob®_·ge_poŞ", "%u", 
¦abşass
[
SLAB_GLOBAL_PAGE_POOL
].
¦abs
);

453 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

455 
	`™em_¡©s_tÙ®s
(
add_¡©s
, 
c
);

456 } ià(
	`nz_¡rcmp
(
nkey
, 
¡©_ty³
, "items") == 0) {

457 
	`™em_¡©s
(
add_¡©s
, 
c
);

458 } ià(
	`nz_¡rcmp
(
nkey
, 
¡©_ty³
, "slabs") == 0) {

459 
	`¦abs_¡©s
(
add_¡©s
, 
c
);

460 } ià(
	`nz_¡rcmp
(
nkey
, 
¡©_ty³
, "sizes") == 0) {

461 
	`™em_¡©s_sizes
(
add_¡©s
, 
c
);

462 } ià(
	`nz_¡rcmp
(
nkey
, 
¡©_ty³
, "sizes_enable") == 0) {

463 
	`™em_¡©s_sizes_’abË
(
add_¡©s
, 
c
);

464 } ià(
	`nz_¡rcmp
(
nkey
, 
¡©_ty³
, "sizes_disable") == 0) {

465 
	`™em_¡©s_sizes_di§bË
(
add_¡©s
, 
c
);

467 
»t
 = 
çl£
;

470 
»t
 = 
çl£
;

473  
»t
;

474 
	}
}

477 
	$do_¦abs_¡©s
(
ADD_STAT
 
add_¡©s
, *
c
) {

478 
i
, 
tÙ®
;

480 
th»ad_¡©s
hread_stats;

481 
	`th»adloÿl_¡©s_agg»g©e
(&
th»ad_¡©s
);

483 
tÙ®
 = 0;

484 
i
 = 
POWER_SMALLEST
; i <ğ
pow”_Ïrge¡
; i++) {

485 
¦abşass_t
 *
p
 = &
¦abşass
[
i
];

486 ià(
p
->
¦abs
 != 0) {

487 
ušt32_t
 
³r¦ab
, 
¦abs
;

488 
¦abs
 = 
p
->slabs;

489 
³r¦ab
 = 
p
->perslab;

491 
key_¡r
[
STAT_KEY_LEN
];

492 
v®_¡r
[
STAT_VAL_LEN
];

493 
kËn
 = 0, 
vËn
 = 0;

495 
	`APPEND_NUM_STAT
(
i
, "chunk_size", "%u", 
p
->
size
);

496 
	`APPEND_NUM_STAT
(
i
, "chunks_³r_·ge", "%u", 
³r¦ab
);

497 
	`APPEND_NUM_STAT
(
i
, "tÙ®_·ges", "%u", 
¦abs
);

498 
	`APPEND_NUM_STAT
(
i
, "tÙ®_chunks", "%u", 
¦abs
 * 
³r¦ab
);

499 
	`APPEND_NUM_STAT
(
i
, "used_chunks", "%u",

500 
¦abs
*
³r¦ab
 - 
p
->
¦_cu¼
);

501 
	`APPEND_NUM_STAT
(
i
, "ä“_chunks", "%u", 
p
->
¦_cu¼
);

503 
	`APPEND_NUM_STAT
(
i
, "free_chunks_end", "%u", 0);

504 
	`APPEND_NUM_STAT
(
i
, "mem_requested", "%llu",

505 ()
p
->
»que¡ed
);

506 
	`APPEND_NUM_STAT
(
i
, "get_hits", "%llu",

507 ()
th»ad_¡©s
.
¦ab_¡©s
[
i
].
g‘_h™s
);

508 
	`APPEND_NUM_STAT
(
i
, "cmd_set", "%llu",

509 ()
th»ad_¡©s
.
¦ab_¡©s
[
i
].
£t_cmds
);

510 
	`APPEND_NUM_STAT
(
i
, "delete_hits", "%llu",

511 ()
th»ad_¡©s
.
¦ab_¡©s
[
i
].
d–‘e_h™s
);

512 
	`APPEND_NUM_STAT
(
i
, "incr_hits", "%llu",

513 ()
th»ad_¡©s
.
¦ab_¡©s
[
i
].
šü_h™s
);

514 
	`APPEND_NUM_STAT
(
i
, "decr_hits", "%llu",

515 ()
th»ad_¡©s
.
¦ab_¡©s
[
i
].
deü_h™s
);

516 
	`APPEND_NUM_STAT
(
i
, "cas_hits", "%llu",

517 ()
th»ad_¡©s
.
¦ab_¡©s
[
i
].
ÿs_h™s
);

518 
	`APPEND_NUM_STAT
(
i
, "cas_badval", "%llu",

519 ()
th»ad_¡©s
.
¦ab_¡©s
[
i
].
ÿs_badv®
);

520 
	`APPEND_NUM_STAT
(
i
, "touch_hits", "%llu",

521 ()
th»ad_¡©s
.
¦ab_¡©s
[
i
].
touch_h™s
);

522 
tÙ®
++;

528 
	`APPEND_STAT
("aùive_¦abs", "%d", 
tÙ®
);

529 
	`APPEND_STAT
("tÙ®_m®loûd", "%Îu", ()
mem_m®loûd
);

530 
	`add_¡©s
(
NULL
, 0, NULL, 0, 
c
);

531 
	}
}

533 *
	$memÜy_®loÿ‹
(
size_t
 
size
) {

534 *
»t
;

536 ià(
mem_ba£
 =ğ
NULL
) {

538 
»t
 = 
	`m®loc
(
size
);

540 
»t
 = 
mem_cu¼’t
;

542 ià(
size
 > 
mem_ava
) {

543  
NULL
;

547 ià(
size
 % 
CHUNK_ALIGN_BYTES
) {

548 
size
 +ğ
CHUNK_ALIGN_BYTES
 - (size % CHUNK_ALIGN_BYTES);

551 
mem_cu¼’t
 = ((*)mem_cu¼’tè+ 
size
;

552 ià(
size
 < 
mem_ava
) {

553 
mem_ava
 -ğ
size
;

555 
mem_ava
 = 0;

558 
mem_m®loûd
 +ğ
size
;

560  
»t
;

561 
	}
}

564 
	$memÜy_»Ëa£
() {

565 *
p
 = 
NULL
;

566 ià(
mem_ba£
 !ğ
NULL
)

569 ià(!
£‰šgs
.
¦ab_»assign
)

572 
mem_m®loûd
 > 
mem_lim™
 &&

573 (
p
 = 
	`g‘_·ge_äom_glob®_poŞ
()è!ğ
NULL
) {

574 
	`ä“
(
p
);

575 
mem_m®loûd
 -ğ
£‰šgs
.
™em_size_max
;

577 
	}
}

579 *
	$¦abs_®loc
(
size_t
 
size
, 
id
, 
ušt64_t
 *
tÙ®_by‹s
,

580 
æags
) {

581 *
»t
;

583 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

584 
»t
 = 
	`do_¦abs_®loc
(
size
, 
id
, 
tÙ®_by‹s
, 
æags
);

585 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

586  
»t
;

587 
	}
}

589 
	$¦abs_ä“
(*
±r
, 
size_t
 
size
, 
id
) {

590 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

591 
	`do_¦abs_ä“
(
±r
, 
size
, 
id
);

592 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

593 
	}
}

595 
	$¦abs_¡©s
(
ADD_STAT
 
add_¡©s
, *
c
) {

596 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

597 
	`do_¦abs_¡©s
(
add_¡©s
, 
c
);

598 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

599 
	}
}

601 
boŞ
 
	$do_¦abs_adju¡_mem_lim™
(
size_t
 
Ãw_mem_lim™
) {

603 ià(
mem_ba£
 !ğ
NULL
)

604  
çl£
;

605 
£‰šgs
.
maxby‹s
 = 
Ãw_mem_lim™
;

606 
mem_lim™
 = 
Ãw_mem_lim™
;

607 
mem_lim™_»ached
 = 
çl£
;

608 
	`memÜy_»Ëa£
();

609  
Œue
;

610 
	}
}

612 
boŞ
 
	$¦abs_adju¡_mem_lim™
(
size_t
 
Ãw_mem_lim™
) {

613 
boŞ
 
»t
;

614 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

615 
»t
 = 
	`do_¦abs_adju¡_mem_lim™
(
Ãw_mem_lim™
);

616 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

617  
»t
;

618 
	}
}

620 
	$¦abs_adju¡_mem_»que¡ed
(
id
, 
size_t
 
Şd
, size_ˆ
ÁÙ®
)

622 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

623 
¦abşass_t
 *
p
;

624 ià(
id
 < 
POWER_SMALLEST
 || id > 
pow”_Ïrge¡
) {

625 
	`årštf
(
¡d”r
, "Internalƒrror! Invalid slab class\n");

626 
	`abÜt
();

629 
p
 = &
¦abşass
[
id
];

630 
p
->
»que¡ed
 =…->»que¡ed - 
Şd
 + 
ÁÙ®
;

631 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

632 
	}
}

634 
	$¦abs_avaabË_chunks
(cÚ¡ 
id
, 
boŞ
 *
mem_æag
,

635 
ušt64_t
 *
tÙ®_by‹s
, *
chunks_³r¦ab
) {

636 
»t
;

637 
¦abşass_t
 *
p
;

639 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

640 
p
 = &
¦abşass
[
id
];

641 
»t
 = 
p
->
¦_cu¼
;

642 ià(
mem_æag
 !ğ
NULL
)

643 *
mem_æag
 = 
mem_lim™_»ached
;

644 ià(
tÙ®_by‹s
 !ğ
NULL
)

645 *
tÙ®_by‹s
 = 
p
->
»que¡ed
;

646 ià(
chunks_³r¦ab
 !ğ
NULL
)

647 *
chunks_³r¦ab
 = 
p
->
³r¦ab
;

648 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

649  
»t
;

650 
	}
}

652 
±h»ad_cÚd_t
 
	g¦ab_»b®ªû_cÚd
 = 
PTHREAD_COND_INITIALIZER
;

653 vŞ©
	gdo_run_¦ab_th»ad
 = 1;

654 vŞ©
	gdo_run_¦ab_»b®ªû_th»ad
 = 1;

656 
	#DEFAULT_SLAB_BULK_CHECK
 1

	)

657 
	g¦ab_bulk_check
 = 
DEFAULT_SLAB_BULK_CHECK
;

659 
	$¦ab_»b®ªû_¡¬t
() {

660 
¦abşass_t
 *
s_şs
;

661 
no_go
 = 0;

663 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

665 ià(
¦ab_»b®
.
s_şsid
 < 
POWER_SMALLEST
 ||

666 
¦ab_»b®
.
s_şsid
 > 
pow”_Ïrge¡
 ||

667 
¦ab_»b®
.
d_şsid
 < 
SLAB_GLOBAL_PAGE_POOL
 ||

668 
¦ab_»b®
.
d_şsid
 > 
pow”_Ïrge¡
 ||

669 
¦ab_»b®
.
s_şsid
 =ğ¦ab_»b®.
d_şsid
)

670 
no_go
 = -2;

672 
s_şs
 = &
¦abşass
[
¦ab_»b®
.
s_şsid
];

674 ià(!
	`grow_¦ab_li¡
(
¦ab_»b®
.
d_şsid
)) {

675 
no_go
 = -1;

678 ià(
s_şs
->
¦abs
 < 2)

679 
no_go
 = -3;

681 ià(
no_go
 != 0) {

682 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

683  
no_go
;

689 
¦ab_»b®
.
¦ab_¡¬t
 = 
s_şs
->
¦ab_li¡
[0];

690 
¦ab_»b®
.
¦ab_’d
 = (*)¦ab_»b®.
¦ab_¡¬t
 +

691 (
s_şs
->
size
 * s_şs->
³r¦ab
);

692 
¦ab_»b®
.
¦ab_pos
 = sÏb_»b®.
¦ab_¡¬t
;

693 
¦ab_»b®
.
dÚe
 = 0;

696 
¦ab_»b®ªû_sigÇl
 = 2;

698 ià(
£‰šgs
.
v”bo£
 > 1) {

699 
	`årštf
(
¡d”r
, "Started‡ slab„ebalance\n");

702 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

704 
	`STATS_LOCK
();

705 
¡©s_¡©e
.
¦ab_»assign_ruÂšg
 = 
Œue
;

706 
	`STATS_UNLOCK
();

709 
	}
}

712 *
	$¦ab_»b®ªû_®loc
(cÚ¡ 
size_t
 
size
, 
id
) {

713 
¦abşass_t
 *
s_şs
;

714 
s_şs
 = &
¦abşass
[
¦ab_»b®
.
s_şsid
];

715 
x
;

716 
™em
 *
Ãw_™
 = 
NULL
;

718 
x
 = 0; x < 
s_şs
->
³r¦ab
; x++) {

719 
Ãw_™
 = 
	`do_¦abs_®loc
(
size
, 
id
, 
NULL
, 
SLABS_ALLOC_NO_NEWPAGE
);

721 ià(
Ãw_™
 =ğ
NULL
) {

724 ià((*)
Ãw_™
 >ğ
¦ab_»b®
.
¦ab_¡¬t


725 && (*)
Ãw_™
 < 
¦ab_»b®
.
¦ab_’d
) {

729 
s_şs
->
»que¡ed
 -ğ
size
;

730 
Ãw_™
->
»fcouÁ
 = 0;

731 
Ãw_™
->
™_æags
 = 
ITEM_SLABBED
|
ITEM_FETCHED
;

732 #ifdeà
DEBUG_SLAB_MOVER


733 
	`memıy
(
	`ITEM_key
(
Ãw_™
), "deadbeef", 8);

735 
Ãw_™
 = 
NULL
;

736 
¦ab_»b®
.
šlše_»şaim
++;

741  
Ãw_™
;

742 
	}
}

746 
	$¦ab_»b®ªû_cut_ä“
(
¦abşass_t
 *
s_şs
, 
™em
 *
™
) {

748 
	`as£¹
(
™
->
™_æags
 =ğ
ITEM_SLABBED
);

749 ià(
s_şs
->
¦Ùs
 =ğ
™
) {

750 
s_şs
->
¦Ùs
 = 
™
->
Ãxt
;

752 ià(
™
->
Ãxt
è™->Ãxt->
´ev
 = it->prev;

753 ià(
™
->
´ev
è™->´ev->
Ãxt
 = it->next;

754 
s_şs
->
¦_cu¼
--;

755 
	}
}

757 
	emove_¡©us
 {

758 
	mMOVE_PASS
=0, 
	mMOVE_FROM_SLAB
, 
	mMOVE_FROM_LRU
, 
	mMOVE_BUSY
, 
	mMOVE_LOCKED


778 
	$¦ab_»b®ªû_move
() {

779 
¦abşass_t
 *
s_şs
;

780 
x
;

781 
was_busy
 = 0;

782 
»fcouÁ
 = 0;

783 
ušt32_t
 
hv
;

784 *
hŞd_lock
;

785 
move_¡©us
 
¡©us
 = 
MOVE_PASS
;

787 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

789 
s_şs
 = &
¦abşass
[
¦ab_»b®
.
s_şsid
];

791 
x
 = 0; x < 
¦ab_bulk_check
; x++) {

792 
hv
 = 0;

793 
hŞd_lock
 = 
NULL
;

794 
™em
 *
™
 = 
¦ab_»b®
.
¦ab_pos
;

795 
™em_chunk
 *
ch
 = 
NULL
;

796 
¡©us
 = 
MOVE_PASS
;

797 ià(
™
->
™_æags
 & 
ITEM_CHUNK
) {

799 
ch
 = (
™em_chunk
 *è
™
;

803 
™
 = 
ch
->
h—d
;

804 
	`as£¹
(
™
->
™_æags
 & 
ITEM_CHUNKED
);

810 ià(
™
->
™_æags
 !ğ(
ITEM_SLABBED
|
ITEM_FETCHED
)) {

812 ià(
™
->
™_æags
 & 
ITEM_SLABBED
) {

813 
	`as£¹
(
ch
 =ğ
NULL
);

814 
	`¦ab_»b®ªû_cut_ä“
(
s_şs
, 
™
);

815 
¡©us
 = 
MOVE_FROM_SLAB
;

816 } ià((
™
->
™_æags
 & 
ITEM_LINKED
) != 0) {

822 
hv
 = 
	`hash
(
	`ITEM_key
(
™
), it->
nkey
);

823 ià((
hŞd_lock
 = 
	`™em_Œylock
(
hv
)è=ğ
NULL
) {

824 
¡©us
 = 
MOVE_LOCKED
;

826 
»fcouÁ
 = 
	`»fcouÁ_šü
(&
™
->refcount);

827 ià(
»fcouÁ
 == 2) {

830 ià((
™
->
™_æags
 & 
ITEM_LINKED
) != 0) {

831 
¡©us
 = 
MOVE_FROM_LRU
;

836 
¡©us
 = 
MOVE_BUSY
;

839 ià(
£‰šgs
.
v”bo£
 > 2) {

840 
	`årštf
(
¡d”r
, "Slab„eassign hit‡ busy item:„efcount: %d (%d -> %d)\n",

841 
™
->
»fcouÁ
, 
¦ab_»b®
.
s_şsid
, sÏb_»b®.
d_şsid
);

843 
¡©us
 = 
MOVE_BUSY
;

846 ià(
¡©us
 =ğ
MOVE_BUSY
) {

847 
	`»fcouÁ_deü
(&
™
->
»fcouÁ
);

848 
	`™em_Œylock_uÆock
(
hŞd_lock
);

854 
¡©us
 = 
MOVE_BUSY
;

858 
§ve_™em
 = 0;

859 
™em
 *
Ãw_™
 = 
NULL
;

860 
size_t
 
ÁÙ®
 = 0;

861 
¡©us
) {

862 
MOVE_FROM_LRU
:

870 
ÁÙ®
 = 
	`ITEM_ÁÙ®
(
™
);

872 ià(
ch
 =ğ
NULL
 && (
™
->
™_æags
 & 
ITEM_CHUNKED
)) {

875 
ÁÙ®
 = 
s_şs
->
size
;

877 ià((
™
->
ex±ime
 !ğ0 && it->ex±im< 
cu¼’t_time
)

878 || 
	`™em_is_æushed
(
™
)) {

880 
§ve_™em
 = 0;

881 } ià(
ch
 =ğ
NULL
 &&

882 (
Ãw_™
 = 
	`¦ab_»b®ªû_®loc
(
ÁÙ®
, 
¦ab_»b®
.
s_şsid
)è=ğ
NULL
) {

884 
§ve_™em
 = 0;

885 
¦ab_»b®
.
eviùiÚs_nomem
++;

886 } ià(
ch
 !ğ
NULL
 &&

887 (
Ãw_™
 = 
	`¦ab_»b®ªû_®loc
(
s_şs
->
size
, 
¦ab_»b®
.
s_şsid
)è=ğ
NULL
) {

889 
§ve_™em
 = 0;

890 
¦ab_»b®
.
eviùiÚs_nomem
++;

893 
§ve_™em
 = 1;

895 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

896 
»que¡ed_adju¡
 = 0;

897 ià(
§ve_™em
) {

898 ià(
ch
 =ğ
NULL
) {

899 
	`as£¹
((
Ãw_™
->
™_æags
 & 
ITEM_CHUNKED
) == 0);

901 
	`memıy
(
Ãw_™
, 
™
, 
ÁÙ®
);

902 
Ãw_™
->
´ev
 = 0;

903 
Ãw_™
->
Ãxt
 = 0;

904 
Ãw_™
->
h_Ãxt
 = 0;

906 
Ãw_™
->
™_æags
 &ğ~
ITEM_LINKED
;

907 
Ãw_™
->
»fcouÁ
 = 0;

908 
	`do_™em_»¶aû
(
™
, 
Ãw_™
, 
hv
);

910 ià(
Ãw_™
->
™_æags
 & 
ITEM_CHUNKED
) {

911 
™em_chunk
 *
fch
 = (™em_chunk *è
	`ITEM_d©a
(
Ãw_™
);

912 
fch
->
Ãxt
->
´ev
 = fch;

913 
fch
) {

914 
fch
->
h—d
 = 
Ãw_™
;

915 
fch
 = fch->
Ãxt
;

918 
™
->
»fcouÁ
 = 0;

919 
™
->
™_æags
 = 
ITEM_SLABBED
|
ITEM_FETCHED
;

920 #ifdeà
DEBUG_SLAB_MOVER


921 
	`memıy
(
	`ITEM_key
(
™
), "deadbeef", 8);

923 
¦ab_»b®
.
»scues
++;

924 
»que¡ed_adju¡
 = 
ÁÙ®
;

926 
™em_chunk
 *
nch
 = (™em_chunk *è
Ãw_™
;

928 
ch
->
´ev
->
Ãxt
 = 
nch
;

929 ià(
ch
->
Ãxt
)

930 
ch
->
Ãxt
->
´ev
 = 
nch
;

931 
	`memıy
(
nch
, 
ch
, ch->
u£d
 + (
™em_chunk
));

932 
ch
->
»fcouÁ
 = 0;

933 
ch
->
™_æags
 = 
ITEM_SLABBED
|
ITEM_FETCHED
;

934 
¦ab_»b®
.
chunk_»scues
++;

935 #ifdeà
DEBUG_SLAB_MOVER


936 
	`memıy
(
	`ITEM_key
((
™em
 *)
ch
), "deadbeef", 8);

938 
	`»fcouÁ_deü
(&
™
->
»fcouÁ
);

939 
»que¡ed_adju¡
 = 
s_şs
->
size
;

943 
ÁÙ®
 = 
	`ITEM_ÁÙ®
(
™
);

944 
	`do_™em_uÆšk
(
™
, 
hv
);

945 
	`¦abs_ä“
(
™
, 
ÁÙ®
, 
¦ab_»b®
.
s_şsid
);

947 
¦ab_»b®
.
busy_™ems
++;

948 
was_busy
++;

950 
	`™em_Œylock_uÆock
(
hŞd_lock
);

951 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

955 
s_şs
->
»que¡ed
 -ğ
»que¡ed_adju¡
;

957 
MOVE_FROM_SLAB
:

958 
™
->
»fcouÁ
 = 0;

959 
™
->
™_æags
 = 
ITEM_SLABBED
|
ITEM_FETCHED
;

960 #ifdeà
DEBUG_SLAB_MOVER


961 
	`memıy
(
	`ITEM_key
(
™
), "deadbeef", 8);

964 
MOVE_BUSY
:

965 
MOVE_LOCKED
:

966 
¦ab_»b®
.
busy_™ems
++;

967 
was_busy
++;

969 
MOVE_PASS
:

973 
¦ab_»b®
.
¦ab_pos
 = (*)¦ab_»b®.¦ab_po + 
s_şs
->
size
;

974 ià(
¦ab_»b®
.
¦ab_pos
 >ğ¦ab_»b®.
¦ab_’d
)

978 ià(
¦ab_»b®
.
¦ab_pos
 >ğ¦ab_»b®.
¦ab_’d
) {

980 ià(
¦ab_»b®
.
busy_™ems
) {

981 
¦ab_»b®
.
¦ab_pos
 = sÏb_»b®.
¦ab_¡¬t
;

982 
	`STATS_LOCK
();

983 
¡©s
.
¦ab_»assign_busy_™ems
 +ğ
¦ab_»b®
.
busy_™ems
;

984 
	`STATS_UNLOCK
();

985 
¦ab_»b®
.
busy_™ems
 = 0;

987 
¦ab_»b®
.
dÚe
++;

991 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

993  
was_busy
;

994 
	}
}

996 
	$¦ab_»b®ªû_fšish
() {

997 
¦abşass_t
 *
s_şs
;

998 
¦abşass_t
 *
d_şs
;

999 
x
;

1000 
ušt32_t
 
»scues
;

1001 
ušt32_t
 
eviùiÚs_nomem
;

1002 
ušt32_t
 
šlše_»şaim
;

1003 
ušt32_t
 
chunk_»scues
;

1005 
	`±h»ad_mu‹x_lock
(&
¦abs_lock
);

1007 
s_şs
 = &
¦abşass
[
¦ab_»b®
.
s_şsid
];

1008 
d_şs
 = &
¦abşass
[
¦ab_»b®
.
d_şsid
];

1010 #ifdeà
DEBUG_SLAB_MOVER


1012 
¦ab_»b®
.
¦ab_pos
 = sÏb_»b®.
¦ab_¡¬t
;

1014 
™em
 *
™
 = 
¦ab_»b®
.
¦ab_pos
;

1015 
	`as£¹
(
™
->
™_æags
 =ğ(
ITEM_SLABBED
|
ITEM_FETCHED
));

1016 
	`as£¹
(
	`memcmp
(
	`ITEM_key
(
™
), "deadbeef", 8) == 0);

1017 
™
->
™_æags
 = 
ITEM_SLABBED
|
ITEM_FETCHED
;

1018 
¦ab_»b®
.
¦ab_pos
 = (*)¦ab_»b®.¦ab_po + 
s_şs
->
size
;

1019 ià(
¦ab_»b®
.
¦ab_pos
 >ğ¦ab_»b®.
¦ab_’d
)

1028 
s_şs
->
¦abs
--;

1029 
x
 = 0; x < 
s_şs
->
¦abs
; x++) {

1030 
s_şs
->
¦ab_li¡
[
x
] = s_cls->slab_list[x+1];

1033 
d_şs
->
¦ab_li¡
[d_şs->
¦abs
++] = 
¦ab_»b®
.
¦ab_¡¬t
;

1035 ià(
¦ab_»b®
.
d_şsid
 > 
SLAB_GLOBAL_PAGE_POOL
) {

1036 
	`mem£t
(
¦ab_»b®
.
¦ab_¡¬t
, 0, (
size_t
)
£‰šgs
.
™em_size_max
);

1037 
	`¥l™_¦ab_·ge_što_ä“li¡
(
¦ab_»b®
.
¦ab_¡¬t
,

1038 
¦ab_»b®
.
d_şsid
);

1039 } ià(
¦ab_»b®
.
d_şsid
 =ğ
SLAB_GLOBAL_PAGE_POOL
) {

1041 
	`memÜy_»Ëa£
();

1044 
¦ab_»b®
.
dÚe
 = 0;

1045 
¦ab_»b®
.
s_şsid
 = 0;

1046 
¦ab_»b®
.
d_şsid
 = 0;

1047 
¦ab_»b®
.
¦ab_¡¬t
 = 
NULL
;

1048 
¦ab_»b®
.
¦ab_’d
 = 
NULL
;

1049 
¦ab_»b®
.
¦ab_pos
 = 
NULL
;

1050 
eviùiÚs_nomem
 = 
¦ab_»b®
.evictions_nomem;

1051 
šlše_»şaim
 = 
¦ab_»b®
.inline_reclaim;

1052 
»scues
 = 
¦ab_»b®
.rescues;

1053 
chunk_»scues
 = 
¦ab_»b®
.chunk_rescues;

1054 
¦ab_»b®
.
eviùiÚs_nomem
 = 0;

1055 
¦ab_»b®
.
šlše_»şaim
 = 0;

1056 
¦ab_»b®
.
»scues
 = 0;

1058 
¦ab_»b®ªû_sigÇl
 = 0;

1060 
	`±h»ad_mu‹x_uÆock
(&
¦abs_lock
);

1062 
	`STATS_LOCK
();

1063 
¡©s
.
¦abs_moved
++;

1064 
¡©s
.
¦ab_»assign_»scues
 +ğ
»scues
;

1065 
¡©s
.
¦ab_»assign_eviùiÚs_nomem
 +ğ
eviùiÚs_nomem
;

1066 
¡©s
.
¦ab_»assign_šlše_»şaim
 +ğ
šlše_»şaim
;

1067 
¡©s
.
¦ab_»assign_chunk_»scues
 +ğ
chunk_»scues
;

1068 
¡©s_¡©e
.
¦ab_»assign_ruÂšg
 = 
çl£
;

1069 
	`STATS_UNLOCK
();

1071 ià(
£‰šgs
.
v”bo£
 > 1) {

1072 
	`årštf
(
¡d”r
, "finished‡ slab move\n");

1074 
	}
}

1079 *
	$¦ab_»b®ªû_th»ad
(*
¬g
) {

1080 
was_busy
 = 0;

1082 
	`mu‹x_lock
(&
¦abs_»b®ªû_lock
);

1084 
do_run_¦ab_»b®ªû_th»ad
) {

1085 ià(
¦ab_»b®ªû_sigÇl
 == 1) {

1086 ià(
	`¦ab_»b®ªû_¡¬t
() < 0) {

1088 
¦ab_»b®ªû_sigÇl
 = 0;

1091 
was_busy
 = 0;

1092 } ià(
¦ab_»b®ªû_sigÇl
 && 
¦ab_»b®
.
¦ab_¡¬t
 !ğ
NULL
) {

1093 
was_busy
 = 
	`¦ab_»b®ªû_move
();

1096 ià(
¦ab_»b®
.
dÚe
) {

1097 
	`¦ab_»b®ªû_fšish
();

1098 } ià(
was_busy
) {

1101 
	`u¦“p
(50);

1104 ià(
¦ab_»b®ªû_sigÇl
 == 0) {

1106 
	`±h»ad_cÚd_wa™
(&
¦ab_»b®ªû_cÚd
, &
¦abs_»b®ªû_lock
);

1109  
NULL
;

1110 
	}
}

1116 
	$¦abs_»assign_pick_ªy
(
d¡
) {

1117 
cur
 = 
POWER_SMALLEST
 - 1;

1118 
Œ›s
 = 
pow”_Ïrge¡
 - 
POWER_SMALLEST
 + 1;

1119 ; 
Œ›s
 > 0;ries--) {

1120 
cur
++;

1121 ià(
cur
 > 
pow”_Ïrge¡
)

1122 
cur
 = 
POWER_SMALLEST
;

1123 ià(
cur
 =ğ
d¡
)

1125 ià(
¦abşass
[
cur
].
¦abs
 > 1) {

1126  
cur
;

1130 
	}
}

1132 
»assign_»suÉ_ty³
 
	$do_¦abs_»assign
(
¤c
, 
d¡
) {

1133 ià(
¦ab_»b®ªû_sigÇl
 != 0)

1134  
REASSIGN_RUNNING
;

1136 ià(
¤c
 =ğ
d¡
)

1137  
REASSIGN_SRC_DST_SAME
;

1140 ià(
¤c
 == -1) {

1141 
¤c
 = 
	`¦abs_»assign_pick_ªy
(
d¡
);

1145 ià(
¤c
 < 
POWER_SMALLEST
 || srø> 
pow”_Ïrge¡
 ||

1146 
d¡
 < 
SLAB_GLOBAL_PAGE_POOL
 || d¡ > 
pow”_Ïrge¡
)

1147  
REASSIGN_BADCLASS
;

1149 ià(
¦abşass
[
¤c
].
¦abs
 < 2)

1150  
REASSIGN_NOSPARE
;

1152 
¦ab_»b®
.
s_şsid
 = 
¤c
;

1153 
¦ab_»b®
.
d_şsid
 = 
d¡
;

1155 
¦ab_»b®ªû_sigÇl
 = 1;

1156 
	`±h»ad_cÚd_sigÇl
(&
¦ab_»b®ªû_cÚd
);

1158  
REASSIGN_OK
;

1159 
	}
}

1161 
»assign_»suÉ_ty³
 
	$¦abs_»assign
(
¤c
, 
d¡
) {

1162 
»assign_»suÉ_ty³
 
»t
;

1163 ià(
	`±h»ad_mu‹x_Œylock
(&
¦abs_»b®ªû_lock
) != 0) {

1164  
REASSIGN_RUNNING
;

1166 
»t
 = 
	`do_¦abs_»assign
(
¤c
, 
d¡
);

1167 
	`±h»ad_mu‹x_uÆock
(&
¦abs_»b®ªû_lock
);

1168  
»t
;

1169 
	}
}

1172 
	$¦abs_»b®ªûr_·u£
() {

1173 
	`±h»ad_mu‹x_lock
(&
¦abs_»b®ªû_lock
);

1174 
	}
}

1176 
	$¦abs_»b®ªûr_»sume
() {

1177 
	`±h»ad_mu‹x_uÆock
(&
¦abs_»b®ªû_lock
);

1178 
	}
}

1180 
±h»ad_t
 
	g»b®ªû_tid
;

1182 
	$¡¬t_¦ab_maš‹Çnû_th»ad
() {

1183 
»t
;

1184 
¦ab_»b®ªû_sigÇl
 = 0;

1185 
¦ab_»b®
.
¦ab_¡¬t
 = 
NULL
;

1186 *
’v
 = 
	`g‘’v
("MEMCACHED_SLAB_BULK_CHECK");

1187 ià(
’v
 !ğ
NULL
) {

1188 
¦ab_bulk_check
 = 
	`©oi
(
’v
);

1189 ià(
¦ab_bulk_check
 == 0) {

1190 
¦ab_bulk_check
 = 
DEFAULT_SLAB_BULK_CHECK
;

1194 ià(
	`±h»ad_cÚd_š™
(&
¦ab_»b®ªû_cÚd
, 
NULL
) != 0) {

1195 
	`årštf
(
¡d”r
, "Can't intiialize„ebalance condition\n");

1198 
	`±h»ad_mu‹x_š™
(&
¦abs_»b®ªû_lock
, 
NULL
);

1200 ià((
»t
 = 
	`±h»ad_ü—‹
(&
»b®ªû_tid
, 
NULL
,

1201 
¦ab_»b®ªû_th»ad
, 
NULL
)) != 0) {

1202 
	`årštf
(
¡d”r
, "Cª'ˆü—‹„eb®h»ad: %s\n", 
	`¡»¼Ü
(
»t
));

1206 
	}
}

1210 
	$¡İ_¦ab_maš‹Çnû_th»ad
() {

1211 
	`mu‹x_lock
(&
¦abs_»b®ªû_lock
);

1212 
do_run_¦ab_th»ad
 = 0;

1213 
do_run_¦ab_»b®ªû_th»ad
 = 0;

1214 
	`±h»ad_cÚd_sigÇl
(&
¦ab_»b®ªû_cÚd
);

1215 
	`±h»ad_mu‹x_uÆock
(&
¦abs_»b®ªû_lock
);

1218 
	`±h»ad_još
(
»b®ªû_tid
, 
NULL
);

1219 
	}
}

	@slabs.h

2 #iâdeà
SLABS_H


3 
	#SLABS_H


	)

11 
¦abs_š™
(cÚ¡ 
size_t
 
lim™
, cÚ¡ 
çùÜ
, cÚ¡ 
boŞ
 
´—Îoc
, cÚ¡ 
ušt32_t
 *
¦ab_sizes
);

19 
¦abs_şsid
(cÚ¡ 
size_t
 
size
);

22 
	#SLABS_ALLOC_NO_NEWPAGE
 1

	)

23 *
¦abs_®loc
(cÚ¡ 
size_t
 
size
, 
id
, 
ušt64_t
 *
tÙ®_by‹s
, 
æags
);

26 
¦abs_ä“
(*
±r
, 
size_t
 
size
, 
id
);

29 
¦abs_adju¡_mem_»que¡ed
(
id
, 
size_t
 
Şd
, size_ˆ
ÁÙ®
);

32 
boŞ
 
¦abs_adju¡_mem_lim™
(
size_t
 
Ãw_mem_lim™
);

35 
boŞ
 
g‘_¡©s
(cÚ¡ *
¡©_ty³
, 
nkey
, 
ADD_STAT
 
add_¡©s
, *
c
);

38 
¦abs_¡©s
(
ADD_STAT
 
add_¡©s
, *
c
);

41 
¦abs_avaabË_chunks
(
id
, 
boŞ
 *
mem_æag
, 
ušt64_t
 *
tÙ®_by‹s
, *
chunks_³r¦ab
);

43 
¡¬t_¦ab_maš‹Çnû_th»ad
();

44 
¡İ_¦ab_maš‹Çnû_th»ad
();

46 
	e»assign_»suÉ_ty³
 {

47 
	mREASSIGN_OK
=0, 
	mREASSIGN_RUNNING
, 
	mREASSIGN_BADCLASS
, 
	mREASSIGN_NOSPARE
,

48 
	mREASSIGN_SRC_DST_SAME


51 
»assign_»suÉ_ty³
 
¦abs_»assign
(
¤c
, 
d¡
);

53 
¦abs_»b®ªûr_·u£
();

54 
¦abs_»b®ªûr_»sume
();

	@solaris_priv.c

1 
	~<¡dlib.h
>

2 
	~<´iv.h
>

3 
	~<¡dio.h
>

4 
	~"memÿched.h
"

12 
	$drİ_´iveges
() {

13 
´iv_£t_t
 *
´ivs
 = 
	`´iv_¡r_to_£t
("basic", ",", 
NULL
);

15 ià(
´ivs
 =ğ
NULL
) {

16 
	`³¼Ü
("priv_str_to_set");

17 
	`ex™
(
EXIT_FAILURE
);

20 ()
	`´iv_d–£t
(
´ivs
, 
PRIV_FILE_LINK_ANY
);

21 ()
	`´iv_d–£t
(
´ivs
, 
PRIV_PROC_EXEC
);

22 ()
	`´iv_d–£t
(
´ivs
, 
PRIV_PROC_FORK
);

23 ()
	`´iv_d–£t
(
´ivs
, 
PRIV_PROC_INFO
);

24 ()
	`´iv_d–£t
(
´ivs
, 
PRIV_PROC_SESSION
);

26 ià(
	`£´iv
(
PRIV_SET
, 
PRIV_PERMITTED
, 
´ivs
) != 0) {

27 
	`³¼Ü
("setppriv(PRIV_SET, PRIV_PERMITTED)");

28 
	`ex™
(
EXIT_FAILURE
);

31 
	`´iv_em±y£t
(
´ivs
);

33 ià(
	`£´iv
(
PRIV_SET
, 
PRIV_INHERITABLE
, 
´ivs
) != 0) {

34 
	`³¼Ü
("setppriv(PRIV_SET, PRIV_INHERITABLE)");

35 
	`ex™
(
EXIT_FAILURE
);

38 ià(
	`£´iv
(
PRIV_SET
, 
PRIV_LIMIT
, 
´ivs
) != 0) {

39 
	`³¼Ü
("setppriv(PRIV_SET, PRIV_LIMIT)");

40 
	`ex™
(
EXIT_FAILURE
);

43 
	`´iv_ä“£t
(
´ivs
);

44 
	}
}

	@stats.c

10 
	~"memÿched.h
"

11 
	~<¡dio.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

14 
	~<as£¹.h
>

21 
_´efix_¡©s
 
	tPREFIX_STATS
;

22 
	s_´efix_¡©s
 {

23 *
	m´efix
;

24 
size_t
 
	m´efix_Ën
;

25 
ušt64_t
 
	mnum_g‘s
;

26 
ušt64_t
 
	mnum_£ts
;

27 
ušt64_t
 
	mnum_d–‘es
;

28 
ušt64_t
 
	mnum_h™s
;

29 
PREFIX_STATS
 *
	mÃxt
;

32 
	#PREFIX_HASH_SIZE
 256

	)

34 
PREFIX_STATS
 *
	g´efix_¡©s
[
PREFIX_HASH_SIZE
];

35 
	gnum_´efixes
 = 0;

36 
	gtÙ®_´efix_size
 = 0;

38 
	$¡©s_´efix_š™
() {

39 
	`mem£t
(
´efix_¡©s
, 0, (prefix_stats));

40 
	}
}

46 
	$¡©s_´efix_ş—r
() {

47 
i
;

49 
i
 = 0; i < 
PREFIX_HASH_SIZE
; i++) {

50 
PREFIX_STATS
 *
cur
, *
Ãxt
;

51 
cur
 = 
´efix_¡©s
[
i
]; cu¸!ğ
NULL
; cu¸ğ
Ãxt
) {

52 
Ãxt
 = 
cur
->next;

53 
	`ä“
(
cur
->
´efix
);

54 
	`ä“
(
cur
);

56 
´efix_¡©s
[
i
] = 
NULL
;

58 
num_´efixes
 = 0;

59 
tÙ®_´efix_size
 = 0;

60 
	}
}

67 
PREFIX_STATS
 *
	$¡©s_´efix_fšd
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
) {

68 
PREFIX_STATS
 *
pfs
;

69 
ušt32_t
 
hashv®
;

70 
size_t
 
Ëngth
;

71 
boŞ
 
baout
 = 
Œue
;

73 
	`as£¹
(
key
 !ğ
NULL
);

75 
Ëngth
 = 0;†’gth < 
nkey
 && 
key
[length] != '\0';†ength++) {

76 ià(
key
[
Ëngth
] =ğ
£‰šgs
.
´efix_d–im™”
) {

77 
baout
 = 
çl£
;

82 ià(
baout
) {

83  
NULL
;

86 
hashv®
 = 
	`hash
(
key
, 
Ëngth
è% 
PREFIX_HASH_SIZE
;

88 
pfs
 = 
´efix_¡©s
[
hashv®
]; 
NULL
 !ğpfs;…f ğpfs->
Ãxt
) {

89 ià(
	`¡ºcmp
(
pfs
->
´efix
, 
key
, 
Ëngth
) == 0)

90  
pfs
;

93 
pfs
 = 
	`ÿÎoc
((
PREFIX_STATS
), 1);

94 ià(
NULL
 =ğ
pfs
) {

95 
	`³¼Ü
("Can't‡llocate space for stats structure: calloc");

96  
NULL
;

99 
pfs
->
´efix
 = 
	`m®loc
(
Ëngth
 + 1);

100 ià(
NULL
 =ğ
pfs
->
´efix
) {

101 
	`³¼Ü
("Can't‡llocate space for copy of…refix: malloc");

102 
	`ä“
(
pfs
);

103  
NULL
;

106 
	`¡ºıy
(
pfs
->
´efix
, 
key
, 
Ëngth
);

107 
pfs
->
´efix
[
Ëngth
] = '\0';

108 
pfs
->
´efix_Ën
 = 
Ëngth
;

110 
pfs
->
Ãxt
 = 
´efix_¡©s
[
hashv®
];

111 
´efix_¡©s
[
hashv®
] = 
pfs
;

113 
num_´efixes
++;

114 
tÙ®_´efix_size
 +ğ
Ëngth
;

116  
pfs
;

117 
	}
}

122 
	$¡©s_´efix_»cÜd_g‘
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
boŞ
 
is_h™
) {

123 
PREFIX_STATS
 *
pfs
;

125 
	`STATS_LOCK
();

126 
pfs
 = 
	`¡©s_´efix_fšd
(
key
, 
nkey
);

127 ià(
NULL
 !ğ
pfs
) {

128 
pfs
->
num_g‘s
++;

129 ià(
is_h™
) {

130 
pfs
->
num_h™s
++;

133 
	`STATS_UNLOCK
();

134 
	}
}

139 
	$¡©s_´efix_»cÜd_d–‘e
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
) {

140 
PREFIX_STATS
 *
pfs
;

142 
	`STATS_LOCK
();

143 
pfs
 = 
	`¡©s_´efix_fšd
(
key
, 
nkey
);

144 ià(
NULL
 !ğ
pfs
) {

145 
pfs
->
num_d–‘es
++;

147 
	`STATS_UNLOCK
();

148 
	}
}

153 
	$¡©s_´efix_»cÜd_£t
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
) {

154 
PREFIX_STATS
 *
pfs
;

156 
	`STATS_LOCK
();

157 
pfs
 = 
	`¡©s_´efix_fšd
(
key
, 
nkey
);

158 ià(
NULL
 !ğ
pfs
) {

159 
pfs
->
num_£ts
++;

161 
	`STATS_UNLOCK
();

162 
	}
}

168 *
	$¡©s_´efix_dump
(*
Ëngth
) {

169 cÚ¡ *
fÜm©
 = "PREFIX %s get %llu hit %llu set %llu del %llu\r\n";

170 
PREFIX_STATS
 *
pfs
;

171 *
buf
;

172 
i
, 
pos
;

173 
size_t
 
size
 = 0, 
wr™‹n
 = 0, 
tÙ®_wr™‹n
 = 0;

181 
	`STATS_LOCK
();

182 
size
 = 
	`¡¾’
(
fÜm©
è+ 
tÙ®_´efix_size
 +

183 
num_´efixes
 * (
	`¡¾’
(
fÜm©
) - 2

186 
buf
 = 
	`m®loc
(
size
);

187 ià(
NULL
 =ğ
buf
) {

188 
	`³¼Ü
("Can't‡llocate stats„esponse: malloc");

189 
	`STATS_UNLOCK
();

190  
NULL
;

193 
pos
 = 0;

194 
i
 = 0; i < 
PREFIX_HASH_SIZE
; i++) {

195 
pfs
 = 
´efix_¡©s
[
i
]; 
NULL
 !ğpfs;…f ğpfs->
Ãxt
) {

196 
wr™‹n
 = 
	`¢´štf
(
buf
 + 
pos
, 
size
-pos, 
fÜm©
,

197 
pfs
->
´efix
,…fs->
num_g‘s
,…fs->
num_h™s
,

198 
pfs
->
num_£ts
,…fs->
num_d–‘es
);

199 
pos
 +ğ
wr™‹n
;

200 
tÙ®_wr™‹n
 +ğ
wr™‹n
;

201 
	`as£¹
(
tÙ®_wr™‹n
 < 
size
);

205 
	`STATS_UNLOCK
();

206 
	`memıy
(
buf
 + 
pos
, "END\r\n", 6);

208 *
Ëngth
 = 
pos
 + 5;

209  
buf
;

210 
	}
}

213 #ifdeà
UNIT_TEST


220 
£‰šgs
 
	g£‰šgs
;

222 *
	gcu¼’t_‹¡
 = "";

223 
	g‹¡_couÁ
 = 0;

224 
	gç_couÁ
 = 0;

226 
	$ç
(*
wh©
è{ 
	`´štf
("\tFAIL: %s\n", wh©); 
	`fæush
(
¡dout
); 
ç_couÁ
++; 
	}
}

227 
	$‹¡_equ®s_št
(*
wh©
, 
a
, 
b
è{ 
‹¡_couÁ
++; ià× !ğbè
	`ç
(wh©); 
	}
}

228 
	$‹¡_equ®s_±r
(*
wh©
, *
a
, *
b
è{ 
‹¡_couÁ
++; ià× !ğbè
	`ç
(wh©); 
	}
}

229 
	$‹¡_equ®s_¡r
(*
wh©
, cÚ¡ *
a
, cÚ¡ *
b
è{ 
‹¡_couÁ
++; ià(
	`¡rcmp
×, b)è
	`ç
(wh©); 
	}
}

230 
	$‹¡_equ®s_uÎ
(*
wh©
, 
ušt64_t
 
a
, ušt64_ˆ
b
è{ 
‹¡_couÁ
++; ià× !ğbè
	`ç
(wh©); 
	}
}

231 
	$‹¡_nÙequ®s_±r
(*
wh©
, *
a
, *
b
è{ 
‹¡_couÁ
++; ià× =ğbè
	`ç
(wh©); 
	}
}

232 
	$‹¡_nÙnuÎ_±r
(*
wh©
, *
a
è{ 
‹¡_couÁ
++; ià(
NULL
 =ğaè
	`ç
(wh©); 
	}
}

234 
	$‹¡_´efix_fšd
() {

235 
PREFIX_STATS
 *
pfs1
, *
pfs2
;

237 
pfs1
 = 
	`¡©s_´efix_fšd
("abc");

238 
	`‹¡_nÙnuÎ_±r
("š™ŸÈ´efix fšd", 
pfs1
);

239 
	`‹¡_equ®s_uÎ
("request counts", 0ULL,

240 
pfs1
->
num_g‘s
 +…fs1->
num_£ts
 +…fs1->
num_d–‘es
 +…fs1->
num_h™s
);

241 
pfs2
 = 
	`¡©s_´efix_fšd
("abc");

242 
	`‹¡_equ®s_±r
("fšd oà§m´efix", 
pfs1
, 
pfs2
);

243 
pfs2
 = 
	`¡©s_´efix_fšd
("abc:");

244 
	`‹¡_equ®s_±r
("fšd oà§m´efix, ignÜšg d–im™”", 
pfs1
, 
pfs2
);

245 
pfs2
 = 
	`¡©s_´efix_fšd
("abc:d");

246 
	`‹¡_equ®s_±r
("fšd oà§m´efix, ignÜšgƒxŒ¨ch¬s", 
pfs1
, 
pfs2
);

247 
pfs2
 = 
	`¡©s_´efix_fšd
("xyz123");

248 
	`‹¡_nÙequ®s_±r
("fšd oàdifã»Á…»fix", 
pfs1
, 
pfs2
);

249 
pfs2
 = 
	`¡©s_´efix_fšd
("ab:");

250 
	`‹¡_nÙequ®s_±r
("fšd oàshÜ‹¸´efix", 
pfs1
, 
pfs2
);

251 
	}
}

253 
	$‹¡_´efix_»cÜd_g‘
() {

254 
PREFIX_STATS
 *
pfs
;

256 
	`¡©s_´efix_»cÜd_g‘
("abc:123", 0);

257 
pfs
 = 
	`¡©s_´efix_fšd
("abc:123");

258 
	`‹¡_equ®s_uÎ
("g‘ couÁ‡á” g‘ #1", 1, 
pfs
->
num_g‘s
);

259 
	`‹¡_equ®s_uÎ
("h™ couÁ‡á” g‘ #1", 0, 
pfs
->
num_h™s
);

260 
	`¡©s_´efix_»cÜd_g‘
("abc:456", 0);

261 
	`‹¡_equ®s_uÎ
("g‘ couÁ‡á” g‘ #2", 2, 
pfs
->
num_g‘s
);

262 
	`‹¡_equ®s_uÎ
("h™ couÁ‡á” g‘ #2", 0, 
pfs
->
num_h™s
);

263 
	`¡©s_´efix_»cÜd_g‘
("abc:456", 1);

264 
	`‹¡_equ®s_uÎ
("g‘ couÁ‡á” g‘ #3", 3, 
pfs
->
num_g‘s
);

265 
	`‹¡_equ®s_uÎ
("h™ couÁ‡á” g‘ #3", 1, 
pfs
->
num_h™s
);

266 
	`¡©s_´efix_»cÜd_g‘
("def:", 1);

267 
	`‹¡_equ®s_uÎ
("g‘ couÁ‡á” g‘ #4", 3, 
pfs
->
num_g‘s
);

268 
	`‹¡_equ®s_uÎ
("h™ couÁ‡á” g‘ #4", 1, 
pfs
->
num_h™s
);

269 
	}
}

271 
	$‹¡_´efix_»cÜd_d–‘e
() {

272 
PREFIX_STATS
 *
pfs
;

274 
	`¡©s_´efix_»cÜd_d–‘e
("abc:123");

275 
pfs
 = 
	`¡©s_´efix_fšd
("abc:123");

276 
	`‹¡_equ®s_uÎ
("g‘ couÁ‡á” d–‘#1", 0, 
pfs
->
num_g‘s
);

277 
	`‹¡_equ®s_uÎ
("h™ couÁ‡á” d–‘#1", 0, 
pfs
->
num_h™s
);

278 
	`‹¡_equ®s_uÎ
("d–‘couÁ‡á” d–‘#1", 1, 
pfs
->
num_d–‘es
);

279 
	`‹¡_equ®s_uÎ
("£ˆcouÁ‡á” d–‘#1", 0, 
pfs
->
num_£ts
);

280 
	`¡©s_´efix_»cÜd_d–‘e
("def:");

281 
	`‹¡_equ®s_uÎ
("d–‘couÁ‡á” d–‘#2", 1, 
pfs
->
num_d–‘es
);

282 
	}
}

284 
	$‹¡_´efix_»cÜd_£t
() {

285 
PREFIX_STATS
 *
pfs
;

287 
	`¡©s_´efix_»cÜd_£t
("abc:123");

288 
pfs
 = 
	`¡©s_´efix_fšd
("abc:123");

289 
	`‹¡_equ®s_uÎ
("g‘ couÁ‡á” s‘ #1", 0, 
pfs
->
num_g‘s
);

290 
	`‹¡_equ®s_uÎ
("h™ couÁ‡á” s‘ #1", 0, 
pfs
->
num_h™s
);

291 
	`‹¡_equ®s_uÎ
("d–‘couÁ‡á” s‘ #1", 0, 
pfs
->
num_d–‘es
);

292 
	`‹¡_equ®s_uÎ
("£ˆcouÁ‡á” s‘ #1", 1, 
pfs
->
num_£ts
);

293 
	`¡©s_´efix_»cÜd_d–‘e
("def:");

294 
	`‹¡_equ®s_uÎ
("£ˆcouÁ‡á” s‘ #2", 1, 
pfs
->
num_£ts
);

295 
	}
}

297 
	$‹¡_´efix_dump
() {

298 
hashv®
 = 
	`hash
("abc", 3è% 
PREFIX_HASH_SIZE
;

299 
tmp
[500];

300 *
ex³ùed
;

301 
keynum
;

302 
Ëngth
;

304 
	`‹¡_equ®s_¡r
("em±y sts", "END\r\n", 
	`¡©s_´efix_dump
(&
Ëngth
));

305 
	`‹¡_equ®s_št
("em±y st Ëngth", 5, 
Ëngth
);

306 
	`¡©s_´efix_»cÜd_£t
("abc:123");

307 
ex³ùed
 = "PREFIX‡bc get 0 hit 0 set 1 del 0\r\nEND\r\n";

308 
	`‹¡_equ®s_¡r
("¡© aá” s‘", 
ex³ùed
, 
	`¡©s_´efix_dump
(&
Ëngth
));

309 
	`‹¡_equ®s_št
("¡© Ëngth‡á” s‘", 
	`¡¾’
(
ex³ùed
), 
Ëngth
);

310 
	`¡©s_´efix_»cÜd_g‘
("abc:123", 0);

311 
ex³ùed
 = "PREFIX‡bc get 1 hit 0 set 1 del 0\r\nEND\r\n";

312 
	`‹¡_equ®s_¡r
("¡© aá” g‘ #1", 
ex³ùed
, 
	`¡©s_´efix_dump
(&
Ëngth
));

313 
	`‹¡_equ®s_št
("¡© Ëngth‡á” g‘ #1", 
	`¡¾’
(
ex³ùed
), 
Ëngth
);

314 
	`¡©s_´efix_»cÜd_g‘
("abc:123", 1);

315 
ex³ùed
 = "PREFIX‡bc get 2 hit 1 set 1 del 0\r\nEND\r\n";

316 
	`‹¡_equ®s_¡r
("¡© aá” g‘ #2", 
ex³ùed
, 
	`¡©s_´efix_dump
(&
Ëngth
));

317 
	`‹¡_equ®s_št
("¡© Ëngth‡á” g‘ #2", 
	`¡¾’
(
ex³ùed
), 
Ëngth
);

318 
	`¡©s_´efix_»cÜd_d–‘e
("abc:123");

319 
ex³ùed
 = "PREFIX‡bc get 2 hit 1 set 1 del 1\r\nEND\r\n";

320 
	`‹¡_equ®s_¡r
("¡© aá” d– #1", 
ex³ùed
, 
	`¡©s_´efix_dump
(&
Ëngth
));

321 
	`‹¡_equ®s_št
("¡© Ëngth‡á” d– #1", 
	`¡¾’
(
ex³ùed
), 
Ëngth
);

324 
	`¡©s_´efix_»cÜd_d–‘e
("def:123");

325 
ex³ùed
 = "PREFIX‡bc get 2 hit 1 set 1 del 1\r\n"

328 
	`‹¡_equ®s_¡r
("¡© aá” d– #2", 
ex³ùed
, 
	`¡©s_´efix_dump
(&
Ëngth
));

329 
	`‹¡_equ®s_št
("¡© Ëngth‡á” d– #2", 
	`¡¾’
(
ex³ùed
), 
Ëngth
);

332 
keynum
 = 0; keynum < 
PREFIX_HASH_SIZE
 * 100; keynum++) {

333 
	`¢´štf
(
tmp
, Ñmp), "%d", 
keynum
);

334 ià(
hashv®
 =ğ
	`hash
(
tmp
, 
	`¡¾’
Ñmp)è% 
PREFIX_HASH_SIZE
) {

338 
	`¡©s_´efix_»cÜd_£t
(
tmp
);

339 
	`¢´štf
(
tmp
, (tmp),

343 "END\r\n", 
keynum
);

344 
	`‹¡_equ®s_¡r
("stats withwo stats in one bucket",

345 
tmp
, 
	`¡©s_´efix_dump
(&
Ëngth
));

346 
	`‹¡_equ®s_št
("stats†ength withwo stats in one bucket",

347 
	`¡¾’
(
tmp
), 
Ëngth
);

348 
	}
}

350 
run_‹¡
(*
wh©
, (*
func
)()) {

351 
cu¼’t_‹¡
 = 
wh©
;

352 
‹¡_couÁ
 = 
ç_couÁ
 = 0;

353 
	`puts
(
wh©
);

354 
	`fæush
(
¡dout
);

356 
	`¡©s_´efix_ş—r
();

357 (
func
)();

358 
	`´štf
("\t%d / %d…ass\n", (
‹¡_couÁ
 - 
ç_couÁ
),est_count);

359 
	}
}

362 
	$mt_¡©s_lock
(è{ 
	}
}

363 
	$mt_¡©s_uÆock
(è{ 
	}
}

365 
	$maš
(
¬gc
, **
¬gv
) {

366 
	`¡©s_´efix_š™
();

367 
£‰šgs
.
´efix_d–im™”
 = ':';

368 
	`run_‹¡
("¡©s_´efix_fšd", 
‹¡_´efix_fšd
);

369 
	`run_‹¡
("¡©s_´efix_»cÜd_g‘", 
‹¡_´efix_»cÜd_g‘
);

370 
	`run_‹¡
("¡©s_´efix_»cÜd_d–‘e", 
‹¡_´efix_»cÜd_d–‘e
);

371 
	`run_‹¡
("¡©s_´efix_»cÜd_£t", 
‹¡_´efix_»cÜd_£t
);

372 
	`run_‹¡
("¡©s_´efix_dump", 
‹¡_´efix_dump
);

373 
	}
}

	@stats.h

2 
¡©s_´efix_š™
();

3 
¡©s_´efix_ş—r
();

4 
¡©s_´efix_»cÜd_g‘
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, cÚ¡ 
boŞ
 
is_h™
);

5 
¡©s_´efix_»cÜd_d–‘e
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
);

6 
¡©s_´efix_»cÜd_£t
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
);

8 *
¡©s_´efix_dump
(*
Ëngth
);

	@testapp.c

2 #undeà
NDEBUG


3 
	~<±h»ad.h
>

4 
	~<sys/ty³s.h
>

5 
	~<sys/sock‘.h
>

6 
	~<sys/wa™.h
>

7 
	~<Ãtdb.h
>

8 
	~<¬·/š‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<Ãtš‘/tı.h
>

11 
	~<sigÇl.h
>

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

14 
	~<”ºo.h
>

15 
	~<as£¹.h
>

16 
	~<¡ršg.h
>

17 
	~<uni¡d.h
>

18 
	~<Ãtš‘/š.h
>

19 
	~<fú.h
>

21 
	~"cÚfig.h
"

22 
	~"ÿche.h
"

23 
	~"ut.h
"

24 
	~"´ÙocŞ_bš¬y.h
"

26 
	#TMP_TEMPLATE
 "/tmp/‹¡_fe.XXXXXXX"

	)

28 
	e‹¡_»tuº
 { 
	mTEST_SKIP
, 
	mTEST_PASS
, 
	mTEST_FAIL
 };

30 
pid_t
 
	g£rv”_pid
;

31 
š_pÜt_t
 
	gpÜt
;

32 
	gsock
;

33 
boŞ
 
	g®low_şo£d_»ad
 = 
çl£
;

35 
‹¡_»tuº
 
	$ÿche_ü—‹_‹¡
()

37 
ÿche_t
 *
ÿche
 = 
	`ÿche_ü—‹
("‹¡", (
ušt32_t
), (*),

38 
NULL
, NULL);

39 
	`as£¹
(
ÿche
 !ğ
NULL
);

40 
	`ÿche_de¡roy
(
ÿche
);

41  
TEST_PASS
;

42 
	}
}

44 cÚ¡ 
ušt64_t
 
	gcÚ¡ruùÜ_·‰”n
 = 0xdeadcafebabebeef;

46 
	$ÿche_cÚ¡ruùÜ
(*
bufãr
, *
nÙu£d1
, 
nÙu£d2
) {

47 
ušt64_t
 *
±r
 = 
bufãr
;

48 *
±r
 = 
cÚ¡ruùÜ_·‰”n
;

50 
	}
}

52 
‹¡_»tuº
 
	$ÿche_cÚ¡ruùÜ_‹¡
()

54 
ÿche_t
 *
ÿche
 = 
	`ÿche_ü—‹
("‹¡", (
ušt64_t
), (uint64_t),

55 
ÿche_cÚ¡ruùÜ
, 
NULL
);

56 
	`as£¹
(
ÿche
 !ğ
NULL
);

57 
ušt64_t
 *
±r
 = 
	`ÿche_®loc
(
ÿche
);

58 
ušt64_t
 
·‰”n
 = *
±r
;

59 
	`ÿche_ä“
(
ÿche
, 
±r
);

60 
	`ÿche_de¡roy
(
ÿche
);

61  (
·‰”n
 =ğ
cÚ¡ruùÜ_·‰”n
è? 
TEST_PASS
 : 
TEST_FAIL
;

62 
	}
}

64 
	$ÿche_ç_cÚ¡ruùÜ
(*
bufãr
, *
nÙu£d1
, 
nÙu£d2
) {

66 
	}
}

68 
‹¡_»tuº
 
	$ÿche_ç_cÚ¡ruùÜ_‹¡
()

70 
‹¡_»tuº
 
»t
 = 
TEST_PASS
;

72 
ÿche_t
 *
ÿche
 = 
	`ÿche_ü—‹
("‹¡", (
ušt64_t
), (uint64_t),

73 
ÿche_ç_cÚ¡ruùÜ
, 
NULL
);

74 
	`as£¹
(
ÿche
 !ğ
NULL
);

75 
ušt64_t
 *
±r
 = 
	`ÿche_®loc
(
ÿche
);

76 ià(
±r
 !ğ
NULL
) {

77 
»t
 = 
TEST_FAIL
;

79 
	`ÿche_de¡roy
(
ÿche
);

80  
»t
;

81 
	}
}

83 *
	gde¡ruù_d©a
 = 0;

85 
	$ÿche_de¡ruùÜ
(*
bufãr
, *
nÙu£d
) {

86 
de¡ruù_d©a
 = 
bufãr
;

87 
	}
}

89 
‹¡_»tuº
 
	$ÿche_de¡ruùÜ_‹¡
()

91 
ÿche_t
 *
ÿche
 = 
	`ÿche_ü—‹
("‹¡", (
ušt32_t
), (*),

92 
NULL
, 
ÿche_de¡ruùÜ
);

93 
	`as£¹
(
ÿche
 !ğ
NULL
);

94 *
±r
 = 
	`ÿche_®loc
(
ÿche
);

95 
	`ÿche_ä“
(
ÿche
, 
±r
);

96 
	`ÿche_de¡roy
(
ÿche
);

98  (
±r
 =ğ
de¡ruù_d©a
è? 
TEST_PASS
 : 
TEST_FAIL
;

99 
	}
}

101 
‹¡_»tuº
 
	$ÿche_»u£_‹¡
()

103 
ii
;

104 
ÿche_t
 *
ÿche
 = 
	`ÿche_ü—‹
("‹¡", (
ušt32_t
), (*),

105 
NULL
, NULL);

106 *
±r
 = 
	`ÿche_®loc
(
ÿche
);

107 
	`ÿche_ä“
(
ÿche
, 
±r
);

108 
ii
 = 0; ii < 100; ++ii) {

109 *
p
 = 
	`ÿche_®loc
(
ÿche
);

110 
	`as£¹
(
p
 =ğ
±r
);

111 
	`ÿche_ä“
(
ÿche
, 
±r
);

113 
	`ÿche_de¡roy
(
ÿche
);

114  
TEST_PASS
;

115 
	}
}

118 
‹¡_»tuº
 
	$ÿche_bulk®loc
(
size_t
 
d©asize
)

120 
ÿche_t
 *
ÿche
 = 
	`ÿche_ü—‹
("‹¡", 
d©asize
, (*),

121 
NULL
, NULL);

122 
	#ITERATIONS
 1024

	)

123 *
±r
[
ITERATIONS
];

125 
ii
 = 0; i˜< 
ITERATIONS
; ++ii) {

126 
±r
[
ii
] = 
	`ÿche_®loc
(
ÿche
);

127 
	`as£¹
(
±r
[
ii
] != 0);

128 
	`mem£t
(
±r
[
ii
], 0xff, 
d©asize
);

131 
ii
 = 0; i˜< 
ITERATIONS
; ++ii) {

132 
	`ÿche_ä“
(
ÿche
, 
±r
[
ii
]);

135 #undeà
ITERATIONS


136 
	`ÿche_de¡roy
(
ÿche
);

137  
TEST_PASS
;

138 
	}
}

140 
‹¡_»tuº
 
	$‹¡_issue_161
()

142 
‹¡_»tuº
 
»t
 = 
	`ÿche_bulk®loc
(1);

143 ià(
»t
 =ğ
TEST_PASS
) {

144 
»t
 = 
	`ÿche_bulk®loc
(512);

147  
»t
;

148 
	}
}

150 
‹¡_»tuº
 
	$ÿche_»dzÚe_‹¡
()

152 #iâdeà
HAVE_UMEM_H


153 
ÿche_t
 *
ÿche
 = 
	`ÿche_ü—‹
("‹¡", (
ušt32_t
), (*),

154 
NULL
, NULL);

157 
sigaùiÚ
 
Şd_aùiÚ
;

158 
sigaùiÚ
 
aùiÚ
 = { .
§_hªdËr
 = 
SIG_IGN
, .
§_æags
 = 0};

159 
	`sigem±y£t
(&
aùiÚ
.
§_mask
);

160 
	`sigaùiÚ
(
SIGABRT
, &
aùiÚ
, &
Şd_aùiÚ
);

163 *
p
 = 
	`ÿche_®loc
(
ÿche
);

164 
Şd
 = *(
p
 - 1);

165 *(
p
 - 1) = 0;

166 
	`ÿche_ä“
(
ÿche
, 
p
);

167 
	`as£¹
(
ÿche_”rÜ
 == -1);

168 *(
p
 - 1èğ
Şd
;

170 
p
[(
ušt32_t
)] = 0;

171 
	`ÿche_ä“
(
ÿche
, 
p
);

172 
	`as£¹
(
ÿche_”rÜ
 == 1);

175 
	`sigaùiÚ
(
SIGABRT
, &
Şd_aùiÚ
, 
NULL
);

177 
	`ÿche_de¡roy
(
ÿche
);

179  
TEST_PASS
;

181  
TEST_SKIP
;

183 
	}
}

185 
‹¡_»tuº
 
	$‹¡_§ã_¡¹oul
() {

186 
ušt32_t
 
v®
;

187 
	`as£¹
(
	`§ã_¡¹oul
("123", &
v®
));

188 
	`as£¹
(
v®
 == 123);

189 
	`as£¹
(
	`§ã_¡¹oul
("+123", &
v®
));

190 
	`as£¹
(
v®
 == 123);

191 
	`as£¹
(!
	`§ã_¡¹oul
("", &
v®
));

192 
	`as£¹
(!
	`§ã_¡¹oul
("123BOGUS", &
v®
));

193 
	`as£¹
(!
	`§ã_¡¹oul
(" issue221", &
v®
));

199 
	`as£¹
(
	`§ã_¡¹oul
("4294967295", &
v®
));

200 
	`as£¹
(
v®
 == 4294967295L);

204 
	`as£¹
(!
	`§ã_¡¹oul
("-1", &
v®
));

205  
TEST_PASS
;

206 
	}
}

209 
‹¡_»tuº
 
	$‹¡_§ã_¡¹ouÎ
() {

210 
ušt64_t
 
v®
;

211 
	`as£¹
(
	`§ã_¡¹ouÎ
("123", &
v®
));

212 
	`as£¹
(
v®
 == 123);

213 
	`as£¹
(
	`§ã_¡¹ouÎ
("+123", &
v®
));

214 
	`as£¹
(
v®
 == 123);

215 
	`as£¹
(!
	`§ã_¡¹ouÎ
("", &
v®
));

216 
	`as£¹
(!
	`§ã_¡¹ouÎ
("123BOGUS", &
v®
));

217 
	`as£¹
(!
	`§ã_¡¹ouÎ
("92837498237498237498029383", &
v®
));

218 
	`as£¹
(!
	`§ã_¡¹ouÎ
(" issue221", &
v®
));

221 
	`as£¹
(
	`§ã_¡¹ouÎ
("18446744073709551615", &
v®
));

222 
	`as£¹
(
v®
 == 18446744073709551615ULL);

223 
	`as£¹
(!
	`§ã_¡¹ouÎ
("18446744073709551616", &
v®
));

224 
	`as£¹
(!
	`§ã_¡¹ouÎ
("-1", &
v®
));

225  
TEST_PASS
;

226 
	}
}

228 
‹¡_»tuº
 
	$‹¡_§ã_¡¹Şl
() {

229 
št64_t
 
v®
;

230 
	`as£¹
(
	`§ã_¡¹Şl
("123", &
v®
));

231 
	`as£¹
(
v®
 == 123);

232 
	`as£¹
(
	`§ã_¡¹Şl
("+123", &
v®
));

233 
	`as£¹
(
v®
 == 123);

234 
	`as£¹
(
	`§ã_¡¹Şl
("-123", &
v®
));

235 
	`as£¹
(
v®
 == -123);

236 
	`as£¹
(!
	`§ã_¡¹Şl
("", &
v®
));

237 
	`as£¹
(!
	`§ã_¡¹Şl
("123BOGUS", &
v®
));

238 
	`as£¹
(!
	`§ã_¡¹Şl
("92837498237498237498029383", &
v®
));

239 
	`as£¹
(!
	`§ã_¡¹Şl
(" issue221", &
v®
));

242 
	`as£¹
(!
	`§ã_¡¹Şl
("18446744073709551615", &
v®
));

243 
	`as£¹
(
	`§ã_¡¹Şl
("9223372036854775807", &
v®
));

244 
	`as£¹
(
v®
 == 9223372036854775807LL);

249 
	`as£¹
(!
	`§ã_¡¹Şl
("-9223372036854775809", &
v®
));

252 
	`as£¹
(
	`§ã_¡¹Şl
(" 123 foo", &
v®
));

253 
	`as£¹
(
v®
 == 123);

254  
TEST_PASS
;

255 
	}
}

257 
‹¡_»tuº
 
	$‹¡_§ã_¡¹Ş
() {

258 
št32_t
 
v®
;

259 
	`as£¹
(
	`§ã_¡¹Ş
("123", &
v®
));

260 
	`as£¹
(
v®
 == 123);

261 
	`as£¹
(
	`§ã_¡¹Ş
("+123", &
v®
));

262 
	`as£¹
(
v®
 == 123);

263 
	`as£¹
(
	`§ã_¡¹Ş
("-123", &
v®
));

264 
	`as£¹
(
v®
 == -123);

265 
	`as£¹
(!
	`§ã_¡¹Ş
("", &
v®
));

266 
	`as£¹
(!
	`§ã_¡¹Ş
("123BOGUS", &
v®
));

267 
	`as£¹
(!
	`§ã_¡¹Ş
("92837498237498237498029383", &
v®
));

268 
	`as£¹
(!
	`§ã_¡¹Ş
(" issue221", &
v®
));

274 
	`as£¹
(
	`§ã_¡¹Ş
("2147483647", &
v®
));

275 
	`as£¹
(
v®
 == 2147483647L);

281 
	`as£¹
(
	`§ã_¡¹Ş
(" 123 foo", &
v®
));

282 
	`as£¹
(
v®
 == 123);

283  
TEST_PASS
;

284 
	}
}

295 
pid_t
 
	$¡¬t_£rv”
(
š_pÜt_t
 *
pÜt_out
, 
boŞ
 
d«mÚ
, 
timeout
) {

296 
’vœÚm’t
[80];

297 
	`¢´štf
(
’vœÚm’t
, (environment),

298 "MEMCACHED_PORT_FILENAME=/tmp/pÜts.%lu", ()
	`g‘pid
());

299 *
f’ame
ğ
’vœÚm’t
 + 
	`¡¾’
("MEMCACHED_PORT_FILENAME=");

300 
pid_fe
[80];

301 
	`¢´štf
(
pid_fe
, Õid_fe), "/tmp/pid.%lu", ()
	`g‘pid
());

303 
	`»move
(
f’ame
);

304 
	`»move
(
pid_fe
);

306 #ifdeà
__sun


310 
cÜ—dm
[128];

311 
	`¢´štf
(
cÜ—dm
, (coreadm),

312 "cÜ—dm -°cÜe.%%f.%%°%lu", ()
	`g‘pid
());

313 
	`sy¡em
(
cÜ—dm
);

316 
pid_t
 
pid
 = 
	`fÜk
();

317 
	`as£¹
(
pid
 != -1);

319 ià(
pid
 == 0) {

321 *
¬gv
[20];

322 
¬g
 = 0;

323 
tmo
[24];

324 
	`¢´štf
(
tmo
, Ñmo), "%u", 
timeout
);

326 
	`pu‹nv
(
’vœÚm’t
);

327 #ifdeà
__sun


328 
	`pu‹nv
("LD_PRELOAD=watchmalloc.so.1");

329 
	`pu‹nv
("MALLOC_DEBUG=WATCH");

332 ià(!
d«mÚ
) {

333 
¬gv
[
¬g
++] = "./timedrun";

334 
¬gv
[
¬g
++] = 
tmo
;

336 
¬gv
[
¬g
++] = "./memcached-debug";

337 
¬gv
[
¬g
++] = "-A";

338 
¬gv
[
¬g
++] = "-p";

339 
¬gv
[
¬g
++] = "-1";

340 
¬gv
[
¬g
++] = "-U";

341 
¬gv
[
¬g
++] = "0";

343 ià(
	`g‘uid
() == 0) {

344 
¬gv
[
¬g
++] = "-u";

345 
¬gv
[
¬g
++] = "root";

347 ià(
d«mÚ
) {

348 
¬gv
[
¬g
++] = "-d";

349 
¬gv
[
¬g
++] = "-P";

350 
¬gv
[
¬g
++] = 
pid_fe
;

352 #ifdeà
MESSAGE_DEBUG


353 
¬gv
[
¬g
++] = "-vvv";

355 
¬gv
[
¬g
++] = 
NULL
;

356 
	`as£¹
(
	`execv
(
¬gv
[0],‡rgv) != -1);

360 
	`acûss
(
f’ame
, 
F_OK
) == -1) {

361 
	`u¦“p
(10);

364 
FILE
 *
å
 = 
	`fİ’
(
f’ame
, "r");

365 ià(
å
 =ğ
NULL
) {

366 
	`årštf
(
¡d”r
, "Failedo openhe file containing…ort‚umbers: %s\n",

367 
	`¡»¼Ü
(
”ºo
));

368 
	`as£¹
(
çl£
);

371 *
pÜt_out
 = (
š_pÜt_t
)-1;

372 
bufãr
[80];

373 (
	`fg‘s
(
bufãr
, (bufãr), 
å
)è!ğ
NULL
) {

374 ià(
	`¡ºcmp
(
bufãr
, "TCP INET: ", 10) == 0) {

375 
št32_t
 
v®
;

376 
	`as£¹
(
	`§ã_¡¹Ş
(
bufãr
 + 10, &
v®
));

377 *
pÜt_out
 = (
š_pÜt_t
)
v®
;

380 
	`fşo£
(
å
);

381 
	`as£¹
(
	`»move
(
f’ame
) == 0);

383 ià(
d«mÚ
) {

388 
	`acûss
(
pid_fe
, 
F_OK
) == -1) {

389 
	`u¦“p
(10);

392 
å
 = 
	`fİ’
(
pid_fe
, "r");

393 ià(
å
 =ğ
NULL
) {

394 
	`årštf
(
¡d”r
, "Failedo open…id file: %s\n",

395 
	`¡»¼Ü
(
”ºo
));

396 
	`as£¹
(
çl£
);

400 
x
 = 0; x < 20 && 
	`fg‘s
(
bufãr
, (bufãr), 
å
è=ğ
NULL
; x++) {

401 
	`u¦“p
(10);

403 
	`fşo£
(
å
);

405 
št32_t
 
v®
;

406 
	`as£¹
(
	`§ã_¡¹Ş
(
bufãr
, &
v®
));

407 
pid
 = (
pid_t
)
v®
;

410  
pid
;

411 
	}
}

413 
‹¡_»tuº
 
	$‹¡_issue_44
() {

414 
š_pÜt_t
 
pÜt
;

415 
pid_t
 
pid
 = 
	`¡¬t_£rv”
(&
pÜt
, 
Œue
, 15);

416 
	`as£¹
(
	`kl
(
pid
, 
SIGHUP
) == 0);

417 
	`¦“p
(1);

418 
	`as£¹
(
	`kl
(
pid
, 
SIGTERM
) == 0);

420  
TEST_PASS
;

421 
	}
}

423 
addršfo
 *
	$lookupho¡
(cÚ¡ *
ho¡Çme
, 
š_pÜt_t
 
pÜt
)

425 
addršfo
 *
ai
 = 0;

426 
addršfo
 
hšts
 = { .
ai_çmy
 = 
AF_UNSPEC
,

427 .
ai_´ÙocŞ
 = 
IPPROTO_TCP
,

428 .
ai_sockty³
 = 
SOCK_STREAM
 };

429 
£rviû
[
NI_MAXSERV
];

430 
”rÜ
;

432 ()
	`¢´štf
(
£rviû
, 
NI_MAXSERV
, "%d", 
pÜt
);

433 ià((
”rÜ
 = 
	`g‘addršfo
(
ho¡Çme
, 
£rviû
, &
hšts
, &
ai
)) != 0) {

434 ià(
”rÜ
 !ğ
EAI_SYSTEM
) {

435 
	`årštf
(
¡d”r
, "g‘addršfo(): %s\n", 
	`gai_¡»¼Ü
(
”rÜ
));

437 
	`³¼Ü
("getaddrinfo()");

441  
ai
;

442 
	}
}

444 
	$cÚÃù_£rv”
(cÚ¡ *
ho¡Çme
, 
š_pÜt_t
 
pÜt
, 
boŞ
 
nÚblock
)

446 
addršfo
 *
ai
 = 
	`lookupho¡
(
ho¡Çme
, 
pÜt
);

447 
sock
 = -1;

448 ià(
ai
 !ğ
NULL
) {

449 ià((
sock
 = 
	`sock‘
(
ai
->
ai_çmy
,‡i->
ai_sockty³
,

450 
ai
->
ai_´ÙocŞ
)) != -1) {

451 ià(
	`cÚÃù
(
sock
, 
ai
->
ai_addr
,‡i->
ai_add¾’
) == -1) {

452 
	`årštf
(
¡d”r
, "Failedo connect socket: %s\n",

453 
	`¡»¼Ü
(
”ºo
));

454 
	`şo£
(
sock
);

455 
sock
 = -1;

456 } ià(
nÚblock
) {

457 
æags
 = 
	`fú
(
sock
, 
F_GETFL
, 0);

458 ià(
æags
 < 0 || 
	`fú
(
sock
, 
F_SETFL
, fÏg | 
O_NONBLOCK
) < 0) {

459 
	`årštf
(
¡d”r
, "Failedoƒnable‚onblocking mode: %s\n",

460 
	`¡»¼Ü
(
”ºo
));

461 
	`şo£
(
sock
);

462 
sock
 = -1;

466 
	`årštf
(
¡d”r
, "FaedØü—‹ sock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

469 
	`ä“addršfo
(
ai
);

471  
sock
;

472 
	}
}

474 
‹¡_»tuº
 
	$‹¡_v³¼Ü
() {

475 
rv
 = 0;

476 
Şd¡d”r
 = 
	`dup
(
STDERR_FILENO
);

477 
tm¶
[(
TMP_TEMPLATE
)+1];

478 
	`¡ºıy
(
tm¶
, 
TMP_TEMPLATE
, (TMP_TEMPLATE)+1);

480 
Ãwfe
 = 
	`mk¡emp
(
tm¶
);

481 
	`as£¹
(
Ãwfe
 > 0);

482 
rv
 = 
	`dup2
(
Ãwfe
, 
STDERR_FILENO
);

483 
	`as£¹
(
rv
 =ğ
STDERR_FILENO
);

484 
rv
 = 
	`şo£
(
Ãwfe
);

485 
	`as£¹
(
rv
 == 0);

487 
”ºo
 = 
EIO
;

488 
	`v³¼Ü
("Old McDonald had‡ farm. %s", "EI EIO");

491 
rv
 = 
	`dup2
(
Şd¡d”r
, 
STDERR_FILENO
);

492 
	`as£¹
(
rv
 =ğ
STDERR_FILENO
);

496 
buf
[80] = { 0 };

497 
FILE
 *
efe
 = 
	`fİ’
(
tm¶
, "r");

498 
	`as£¹
(
efe
);

499 *
´v
 = 
	`fg‘s
(
buf
, (buf), 
efe
);

500 
	`as£¹
(
´v
);

501 
	`fşo£
(
efe
);

503 
	`uÆšk
(
tm¶
);

505 
ex³ùed
[80] = { 0 };

506 
	`¢´štf
(
ex³ùed
, (expected),

507 "Old McDÚ®d had‡ f¬m. EI EIO: %s\n", 
	`¡»¼Ü
(
EIO
));

515  
	`¡rcmp
(
ex³ùed
, 
buf
è=ğ0 ? 
TEST_PASS
 : 
TEST_FAIL
;

516 
	}
}

518 
	$£nd_ascii_commªd
(cÚ¡ *
buf
) {

519 
off_t
 
off£t
 = 0;

520 cÚ¡ * 
±r
 = 
buf
;

521 
size_t
 
Ën
 = 
	`¡¾’
(
buf
);

524 
ssize_t
 
nw
 = 
	`wr™e
(
sock
, 
±r
 + 
off£t
, 
Ën
 - offset);

525 ià(
nw
 == -1) {

526 ià(
”ºo
 !ğ
EINTR
) {

527 
	`årštf
(
¡d”r
, "FaedØwr™e: %s\n", 
	`¡»¼Ü
(
”ºo
));

528 
	`abÜt
();

531 
off£t
 +ğ
nw
;

533 } 
off£t
 < 
Ën
);

534 
	}
}

542 
	$»ad_ascii_»¥Ú£
(*
bufãr
, 
size_t
 
size
) {

543 
off_t
 
off£t
 = 0;

544 
boŞ
 
Ãed_mÜe
 = 
Œue
;

546 
ssize_t
 
Ä
 = 
	`»ad
(
sock
, 
bufãr
 + 
off£t
, 1);

547 ià(
Ä
 == -1) {

548 ià(
”ºo
 !ğ
EINTR
) {

549 
	`årštf
(
¡d”r
, "FaedØ»ad: %s\n", 
	`¡»¼Ü
(
”ºo
));

550 
	`abÜt
();

553 
	`as£¹
(
Ä
 == 1);

554 ià(
bufãr
[
off£t
] == '\n') {

555 
Ãed_mÜe
 = 
çl£
;

556 
bufãr
[
off£t
 + 1] = '\0';

558 
off£t
 +ğ
Ä
;

559 
	`as£¹
(
off£t
 + 1 < 
size
);

561 } 
Ãed_mÜe
);

562 
	}
}

564 
‹¡_»tuº
 
	$‹¡_issue_92
() {

565 
bufãr
[1024];

567 
	`şo£
(
sock
);

568 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

570 
	`£nd_ascii_commªd
("stats cachedump 1 0 0\r\n");

571 
	`»ad_ascii_»¥Ú£
(
bufãr
, (buffer));

572 
	`as£¹
(
	`¡ºcmp
(
bufãr
, "END", 
	`¡¾’
("END")) == 0);

574 
	`£nd_ascii_commªd
("stats cachedump 200 0 0\r\n");

575 
	`»ad_ascii_»¥Ú£
(
bufãr
, (buffer));

576 
	`as£¹
(
	`¡ºcmp
(
bufãr
, "CLIENT_ERROR", 
	`¡¾’
("CLIENT_ERROR")) == 0);

578 
	`şo£
(
sock
);

579 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

580  
TEST_PASS
;

581 
	}
}

583 
‹¡_»tuº
 
	$‹¡_issue_102
() {

584 
bufãr
[4096];

585 
	`mem£t
(
bufãr
, ' ', (buffer));

586 
bufãr
[(buffer) - 1] = '\0';

588 
	`şo£
(
sock
);

589 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

591 
	`£nd_ascii_commªd
(
bufãr
);

593 
	`as£¹
(
	`»ad
(
sock
, 
bufãr
, (buffer)) == 0);

594 
	`şo£
(
sock
);

595 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

597 
	`¢´štf
(
bufãr
, (buffer), "gets ");

598 
size_t
 
off£t
 = 5;

599 
off£t
 < 4000) {

600 
off£t
 +ğ
	`¢´štf
(
bufãr
 + offset, (buffer) - offset,

601 "%010u ", ()
off£t
);

604 
	`£nd_ascii_commªd
(
bufãr
);

605 
	`u¦“p
(250);

607 
	`£nd_ascii_commªd
("\r\n");

608 
r¥
[80];

609 
	`»ad_ascii_»¥Ú£
(
r¥
, (rsp));

610 
	`as£¹
(
	`¡ºcmp
(
r¥
, "END", 
	`¡¾’
("END")) == 0);

611 
bufãr
[3]= ' ';

612 
	`£nd_ascii_commªd
(
bufãr
);

613 
	`u¦“p
(250);

614 
	`£nd_ascii_commªd
("\r\n");

615 
	`»ad_ascii_»¥Ú£
(
r¥
, (rsp));

616 
	`as£¹
(
	`¡ºcmp
(
r¥
, "END", 
	`¡¾’
("END")) == 0);

618 
	`mem£t
(
bufãr
, ' ', (buffer));

619 
Ën
 = 
	`¢´štf
(
bufãr
 + 101, (buffer) - 101, "gets foo");

620 
bufãr
[101 + 
Ën
] = ' ';

621 
bufãr
[(buffer) - 1] = '\0';

622 
	`£nd_ascii_commªd
(
bufãr
);

624 
	`as£¹
(
	`»ad
(
sock
, 
bufãr
, (buffer)) == 0);

626 
	`şo£
(
sock
);

627 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

629  
TEST_PASS
;

630 
	}
}

632 
‹¡_»tuº
 
	$¡¬t_memÿched_£rv”
() {

633 
£rv”_pid
 = 
	`¡¬t_£rv”
(&
pÜt
, 
çl£
, 600);

634 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

635  
TEST_PASS
;

636 
	}
}

638 
‹¡_»tuº
 
	$¡İ_memÿched_£rv”
() {

639 
	`şo£
(
sock
);

640 ià(
£rv”_pid
 != -1) {

641 
	`as£¹
(
	`kl
(
£rv”_pid
, 
SIGTERM
) == 0);

644  
TEST_PASS
;

645 
	}
}

647 
‹¡_»tuº
 
	$shutdown_memÿched_£rv”
() {

648 
bufãr
[1024];

650 
	`şo£
(
sock
);

651 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

653 
	`£nd_ascii_commªd
("shutdown\r\n");

655 
	`as£¹
(
	`»ad
(
sock
, 
bufãr
, (buffer)) == 0);

657 
	`şo£
(
sock
);

660 ià(
	`kl
(
£rv”_pid
, 0) == 0) {

661 
£rv”_pid
 = -1;

664  
TEST_PASS
;

665 
	}
}

667 
	$§ã_£nd
(cÚ¡ * 
buf
, 
size_t
 
Ën
, 
boŞ
 
hickup
)

669 
off_t
 
off£t
 = 0;

670 cÚ¡ * 
±r
 = 
buf
;

671 #ifdeà
MESSAGE_DEBUG


672 
ušt8_t
 
v®
 = *
±r
;

673 
	`as£¹
(
v®
 =ğ(
ušt8_t
)0x80);

674 
	`årštf
(
¡d”r
, "AbouˆtØ£nd %lu by‹s:", ()
Ën
);

675 
ii
 = 0; i˜< 
Ën
; ++ii) {

676 ià(
ii
 % 4 == 0) {

677 
	`årštf
(
¡d”r
, "\n ");

679 
v®
 = *(
±r
 + 
ii
);

680 
	`årštf
(
¡d”r
, " 0x%02x", 
v®
);

682 
	`årštf
(
¡d”r
, "\n");

683 
	`u¦“p
(500);

687 
size_t
 
num_by‹s
 = 
Ën
 - 
off£t
;

688 ià(
hickup
) {

689 ià(
num_by‹s
 > 1024) {

690 
num_by‹s
 = (
	`¿nd
() % 1023) + 1;

694 
ssize_t
 
nw
 = 
	`wr™e
(
sock
, 
±r
 + 
off£t
, 
num_by‹s
);

695 ià(
nw
 == -1) {

696 ià(
”ºo
 !ğ
EINTR
) {

697 
	`årštf
(
¡d”r
, "FaedØwr™e: %s\n", 
	`¡»¼Ü
(
”ºo
));

698 
	`abÜt
();

701 ià(
hickup
) {

702 
	`u¦“p
(100);

704 
off£t
 +ğ
nw
;

706 } 
off£t
 < 
Ën
);

707 
	}
}

709 
boŞ
 
	$§ã_»cv
(*
buf
, 
size_t
 
Ën
) {

710 ià(
Ën
 == 0) {

711  
Œue
;

713 
off_t
 
off£t
 = 0;

715 
ssize_t
 
Ä
 = 
	`»ad
(
sock
, ((*)
buf
è+ 
off£t
, 
Ën
 - offset);

716 ià(
Ä
 == -1) {

717 ià(
”ºo
 !ğ
EINTR
) {

718 
	`årštf
(
¡d”r
, "FaedØ»ad: %s\n", 
	`¡»¼Ü
(
”ºo
));

719 
	`abÜt
();

722 ià(
Ä
 =ğ0 && 
®low_şo£d_»ad
) {

723  
çl£
;

725 
	`as£¹
(
Ä
 != 0);

726 
off£t
 +ğ
Ä
;

728 } 
off£t
 < 
Ën
);

730  
Œue
;

731 
	}
}

733 
boŞ
 
	$§ã_»cv_·ck‘
(*
buf
, 
size_t
 
size
) {

734 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 *
»¥Ú£
 = 
buf
;

735 
	`as£¹
(
size
 > (*
»¥Ú£
));

736 ià(!
	`§ã_»cv
(
»¥Ú£
, (*response))) {

737  
çl£
;

739 
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 = 
	`Áohs
(response->message.header.response.keylen);

740 
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
¡©us
 = 
	`Áohs
(response->message.header.response.status);

741 
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
bodyËn
 = 
	`Áohl
(response->message.header.response.bodylen);

743 
size_t
 
Ën
 = (*
»¥Ú£
);

745 *
±r
 = 
buf
;

746 
±r
 +ğ
Ën
;

747 ià(!
	`§ã_»cv
(
±r
, 
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
bodyËn
)) {

748  
çl£
;

751 #ifdeà
MESSAGE_DEBUG


752 
	`u¦“p
(500);

753 
±r
 = 
buf
;

754 
Ën
 +ğ
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
bodyËn
;

755 
ušt8_t
 
v®
 = *
±r
;

756 
	`as£¹
(
v®
 =ğ(
ušt8_t
)0x81);

757 
	`årštf
(
¡d”r
, "Reûived %lu by‹s:", ()
Ën
);

758 
ii
 = 0; i˜< 
Ën
; ++ii) {

759 ià(
ii
 % 4 == 0) {

760 
	`årštf
(
¡d”r
, "\n ");

762 
v®
 = *(
±r
 + 
ii
);

763 
	`årštf
(
¡d”r
, " 0x%02x", 
v®
);

765 
	`årštf
(
¡d”r
, "\n");

767  
Œue
;

768 
	}
}

770 
off_t
 
	$¡Üage_commªd
(*
buf
,

771 
size_t
 
bufsz
,

772 
ušt8_t
 
cmd
,

773 cÚ¡ * 
key
,

774 
size_t
 
keyËn
,

775 cÚ¡ * 
d
,

776 
size_t
 
dËn
,

777 
ušt32_t
 
æags
,

778 
ušt32_t
 
exp
) {

780 
´ÙocŞ_bš¬y_»que¡_£t
 *
»que¡
 = (*)
buf
;

781 
	`as£¹
(
bufsz
 > (*
»que¡
è+ 
keyËn
 + 
dËn
);

783 
	`mem£t
(
»que¡
, 0, (*request));

784 
»que¡
->
mes§ge
.
h—d”
.»que¡.
magic
 = 
PROTOCOL_BINARY_REQ
;

785 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İcode
 = 
cmd
;

786 
»que¡
->
mes§ge
.
h—d”
.»que¡.
keyËn
 = 
	`htÚs
(keylen);

787 
»que¡
->
mes§ge
.
h—d”
.»que¡.
ex’
 = 8;

788 
»que¡
->
mes§ge
.
h—d”
.»que¡.
bodyËn
 = 
	`htÚl
(
keyËn
 + 8 + 
dËn
);

789 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İaque
 = 0xdeadbeef;

790 
»que¡
->
mes§ge
.
body
.
æags
 = flags;

791 
»que¡
->
mes§ge
.
body
.
expœ©iÚ
 = 
exp
;

793 
off_t
 
key_off£t
 = (
´ÙocŞ_bš¬y_»que¡_no_exŒas
) + 8;

795 
	`memıy
(
buf
 + 
key_off£t
, 
key
, 
keyËn
);

796 ià(
d
 !ğ
NULL
) {

797 
	`memıy
(
buf
 + 
key_off£t
 + 
keyËn
, 
d
, 
dËn
);

800  
key_off£t
 + 
keyËn
 + 
dËn
;

801 
	}
}

803 
off_t
 
	$ext_commªd
(* 
buf
,

804 
size_t
 
bufsz
,

805 
ušt8_t
 
cmd
,

806 cÚ¡ * 
ext
,

807 
size_t
 
ex’
,

808 cÚ¡ * 
key
,

809 
size_t
 
keyËn
,

810 cÚ¡ * 
d
,

811 
size_t
 
dËn
) {

812 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 *
»que¡
 = (*)
buf
;

813 
	`as£¹
(
bufsz
 > (*
»que¡
è+ 
ex’
 + 
keyËn
 + 
dËn
);

815 
	`mem£t
(
»que¡
, 0, (*request));

816 
»que¡
->
mes§ge
.
h—d”
.»que¡.
magic
 = 
PROTOCOL_BINARY_REQ
;

817 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İcode
 = 
cmd
;

818 
»que¡
->
mes§ge
.
h—d”
.»que¡.
ex’
 =ƒxtlen;

819 
»que¡
->
mes§ge
.
h—d”
.»que¡.
keyËn
 = 
	`htÚs
(keylen);

820 
»que¡
->
mes§ge
.
h—d”
.»que¡.
bodyËn
 = 
	`htÚl
(
ex’
 + 
keyËn
 + 
dËn
);

821 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İaque
 = 0xdeadbeef;

823 
off_t
 
ext_off£t
 = (
´ÙocŞ_bš¬y_»que¡_no_exŒas
);

824 
off_t
 
key_off£t
 = 
ext_off£t
 + 
ex’
;

825 
off_t
 
d_off£t
 = 
key_off£t
 + 
keyËn
;

827 ià(
ext
 !ğ
NULL
) {

828 
	`memıy
(
buf
 + 
ext_off£t
, 
ext
, 
ex’
);

830 ià(
key
 !ğ
NULL
) {

831 
	`memıy
(
buf
 + 
key_off£t
, 
key
, 
keyËn
);

833 ià(
d
 !ğ
NULL
) {

834 
	`memıy
(
buf
 + 
d_off£t
, 
d
, 
dËn
);

837  (*
»que¡
è+ 
ex’
 + 
keyËn
 + 
dËn
;

838 
	}
}

840 
off_t
 
	$¿w_commªd
(* 
buf
,

841 
size_t
 
bufsz
,

842 
ušt8_t
 
cmd
,

843 cÚ¡ * 
key
,

844 
size_t
 
keyËn
,

845 cÚ¡ * 
d
,

846 
size_t
 
dËn
) {

848  
	`ext_commªd
(
buf
, 
bufsz
, 
cmd
, 
NULL
, 0, 
key
, 
keyËn
, 
d
, 
dËn
);

849 
	}
}

851 
off_t
 
	$æush_commªd
(* 
buf
, 
size_t
 
bufsz
, 
ušt8_t
 
cmd
, 
ušt32_t
 
ex±ime
, 
boŞ
 
u£_exŒa
) {

852 
´ÙocŞ_bš¬y_»que¡_æush
 *
»que¡
 = (*)
buf
;

853 
	`as£¹
(
bufsz
 > (*
»que¡
));

855 
	`mem£t
(
»que¡
, 0, (*request));

856 
»que¡
->
mes§ge
.
h—d”
.»que¡.
magic
 = 
PROTOCOL_BINARY_REQ
;

857 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İcode
 = 
cmd
;

859 
off_t
 
size
 = (
´ÙocŞ_bš¬y_»que¡_no_exŒas
);

860 ià(
u£_exŒa
) {

861 
»que¡
->
mes§ge
.
h—d”
.»que¡.
ex’
 = 4;

862 
»que¡
->
mes§ge
.
body
.
expœ©iÚ
 = 
	`htÚl
(
ex±ime
);

863 
»que¡
->
mes§ge
.
h—d”
.»que¡.
bodyËn
 = 
	`htÚl
(4);

864 
size
 += 4;

867 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İaque
 = 0xdeadbeef;

869  
size
;

870 
	}
}

873 
off_t
 
	$touch_commªd
(* 
buf
,

874 
size_t
 
bufsz
,

875 
ušt8_t
 
cmd
,

876 cÚ¡ * 
key
,

877 
size_t
 
keyËn
,

878 
ušt32_t
 
ex±ime
) {

879 
´ÙocŞ_bš¬y_»que¡_touch
 *
»que¡
 = (*)
buf
;

880 
	`as£¹
(
bufsz
 > (*
»que¡
));

882 
	`mem£t
(
»que¡
, 0, (*request));

883 
»que¡
->
mes§ge
.
h—d”
.»que¡.
magic
 = 
PROTOCOL_BINARY_REQ
;

884 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İcode
 = 
cmd
;

886 
»que¡
->
mes§ge
.
h—d”
.»que¡.
keyËn
 = 
	`htÚs
(keylen);

887 
»que¡
->
mes§ge
.
h—d”
.»que¡.
ex’
 = 4;

888 
»que¡
->
mes§ge
.
body
.
expœ©iÚ
 = 
	`htÚl
(
ex±ime
);

889 
»que¡
->
mes§ge
.
h—d”
.»que¡.
bodyËn
 = 
	`htÚl
(
keyËn
 + 4);

891 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İaque
 = 0xdeadbeef;

893 
off_t
 
key_off£t
 = (
´ÙocŞ_bš¬y_»que¡_no_exŒas
) + 4;

895 
	`memıy
(
buf
 + 
key_off£t
, 
key
, 
keyËn
);

896  (
´ÙocŞ_bš¬y_»que¡_no_exŒas
è+ 4 + 
keyËn
;

897 
	}
}

899 
off_t
 
	$¬™hm‘ic_commªd
(* 
buf
,

900 
size_t
 
bufsz
,

901 
ušt8_t
 
cmd
,

902 cÚ¡ * 
key
,

903 
size_t
 
keyËn
,

904 
ušt64_t
 
d–
,

905 
ušt64_t
 
š™Ÿl
,

906 
ušt32_t
 
exp
) {

907 
´ÙocŞ_bš¬y_»que¡_šü
 *
»que¡
 = (*)
buf
;

908 
	`as£¹
(
bufsz
 > (*
»que¡
è+ 
keyËn
);

910 
	`mem£t
(
»que¡
, 0, (*request));

911 
»que¡
->
mes§ge
.
h—d”
.»que¡.
magic
 = 
PROTOCOL_BINARY_REQ
;

912 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İcode
 = 
cmd
;

913 
»que¡
->
mes§ge
.
h—d”
.»que¡.
keyËn
 = 
	`htÚs
(keylen);

914 
»que¡
->
mes§ge
.
h—d”
.»que¡.
ex’
 = 20;

915 
»que¡
->
mes§ge
.
h—d”
.»que¡.
bodyËn
 = 
	`htÚl
(
keyËn
 + 20);

916 
»que¡
->
mes§ge
.
h—d”
.»que¡.
İaque
 = 0xdeadbeef;

917 
»que¡
->
mes§ge
.
body
.
d–
 = 
	`htÚÎ
(delta);

918 
»que¡
->
mes§ge
.
body
.
š™Ÿl
 = 
	`htÚÎ
(initial);

919 
»que¡
->
mes§ge
.
body
.
expœ©iÚ
 = 
	`htÚl
(
exp
);

921 
off_t
 
key_off£t
 = (
´ÙocŞ_bš¬y_»que¡_no_exŒas
) + 20;

923 
	`memıy
(
buf
 + 
key_off£t
, 
key
, 
keyËn
);

924  
key_off£t
 + 
keyËn
;

925 
	}
}

927 
	$v®id©e_»¥Ú£_h—d”
(
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 *
»¥Ú£
,

928 
ušt8_t
 
cmd
, 
ušt16_t
 
¡©us
)

930 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
magic
 =ğ
PROTOCOL_BINARY_RES
);

931 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
İcode
 =ğ
cmd
);

932 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
d©©y³
 =ğ
PROTOCOL_BINARY_RAW_BYTES
);

933 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
¡©us
 == status);

934 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
İaque
 == 0xdeadbeef);

936 ià(
¡©us
 =ğ
PROTOCOL_BINARY_RESPONSE_SUCCESS
) {

937 
cmd
) {

938 
PROTOCOL_BINARY_CMD_ADDQ
:

939 
PROTOCOL_BINARY_CMD_APPENDQ
:

940 
PROTOCOL_BINARY_CMD_DECREMENTQ
:

941 
PROTOCOL_BINARY_CMD_DELETEQ
:

942 
PROTOCOL_BINARY_CMD_FLUSHQ
:

943 
PROTOCOL_BINARY_CMD_INCREMENTQ
:

944 
PROTOCOL_BINARY_CMD_PREPENDQ
:

945 
PROTOCOL_BINARY_CMD_QUITQ
:

946 
PROTOCOL_BINARY_CMD_REPLACEQ
:

947 
PROTOCOL_BINARY_CMD_SETQ
:

948 
	`as£¹
("Qu›ˆcommªd shouldn'ˆ»tuº oÀsucûss" =ğ
NULL
);

953 
cmd
) {

954 
PROTOCOL_BINARY_CMD_ADD
:

955 
PROTOCOL_BINARY_CMD_REPLACE
:

956 
PROTOCOL_BINARY_CMD_SET
:

957 
PROTOCOL_BINARY_CMD_APPEND
:

958 
PROTOCOL_BINARY_CMD_PREPEND
:

959 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 == 0);

960 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ex’
 == 0);

961 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
bodyËn
 == 0);

962 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 != 0);

964 
PROTOCOL_BINARY_CMD_FLUSH
:

965 
PROTOCOL_BINARY_CMD_NOOP
:

966 
PROTOCOL_BINARY_CMD_QUIT
:

967 
PROTOCOL_BINARY_CMD_DELETE
:

968 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 == 0);

969 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ex’
 == 0);

970 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
bodyËn
 == 0);

971 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 == 0);

974 
PROTOCOL_BINARY_CMD_DECREMENT
:

975 
PROTOCOL_BINARY_CMD_INCREMENT
:

976 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 == 0);

977 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ex’
 == 0);

978 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
bodyËn
 == 8);

979 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 != 0);

982 
PROTOCOL_BINARY_CMD_STAT
:

983 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ex’
 == 0);

985 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 == 0);

988 
PROTOCOL_BINARY_CMD_VERSION
:

989 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 == 0);

990 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ex’
 == 0);

991 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
bodyËn
 != 0);

992 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 == 0);

995 
PROTOCOL_BINARY_CMD_GET
:

996 
PROTOCOL_BINARY_CMD_GETQ
:

997 
PROTOCOL_BINARY_CMD_GAT
:

998 
PROTOCOL_BINARY_CMD_GATQ
:

999 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 == 0);

1000 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ex’
 == 4);

1001 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 != 0);

1004 
PROTOCOL_BINARY_CMD_GETK
:

1005 
PROTOCOL_BINARY_CMD_GETKQ
:

1006 
PROTOCOL_BINARY_CMD_GATK
:

1007 
PROTOCOL_BINARY_CMD_GATKQ
:

1008 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 != 0);

1009 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ex’
 == 4);

1010 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 != 0);

1018 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 == 0);

1019 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
ex’
 == 0);

1020 ià(
cmd
 !ğ
PROTOCOL_BINARY_CMD_GETK
 &&

1021 
cmd
 !ğ
PROTOCOL_BINARY_CMD_GATK
) {

1022 
	`as£¹
(
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 == 0);

1025 
	}
}

1027 
‹¡_»tuº
 
	$‹¡_bš¬y_noİ
() {

1029 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1030 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1031 
by‹s
[1024];

1032 } 
bufãr
;

1034 
size_t
 
Ën
 = 
	`¿w_commªd
(
bufãr
.
by‹s
, (buffer.bytes),

1035 
PROTOCOL_BINARY_CMD_NOOP
,

1036 
NULL
, 0, NULL, 0);

1038 
	`§ã_£nd
(
bufãr
.
by‹s
, 
Ën
, 
çl£
);

1039 
	`§ã_»cv_·ck‘
(
bufãr
.
by‹s
, (buffer.bytes));

1040 
	`v®id©e_»¥Ú£_h—d”
(&
bufãr
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_NOOP
,

1041 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1043  
TEST_PASS
;

1044 
	}
}

1046 
‹¡_»tuº
 
	$‹¡_bš¬y_qu™_im¶
(
ušt8_t
 
cmd
) {

1048 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1049 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1050 
by‹s
[1024];

1051 } 
bufãr
;

1052 
size_t
 
Ën
 = 
	`¿w_commªd
(
bufãr
.
by‹s
, (buffer.bytes),

1053 
cmd
, 
NULL
, 0, NULL, 0);

1055 
	`§ã_£nd
(
bufãr
.
by‹s
, 
Ën
, 
çl£
);

1056 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_QUIT
) {

1057 
	`§ã_»cv_·ck‘
(
bufãr
.
by‹s
, (buffer.bytes));

1058 
	`v®id©e_»¥Ú£_h—d”
(&
bufãr
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_QUIT
,

1059 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1063 
	`as£¹
(
	`»ad
(
sock
, 
bufãr
.
by‹s
, (buffer.bytes)) == 0);

1064 
	`şo£
(
sock
);

1065 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

1067  
TEST_PASS
;

1068 
	}
}

1070 
‹¡_»tuº
 
	$‹¡_bš¬y_qu™
() {

1071  
	`‹¡_bš¬y_qu™_im¶
(
PROTOCOL_BINARY_CMD_QUIT
);

1072 
	}
}

1074 
‹¡_»tuº
 
	$‹¡_bš¬y_qu™q
() {

1075  
	`‹¡_bš¬y_qu™_im¶
(
PROTOCOL_BINARY_CMD_QUITQ
);

1076 
	}
}

1078 
‹¡_»tuº
 
	$‹¡_bš¬y_£t_im¶
(cÚ¡ *
key
, 
ušt8_t
 
cmd
) {

1080 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1081 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1082 
by‹s
[1024];

1083 } 
£nd
, 
»ûive
;

1084 
ušt64_t
 
v®ue
 = 0xdeadbeefdeadcafe;

1085 
size_t
 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1086 
key
, 
	`¡¾’
(key), &
v®ue
, (value),

1090 
ii
;

1091 
ii
 = 0; ii < 10; ++ii) {

1092 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1093 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_SET
) {

1094 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1095 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1096 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1100 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_SETQ
) {

1101  
	`‹¡_bš¬y_noİ
();

1104 
£nd
.
»que¡
.
mes§ge
.
h—d”
.»que¡.
ÿs
 = 
»ûive
.
»¥Ú£
.message.header.response.cas;

1105 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1106 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_SET
) {

1107 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1108 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1109 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1110 
	`as£¹
(
»ûive
.
»¥Ú£
.
mes§ge
.
h—d”
.»¥Ú£.
ÿs
 !ğ
£nd
.
»que¡
.message.header.request.cas);

1112  
	`‹¡_bš¬y_noİ
();

1115  
TEST_PASS
;

1116 
	}
}

1118 
‹¡_»tuº
 
	$‹¡_bš¬y_£t
() {

1119  
	`‹¡_bš¬y_£t_im¶
("‹¡_bš¬y_£t", 
PROTOCOL_BINARY_CMD_SET
);

1120 
	}
}

1122 
‹¡_»tuº
 
	$‹¡_bš¬y_£tq
() {

1123  
	`‹¡_bš¬y_£t_im¶
("‹¡_bš¬y_£tq", 
PROTOCOL_BINARY_CMD_SETQ
);

1124 
	}
}

1127 
‹¡_»tuº
 
	$‹¡_bš¬y_add_im¶
(cÚ¡ *
key
, 
ušt8_t
 
cmd
) {

1128 
ušt64_t
 
v®ue
 = 0xdeadbeefdeadcafe;

1130 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1131 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1132 
by‹s
[1024];

1133 } 
£nd
, 
»ûive
;

1134 
size_t
 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
, 
key
,

1135 
	`¡¾’
(
key
), &
v®ue
, (value),

1139 
ii
;

1140 
ii
 = 0; ii < 10; ++ii) {

1141 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1142 ià(
ii
 == 0) {

1143 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_ADD
) {

1144 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1145 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1146 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1149 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1150 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1151 
PROTOCOL_BINARY_RESPONSE_KEY_EEXISTS
);

1155  
TEST_PASS
;

1156 
	}
}

1158 
‹¡_»tuº
 
	$‹¡_bš¬y_add
() {

1159  
	`‹¡_bš¬y_add_im¶
("‹¡_bš¬y_add", 
PROTOCOL_BINARY_CMD_ADD
);

1160 
	}
}

1162 
‹¡_»tuº
 
	$‹¡_bš¬y_addq
() {

1163  
	`‹¡_bš¬y_add_im¶
("‹¡_bš¬y_addq", 
PROTOCOL_BINARY_CMD_ADDQ
);

1164 
	}
}

1166 
‹¡_»tuº
 
	$‹¡_bš¬y_»¶aû_im¶
(cÚ¡ * 
key
, 
ušt8_t
 
cmd
) {

1167 
ušt64_t
 
v®ue
 = 0xdeadbeefdeadcafe;

1169 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1170 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1171 
by‹s
[1024];

1172 } 
£nd
, 
»ûive
;

1173 
size_t
 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1174 
key
, 
	`¡¾’
(key), &
v®ue
, (value),

1176 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1177 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1178 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1179 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
);

1180 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (send.bytes),

1181 
PROTOCOL_BINARY_CMD_ADD
,

1182 
key
, 
	`¡¾’
(key), &
v®ue
, (value), 0, 0);

1183 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1184 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1185 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_ADD
,

1186 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1188 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1189 
key
, 
	`¡¾’
(key), &
v®ue
, (value), 0, 0);

1190 
ii
;

1191 
ii
 = 0; ii < 10; ++ii) {

1192 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1193 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_REPLACE
) {

1194 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1195 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
,

1196 
PROTOCOL_BINARY_CMD_REPLACE
,

1197 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1201 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_REPLACEQ
) {

1202 
	`‹¡_bš¬y_noİ
();

1205  
TEST_PASS
;

1206 
	}
}

1208 
‹¡_»tuº
 
	$‹¡_bš¬y_»¶aû
() {

1209  
	`‹¡_bš¬y_»¶aû_im¶
("test_binary_replace",

1210 
PROTOCOL_BINARY_CMD_REPLACE
);

1211 
	}
}

1213 
‹¡_»tuº
 
	$‹¡_bš¬y_»¶aûq
() {

1214  
	`‹¡_bš¬y_»¶aû_im¶
("test_binary_replaceq",

1215 
PROTOCOL_BINARY_CMD_REPLACEQ
);

1216 
	}
}

1218 
‹¡_»tuº
 
	$‹¡_bš¬y_d–‘e_im¶
(cÚ¡ *
key
, 
ušt8_t
 
cmd
) {

1220 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1221 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1222 
by‹s
[1024];

1223 } 
£nd
, 
»ûive
;

1224 
size_t
 
Ën
 = 
	`¿w_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1225 
key
, 
	`¡¾’
(key), 
NULL
, 0);

1227 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1228 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1229 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1230 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
);

1231 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (send.bytes),

1232 
PROTOCOL_BINARY_CMD_ADD
,

1233 
key
, 
	`¡¾’
(key), 
NULL
, 0, 0, 0);

1234 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1235 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1236 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_ADD
,

1237 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1239 
Ën
 = 
	`¿w_commªd
(
£nd
.
by‹s
, (send.bytes),

1240 
cmd
, 
key
, 
	`¡¾’
(key), 
NULL
, 0);

1241 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1243 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_DELETE
) {

1244 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1245 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_DELETE
,

1246 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1249 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1250 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1251 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1252 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
);

1254  
TEST_PASS
;

1255 
	}
}

1257 
‹¡_»tuº
 
	$‹¡_bš¬y_d–‘e
() {

1258  
	`‹¡_bš¬y_d–‘e_im¶
("test_binary_delete",

1259 
PROTOCOL_BINARY_CMD_DELETE
);

1260 
	}
}

1262 
‹¡_»tuº
 
	$‹¡_bš¬y_d–‘eq
() {

1263  
	`‹¡_bš¬y_d–‘e_im¶
("test_binary_deleteq",

1264 
PROTOCOL_BINARY_CMD_DELETEQ
);

1265 
	}
}

1267 
‹¡_»tuº
 
	$‹¡_bš¬y_g‘_im¶
(cÚ¡ *
key
, 
ušt8_t
 
cmd
) {

1269 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1270 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1271 
by‹s
[1024];

1272 } 
£nd
, 
»ûive
;

1274 
ušt32_t
 
expœ©iÚ
 = 
	`htÚl
(3600);

1275 
size_t
 
ex’
 = 0;

1276 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_GAT
 || cmd =ğ
PROTOCOL_BINARY_CMD_GATK
)

1277 
ex’
 = (
expœ©iÚ
);

1279 
size_t
 
Ën
 = 
	`ext_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1280 
ex’
 ? &
expœ©iÚ
 : 
NULL
,ƒxtlen,

1281 
key
, 
	`¡¾’
(key), 
NULL
, 0);

1283 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1284 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1285 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1286 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
);

1288 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (send.bytes),

1289 
PROTOCOL_BINARY_CMD_ADD
,

1290 
key
, 
	`¡¾’
(key), 
NULL
, 0,

1292 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1293 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1294 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_ADD
,

1295 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1298 
Ën
 = 0;

1299 
ii
;

1300 
ii
 = 0; ii < 10; ++ii) {

1302 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1303 
by‹s
[1024];

1304 } 
‹mp
;

1305 
size_t
 
l
 = 
	`ext_commªd
(
‹mp
.
by‹s
, Ñemp.by‹s), 
cmd
,

1306 
ex’
 ? &
expœ©iÚ
 : 
NULL
,ƒxtlen,

1307 
key
, 
	`¡¾’
(key), 
NULL
, 0);

1308 
	`memıy
(
£nd
.
by‹s
 + 
Ën
, 
‹mp
.by‹s, 
l
);

1309 
Ën
 +ğ
l
;

1312 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1313 
ii
 = 0; ii < 10; ++ii) {

1314 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1315 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1316 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1319  
TEST_PASS
;

1320 
	}
}

1322 
‹¡_»tuº
 
	$‹¡_bš¬y_g‘
() {

1323  
	`‹¡_bš¬y_g‘_im¶
("‹¡_bš¬y_g‘", 
PROTOCOL_BINARY_CMD_GET
);

1324 
	}
}

1326 
‹¡_»tuº
 
	$‹¡_bš¬y_g‘k
() {

1327  
	`‹¡_bš¬y_g‘_im¶
("‹¡_bš¬y_g‘k", 
PROTOCOL_BINARY_CMD_GETK
);

1328 
	}
}

1330 
‹¡_»tuº
 
	$‹¡_bš¬y_g©
() {

1331  
	`‹¡_bš¬y_g‘_im¶
("‹¡_bš¬y_g©", 
PROTOCOL_BINARY_CMD_GAT
);

1332 
	}
}

1334 
‹¡_»tuº
 
	$‹¡_bš¬y_g©k
() {

1335  
	`‹¡_bš¬y_g‘_im¶
("‹¡_bš¬y_g©k", 
PROTOCOL_BINARY_CMD_GATK
);

1336 
	}
}

1338 
‹¡_»tuº
 
	$‹¡_bš¬y_g‘q_im¶
(cÚ¡ *
key
, 
ušt8_t
 
cmd
) {

1339 cÚ¡ *
missšg
 = "test_binary_getq_missing";

1341 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1342 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1343 
by‹s
[1024];

1344 } 
£nd
, 
‹mp
, 
»ûive
;

1346 
ušt32_t
 
expœ©iÚ
 = 
	`htÚl
(3600);

1347 
size_t
 
ex’
 = 0;

1348 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_GATQ
 || cmd =ğ
PROTOCOL_BINARY_CMD_GATKQ
)

1349 
ex’
 = (
expœ©iÚ
);

1351 
size_t
 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (send.bytes),

1352 
PROTOCOL_BINARY_CMD_ADD
,

1353 
key
, 
	`¡¾’
(key), 
NULL
, 0,

1355 
size_t
 
Ën2
 = 
	`ext_commªd
(
‹mp
.
by‹s
, Ñemp.by‹s), 
cmd
,

1356 
ex’
 ? &
expœ©iÚ
 : 
NULL
,ƒxtlen,

1357 
missšg
, 
	`¡¾’
(missšg), 
NULL
, 0);

1360 
‹mp
.
»que¡
.
mes§ge
.
h—d”
.»que¡.
İaque
 = 0xfeedface;

1361 
	`memıy
(
£nd
.
by‹s
 + 
Ën
, 
‹mp
.by‹s, 
Ën2
);

1362 
Ën
 +ğ
Ën2
;

1364 
Ën2
 = 
	`ext_commªd
(
‹mp
.
by‹s
, Ñemp.by‹s), 
cmd
,

1365 
ex’
 ? &
expœ©iÚ
 : 
NULL
,ƒxtlen,

1366 
key
, 
	`¡¾’
(key), 
NULL
, 0);

1367 
	`memıy
(
£nd
.
by‹s
 + 
Ën
, 
‹mp
.by‹s, 
Ën2
);

1368 
Ën
 +ğ
Ën2
;

1370 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1371 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1372 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_ADD
,

1373 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1375 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1376 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1377 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1379  
TEST_PASS
;

1380 
	}
}

1382 
‹¡_»tuº
 
	$‹¡_bš¬y_g‘q
() {

1383  
	`‹¡_bš¬y_g‘q_im¶
("‹¡_bš¬y_g‘q", 
PROTOCOL_BINARY_CMD_GETQ
);

1384 
	}
}

1386 
‹¡_»tuº
 
	$‹¡_bš¬y_g‘kq
() {

1387  
	`‹¡_bš¬y_g‘q_im¶
("‹¡_bš¬y_g‘kq", 
PROTOCOL_BINARY_CMD_GETKQ
);

1388 
	}
}

1390 
‹¡_»tuº
 
	$‹¡_bš¬y_g©q
() {

1391  
	`‹¡_bš¬y_g‘q_im¶
("‹¡_bš¬y_g©q", 
PROTOCOL_BINARY_CMD_GATQ
);

1392 
	}
}

1394 
‹¡_»tuº
 
	$‹¡_bš¬y_g©kq
() {

1395  
	`‹¡_bš¬y_g‘q_im¶
("‹¡_bš¬y_g©kq", 
PROTOCOL_BINARY_CMD_GATKQ
);

1396 
	}
}

1398 
‹¡_»tuº
 
	$‹¡_bš¬y_šü_im¶
(cÚ¡ * 
key
, 
ušt8_t
 
cmd
) {

1400 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1401 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£_h—d”
;

1402 
´ÙocŞ_bš¬y_»¥Ú£_šü
 
»¥Ú£
;

1403 
by‹s
[1024];

1404 } 
£nd
, 
»ûive
;

1405 
size_t
 
Ën
 = 
	`¬™hm‘ic_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1406 
key
, 
	`¡¾’
(key), 1, 0, 0);

1408 
ii
;

1409 
ii
 = 0; ii < 10; ++ii) {

1410 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1411 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_INCREMENT
) {

1412 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1413 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£_h—d”
, 
cmd
,

1414 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1415 
	`as£¹
(
	`ÁohÎ
(
»ûive
.
»¥Ú£
.
mes§ge
.
body
.
v®ue
è=ğ
ii
);

1419 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_INCREMENTQ
) {

1420 
	`‹¡_bš¬y_noİ
();

1422  
TEST_PASS
;

1423 
	}
}

1425 
‹¡_»tuº
 
	$‹¡_bš¬y_šü
() {

1426  
	`‹¡_bš¬y_šü_im¶
("test_binary_incr",

1427 
PROTOCOL_BINARY_CMD_INCREMENT
);

1428 
	}
}

1430 
‹¡_»tuº
 
	$‹¡_bš¬y_šüq
() {

1431  
	`‹¡_bš¬y_šü_im¶
("test_binary_incrq",

1432 
PROTOCOL_BINARY_CMD_INCREMENTQ
);

1433 
	}
}

1435 
‹¡_»tuº
 
	$‹¡_bš¬y_deü_im¶
(cÚ¡ * 
key
, 
ušt8_t
 
cmd
) {

1437 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1438 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£_h—d”
;

1439 
´ÙocŞ_bš¬y_»¥Ú£_deü
 
»¥Ú£
;

1440 
by‹s
[1024];

1441 } 
£nd
, 
»ûive
;

1442 
size_t
 
Ën
 = 
	`¬™hm‘ic_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1443 
key
, 
	`¡¾’
(key), 1, 9, 0);

1445 
ii
;

1446 
ii
 = 9; ii >= 0; --ii) {

1447 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1448 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_DECREMENT
) {

1449 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1450 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£_h—d”
, 
cmd
,

1451 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1452 
	`as£¹
(
	`ÁohÎ
(
»ûive
.
»¥Ú£
.
mes§ge
.
body
.
v®ue
è=ğ
ii
);

1457 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1458 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_DECREMENT
) {

1459 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1460 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£_h—d”
, 
cmd
,

1461 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1462 
	`as£¹
(
	`ÁohÎ
(
»ûive
.
»¥Ú£
.
mes§ge
.
body
.
v®ue
) == 0);

1464 
	`‹¡_bš¬y_noİ
();

1467  
TEST_PASS
;

1468 
	}
}

1470 
‹¡_»tuº
 
	$‹¡_bš¬y_deü
() {

1471  
	`‹¡_bš¬y_deü_im¶
("test_binary_decr",

1472 
PROTOCOL_BINARY_CMD_DECREMENT
);

1473 
	}
}

1475 
‹¡_»tuº
 
	$‹¡_bš¬y_deüq
() {

1476  
	`‹¡_bš¬y_deü_im¶
("test_binary_decrq",

1477 
PROTOCOL_BINARY_CMD_DECREMENTQ
);

1478 
	}
}

1480 
‹¡_»tuº
 
	$‹¡_bš¬y_v”siÚ
() {

1482 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1483 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1484 
by‹s
[1024];

1485 } 
bufãr
;

1487 
size_t
 
Ën
 = 
	`¿w_commªd
(
bufãr
.
by‹s
, (buffer.bytes),

1488 
PROTOCOL_BINARY_CMD_VERSION
,

1489 
NULL
, 0, NULL, 0);

1491 
	`§ã_£nd
(
bufãr
.
by‹s
, 
Ën
, 
çl£
);

1492 
	`§ã_»cv_·ck‘
(
bufãr
.
by‹s
, (buffer.bytes));

1493 
	`v®id©e_»¥Ú£_h—d”
(&
bufãr
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_VERSION
,

1494 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1496  
TEST_PASS
;

1497 
	}
}

1499 
‹¡_»tuº
 
	$‹¡_bš¬y_æush_im¶
(cÚ¡ *
key
, 
ušt8_t
 
cmd
) {

1501 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1502 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1503 
by‹s
[1024];

1504 } 
£nd
, 
»ûive
;

1506 
size_t
 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (send.bytes),

1507 
PROTOCOL_BINARY_CMD_ADD
,

1508 
key
, 
	`¡¾’
(key), 
NULL
, 0, 0, 0);

1509 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1510 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1511 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_ADD
,

1512 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1514 
Ën
 = 
	`æush_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
, 2, 
Œue
);

1515 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1516 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_FLUSH
) {

1517 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1518 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1519 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1522 
Ën
 = 
	`¿w_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
PROTOCOL_BINARY_CMD_GET
,

1523 
key
, 
	`¡¾’
(key), 
NULL
, 0);

1524 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1525 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1526 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_GET
,

1527 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1529 
	`¦“p
(2);

1530 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1531 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1532 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_GET
,

1533 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
);

1535 
ii
;

1536 
ii
 = 0; ii < 2; ++ii) {

1537 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (send.bytes),

1538 
PROTOCOL_BINARY_CMD_ADD
,

1539 
key
, 
	`¡¾’
(key), 
NULL
, 0, 0, 0);

1540 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1541 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1542 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_ADD
,

1543 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1545 
Ën
 = 
	`æush_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
, 0, 
ii
 == 0);

1546 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1547 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_FLUSH
) {

1548 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1549 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1550 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1553 
Ën
 = 
	`¿w_commªd
(
£nd
.
by‹s
, (send.bytes),

1554 
PROTOCOL_BINARY_CMD_GET
,

1555 
key
, 
	`¡¾’
(key), 
NULL
, 0);

1556 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1557 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1558 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_GET
,

1559 
PROTOCOL_BINARY_RESPONSE_KEY_ENOENT
);

1562  
TEST_PASS
;

1563 
	}
}

1565 
‹¡_»tuº
 
	$‹¡_bš¬y_æush
() {

1566  
	`‹¡_bš¬y_æush_im¶
("test_binary_flush",

1567 
PROTOCOL_BINARY_CMD_FLUSH
);

1568 
	}
}

1570 
‹¡_»tuº
 
	$‹¡_bš¬y_æushq
() {

1571  
	`‹¡_bš¬y_æush_im¶
("test_binary_flushq",

1572 
PROTOCOL_BINARY_CMD_FLUSHQ
);

1573 
	}
}

1575 
‹¡_»tuº
 
	$‹¡_bš¬y_cÚÿt_im¶
(cÚ¡ *
key
, 
ušt8_t
 
cmd
) {

1577 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1578 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1579 
by‹s
[1024];

1580 } 
£nd
, 
»ûive
;

1581 cÚ¡ *
v®ue
 = "world";

1583 
size_t
 
Ën
 = 
	`¿w_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1584 
key
, 
	`¡¾’
(key), 
v®ue
, strlen(value));

1587 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1588 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1589 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1590 
PROTOCOL_BINARY_RESPONSE_NOT_STORED
);

1592 
Ën
 = 
	`¡Üage_commªd
(
£nd
.
by‹s
, (send.bytes),

1593 
PROTOCOL_BINARY_CMD_ADD
,

1594 
key
, 
	`¡¾’
(key), 
v®ue
, strlen(value), 0, 0);

1595 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1596 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1597 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_ADD
,

1598 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1600 
Ën
 = 
	`¿w_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
cmd
,

1601 
key
, 
	`¡¾’
(key), 
v®ue
, strlen(value));

1602 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1604 ià(
cmd
 =ğ
PROTOCOL_BINARY_CMD_APPEND
 || cmd =ğ
PROTOCOL_BINARY_CMD_PREPEND
) {

1605 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1606 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
cmd
,

1607 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1609 
Ën
 = 
	`¿w_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
PROTOCOL_BINARY_CMD_NOOP
,

1610 
NULL
, 0, NULL, 0);

1611 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1612 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1613 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_NOOP
,

1614 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1617 
Ën
 = 
	`¿w_commªd
(
£nd
.
by‹s
, (£nd.by‹s), 
PROTOCOL_BINARY_CMD_GETK
,

1618 
key
, 
	`¡¾’
(key), 
NULL
, 0);

1620 
	`§ã_£nd
(
£nd
.
by‹s
, 
Ën
, 
çl£
);

1621 
	`§ã_»cv_·ck‘
(
»ûive
.
by‹s
, (receive.bytes));

1622 
	`v®id©e_»¥Ú£_h—d”
(&
»ûive
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_GETK
,

1623 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1625 
	`as£¹
(
»ûive
.
»¥Ú£
.
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 =ğ
	`¡¾’
(
key
));

1626 
	`as£¹
(
»ûive
.
»¥Ú£
.
mes§ge
.
h—d”
.»¥Ú£.
bodyËn
 =ğ(
	`¡¾’
(
key
è+ 2*¡¾’(
v®ue
) + 4));

1628 *
±r
 = 
»ûive
.
by‹s
;

1629 
±r
 +ğ(
»ûive
.
»¥Ú£
);

1630 
±r
 += 4;

1632 
	`as£¹
(
	`memcmp
(
±r
, 
key
, 
	`¡¾’
(key)) == 0);

1633 
±r
 +ğ
	`¡¾’
(
key
);

1634 
	`as£¹
(
	`memcmp
(
±r
, 
v®ue
, 
	`¡¾’
(value)) == 0);

1635 
±r
 +ğ
	`¡¾’
(
v®ue
);

1636 
	`as£¹
(
	`memcmp
(
±r
, 
v®ue
, 
	`¡¾’
(value)) == 0);

1638  
TEST_PASS
;

1639 
	}
}

1641 
‹¡_»tuº
 
	$‹¡_bš¬y_­³nd
() {

1642  
	`‹¡_bš¬y_cÚÿt_im¶
("test_binary_append",

1643 
PROTOCOL_BINARY_CMD_APPEND
);

1644 
	}
}

1646 
‹¡_»tuº
 
	$‹¡_bš¬y_´•’d
() {

1647  
	`‹¡_bš¬y_cÚÿt_im¶
("test_binary_prepend",

1648 
PROTOCOL_BINARY_CMD_PREPEND
);

1649 
	}
}

1651 
‹¡_»tuº
 
	$‹¡_bš¬y_­³ndq
() {

1652  
	`‹¡_bš¬y_cÚÿt_im¶
("test_binary_appendq",

1653 
PROTOCOL_BINARY_CMD_APPENDQ
);

1654 
	}
}

1656 
‹¡_»tuº
 
	$‹¡_bš¬y_´•’dq
() {

1657  
	`‹¡_bš¬y_cÚÿt_im¶
("test_binary_prependq",

1658 
PROTOCOL_BINARY_CMD_PREPENDQ
);

1659 
	}
}

1661 
‹¡_»tuº
 
	$‹¡_bš¬y_¡©
() {

1663 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1664 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1665 
by‹s
[1024];

1666 } 
bufãr
;

1668 
size_t
 
Ën
 = 
	`¿w_commªd
(
bufãr
.
by‹s
, (buffer.bytes),

1669 
PROTOCOL_BINARY_CMD_STAT
,

1670 
NULL
, 0, NULL, 0);

1672 
	`§ã_£nd
(
bufãr
.
by‹s
, 
Ën
, 
çl£
);

1674 
	`§ã_»cv_·ck‘
(
bufãr
.
by‹s
, (buffer.bytes));

1675 
	`v®id©e_»¥Ú£_h—d”
(&
bufãr
.
»¥Ú£
, 
PROTOCOL_BINARY_CMD_STAT
,

1676 
PROTOCOL_BINARY_RESPONSE_SUCCESS
);

1677 } 
bufãr
.
»¥Ú£
.
mes§ge
.
h—d”
.»¥Ú£.
keyËn
 != 0);

1679  
TEST_PASS
;

1680 
	}
}

1682 
‹¡_»tuº
 
	$‹¡_bš¬y_Ëg®
() {

1683 
ušt8_t
 
cmd
 = 0x25;

1684 
cmd
 != 0x00) {

1686 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1687 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 
»¥Ú£
;

1688 
by‹s
[1024];

1689 } 
bufãr
;

1690 
size_t
 
Ën
 = 
	`¿w_commªd
(
bufãr
.
by‹s
, (buffer.bytes),

1691 
cmd
, 
NULL
, 0, NULL, 0);

1692 
	`§ã_£nd
(
bufãr
.
by‹s
, 
Ën
, 
çl£
);

1693 
	`§ã_»cv_·ck‘
(
bufãr
.
by‹s
, (buffer.bytes));

1694 
	`v®id©e_»¥Ú£_h—d”
(&
bufãr
.
»¥Ú£
, 
cmd
,

1695 
PROTOCOL_BINARY_RESPONSE_UNKNOWN_COMMAND
);

1696 ++
cmd
;

1699  
TEST_PASS
;

1700 
	}
}

1702 vŞ©
boŞ
 
	ghickup_th»ad_ruÂšg
;

1704 *
	$bš¬y_hickup_»cv_v”ifiÿtiÚ_th»ad
(*
¬g
) {

1705 
´ÙocŞ_bš¬y_»¥Ú£_no_exŒas
 *
»¥Ú£
 = 
	`m®loc
(65*1024);

1706 ià(
»¥Ú£
 !ğ
NULL
) {

1707 
	`§ã_»cv_·ck‘
(
»¥Ú£
, 65*1024)) {

1709 
	`v®id©e_»¥Ú£_h—d”
(
»¥Ú£
,

1710 
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
İcode
,

1711 
»¥Ú£
->
mes§ge
.
h—d”
.»¥Ú£.
¡©us
);

1713 
	`ä“
(
»¥Ú£
);

1715 
hickup_th»ad_ruÂšg
 = 
çl£
;

1716 
®low_şo£d_»ad
 = 
çl£
;

1717  
NULL
;

1718 
	}
}

1720 
‹¡_»tuº
 
	$‹¡_bš¬y_p–še_hickup_chunk
(*
bufãr
, 
size_t
 
bufãrsize
) {

1721 
off_t
 
off£t
 = 0;

1722 *
key
[256];

1723 
ušt64_t
 
v®ue
 = 0xfeedfacedeadbeef;

1725 
hickup_th»ad_ruÂšg
 &&

1726 
off£t
 + (
´ÙocŞ_bš¬y_»que¡_no_exŒas
è< 
bufãrsize
) {

1728 
´ÙocŞ_bš¬y_»que¡_no_exŒas
 
»que¡
;

1729 
by‹s
[65 * 1024];

1730 } 
commªd
;

1731 
ušt8_t
 
cmd
 = (ušt8_t)(
	`¿nd
() & 0xff);

1732 
size_t
 
Ën
;

1733 
size_t
 
keyËn
 = (
	`¿nd
() % 250) + 1;

1735 
cmd
) {

1736 
PROTOCOL_BINARY_CMD_ADD
:

1737 
PROTOCOL_BINARY_CMD_ADDQ
:

1738 
PROTOCOL_BINARY_CMD_REPLACE
:

1739 
PROTOCOL_BINARY_CMD_REPLACEQ
:

1740 
PROTOCOL_BINARY_CMD_SET
:

1741 
PROTOCOL_BINARY_CMD_SETQ
:

1742 
Ën
 = 
	`¡Üage_commªd
(
commªd
.
by‹s
, (commªd.by‹s), 
cmd
,

1743 
key
, 
keyËn
 , &
v®ue
, (value),

1746 
PROTOCOL_BINARY_CMD_APPEND
:

1747 
PROTOCOL_BINARY_CMD_APPENDQ
:

1748 
PROTOCOL_BINARY_CMD_PREPEND
:

1749 
PROTOCOL_BINARY_CMD_PREPENDQ
:

1750 
Ën
 = 
	`¿w_commªd
(
commªd
.
by‹s
, (commªd.by‹s), 
cmd
,

1751 
key
, 
keyËn
, &
v®ue
, (value));

1753 
PROTOCOL_BINARY_CMD_FLUSH
:

1754 
PROTOCOL_BINARY_CMD_FLUSHQ
:

1755 
Ën
 = 
	`¿w_commªd
(
commªd
.
by‹s
, (commªd.by‹s), 
cmd
,

1756 
NULL
, 0, NULL, 0);

1758 
PROTOCOL_BINARY_CMD_NOOP
:

1759 
Ën
 = 
	`¿w_commªd
(
commªd
.
by‹s
, (commªd.by‹s), 
cmd
,

1760 
NULL
, 0, NULL, 0);

1762 
PROTOCOL_BINARY_CMD_DELETE
:

1763 
PROTOCOL_BINARY_CMD_DELETEQ
:

1764 
Ën
 = 
	`¿w_commªd
(
commªd
.
by‹s
, (commªd.by‹s), 
cmd
,

1765 
key
, 
keyËn
, 
NULL
, 0);

1767 
PROTOCOL_BINARY_CMD_DECREMENT
:

1768 
PROTOCOL_BINARY_CMD_DECREMENTQ
:

1769 
PROTOCOL_BINARY_CMD_INCREMENT
:

1770 
PROTOCOL_BINARY_CMD_INCREMENTQ
:

1771 
Ën
 = 
	`¬™hm‘ic_commªd
(
commªd
.
by‹s
, (commªd.by‹s), 
cmd
,

1772 
key
, 
keyËn
, 1, 0, 0);

1774 
PROTOCOL_BINARY_CMD_VERSION
:

1775 
Ën
 = 
	`¿w_commªd
(
commªd
.
by‹s
, (command.bytes),

1776 
PROTOCOL_BINARY_CMD_VERSION
,

1777 
NULL
, 0, NULL, 0);

1779 
PROTOCOL_BINARY_CMD_GET
:

1780 
PROTOCOL_BINARY_CMD_GETK
:

1781 
PROTOCOL_BINARY_CMD_GETKQ
:

1782 
PROTOCOL_BINARY_CMD_GETQ
:

1783 
Ën
 = 
	`¿w_commªd
(
commªd
.
by‹s
, (commªd.by‹s), 
cmd
,

1784 
key
, 
keyËn
, 
NULL
, 0);

1787 
PROTOCOL_BINARY_CMD_TOUCH
:

1788 
PROTOCOL_BINARY_CMD_GAT
:

1789 
PROTOCOL_BINARY_CMD_GATQ
:

1790 
PROTOCOL_BINARY_CMD_GATK
:

1791 
PROTOCOL_BINARY_CMD_GATKQ
:

1792 
Ën
 = 
	`touch_commªd
(
commªd
.
by‹s
, (commªd.by‹s), 
cmd
,

1793 
key
, 
keyËn
, 10);

1796 
PROTOCOL_BINARY_CMD_STAT
:

1797 
Ën
 = 
	`¿w_commªd
(
commªd
.
by‹s
, (command.bytes),

1798 
PROTOCOL_BINARY_CMD_STAT
,

1799 
NULL
, 0, NULL, 0);

1802 
PROTOCOL_BINARY_CMD_SASL_LIST_MECHS
:

1803 
PROTOCOL_BINARY_CMD_SASL_AUTH
:

1804 
PROTOCOL_BINARY_CMD_SASL_STEP
:

1806 
PROTOCOL_BINARY_CMD_QUITQ
:

1807 
PROTOCOL_BINARY_CMD_QUIT
:

1809 
cmd
 |= 0xf0;

1812 
Ën
 = 
	`¿w_commªd
(
commªd
.
by‹s
, (command.bytes),

1813 
cmd
, 
NULL
, 0, NULL, 0);

1816 ià((
Ën
 + 
off£t
è< 
bufãrsize
) {

1817 
	`memıy
(((*)
bufãr
è+ 
off£t
, 
commªd
.
by‹s
, 
Ën
);

1818 
off£t
 +ğ
Ën
;

1823 
	`§ã_£nd
(
bufãr
, 
off£t
, 
Œue
);

1825  
TEST_PASS
;

1826 
	}
}

1828 
‹¡_»tuº
 
	$‹¡_bš¬y_p–še_hickup
()

1830 
size_t
 
bufãrsize
 = 65 * 1024;

1831 *
bufãr
 = 
	`m®loc
(
bufãrsize
);

1832 
ii
;

1834 
±h»ad_t
 
tid
;

1835 
»t
;

1836 
®low_şo£d_»ad
 = 
Œue
;

1837 
hickup_th»ad_ruÂšg
 = 
Œue
;

1838 ià((
»t
 = 
	`±h»ad_ü—‹
(&
tid
, 
NULL
,

1839 
bš¬y_hickup_»cv_v”ifiÿtiÚ_th»ad
, 
NULL
)) != 0) {

1840 
	`årštf
(
¡d”r
, "Cª'ˆü—‹h»ad: %s\n", 
	`¡»¼Ü
(
»t
));

1841  
TEST_FAIL
;

1845 
	`u¦“p
(250);

1847 
	`¤ªd
(()
	`time
(
NULL
));

1848 
ii
 = 0; ii < 2; ++ii) {

1849 
	`‹¡_bš¬y_p–še_hickup_chunk
(
bufãr
, 
bufãrsize
);

1853 
size_t
 
Ën
 = 
	`¿w_commªd
(
bufãr
, 
bufãrsize
, 
PROTOCOL_BINARY_CMD_QUITQ
,

1854 
NULL
, 0, NULL, 0);

1855 
	`§ã_£nd
(
bufãr
, 
Ën
, 
çl£
);

1857 
	`±h»ad_još
(
tid
, 
NULL
);

1858 
	`ä“
(
bufãr
);

1859  
TEST_PASS
;

1860 
	}
}

1863 
‹¡_»tuº
 
	$‹¡_issue_101
() {

1864 ’um { 
max
 = 2 };

1865 
‹¡_»tuº
 
»t
 = 
TEST_PASS
;

1866 
fds
[
max
];

1867 
ii
 = 0;

1868 
pid_t
 
chd
 = 0;

1870 ià(
	`g‘’v
("SKIP_TEST_101"è!ğ
NULL
) {

1871  
TEST_SKIP
;

1874 cÚ¡ *
commªd
 = "stats\r\nstats\r\nstats\r\nstats\r\nstats\r\n";

1875 
size_t
 
cmdËn
 = 
	`¡¾’
(
commªd
);

1877 
£rv”_pid
 = 
	`¡¬t_£rv”
(&
pÜt
, 
çl£
, 1000);

1879 
ii
 = 0; i˜< 
max
; ++ii) {

1880 
fds
[
ii
] = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
Œue
);

1881 
	`as£¹
(
fds
[
ii
] > 0);

1885 
ii
 = 0; i˜< 
max
; ++ii) {

1886 
boŞ
 
mÜe
 = 
Œue
;

1888 
ssize_t
 
”r
 = 
	`wr™e
(
fds
[
ii
], 
commªd
, 
cmdËn
);

1889 ià(
”r
 == -1) {

1890 
”ºo
) {

1891 
EINTR
:

1893 
ENOMEM
:

1894 
EWOULDBLOCK
:

1895 
mÜe
 = 
çl£
;

1898 
»t
 = 
TEST_FAIL
;

1899 
ş—nup
;

1902 } 
mÜe
);

1905 
chd
 = 
	`fÜk
();

1906 ià(
chd
 =ğ(
pid_t
)-1) {

1907 
	`abÜt
();

1908 } ià(
chd
 > 0) {

1909 
¡©
;

1910 
pid_t
 
c
;

1911 (
c
 = 
	`wa™pid
(
chd
, &
¡©
, 0)è=ğ(
pid_t
)-1 && 
”ºo
 =ğ
EINTR
);

1912 
	`as£¹
(
c
 =ğ
chd
);

1913 
	`as£¹
(
¡©
 == 0);

1915 
sock
 = 
	`cÚÃù_£rv”
("127.0.0.1", 
pÜt
, 
çl£
);

1916 
»t
 = 
	`‹¡_bš¬y_noİ
();

1917 
	`şo£
(
sock
);

1918 
	`ex™
(0);

1921 
ş—nup
:

1923 
ii
 = 0; i˜< 
max
; ++ii) {

1924 
	`şo£
(
fds
[
ii
]);

1927 
	`as£¹
(
	`kl
(
£rv”_pid
, 
SIGTERM
) == 0);

1929  
»t
;

1930 
	}
}

1932 
	$‹¡_»tuº
 (*
	tTEST_FUNC
)();

1933 
	s‹¡ÿ£
 {

1934 cÚ¡ *
desütiÚ
;

1935 
TEST_FUNC
 
funùiÚ
;

1938 
‹¡ÿ£
 
‹¡ÿ£s
[] = {

1939 { "ÿche_ü—‹", 
ÿche_ü—‹_‹¡
 },

1940 { "ÿche_cÚ¡ruùÜ", 
ÿche_cÚ¡ruùÜ_‹¡
 },

1941 { "ÿche_cÚ¡ruùÜ_ç", 
ÿche_ç_cÚ¡ruùÜ_‹¡
 },

1942 { "ÿche_de¡ruùÜ", 
ÿche_de¡ruùÜ_‹¡
 },

1943 { "ÿche_»u£", 
ÿche_»u£_‹¡
 },

1944 { "ÿche_»dzÚe", 
ÿche_»dzÚe_‹¡
 },

1945 { "issue_161", 
‹¡_issue_161
 },

1946 { "¡¹Ş", 
‹¡_§ã_¡¹Ş
 },

1947 { "¡¹Şl", 
‹¡_§ã_¡¹Şl
 },

1948 { "¡¹oul", 
‹¡_§ã_¡¹oul
 },

1949 { "¡¹ouÎ", 
‹¡_§ã_¡¹ouÎ
 },

1950 { "issue_44", 
‹¡_issue_44
 },

1951 { "v³¼Ü", 
‹¡_v³¼Ü
 },

1952 { "issue_101", 
‹¡_issue_101
 },

1954 { "¡¬t_£rv”", 
¡¬t_memÿched_£rv”
 },

1955 { "issue_92", 
‹¡_issue_92
 },

1956 { "issue_102", 
‹¡_issue_102
 },

1957 { "bš¬y_noİ", 
‹¡_bš¬y_noİ
 },

1958 { "bš¬y_qu™", 
‹¡_bš¬y_qu™
 },

1959 { "bš¬y_qu™q", 
‹¡_bš¬y_qu™q
 },

1960 { "bš¬y_£t", 
‹¡_bš¬y_£t
 },

1961 { "bš¬y_£tq", 
‹¡_bš¬y_£tq
 },

1962 { "bš¬y_add", 
‹¡_bš¬y_add
 },

1963 { "bš¬y_addq", 
‹¡_bš¬y_addq
 },

1964 { "bš¬y_»¶aû", 
‹¡_bš¬y_»¶aû
 },

1965 { "bš¬y_»¶aûq", 
‹¡_bš¬y_»¶aûq
 },

1966 { "bš¬y_d–‘e", 
‹¡_bš¬y_d–‘e
 },

1967 { "bš¬y_d–‘eq", 
‹¡_bš¬y_d–‘eq
 },

1968 { "bš¬y_g‘", 
‹¡_bš¬y_g‘
 },

1969 { "bš¬y_g‘q", 
‹¡_bš¬y_g‘q
 },

1970 { "bš¬y_g‘k", 
‹¡_bš¬y_g‘k
 },

1971 { "bš¬y_g‘kq", 
‹¡_bš¬y_g‘kq
 },

1972 { "bš¬y_g©", 
‹¡_bš¬y_g©
 },

1973 { "bš¬y_g©q", 
‹¡_bš¬y_g©q
 },

1974 { "bš¬y_g©k", 
‹¡_bš¬y_g©k
 },

1975 { "bš¬y_g©kq", 
‹¡_bš¬y_g©kq
 },

1976 { "bš¬y_šü", 
‹¡_bš¬y_šü
 },

1977 { "bš¬y_šüq", 
‹¡_bš¬y_šüq
 },

1978 { "bš¬y_deü", 
‹¡_bš¬y_deü
 },

1979 { "bš¬y_deüq", 
‹¡_bš¬y_deüq
 },

1980 { "bš¬y_v”siÚ", 
‹¡_bš¬y_v”siÚ
 },

1981 { "bš¬y_æush", 
‹¡_bš¬y_æush
 },

1982 { "bš¬y_æushq", 
‹¡_bš¬y_æushq
 },

1983 { "bš¬y_­³nd", 
‹¡_bš¬y_­³nd
 },

1984 { "bš¬y_­³ndq", 
‹¡_bš¬y_­³ndq
 },

1985 { "bš¬y_´•’d", 
‹¡_bš¬y_´•’d
 },

1986 { "bš¬y_´•’dq", 
‹¡_bš¬y_´•’dq
 },

1987 { "bš¬y_¡©", 
‹¡_bš¬y_¡©
 },

1988 { "bš¬y_Ëg®", 
‹¡_bš¬y_Ëg®
 },

1989 { "bš¬y_p–še_hickup", 
‹¡_bš¬y_p–še_hickup
 },

1990 { "shutdown", 
shutdown_memÿched_£rv”
 },

1991 { "¡İ_£rv”", 
¡İ_memÿched_£rv”
 },

1992 { 
NULL
, NULL }

1993 
	}
};

1995 
	$maš
(
¬gc
, **
¬gv
)

1997 
ex™code
 = 0;

1998 
ii
 = 0, 
num_ÿ£s
 = 0;

2000 
num_ÿ£s
 = 0; 
‹¡ÿ£s
[num_ÿ£s].
desütiÚ
;‚um_cases++) {

2004 
	`´štf
("1..%d\n", 
num_ÿ£s
);

2006 
ii
 = 0; 
‹¡ÿ£s
[ii].
desütiÚ
 !ğ
NULL
; ++ii) {

2007 
	`fæush
(
¡dout
);

2008 #iâdeà
DEBUG


2010 
	`®¬m
(600);

2012 
‹¡_»tuº
 
»t
 = 
‹¡ÿ£s
[
ii
].
	`funùiÚ
();

2013 ià(
»t
 =ğ
TEST_SKIP
) {

2014 
	`årštf
(
¡dout
, "ok # SKIP %d - %s\n", 
ii
 + 1, 
‹¡ÿ£s
[ii].
desütiÚ
);

2015 } ià(
»t
 =ğ
TEST_PASS
) {

2016 
	`årštf
(
¡dout
, "ok %d - %s\n", 
ii
 + 1, 
‹¡ÿ£s
[ii].
desütiÚ
);

2018 
	`årštf
(
¡dout
, "nÙ ok %d - %s\n", 
ii
 + 1, 
‹¡ÿ£s
[ii].
desütiÚ
);

2019 
ex™code
 = 1;

2021 
	`fæush
(
¡dout
);

2024  
ex™code
;

2025 
	}
}

	@thread.c

5 
	~"memÿched.h
"

6 
	~<as£¹.h
>

7 
	~<¡dio.h
>

8 
	~<”ºo.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

11 
	~<±h»ad.h
>

13 #ifdeà
__sun


14 
	~<©omic.h
>

17 
	#ITEMS_PER_ALLOC
 64

	)

20 
cÚn_queue_™em
 
	tCQ_ITEM
;

21 
	scÚn_queue_™em
 {

22 
	msfd
;

23 
cÚn_¡©es
 
	mš™_¡©e
;

24 
	mev’t_æags
;

25 
	m»ad_bufãr_size
;

26 
ÃtwÜk_Œª¥Üt
 
	mŒª¥Üt
;

27 
cÚn
 *
	mc
;

28 
CQ_ITEM
 *
	mÃxt
;

32 
cÚn_queue
 
	tCQ
;

33 
	scÚn_queue
 {

34 
CQ_ITEM
 *
	mh—d
;

35 
CQ_ITEM
 *
	m
;

36 
±h»ad_mu‹x_t
 
	mlock
;

40 
±h»ad_mu‹x_t
 
	gÌu_locks
[
POWER_LARGEST
];

43 
±h»ad_mu‹x_t
 
	gcÚn_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

45 #ià!
defšed
(
HAVE_GCC_ATOMICS
è&& !defšed(
__sun
)

46 
±h»ad_mu‹x_t
 
	g©omics_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

50 
±h»ad_mu‹x_t
 
	g¡©s_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

53 
±h»ad_mu‹x_t
 
	gwÜk”_hªg_lock
;

56 
CQ_ITEM
 *
	gcqi_ä“li¡
;

57 
±h»ad_mu‹x_t
 
	gcqi_ä“li¡_lock
;

59 
±h»ad_mu‹x_t
 *
	g™em_locks
;

61 
ušt32_t
 
	g™em_lock_couÁ
;

62 
	g™em_lock_hashpow”
;

63 
	#hashsize
(
n
è(()1<<Ò))

	)

64 
	#hashmask
(
n
è(
	`hashsize
Ò)-1)

	)

70 
LIBEVENT_THREAD
 *
	gth»ads
;

75 
	gš™_couÁ
 = 0;

76 
±h»ad_mu‹x_t
 
	gš™_lock
;

77 
±h»ad_cÚd_t
 
	gš™_cÚd
;

80 
th»ad_libev’t_´oûss
(
fd
, 
which
, *
¬g
);

82 
	$»fcouÁ_šü
(*
»fcouÁ
) {

83 #ifdeà
HAVE_GCC_ATOMICS


84  
	`__sync_add_ªd_ãtch
(
»fcouÁ
, 1);

85 #–ià
	`defšed
(
__sun
)

86  
	`©omic_šc_ushÜt_nv
(
»fcouÁ
);

88 
»s
;

89 
	`mu‹x_lock
(&
©omics_mu‹x
);

90 (*
»fcouÁ
)++;

91 
»s
 = *
»fcouÁ
;

92 
	`mu‹x_uÆock
(&
©omics_mu‹x
);

93  
»s
;

95 
	}
}

97 
	$»fcouÁ_deü
(*
»fcouÁ
) {

98 #ifdeà
HAVE_GCC_ATOMICS


99  
	`__sync_sub_ªd_ãtch
(
»fcouÁ
, 1);

100 #–ià
	`defšed
(
__sun
)

101  
	`©omic_dec_ushÜt_nv
(
»fcouÁ
);

103 
»s
;

104 
	`mu‹x_lock
(&
©omics_mu‹x
);

105 (*
»fcouÁ
)--;

106 
»s
 = *
»fcouÁ
;

107 
	`mu‹x_uÆock
(&
©omics_mu‹x
);

108  
»s
;

110 
	}
}

120 
	$™em_lock
(
ušt32_t
 
hv
) {

121 
	`mu‹x_lock
(&
™em_locks
[
hv
 & 
	`hashmask
(
™em_lock_hashpow”
)]);

122 
	}
}

124 *
	$™em_Œylock
(
ušt32_t
 
hv
) {

125 
±h»ad_mu‹x_t
 *
lock
 = &
™em_locks
[
hv
 & 
	`hashmask
(
™em_lock_hashpow”
)];

126 ià(
	`±h»ad_mu‹x_Œylock
(
lock
) == 0) {

127  
lock
;

129  
NULL
;

130 
	}
}

132 
	$™em_Œylock_uÆock
(*
lock
) {

133 
	`mu‹x_uÆock
((
±h»ad_mu‹x_t
 *è
lock
);

134 
	}
}

136 
	$™em_uÆock
(
ušt32_t
 
hv
) {

137 
	`mu‹x_uÆock
(&
™em_locks
[
hv
 & 
	`hashmask
(
™em_lock_hashpow”
)]);

138 
	}
}

140 
	$wa™_fÜ_th»ad_»gi¡¿tiÚ
(
Áh»ads
) {

141 
š™_couÁ
 < 
Áh»ads
) {

142 
	`±h»ad_cÚd_wa™
(&
š™_cÚd
, &
š™_lock
);

144 
	}
}

146 
	$»gi¡”_th»ad_š™Ÿlized
() {

147 
	`±h»ad_mu‹x_lock
(&
š™_lock
);

148 
š™_couÁ
++;

149 
	`±h»ad_cÚd_sigÇl
(&
š™_cÚd
);

150 
	`±h»ad_mu‹x_uÆock
(&
š™_lock
);

152 
	`±h»ad_mu‹x_lock
(&
wÜk”_hªg_lock
);

153 
	`±h»ad_mu‹x_uÆock
(&
wÜk”_hªg_lock
);

154 
	}
}

157 
	$·u£_th»ads
(
·u£_th»ad_ty³s
 
ty³
) {

158 
buf
[1];

159 
i
;

161 
buf
[0] = 0;

162 
ty³
) {

163 
PAUSE_ALL_THREADS
:

164 
	`¦abs_»b®ªûr_·u£
();

165 
	`Ìu_üawËr_·u£
();

166 
	`Ìu_mašš”_·u£
();

167 
PAUSE_WORKER_THREADS
:

168 
buf
[0] = 'p';

169 
	`±h»ad_mu‹x_lock
(&
wÜk”_hªg_lock
);

171 
RESUME_ALL_THREADS
:

172 
	`¦abs_»b®ªûr_»sume
();

173 
	`Ìu_üawËr_»sume
();

174 
	`Ìu_mašš”_»sume
();

175 
RESUME_WORKER_THREADS
:

176 
	`±h»ad_mu‹x_uÆock
(&
wÜk”_hªg_lock
);

179 
	`årštf
(
¡d”r
, "UnknowÀlocky³: %d\n", 
ty³
);

180 
	`as£¹
(1 == 0);

185 ià(
buf
[0] == 0) {

189 
	`±h»ad_mu‹x_lock
(&
š™_lock
);

190 
š™_couÁ
 = 0;

191 
i
 = 0; i < 
£‰šgs
.
num_th»ads
; i++) {

192 ià(
	`wr™e
(
th»ads
[
i
].
nÙify_£nd_fd
, 
buf
, 1) != 1) {

193 
	`³¼Ü
("Failed writingo‚otify…ipe");

197 
	`wa™_fÜ_th»ad_»gi¡¿tiÚ
(
£‰šgs
.
num_th»ads
);

198 
	`±h»ad_mu‹x_uÆock
(&
š™_lock
);

199 
	}
}

204 
	$cq_š™
(
CQ
 *
cq
) {

205 
	`±h»ad_mu‹x_š™
(&
cq
->
lock
, 
NULL
);

206 
cq
->
h—d
 = 
NULL
;

207 
cq
->

 = 
NULL
;

208 
	}
}

215 
CQ_ITEM
 *
	$cq_pİ
(
CQ
 *
cq
) {

216 
CQ_ITEM
 *
™em
;

218 
	`±h»ad_mu‹x_lock
(&
cq
->
lock
);

219 
™em
 = 
cq
->
h—d
;

220 ià(
NULL
 !ğ
™em
) {

221 
cq
->
h—d
 = 
™em
->
Ãxt
;

222 ià(
NULL
 =ğ
cq
->
h—d
)

223 
cq
->

 = 
NULL
;

225 
	`±h»ad_mu‹x_uÆock
(&
cq
->
lock
);

227  
™em
;

228 
	}
}

233 
	$cq_push
(
CQ
 *
cq
, 
CQ_ITEM
 *
™em
) {

234 
™em
->
Ãxt
 = 
NULL
;

236 
	`±h»ad_mu‹x_lock
(&
cq
->
lock
);

237 ià(
NULL
 =ğ
cq
->

)

238 
cq
->
h—d
 = 
™em
;

240 
cq
->

->
Ãxt
 = 
™em
;

241 
cq
->

 = 
™em
;

242 
	`±h»ad_mu‹x_uÆock
(&
cq
->
lock
);

243 
	}
}

248 
CQ_ITEM
 *
	$cqi_Ãw
() {

249 
CQ_ITEM
 *
™em
 = 
NULL
;

250 
	`±h»ad_mu‹x_lock
(&
cqi_ä“li¡_lock
);

251 ià(
cqi_ä“li¡
) {

252 
™em
 = 
cqi_ä“li¡
;

253 
cqi_ä“li¡
 = 
™em
->
Ãxt
;

255 
	`±h»ad_mu‹x_uÆock
(&
cqi_ä“li¡_lock
);

257 ià(
NULL
 =ğ
™em
) {

258 
i
;

261 
™em
 = 
	`m®loc
((
CQ_ITEM
è* 
ITEMS_PER_ALLOC
);

262 ià(
NULL
 =ğ
™em
) {

263 
	`STATS_LOCK
();

264 
¡©s
.
m®loc_çs
++;

265 
	`STATS_UNLOCK
();

266  
NULL
;

274 
i
 = 2; i < 
ITEMS_PER_ALLOC
; i++)

275 
™em
[
i
 - 1].
Ãxt
 = &item[i];

277 
	`±h»ad_mu‹x_lock
(&
cqi_ä“li¡_lock
);

278 
™em
[
ITEMS_PER_ALLOC
 - 1].
Ãxt
 = 
cqi_ä“li¡
;

279 
cqi_ä“li¡
 = &
™em
[1];

280 
	`±h»ad_mu‹x_uÆock
(&
cqi_ä“li¡_lock
);

283  
™em
;

284 
	}
}

290 
	$cqi_ä“
(
CQ_ITEM
 *
™em
) {

291 
	`±h»ad_mu‹x_lock
(&
cqi_ä“li¡_lock
);

292 
™em
->
Ãxt
 = 
cqi_ä“li¡
;

293 
cqi_ä“li¡
 = 
™em
;

294 
	`±h»ad_mu‹x_uÆock
(&
cqi_ä“li¡_lock
);

295 
	}
}

301 
ü—‹_wÜk”
(*(*
func
)(*), *
¬g
) {

302 
±h»ad_©Œ_t
 
	g©Œ
;

303 
	g»t
;

305 
±h»ad_©Œ_š™
(&
©Œ
);

307 ià((
	g»t
 = 
±h»ad_ü—‹
(&((
LIBEVENT_THREAD
*)
¬g
)->
th»ad_id
, &
©Œ
, 
func
,‡rg)) != 0) {

308 
årštf
(
¡d”r
, "Can't createhread: %s\n",

309 
¡»¼Ü
(
»t
));

310 
ex™
(1);

317 
	$acû±_Ãw_cÚns
(cÚ¡ 
boŞ
 
do_acû±
) {

318 
	`±h»ad_mu‹x_lock
(&
cÚn_lock
);

319 
	`do_acû±_Ãw_cÚns
(
do_acû±
);

320 
	`±h»ad_mu‹x_uÆock
(&
cÚn_lock
);

321 
	}
}

327 
	$£tup_th»ad
(
LIBEVENT_THREAD
 *
me
) {

328 
me
->
ba£
 = 
	`ev’t_š™
();

329 ià(! 
me
->
ba£
) {

330 
	`årštf
(
¡d”r
, "Can't‡llocateƒvent base\n");

331 
	`ex™
(1);

335 
	`ev’t_£t
(&
me
->
nÙify_ev’t
, me->
nÙify_»ûive_fd
,

336 
EV_READ
 | 
EV_PERSIST
, 
th»ad_libev’t_´oûss
, 
me
);

337 
	`ev’t_ba£_£t
(
me
->
ba£
, &me->
nÙify_ev’t
);

339 ià(
	`ev’t_add
(&
me
->
nÙify_ev’t
, 0) == -1) {

340 
	`årštf
(
¡d”r
, "Can't monitor†ibevent‚otify…ipe\n");

341 
	`ex™
(1);

344 
me
->
Ãw_cÚn_queue
 = 
	`m®loc
((
cÚn_queue
));

345 ià(
me
->
Ãw_cÚn_queue
 =ğ
NULL
) {

346 
	`³¼Ü
("Failedo‡llocate memory for connection queue");

347 
	`ex™
(
EXIT_FAILURE
);

349 
	`cq_š™
(
me
->
Ãw_cÚn_queue
);

351 
	`±h»ad_mu‹x_š™
(&
me
->
¡©s
.
mu‹x
, 
NULL
) != 0;

353 
me
->
suffix_ÿche
 = 
	`ÿche_ü—‹
("suffix", 
SUFFIX_SIZE
, (*),

354 
NULL
, NULL);

355 
	}
}

360 *
	$wÜk”_libev’t
(*
¬g
) {

361 
LIBEVENT_THREAD
 *
me
 = 
¬g
;

366 
me
->
l
 = 
	`logg”_ü—‹
();

367 ià(
me
->
l
 =ğ
NULL
) {

368 
	`abÜt
();

371 
	`»gi¡”_th»ad_š™Ÿlized
();

373 
	`ev’t_ba£_loİ
(
me
->
ba£
, 0);

374  
NULL
;

375 
	}
}

382 
	$th»ad_libev’t_´oûss
(
fd
, 
which
, *
¬g
) {

383 
LIBEVENT_THREAD
 *
me
 = 
¬g
;

384 
CQ_ITEM
 *
™em
;

385 
buf
[1];

386 
timeout_fd
;

388 ià(
	`»ad
(
fd
, 
buf
, 1) != 1) {

389 ià(
£‰šgs
.
v”bo£
 > 0)

390 
	`årštf
(
¡d”r
, "Can't„ead from†ibevent…ipe\n");

394 
buf
[0]) {

396 
™em
 = 
	`cq_pİ
(
me
->
Ãw_cÚn_queue
);

398 ià(
NULL
 !ğ
™em
) {

399 
cÚn
 *
c
 = 
	`cÚn_Ãw
(
™em
->
sfd
, i‹m->
š™_¡©e
, i‹m->
ev’t_æags
,

400 
™em
->
»ad_bufãr_size
, i‹m->
Œª¥Üt
,

401 
me
->
ba£
);

402 ià(
c
 =ğ
NULL
) {

403 ià(
	`IS_UDP
(
™em
->
Œª¥Üt
)) {

404 
	`årštf
(
¡d”r
, "Can't†isten forƒvents on UDP socket\n");

405 
	`ex™
(1);

407 ià(
£‰šgs
.
v”bo£
 > 0) {

408 
	`årštf
(
¡d”r
, "Can't†isten forƒvents on fd %d\n",

409 
™em
->
sfd
);

411 
	`şo£
(
™em
->
sfd
);

414 
c
->
th»ad
 = 
me
;

416 
	`cqi_ä“
(
™em
);

420 
™em
 = 
	`cq_pİ
(
me
->
Ãw_cÚn_queue
);

422 ià(
NULL
 !ğ
™em
) {

423 
	`cÚn_wÜk”_»add
(
™em
->
c
);

424 
	`cqi_ä“
(
™em
);

429 
	`»gi¡”_th»ad_š™Ÿlized
();

433 ià(
	`»ad
(
fd
, &
timeout_fd
, (timeout_fd)) != (timeout_fd)) {

434 ià(
£‰šgs
.
v”bo£
 > 0)

435 
	`årštf
(
¡d”r
, "Can't„eadimeout fd from†ibevent…ipe\n");

438 
	`cÚn_şo£_idË
(
cÚns
[
timeout_fd
]);

441 
	}
}

444 
	gÏ¡_th»ad
 = -1;

451 
	$di¥©ch_cÚn_Ãw
(
sfd
, 
cÚn_¡©es
 
š™_¡©e
, 
ev’t_æags
,

452 
»ad_bufãr_size
, 
ÃtwÜk_Œª¥Üt
 
Œª¥Üt
) {

453 
CQ_ITEM
 *
™em
 = 
	`cqi_Ãw
();

454 
buf
[1];

455 ià(
™em
 =ğ
NULL
) {

456 
	`şo£
(
sfd
);

458 
	`årštf
(
¡d”r
, "Failedo‡llocate memory for connection object\n");

462 
tid
 = (
Ï¡_th»ad
 + 1è% 
£‰šgs
.
num_th»ads
;

464 
LIBEVENT_THREAD
 *
th»ad
 = 
th»ads
 + 
tid
;

466 
Ï¡_th»ad
 = 
tid
;

468 
™em
->
sfd
 = sfd;

469 
™em
->
š™_¡©e
 = init_state;

470 
™em
->
ev’t_æags
 =ƒvent_flags;

471 
™em
->
»ad_bufãr_size
 =„ead_buffer_size;

472 
™em
->
Œª¥Üt
 =ransport;

474 
	`cq_push
(
th»ad
->
Ãw_cÚn_queue
, 
™em
);

476 
	`MEMCACHED_CONN_DISPATCH
(
sfd
, 
th»ad
->
th»ad_id
);

477 
buf
[0] = 'c';

478 ià(
	`wr™e
(
th»ad
->
nÙify_£nd_fd
, 
buf
, 1) != 1) {

479 
	`³¼Ü
("Writingohread‚otify…ipe");

481 
	}
}

487 
	$»di¥©ch_cÚn
(
cÚn
 *
c
) {

488 
CQ_ITEM
 *
™em
 = 
	`cqi_Ãw
();

489 
buf
[1];

490 ià(
™em
 =ğ
NULL
) {

492 
c
->
¡©e
 = 
cÚn_şo£d
;

493 
	`şo£
(
c
->
sfd
);

496 
LIBEVENT_THREAD
 *
th»ad
 = 
c
->thread;

497 
™em
->
sfd
 = 
c
->sfd;

498 
™em
->
š™_¡©e
 = 
cÚn_Ãw_cmd
;

499 
™em
->
c
 = c;

501 
	`cq_push
(
th»ad
->
Ãw_cÚn_queue
, 
™em
);

503 
buf
[0] = 'r';

504 ià(
	`wr™e
(
th»ad
->
nÙify_£nd_fd
, 
buf
, 1) != 1) {

505 
	`³¼Ü
("Writingohread‚otify…ipe");

507 
	}
}

510 
	$sid‘h»ad_cÚn_şo£
(
cÚn
 *
c
) {

511 
c
->
¡©e
 = 
cÚn_şo£d
;

512 ià(
£‰šgs
.
v”bo£
 > 1)

513 
	`årštf
(
¡d”r
, "<%d cÚÃùiÚ clo£d from sidth»ad.\n", 
c
->
sfd
);

514 
	`şo£
(
c
->
sfd
);

516 
	`STATS_LOCK
();

517 
¡©s_¡©e
.
cu¼_cÚns
--;

518 
	`STATS_UNLOCK
();

521 
	}
}

528 
™em
 *
	$™em_®loc
(*
key
, 
size_t
 
nkey
, 
æags
, 
»l_time_t
 
ex±ime
, 
nby‹s
) {

529 
™em
 *
™
;

531 
™
 = 
	`do_™em_®loc
(
key
, 
nkey
, 
æags
, 
ex±ime
, 
nby‹s
);

532  
™
;

533 
	}
}

539 
™em
 *
	$™em_g‘
(cÚ¡ *
key
, cÚ¡ 
size_t
 
nkey
, 
cÚn
 *
c
) {

540 
™em
 *
™
;

541 
ušt32_t
 
hv
;

542 
hv
 = 
	`hash
(
key
, 
nkey
);

543 
	`™em_lock
(
hv
);

544 
™
 = 
	`do_™em_g‘
(
key
, 
nkey
, 
hv
, 
c
);

545 
	`™em_uÆock
(
hv
);

546  
™
;

547 
	}
}

549 
™em
 *
	$™em_touch
(cÚ¡ *
key
, 
size_t
 
nkey
, 
ušt32_t
 
ex±ime
, 
cÚn
 *
c
) {

550 
™em
 *
™
;

551 
ušt32_t
 
hv
;

552 
hv
 = 
	`hash
(
key
, 
nkey
);

553 
	`™em_lock
(
hv
);

554 
™
 = 
	`do_™em_touch
(
key
, 
nkey
, 
ex±ime
, 
hv
, 
c
);

555 
	`™em_uÆock
(
hv
);

556  
™
;

557 
	}
}

562 
	$™em_lšk
(
™em
 *item) {

563 
»t
;

564 
ušt32_t
 
hv
;

566 
hv
 = 
	`hash
(
	`ITEM_key
(
™em
), i‹m->
nkey
);

567 
	`™em_lock
(
hv
);

568 
»t
 = 
	`do_™em_lšk
(
™em
, 
hv
);

569 
	`™em_uÆock
(
hv
);

570  
»t
;

571 
	}
}

577 
	$™em_»move
(
™em
 *item) {

578 
ušt32_t
 
hv
;

579 
hv
 = 
	`hash
(
	`ITEM_key
(
™em
), i‹m->
nkey
);

581 
	`™em_lock
(
hv
);

582 
	`do_™em_»move
(
™em
);

583 
	`™em_uÆock
(
hv
);

584 
	}
}

591 
	$™em_»¶aû
(
™em
 *
Şd_™
, i‹m *
Ãw_™
, cÚ¡ 
ušt32_t
 
hv
) {

592  
	`do_™em_»¶aû
(
Şd_™
, 
Ãw_™
, 
hv
);

593 
	}
}

598 
	$™em_uÆšk
(
™em
 *item) {

599 
ušt32_t
 
hv
;

600 
hv
 = 
	`hash
(
	`ITEM_key
(
™em
), i‹m->
nkey
);

601 
	`™em_lock
(
hv
);

602 
	`do_™em_uÆšk
(
™em
, 
hv
);

603 
	`™em_uÆock
(
hv
);

604 
	}
}

609 
	$™em_upd©e
(
™em
 *item) {

610 
ušt32_t
 
hv
;

611 
hv
 = 
	`hash
(
	`ITEM_key
(
™em
), i‹m->
nkey
);

613 
	`™em_lock
(
hv
);

614 
	`do_™em_upd©e
(
™em
);

615 
	`™em_uÆock
(
hv
);

616 
	}
}

621 
d–_»suÉ_ty³
 
	$add_d–
(
cÚn
 *
c
, cÚ¡ *
key
,

622 cÚ¡ 
size_t
 
nkey
, 
šü
,

623 cÚ¡ 
št64_t
 
d–
, *
buf
,

624 
ušt64_t
 *
ÿs
) {

625 
d–_»suÉ_ty³
 
»t
;

626 
ušt32_t
 
hv
;

628 
hv
 = 
	`hash
(
key
, 
nkey
);

629 
	`™em_lock
(
hv
);

630 
»t
 = 
	`do_add_d–
(
c
, 
key
, 
nkey
, 
šü
, 
d–
, 
buf
, 
ÿs
, 
hv
);

631 
	`™em_uÆock
(
hv
);

632  
»t
;

633 
	}
}

638 
¡Üe_™em_ty³
 
	$¡Üe_™em
(
™em
 *™em, 
comm
, 
cÚn
* 
c
) {

639 
¡Üe_™em_ty³
 
»t
;

640 
ušt32_t
 
hv
;

642 
hv
 = 
	`hash
(
	`ITEM_key
(
™em
), i‹m->
nkey
);

643 
	`™em_lock
(
hv
);

644 
»t
 = 
	`do_¡Üe_™em
(
™em
, 
comm
, 
c
, 
hv
);

645 
	`™em_uÆock
(
hv
);

646  
»t
;

647 
	}
}

651 
	$STATS_LOCK
() {

652 
	`±h»ad_mu‹x_lock
(&
¡©s_lock
);

653 
	}
}

655 
	$STATS_UNLOCK
() {

656 
	`±h»ad_mu‹x_uÆock
(&
¡©s_lock
);

657 
	}
}

659 
	$th»adloÿl_¡©s_»£t
() {

660 
ii
;

661 
ii
 = 0; i˜< 
£‰šgs
.
num_th»ads
; ++ii) {

662 
	`±h»ad_mu‹x_lock
(&
th»ads
[
ii
].
¡©s
.
mu‹x
);

663 
	#X
(
Çme
è
th»ads
[
ii
].
¡©s
.Çmğ0;

	)

664 
THREAD_STATS_FIELDS


665 #undeà
X


667 
	`mem£t
(&
th»ads
[
ii
].
¡©s
.
¦ab_¡©s
, 0,

668 (
th»ads
[
ii
].
¡©s
.
¦ab_¡©s
));

670 
	`±h»ad_mu‹x_uÆock
(&
th»ads
[
ii
].
¡©s
.
mu‹x
);

672 
	}
}

674 
	$th»adloÿl_¡©s_agg»g©e
(
th»ad_¡©s
 *
¡©s
) {

675 
ii
, 
sid
;

679 
	`mem£t
(
¡©s
, 0, (*stats));

681 
ii
 = 0; i˜< 
£‰šgs
.
num_th»ads
; ++ii) {

682 
	`±h»ad_mu‹x_lock
(&
th»ads
[
ii
].
¡©s
.
mu‹x
);

683 
	#X
(
Çme
è
¡©s
->Çm+ğ
th»ads
[
ii
].¡©s.Çme;

	)

684 
THREAD_STATS_FIELDS


685 #undeà
X


687 
sid
 = 0; sid < 
MAX_NUMBER_OF_SLAB_CLASSES
; sid++) {

688 
	#X
(
Çme
è
¡©s
->
¦ab_¡©s
[
sid
].name += \

689 
th»ads
[
ii
].
¡©s
.
¦ab_¡©s
[
sid
].
Çme
;

	)

690 
SLAB_STATS_FIELDS


691 #undeà
X


694 
	`±h»ad_mu‹x_uÆock
(&
th»ads
[
ii
].
¡©s
.
mu‹x
);

696 
	}
}

698 
	$¦ab_¡©s_agg»g©e
(
th»ad_¡©s
 *
¡©s
, 
¦ab_¡©s
 *
out
) {

699 
sid
;

701 
	`mem£t
(
out
, 0, (*out));

703 
sid
 = 0; sid < 
MAX_NUMBER_OF_SLAB_CLASSES
; sid++) {

704 
	#X
(
Çme
è
out
->Çm+ğ
¡©s
->
¦ab_¡©s
[
sid
].Çme;

	)

705 
SLAB_STATS_FIELDS


706 #undeà
X


708 
	}
}

715 
	$memÿched_th»ad_š™
(
Áh»ads
) {

716 
i
;

717 
pow”
;

719 
i
 = 0; i < 
POWER_LARGEST
; i++) {

720 
	`±h»ad_mu‹x_š™
(&
Ìu_locks
[
i
], 
NULL
);

722 
	`±h»ad_mu‹x_š™
(&
wÜk”_hªg_lock
, 
NULL
);

723 
	`±h»ad_mu‹x_š™
(&
š™_lock
, 
NULL
);

724 
	`±h»ad_cÚd_š™
(&
š™_cÚd
, 
NULL
);

725 
	`±h»ad_mu‹x_š™
(&
cqi_ä“li¡_lock
, 
NULL
);

726 
cqi_ä“li¡
 = 
NULL
;

729 ià(
Áh»ads
 < 3) {

730 
pow”
 = 10;

731 } ià(
Áh»ads
 < 4) {

732 
pow”
 = 11;

733 } ià(
Áh»ads
 < 5) {

734 
pow”
 = 12;

735 } ià(
Áh»ads
 <= 10) {

736 
pow”
 = 13;

737 } ià(
Áh»ads
 <= 20) {

738 
pow”
 = 14;

741 
pow”
 = 15;

744 
™em_lock_couÁ
 = 
	`hashsize
(
pow”
);

745 
™em_lock_hashpow”
 = 
pow”
;

747 
™em_locks
 = 
	`ÿÎoc
(
™em_lock_couÁ
, (
±h»ad_mu‹x_t
));

748 
i
 = 0; i < 
™em_lock_couÁ
; i++) {

749 
	`±h»ad_mu‹x_š™
(&
™em_locks
[
i
], 
NULL
);

752 
th»ads
 = 
	`ÿÎoc
(
Áh»ads
, (
LIBEVENT_THREAD
));

754 
i
 = 0; i < 
Áh»ads
; i++) {

755 
fds
[2];

756 
	`pe
(
fds
);

758 
th»ads
[
i
].
nÙify_»ûive_fd
 = 
fds
[0];

759 
th»ads
[
i
].
nÙify_£nd_fd
 = 
fds
[1];

761 
	`£tup_th»ad
(&
th»ads
[
i
]);

763 
¡©s_¡©e
.
»£rved_fds
 += 5;

767 
i
 = 0; i < 
Áh»ads
; i++) {

768 
	`ü—‹_wÜk”
(
wÜk”_libev’t
, &
th»ads
[
i
]);

772 
	`±h»ad_mu‹x_lock
(&
š™_lock
);

773 
	`wa™_fÜ_th»ad_»gi¡¿tiÚ
(
Áh»ads
);

774 
	`±h»ad_mu‹x_uÆock
(&
š™_lock
);

775 
	}
}

	@timedrun.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<uni¡d.h
>

4 
	~<sigÇl.h
>

5 
	~<sys/wa™.h
>

6 
	~<sy£x™s.h
>

8 
	~<as£¹.h
>

10 
	gÿught
 = 0;

12 
	$ÿught_sigÇl
(
which
)

14 
ÿught
 = 
which
;

15 
	}
}

17 
	$wa™_fÜ_´oûss
(
pid_t
 
pid
)

19 
rv
 = 
EX_SOFTWARE
;

20 
¡©s
 = 0;

21 
i
 = 0;

22 
sigaùiÚ
 
sig_hªdËr
;

24 
sig_hªdËr
.
§_hªdËr
 = 
ÿught_sigÇl
;

25 
sig_hªdËr
.
§_æags
 = 0;

27 
	`sigaùiÚ
(
SIGALRM
, &
sig_hªdËr
, 
NULL
);

28 
	`sigaùiÚ
(
SIGHUP
, &
sig_hªdËr
, 
NULL
);

29 
	`sigaùiÚ
(
SIGINT
, &
sig_hªdËr
, 
NULL
);

30 
	`sigaùiÚ
(
SIGTERM
, &
sig_hªdËr
, 
NULL
);

31 
	`sigaùiÚ
(
SIGPIPE
, &
sig_hªdËr
, 
NULL
);

34 
i
 = 0; ;i++) {

35 
pid_t
 
p
 = 
	`wa™pid
(
pid
, &
¡©s
, 0);

36 ià(
p
 =ğ
pid
) {

38 
rv
 = 
	`WIFEXITED
(
¡©s
) ?

39 
	`WEXITSTATUS
(
¡©s
) :

40 (0x80 | 
	`WTERMSIG
(
¡©s
));

43 
sig
 = 0;

44 
i
) {

47 
sig
 = 
ÿught
 > 0 ? caughˆ: 
SIGTERM
;

48 ià(
ÿught
 =ğ
SIGALRM
) {

49 
	`årštf
(
¡d”r
, "Timeout.. killinghe…rocess\n");

53 
sig
 = 
SIGTERM
;

56 
sig
 = 
SIGKILL
;

59 ià(
	`kl
(
pid
, 
sig
) < 0) {

61 
	`³¼Ü
("lost child whenryingo kill");

64 
	`®¬m
(5);

67  
rv
;

68 
	}
}

70 
	$¥awn_ªd_wa™
(**
¬gv
)

72 
rv
 = 
EX_SOFTWARE
;

73 
pid_t
 
pid
 = 
	`fÜk
();

75 
pid
) {

77 
	`³¼Ü
("fork");

78 
rv
 = 
EX_OSERR
;

81 
	`execvp
(
¬gv
[0],‡rgv);

82 
	`³¼Ü
("exec");

83 
rv
 = 
EX_SOFTWARE
;

86 
rv
 = 
	`wa™_fÜ_´oûss
(
pid
);

88  
rv
;

89 
	}
}

91 
	$maš
(
¬gc
, **
¬gv
)

93 
Ç±ime
 = 0;

94 
	`as£¹
(
¬gc
 > 2);

96 
Ç±ime
 = 
	`©oi
(
¬gv
[1]);

97 
	`as£¹
(
Ç±ime
 > 0 &&‚aptime < 1800);

99 
	`®¬m
(
Ç±ime
);

101  
	`¥awn_ªd_wa™
(
¬gv
+2);

102 
	}
}

	@trace.h

1 #iâdeà
TRACE_H


2 
	#TRACE_H


	)

4 #ifdeà
ENABLE_DTRACE


5 
	~"memÿched_dŒaû.h
"

7 
	#MEMCACHED_ASSOC_DELETE
(
¬g0
, 
¬g1
, 
¬g2
)

	)

8 
	#MEMCACHED_ASSOC_DELETE_ENABLED
(è(0)

	)

9 
	#MEMCACHED_ASSOC_FIND
(
¬g0
, 
¬g1
, 
¬g2
)

	)

10 
	#MEMCACHED_ASSOC_FIND_ENABLED
(è(0)

	)

11 
	#MEMCACHED_ASSOC_INSERT
(
¬g0
, 
¬g1
, 
¬g2
)

	)

12 
	#MEMCACHED_ASSOC_INSERT_ENABLED
(è(0)

	)

13 
	#MEMCACHED_COMMAND_ADD
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
)

	)

14 
	#MEMCACHED_COMMAND_ADD_ENABLED
(è(0)

	)

15 
	#MEMCACHED_COMMAND_APPEND
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
)

	)

16 
	#MEMCACHED_COMMAND_APPEND_ENABLED
(è(0)

	)

17 
	#MEMCACHED_COMMAND_CAS
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
)

	)

18 
	#MEMCACHED_COMMAND_CAS_ENABLED
(è(0)

	)

19 
	#MEMCACHED_COMMAND_DECR
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
)

	)

20 
	#MEMCACHED_COMMAND_DECR_ENABLED
(è(0)

	)

21 
	#MEMCACHED_COMMAND_DELETE
(
¬g0
, 
¬g1
, 
¬g2
)

	)

22 
	#MEMCACHED_COMMAND_DELETE_ENABLED
(è(0)

	)

23 
	#MEMCACHED_COMMAND_GET
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
)

	)

24 
	#MEMCACHED_COMMAND_GET_ENABLED
(è(0)

	)

25 
	#MEMCACHED_COMMAND_TOUCH
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
)

	)

26 
	#MEMCACHED_COMMAND_TOUCH_ENABLED
(è(0)

	)

27 
	#MEMCACHED_COMMAND_INCR
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
)

	)

28 
	#MEMCACHED_COMMAND_INCR_ENABLED
(è(0)

	)

29 
	#MEMCACHED_COMMAND_PREPEND
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
)

	)

30 
	#MEMCACHED_COMMAND_PREPEND_ENABLED
(è(0)

	)

31 
	#MEMCACHED_COMMAND_REPLACE
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
)

	)

32 
	#MEMCACHED_COMMAND_REPLACE_ENABLED
(è(0)

	)

33 
	#MEMCACHED_COMMAND_SET
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
)

	)

34 
	#MEMCACHED_COMMAND_SET_ENABLED
(è(0)

	)

35 
	#MEMCACHED_CONN_ALLOCATE
(
¬g0
)

	)

36 
	#MEMCACHED_CONN_ALLOCATE_ENABLED
(è(0)

	)

37 
	#MEMCACHED_CONN_CREATE
(
¬g0
)

	)

38 
	#MEMCACHED_CONN_CREATE_ENABLED
(è(0)

	)

39 
	#MEMCACHED_CONN_DESTROY
(
¬g0
)

	)

40 
	#MEMCACHED_CONN_DESTROY_ENABLED
(è(0)

	)

41 
	#MEMCACHED_CONN_DISPATCH
(
¬g0
, 
¬g1
)

	)

42 
	#MEMCACHED_CONN_DISPATCH_ENABLED
(è(0)

	)

43 
	#MEMCACHED_CONN_RELEASE
(
¬g0
)

	)

44 
	#MEMCACHED_CONN_RELEASE_ENABLED
(è(0)

	)

45 
	#MEMCACHED_ITEM_LINK
(
¬g0
, 
¬g1
, 
¬g2
)

	)

46 
	#MEMCACHED_ITEM_LINK_ENABLED
(è(0)

	)

47 
	#MEMCACHED_ITEM_REMOVE
(
¬g0
, 
¬g1
, 
¬g2
)

	)

48 
	#MEMCACHED_ITEM_REMOVE_ENABLED
(è(0)

	)

49 
	#MEMCACHED_ITEM_REPLACE
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
, 
¬g4
, 
¬g5
)

	)

50 
	#MEMCACHED_ITEM_REPLACE_ENABLED
(è(0)

	)

51 
	#MEMCACHED_ITEM_UNLINK
(
¬g0
, 
¬g1
, 
¬g2
)

	)

52 
	#MEMCACHED_ITEM_UNLINK_ENABLED
(è(0)

	)

53 
	#MEMCACHED_ITEM_UPDATE
(
¬g0
, 
¬g1
, 
¬g2
)

	)

54 
	#MEMCACHED_ITEM_UPDATE_ENABLED
(è(0)

	)

55 
	#MEMCACHED_PROCESS_COMMAND_END
(
¬g0
, 
¬g1
, 
¬g2
)

	)

56 
	#MEMCACHED_PROCESS_COMMAND_END_ENABLED
(è(0)

	)

57 
	#MEMCACHED_PROCESS_COMMAND_START
(
¬g0
, 
¬g1
, 
¬g2
)

	)

58 
	#MEMCACHED_PROCESS_COMMAND_START_ENABLED
(è(0)

	)

59 
	#MEMCACHED_SLABS_ALLOCATE
(
¬g0
, 
¬g1
, 
¬g2
, 
¬g3
)

	)

60 
	#MEMCACHED_SLABS_ALLOCATE_ENABLED
(è(0)

	)

61 
	#MEMCACHED_SLABS_ALLOCATE_FAILED
(
¬g0
, 
¬g1
)

	)

62 
	#MEMCACHED_SLABS_ALLOCATE_FAILED_ENABLED
(è(0)

	)

63 
	#MEMCACHED_SLABS_FREE
(
¬g0
, 
¬g1
, 
¬g2
)

	)

64 
	#MEMCACHED_SLABS_FREE_ENABLED
(è(0)

	)

65 
	#MEMCACHED_SLABS_SLABCLASS_ALLOCATE
(
¬g0
)

	)

66 
	#MEMCACHED_SLABS_SLABCLASS_ALLOCATE_ENABLED
(è(0)

	)

67 
	#MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED
(
¬g0
)

	)

68 
	#MEMCACHED_SLABS_SLABCLASS_ALLOCATE_FAILED_ENABLED
(è(0)

	)

	@util.c

1 
	~<¡dio.h
>

2 
	~<as£¹.h
>

3 
	~<ùy³.h
>

4 
	~<”ºo.h
>

5 
	~<¡ršg.h
>

6 
	~<¡dlib.h
>

7 
	~<¡d¬g.h
>

9 
	~"memÿched.h
"

11 *
	gur›ncode_m­
[256];

12 
	gur›ncode_¡r
[768];

14 
	$ur›ncode_š™
() {

15 
x
;

16 *
¡r
 = 
ur›ncode_¡r
;

17 
x
 = 0; x < 256; x++) {

18 ià(
	`i§Êum
(
x
) || x == '-' || x == '.' || x == '_' || x == '~') {

19 
ur›ncode_m­
[
x
] = 
NULL
;

21 
	`¢´štf
(
¡r
, 4, "%%%02X", 
x
);

22 
ur›ncode_m­
[
x
] = 
¡r
;

23 
¡r
 += 3;

26 
	}
}

28 
boŞ
 
	$ur›ncode
(cÚ¡ *
¤c
, *
d¡
, cÚ¡ 
size_t
 
¤ş’
, cÚ¡ size_ˆ
d¡Ën
) {

29 
x
;

30 
size_t
 
d
 = 0;

31 
x
 = 0; x < 
¤ş’
; x++) {

32 ià(
d
 + 4 >ğ
d¡Ën
)

33  
çl£
;

34 ià(
ur›ncode_m­
[(è
¤c
[
x
]] !ğ
NULL
) {

35 
	`memıy
(&
d¡
[
d
], 
ur›ncode_m­
[(è
¤c
[
x
]], 3);

36 
d
 += 3;

38 
d¡
[
d
] = 
¤c
[
x
];

39 
d
++;

42 
d¡
[
d
] = '\0';

43  
Œue
;

44 
	}
}

47 
	#xis¥aû
(
c
è
	`is¥aû
(()c)

	)

49 
boŞ
 
	$§ã_¡¹ouÎ
(cÚ¡ *
¡r
, 
ušt64_t
 *
out
) {

50 
	`as£¹
(
out
 !ğ
NULL
);

51 
”ºo
 = 0;

52 *
out
 = 0;

53 *
’d±r
;

54 
uÎ
 = 
	`¡¹ouÎ
(
¡r
, &
’d±r
, 10);

55 ià((
”ºo
 =ğ
ERANGE
è|| (
¡r
 =ğ
’d±r
)) {

56  
çl£
;

59 ià(
	`xis¥aû
(*
’d±r
è|| (*’d±¸=ğ'\0' &&ƒnd±¸!ğ
¡r
)) {

60 ià((è
uÎ
 < 0) {

64 ià(
	`¡rchr
(
¡r
, '-'è!ğ
NULL
) {

65  
çl£
;

68 *
out
 = 
uÎ
;

69  
Œue
;

71  
çl£
;

72 
	}
}

74 
boŞ
 
	$§ã_¡¹Şl
(cÚ¡ *
¡r
, 
št64_t
 *
out
) {

75 
	`as£¹
(
out
 !ğ
NULL
);

76 
”ºo
 = 0;

77 *
out
 = 0;

78 *
’d±r
;

79 
Î
 = 
	`¡¹Şl
(
¡r
, &
’d±r
, 10);

80 ià((
”ºo
 =ğ
ERANGE
è|| (
¡r
 =ğ
’d±r
)) {

81  
çl£
;

84 ià(
	`xis¥aû
(*
’d±r
è|| (*’d±¸=ğ'\0' &&ƒnd±¸!ğ
¡r
)) {

85 *
out
 = 
Î
;

86  
Œue
;

88  
çl£
;

89 
	}
}

91 
boŞ
 
	$§ã_¡¹oul
(cÚ¡ *
¡r
, 
ušt32_t
 *
out
) {

92 *
’d±r
 = 
NULL
;

93 
l
 = 0;

94 
	`as£¹
(
out
);

95 
	`as£¹
(
¡r
);

96 *
out
 = 0;

97 
”ºo
 = 0;

99 
l
 = 
	`¡¹oul
(
¡r
, &
’d±r
, 10);

100 ià((
”ºo
 =ğ
ERANGE
è|| (
¡r
 =ğ
’d±r
)) {

101  
çl£
;

104 ià(
	`xis¥aû
(*
’d±r
è|| (*’d±¸=ğ'\0' &&ƒnd±¸!ğ
¡r
)) {

105 ià((è
l
 < 0) {

109 ià(
	`¡rchr
(
¡r
, '-'è!ğ
NULL
) {

110  
çl£
;

113 *
out
 = 
l
;

114  
Œue
;

117  
çl£
;

118 
	}
}

120 
boŞ
 
	$§ã_¡¹Ş
(cÚ¡ *
¡r
, 
št32_t
 *
out
) {

121 
	`as£¹
(
out
 !ğ
NULL
);

122 
”ºo
 = 0;

123 *
out
 = 0;

124 *
’d±r
;

125 
l
 = 
	`¡¹Ş
(
¡r
, &
’d±r
, 10);

126 ià((
”ºo
 =ğ
ERANGE
è|| (
¡r
 =ğ
’d±r
)) {

127  
çl£
;

130 ià(
	`xis¥aû
(*
’d±r
è|| (*’d±¸=ğ'\0' &&ƒnd±¸!ğ
¡r
)) {

131 *
out
 = 
l
;

132  
Œue
;

134  
çl£
;

135 
	}
}

137 
	$v³¼Ü
(cÚ¡ *
fmt
, ...) {

138 
Şd_”ºo
 = 
”ºo
;

139 
buf
[1024];

140 
va_li¡
 
­
;

142 
	`va_¡¬t
(
­
, 
fmt
);

143 ià(
	`v¢´štf
(
buf
, (buf), 
fmt
, 
­
) == -1) {

144 
buf
[(buf) - 1] = '\0';

146 
	`va_’d
(
­
);

148 
”ºo
 = 
Şd_”ºo
;

150 
	`³¼Ü
(
buf
);

151 
	}
}

153 #iâdeà
HAVE_HTONLL


154 
ušt64_t
 
	$mc_sw­64
(
ušt64_t
 
š
) {

155 #ifdeà
ENDIAN_LITTLE


158 
št64_t
 
rv
 = 0;

159 
i
 = 0;

160 
i
 = 0; i<8; i++) {

161 
rv
 = (rv << 8è| (
š
 & 0xff);

162 
š
 >>= 8;

164  
rv
;

167  
š
;

169 
	}
}

171 
ušt64_t
 
	$ÁohÎ
(
ušt64_t
 
v®
) {

172  
	`mc_sw­64
(
v®
);

173 
	}
}

175 
ušt64_t
 
	$htÚÎ
(
ušt64_t
 
v®
) {

176  
	`mc_sw­64
(
v®
);

177 
	}
}

	@util.h

2 
ur›ncode_š™
();

3 
boŞ
 
ur›ncode
(cÚ¡ *
¤c
, *
d¡
, cÚ¡ 
size_t
 
¤ş’
, cÚ¡ size_ˆ
d¡Ën
);

14 
boŞ
 
§ã_¡¹ouÎ
(cÚ¡ *
¡r
, 
ušt64_t
 *
out
);

15 
boŞ
 
§ã_¡¹Şl
(cÚ¡ *
¡r
, 
št64_t
 *
out
);

16 
boŞ
 
§ã_¡¹oul
(cÚ¡ *
¡r
, 
ušt32_t
 *
out
);

17 
boŞ
 
§ã_¡¹Ş
(cÚ¡ *
¡r
, 
št32_t
 *
out
);

19 #iâdeà
HAVE_HTONLL


20 
ušt64_t
 
htÚÎ
(uint64_t);

21 
ušt64_t
 
ÁohÎ
(uint64_t);

24 #ifdeà
__GCC


25 
	#__gcc_©Œibu‹__
 
__©Œibu‹__


	)

27 
	#__gcc_©Œibu‹__
(
x
)

	)

36 
	$v³¼Ü
(cÚ¡ *
fmt
, ...)

37 
	`__gcc_©Œibu‹__
 ((
	`fÜm©
 (
´štf
, 1, 2)));

	@
1
.
0
36
366
assoc.c
assoc.h
bipbuffer.c
bipbuffer.h
cache.c
cache.h
crawler.c
crawler.h
daemon.c
hash.c
hash.h
items.c
items.h
jenkins_hash.c
jenkins_hash.h
logger.c
logger.h
memcached.c
memcached.h
murmur3_hash.c
murmur3_hash.h
protocol_binary.h
sasl_defs.c
sasl_defs.h
sizes.c
slabs.c
slabs.h
solaris_priv.c
stats.c
stats.h
testapp.c
thread.c
timedrun.c
trace.h
util.c
util.h
